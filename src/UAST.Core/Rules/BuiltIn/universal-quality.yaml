# ╔══════════════════════════════════════════════════════════════════════════════╗
# ║                     UAST-Grep Universal Quality Rules                        ║
# ║               Code quality and maintainability patterns for 15 languages     ║
# ╚══════════════════════════════════════════════════════════════════════════════╝
#
# Generated: 2026-01-04
# Total Rules: 764
# Categories: 15+ quality dimensions
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ LANGUAGES COVERED                                                           │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ Python (78)      │ JavaScript (76)  │ Java (36)        │ Go (32)           │
# │ Rust (48)        │ C/C++ (59)       │ C# (140)         │ Kotlin (30)       │
# │ Scala (80)       │ Ruby (80)        │ Lua (35)         │ Clojure (55)      │
# │ PowerShell (40)  │ Shell/Bash (60)  │ Infrastructure (65)                  │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │ QUALITY CATEGORIES                                                          │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │ • Naming Conventions (PascalCase, camelCase, snake_case, constants)         │
# │ • Code Complexity (cyclomatic complexity, nesting depth, method length)     │
# │ • SOLID Principles (SRP, OCP, LSP, ISP, DIP violations)                     │
# │ • Error Handling (empty catch, swallowed exceptions, missing cleanup)       │
# │ • Dead Code (unused variables, unreachable code, redundant operations)      │
# │ • Documentation (missing docs, outdated comments, TODO tracking)            │
# │ • Modern Language Features (deprecated APIs, legacy patterns)               │
# │ • Testing (test structure, assertions, mocking patterns)                    │
# │ • Type Safety (nullable handling, type coercion, implicit conversions)      │
# │ • Resource Management (disposal, cleanup, lifecycle)                        │
# └─────────────────────────────────────────────────────────────────────────────┘
#
# Usage:
#   uast-grep scan -r rules/universal-quality.yaml ./src
#   uast-grep scan -r rules/universal-quality.yaml --language csharp ./src
#
# Rule Format:
#   id:       [language]-quality-[descriptive-name]
#   language: target language (csharp, ruby, scala, etc.) or "*" for universal
#   severity: error | warning | info
#   message:  "Quality: Description of the code smell or anti-pattern"
#   tags:     [quality, category, maintainability]
#   rule:     UAST pattern (kind, pattern, has, any, all, not)
#   note:     Best practice guidance with refactoring examples

# =============================================================================
# COMPLEXITY - Deep nesting, arrow anti-pattern, cyclomatic complexity
# =============================================================================

---
id: universal-deep-nesting
language: "*"
severity: warning
message: "Deep nesting detected (4+ levels) - consider refactoring with guard clauses"
tags:
  - quality
  - complexity
  - nesting
  - readability
rule:
  kind: IfStatement
  has:
    kind: IfStatement
    has:
      kind: IfStatement
      has:
        kind: IfStatement
note: |
  Deep nesting (4+ levels) creates an "arrow anti-pattern" that makes code hard to read.
  Research shows code readability drops significantly beyond 3 levels of nesting.

  Refactoring strategies:
  - Use guard clauses / early returns
  - Extract nested logic into separate functions
  - Use polymorphism instead of conditionals
  - Apply "Replace Nested Conditional with Guard Clauses"

---
id: universal-triple-nested-loop
language: "*"
severity: warning
message: "Triple nested loop detected - O(n^3) or worse complexity"
tags:
  - quality
  - complexity
  - loop
  - performance
rule:
  kind: ForStatement
  has:
    kind: ForStatement
    has:
      kind: ForStatement
note: |
  Triple nested loops indicate O(n^3) or worse algorithmic complexity.
  This is often a sign that a different data structure or algorithm is needed.

  Consider:
  - Using hash maps/sets for O(1) lookups instead of nested searches
  - Precomputing intermediate results
  - Breaking into smaller functions with clearer purposes
  - Using database JOINs instead of in-memory nested iteration

---
id: universal-nested-ternary
language: "*"
severity: error
message: "Nested ternary operators are hard to read - use if/else instead"
tags:
  - quality
  - complexity
  - readability
rule:
  kind: ConditionalExpression
  has:
    kind: ConditionalExpression
note: |
  Nested ternary operators are explicitly prohibited by most style guides
  including SonarQube and Airbnb. They are extremely difficult to read
  and understand, and prone to bugs during maintenance.

  Replace with:
  - if/else statements
  - switch/case
  - Early returns with guard clauses

---
id: universal-long-condition-chain
language: "*"
severity: warning
message: "Long if/else-if chain (6+ branches) - consider switch, polymorphism, or lookup table"
tags:
  - quality
  - complexity
  - readability
rule:
  kind: IfStatement
  has:
    kind: ElseClause
    has:
      kind: IfStatement
      has:
        kind: ElseClause
        has:
          kind: IfStatement
          has:
            kind: ElseClause
            has:
              kind: IfStatement
              has:
                kind: ElseClause
                has:
                  kind: IfStatement
note: |
  Long if/else-if chains with 6+ branches are hard to maintain and test.

  Better alternatives:
  - Switch/case statement
  - Dictionary/map lookup for simple value mapping
  - Strategy pattern for behavioral variations
  - Polymorphism for type-based dispatch

---
id: universal-complex-boolean
language: "*"
severity: warning
message: "Complex boolean expression - extract to named method for clarity"
tags:
  - quality
  - complexity
  - readability
rule:
  kind: BinaryExpression
  any:
    - operator: "&&"
    - operator: "||"
  has:
    kind: BinaryExpression
    any:
      - operator: "&&"
      - operator: "||"
    has:
      kind: BinaryExpression
      any:
        - operator: "&&"
        - operator: "||"
note: |
  Complex boolean expressions with 4+ logical operators are hard to understand
  and test. Each additional operator doubles the number of test cases needed.

  Refactoring: Extract to well-named methods like:
    isEligibleForDiscount()
    hasValidPermissions()
    shouldProcessOrder()

# =============================================================================
# CODE SMELLS - Long functions, large classes, parameter lists, message chains
# =============================================================================

---
id: universal-long-parameter-list
language: "*"
severity: warning
message: "Function has too many parameters (6+) - consider parameter object"
tags:
  - quality
  - smell
  - parameters
rule:
  kind: FunctionDeclaration
  has:
    pattern: "function $NAME($P1, $P2, $P3, $P4, $P5, $P6, $$$REST)"
note: |
  Functions with 6+ parameters are hard to call correctly and maintain.
  Research suggests 3-4 parameters is optimal for comprehension.

  Refactoring options:
  - Introduce Parameter Object
  - Preserve Whole Object
  - Replace Parameter with Method Call
  - Builder pattern for complex construction

---
id: universal-message-chain
language: "*"
severity: warning
message: "Long method chain (5+ calls) - may violate Law of Demeter"
tags:
  - quality
  - smell
  - coupling
rule:
  pattern: "$A.$B.$C.$D.$E.$F"
note: |
  Long method chains (5+ calls) violate the Law of Demeter ("only talk to your
  immediate friends") and create tight coupling between objects.

  Problems:
  - Changes to intermediate objects break the chain
  - Hard to mock/test in isolation
  - Navigating object structure instead of using behavior

  Refactoring: Hide delegate, create wrapper methods

---
id: universal-empty-function
language: "*"
severity: warning
message: "Empty function body - placeholder or dead code?"
tags:
  - quality
  - smell
  - dead-code
rule:
  kind: FunctionDeclaration
  not:
    has:
      kind: Statement
note: |
  Empty function bodies may indicate:
  - Incomplete implementation (TODO)
  - Dead code that should be removed
  - Interface method stub that should be abstract

  If intentional, add a comment explaining why it's empty.

---
id: universal-empty-catch
language: "*"
severity: error
message: "Empty catch block swallows exceptions silently"
tags:
  - quality
  - smell
  - error-handling
  - CWE-390
rule:
  kind: CatchClause
  not:
    has:
      any:
        - kind: Statement
        - kind: Comment
note: |
  Empty catch blocks silently swallow exceptions, making debugging extremely
  difficult and hiding potential bugs.

  At minimum:
  - Log the exception
  - Re-throw after logging
  - Add a comment explaining why it's intentionally empty

---
id: universal-catch-generic-exception
language: "*"
severity: warning
message: "Catching generic Exception - be more specific"
tags:
  - quality
  - smell
  - error-handling
rule:
  any:
    - pattern: "catch (Exception $E)"
    - pattern: "except Exception"
    - pattern: "rescue => $E"
    - pattern: "catch ($E)"
note: |
  Catching generic Exception catches everything including programming errors
  that should propagate (NullPointerException, OutOfMemoryError, etc.).

  Be specific about which exceptions you can actually handle:
  - IOException for I/O operations
  - NetworkException for network calls
  - ValidationException for input validation

# =============================================================================
# NAMING - Mixed conventions, single-letter names, magic numbers
# =============================================================================

---
id: universal-single-letter-variable
language: "*"
severity: info
message: "Single-letter variable name outside loop context - use descriptive name"
tags:
  - quality
  - naming
  - readability
rule:
  pattern: "$VAR = $VALUE"
constraints:
  VAR:
    regex: "^[a-zA-Z]$"
    not_regex: "^[ijknxyzw]$"
note: |
  Single-letter variable names are acceptable for:
  - Loop counters (i, j, k, n)
  - Coordinates (x, y, z, w)
  - Mathematical formulas where convention dictates

  Avoid especially: l (looks like 1), O (looks like 0)

  Use descriptive names that explain the variable's purpose.

---
id: universal-magic-number
language: "*"
severity: warning
message: "Magic number in code - extract to named constant"
tags:
  - quality
  - naming
  - maintainability
rule:
  any:
    - pattern: "$VAR == $NUM"
    - pattern: "$VAR > $NUM"
    - pattern: "$VAR < $NUM"
    - pattern: "$VAR >= $NUM"
    - pattern: "$VAR <= $NUM"
constraints:
  NUM:
    kind: NumberLiteral
    not_regex: "^(-1|0|1|2|100)$"
note: |
  Magic numbers (unexplained numeric literals) make code hard to understand
  and maintain. Extract to named constants that explain their meaning.

  Common exceptions: 0, 1, -1, 2, 100 (percentages)

  Example:
    // Bad: if (age >= 18)
    // Good: if (age >= MINIMUM_ADULT_AGE)

---
id: universal-magic-string
language: "*"
severity: warning
message: "Magic string in comparison - extract to named constant"
tags:
  - quality
  - naming
  - maintainability
rule:
  any:
    - pattern: '$VAR == "$STRING"'
    - pattern: '$VAR === "$STRING"'
    - pattern: '$VAR != "$STRING"'
    - pattern: '$VAR !== "$STRING"'
constraints:
  STRING:
    regex: ".{4,}"
note: |
  Magic strings make code fragile and hard to maintain. Typos won't be
  caught by the compiler, and changes require searching the whole codebase.

  Extract to named constants or use enums/symbols where available.

---
id: universal-numbered-suffix
language: "*"
severity: info
message: "Numbered variable suffix (var1, var2) - use descriptive names or collection"
tags:
  - quality
  - naming
  - readability
rule:
  pattern: "$VAR = $VALUE"
constraints:
  VAR:
    regex: "^[a-zA-Z_]+[0-9]+$"
    not_regex: "^(v[0-9]+|utf[0-9]+|sha[0-9]+|md[0-9]+|aes[0-9]+|ipv[0-9]+)$"
note: |
  Numbered suffixes (user1, user2, value3) indicate:
  - Missing semantic distinction between variables
  - Should probably be a collection/array
  - Need more descriptive names (firstUser, currentUser, newUser)

---
id: universal-hungarian-notation
language: "*"
severity: info
message: "Hungarian notation (strName, iCount) is discouraged in modern code"
tags:
  - quality
  - naming
  - style
rule:
  pattern: "$VAR = $VALUE"
constraints:
  VAR:
    regex: "^(str|int|i|b|f|d|arr|obj|lst|dict|fn|cb)[A-Z][a-zA-Z]*$"
note: |
  Hungarian notation embeds type information in variable names, which is
  redundant in modern languages with strong typing and IDE support.

  Modern style guides (Microsoft, Google, Airbnb) discourage this practice.
  Use semantic names that describe purpose, not type.

# =============================================================================
# DEAD CODE - Unreachable code, empty blocks, unused patterns
# =============================================================================

---
id: universal-code-after-return
language: "*"
severity: error
message: "Unreachable code after return statement"
tags:
  - quality
  - dead-code
  - unreachable
rule:
  kind: BlockStatement
  has:
    kind: ReturnStatement
    followedBy:
      kind: Statement
note: |
  Code after an unconditional return statement is never executed.
  This is likely a bug or leftover from refactoring.

  Remove the unreachable code or fix the control flow.

---
id: universal-code-after-throw
language: "*"
severity: error
message: "Unreachable code after throw statement"
tags:
  - quality
  - dead-code
  - unreachable
rule:
  kind: BlockStatement
  has:
    kind: ThrowStatement
    followedBy:
      kind: Statement
note: |
  Code after a throw statement is never executed.
  Remove the unreachable code.

---
id: universal-if-false
language: "*"
severity: warning
message: "Condition is always false - dead code block"
tags:
  - quality
  - dead-code
  - suspicious
rule:
  any:
    - pattern: "if (false) { $$$BODY }"
    - pattern: "if (0) { $$$BODY }"
    - pattern: "while (false) { $$$BODY }"
note: |
  A condition that's always false means the block will never execute.
  This is likely debug code that should be removed, or a bug.

---
id: universal-if-true
language: "*"
severity: info
message: "Condition is always true - consider removing the conditional"
tags:
  - quality
  - dead-code
  - suspicious
rule:
  any:
    - pattern: "if (true) { $$$BODY }"
    - pattern: "if (1) { $$$BODY }"
note: |
  A condition that's always true is redundant. The code inside will
  always execute, so the conditional can be removed.

  This may be temporary debug code that was forgotten.

---
id: universal-empty-if
language: "*"
severity: warning
message: "Empty if block - likely incomplete code"
tags:
  - quality
  - dead-code
  - incomplete
rule:
  kind: IfStatement
  has:
    field: consequence
    not:
      has:
        kind: Statement
note: |
  An if statement with an empty block is likely incomplete code.
  Either add the intended logic or remove the conditional.

---
id: universal-empty-loop
language: "*"
severity: warning
message: "Empty loop body - infinite loop or missing implementation"
tags:
  - quality
  - dead-code
  - suspicious
rule:
  any:
    - kind: ForStatement
      not:
        has:
          kind: Statement
    - kind: WhileStatement
      not:
        has:
          kind: Statement
note: |
  An empty loop body may indicate:
  - Missing implementation
  - Infinite loop (intentional busy-wait?)
  - Side effect in the loop condition

  If intentional, add a comment explaining why.

# =============================================================================
# COMMENTS - TODO/FIXME, commented-out code
# =============================================================================

---
id: universal-todo-comment
language: "*"
severity: info
message: "TODO comment found - track as technical debt"
tags:
  - quality
  - comment
  - technical-debt
rule:
  kind: Comment
  has:
    regex: "(?i)\\bTODO\\b"
note: |
  TODO comments indicate incomplete work that should be tracked.

  Consider:
  - Creating an issue in your tracker
  - Adding a due date or owner
  - Scheduling time to address it
  - Removing if no longer relevant

---
id: universal-fixme-comment
language: "*"
severity: warning
message: "FIXME comment found - indicates known bug or issue"
tags:
  - quality
  - comment
  - technical-debt
  - bug
rule:
  kind: Comment
  has:
    regex: "(?i)\\bFIXME\\b"
note: |
  FIXME comments indicate known bugs or issues that need attention.
  These should be prioritized higher than TODOs.

  Create a bug ticket and schedule time to fix it.

---
id: universal-hack-comment
language: "*"
severity: warning
message: "HACK comment found - indicates workaround that needs proper fix"
tags:
  - quality
  - comment
  - technical-debt
rule:
  kind: Comment
  has:
    regex: "(?i)\\bHACK\\b"
note: |
  HACK comments indicate temporary workarounds that should be replaced
  with proper solutions.

  Document why the hack is needed and plan to remove it.

---
id: universal-xxx-comment
language: "*"
severity: warning
message: "XXX comment found - indicates problematic or questionable code"
tags:
  - quality
  - comment
  - technical-debt
rule:
  kind: Comment
  has:
    regex: "\\bXXX\\b"
note: |
  XXX comments typically mark problematic code that needs attention.
  Review and address the underlying issue.

# =============================================================================
# BEST PRACTICES - Guard clauses, modern idioms
# =============================================================================

---
id: universal-negated-condition
language: "*"
severity: info
message: "Negated condition with else - consider flipping for readability"
tags:
  - quality
  - readability
  - style
rule:
  pattern: |
    if (!$COND) {
      $$$ELSE_BODY
    } else {
      $$$IF_BODY
    }
note: |
  Negated conditions with else blocks are harder to read. Consider flipping
  to put the positive case first:

  // Before
  if (!isValid) { handleError(); } else { process(); }

  // After
  if (isValid) { process(); } else { handleError(); }

---
id: universal-yoda-condition
language: "*"
severity: info
message: "Yoda condition detected - consider standard order"
tags:
  - quality
  - readability
  - style
rule:
  any:
    - pattern: "null == $VAR"
    - pattern: "null === $VAR"
    - pattern: "true == $VAR"
    - pattern: "false == $VAR"
note: |
  Yoda conditions (constant on left) were historically used to prevent
  accidental assignment, but modern linters catch this. Standard order
  (variable on left) is more readable.

  // Yoda: if (null === user)
  // Standard: if (user === null)

---
id: universal-double-negation
language: "*"
severity: info
message: "Double negation - consider simplifying"
tags:
  - quality
  - readability
  - style
rule:
  pattern: "!!$VAR"
note: |
  Double negation (!!) is used to convert to boolean, but is cryptic.
  Consider explicit conversion:

  - JavaScript/TypeScript: Boolean(value)
  - Python: bool(value)
  - Ruby: !!value is idiomatic, but value.present? may be clearer

---
id: universal-assignment-in-condition
language: "*"
severity: warning
message: "Assignment in condition - potential bug (== vs =)"
tags:
  - quality
  - suspicious
  - bug
rule:
  any:
    - pattern: "if ($VAR = $VALUE)"
    - pattern: "while ($VAR = $VALUE)"
note: |
  Assignment in a condition is often a bug (= instead of ==).
  If intentional, make it explicit:

  // Suspicious
  if (x = getValue())

  // Explicit (if intentional)
  if ((x = getValue()) !== null)

---
id: universal-equality-with-nan
language: "*"
severity: error
message: "NaN comparison always false - use isNaN() instead"
tags:
  - quality
  - bug
  - suspicious
rule:
  any:
    - pattern: "$VAR == NaN"
    - pattern: "$VAR === NaN"
    - pattern: "NaN == $VAR"
    - pattern: "NaN === $VAR"
note: |
  NaN is not equal to anything, including itself. Direct comparison
  always returns false.

  Use the appropriate function:
  - JavaScript: Number.isNaN(value) or isNaN(value)
  - Python: math.isnan(value)

---
id: universal-self-assignment
language: "*"
severity: warning
message: "Self-assignment has no effect"
tags:
  - quality
  - suspicious
  - dead-code
rule:
  pattern: "$VAR = $VAR"
note: |
  Assigning a variable to itself has no effect. This is likely a typo
  or copy-paste error.

# =============================================================================
# PYTHON-SPECIFIC QUALITY RULES
# =============================================================================

---
id: universal-python-except-pass
language: python
severity: warning
message: "Bare except with pass silently ignores all errors"
tags:
  - quality
  - python
  - error-handling
rule:
  pattern: |
    except:
        pass
note: |
  Catching all exceptions and passing silently is dangerous. It hides
  bugs and makes debugging very difficult.

  At minimum, log the exception:
    except Exception as e:
        logger.exception("Error occurred")

---
id: universal-python-bare-except
language: python
severity: warning
message: "Bare except clause catches SystemExit and KeyboardInterrupt"
tags:
  - quality
  - python
  - error-handling
rule:
  pattern: "except:"
note: |
  Bare except clauses catch everything including SystemExit and
  KeyboardInterrupt, preventing normal program termination.

  Use: except Exception: to catch only actual exceptions

---
id: universal-python-mutable-default
language: python
severity: error
message: "Mutable default argument - use None and create inside function"
tags:
  - quality
  - python
  - bug
rule:
  any:
    - pattern: "def $NAME($$$, $PARAM=[], $$$)"
    - pattern: "def $NAME($$$, $PARAM={}, $$$)"
note: |
  Mutable default arguments (list, dict) are shared between function calls,
  leading to unexpected behavior.

  Fix:
    def func(items=None):
        if items is None:
            items = []

---
id: universal-python-equality-none
language: python
severity: warning
message: "Use 'is None' instead of '== None'"
tags:
  - quality
  - python
  - style
rule:
  any:
    - pattern: "$VAR == None"
    - pattern: "$VAR != None"
note: |
  PEP 8 recommends using 'is None' and 'is not None' for None comparisons
  because None is a singleton.

  // Bad: if x == None
  // Good: if x is None

---
id: universal-python-equality-bool
language: python
severity: info
message: "Don't compare to True/False, use truthiness directly"
tags:
  - quality
  - python
  - style
rule:
  any:
    - pattern: "$VAR == True"
    - pattern: "$VAR == False"
    - pattern: "$VAR is True"
    - pattern: "$VAR is False"
note: |
  PEP 8 recommends against comparing to True/False.

  // Bad: if is_valid == True
  // Good: if is_valid

  // Bad: if is_valid == False
  // Good: if not is_valid

# =============================================================================
# JAVASCRIPT/TYPESCRIPT-SPECIFIC QUALITY RULES
# =============================================================================

---
id: universal-js-var-declaration
language: javascript
severity: warning
message: "Use 'const' or 'let' instead of 'var'"
tags:
  - quality
  - javascript
  - modern
rule:
  pattern: "var $VAR = $VALUE"
note: |
  'var' has function scope and hoisting, which can lead to bugs.
  Use 'const' for values that won't change, 'let' for values that will.

  const/let have block scope which is easier to reason about.

---
id: universal-js-triple-equals
language: javascript
severity: warning
message: "Use === instead of == to avoid type coercion"
tags:
  - quality
  - javascript
  - bug
rule:
  pattern: "$A == $B"
  not:
    pattern: "$A == null"
note: |
  == performs type coercion which leads to surprising results:
    "1" == 1    // true
    0 == false  // true
    null == undefined // true

  Use === for strict equality without coercion.

---
id: universal-js-array-callback-return
language: javascript
severity: warning
message: "Array method callback missing return - did you mean forEach?"
tags:
  - quality
  - javascript
  - bug
rule:
  any:
    - pattern: "$ARR.map($ITEM => { $$$BODY })"
    - pattern: "$ARR.filter($ITEM => { $$$BODY })"
    - pattern: "$ARR.reduce($ITEM => { $$$BODY })"
  not:
    has:
      kind: ReturnStatement
note: |
  Array methods like map, filter, reduce expect a return value.
  Missing return usually means forEach was intended.

  // Wrong: arr.map(x => { console.log(x); })
  // Right: arr.forEach(x => { console.log(x); })
  // Right: arr.map(x => { return x * 2; })

---
id: universal-ts-any-type
language: typescript
severity: warning
message: "Avoid 'any' type - use specific types or 'unknown'"
tags:
  - quality
  - typescript
  - typing
rule:
  any:
    - pattern: ": any"
    - pattern: "as any"
note: |
  'any' disables type checking, defeating the purpose of TypeScript.

  Better alternatives:
  - Use specific types
  - Use 'unknown' for truly unknown types (requires type guards)
  - Use generics for flexible but type-safe code
  - Use type assertions only when you're certain of the type

# =============================================================================
# C#-SPECIFIC QUALITY RULES
# =============================================================================

---
id: universal-csharp-async-void
language: csharp
severity: error
message: "Avoid async void - use async Task instead"
tags:
  - quality
  - csharp
  - async
rule:
  pattern: "async void $NAME($$$)"
note: |
  async void methods cannot be awaited and exceptions cannot be caught.
  They're only appropriate for event handlers.

  Use async Task for all other async methods.

---
id: universal-csharp-sync-over-async
language: csharp
severity: error
message: "Blocking on async (.Result/.Wait()) can cause deadlocks"
tags:
  - quality
  - csharp
  - async
  - bug
rule:
  any:
    - pattern: "$TASK.Result"
    - pattern: "$TASK.Wait()"
    - pattern: "$TASK.GetAwaiter().GetResult()"
note: |
  Synchronously blocking on async operations can cause deadlocks in
  UI and ASP.NET contexts due to SynchronizationContext.

  Propagate async/await up the call stack instead:
    // Bad: var result = GetDataAsync().Result;
    // Good: var result = await GetDataAsync();

---
id: universal-csharp-string-concat-loop
language: csharp
severity: warning
message: "String concatenation in loop - use StringBuilder"
tags:
  - quality
  - csharp
  - performance
rule:
  kind: ForStatement
  has:
    pattern: "$STR += $VALUE"
note: |
  String concatenation in loops creates O(n^2) allocations because
  strings are immutable in C#.

  Use StringBuilder:
    var sb = new StringBuilder();
    foreach (var item in items)
        sb.Append(item);
    return sb.ToString();

# =============================================================================
# GO-SPECIFIC QUALITY RULES
# =============================================================================

---
id: universal-go-error-ignored
language: go
severity: error
message: "Error return value ignored - handle or explicitly ignore with _"
tags:
  - quality
  - go
  - error-handling
rule:
  pattern: "$FN($$$)"
  not:
    any:
      - pattern: "$VAR, $ERR := $FN($$$)"
      - pattern: "_, _ = $FN($$$)"
note: |
  Go requires explicit error handling. Ignoring error returns is dangerous.

  // Bad: data := ReadFile()
  // Good: data, err := ReadFile()
  //       if err != nil { return err }

  If intentionally ignoring: _, _ = FuncThatMayFail()

---
id: universal-go-naked-return
language: go
severity: info
message: "Naked return in long function may be confusing"
tags:
  - quality
  - go
  - readability
rule:
  kind: FunctionDeclaration
  has:
    kind: ReturnStatement
    not:
      has:
        kind: Expression
note: |
  Naked returns (return without values using named returns) are acceptable
  in short functions but can be confusing in longer ones.

  Consider explicit returns in functions longer than 10-15 lines.

# =============================================================================
# RUST-SPECIFIC QUALITY RULES
# =============================================================================

---
id: universal-rust-unwrap
language: rust
severity: warning
message: "unwrap() will panic on None/Err - use expect() or proper handling"
tags:
  - quality
  - rust
  - error-handling
rule:
  pattern: ".unwrap()"
note: |
  unwrap() panics if the value is None or Err, which crashes the program.

  Better alternatives:
  - expect("meaningful message") - for cases that shouldn't fail
  - ? operator - propagate errors to caller
  - match/if let - handle both cases explicitly
  - unwrap_or/unwrap_or_else - provide default value

---
id: universal-rust-clone-instead-borrow
language: rust
severity: info
message: "Consider borrowing instead of cloning if data not modified"
tags:
  - quality
  - rust
  - performance
rule:
  pattern: "$VAR.clone()"
note: |
  clone() creates a full copy which may be unnecessary if you only
  need to read the data. Consider using references (&T) instead.

  // May be wasteful: process(data.clone())
  // Better if read-only: process(&data)

# =============================================================================
# JAVA-SPECIFIC QUALITY RULES
# =============================================================================

---
id: universal-java-equals-on-null
language: java
severity: error
message: "Potential NullPointerException - use Objects.equals() or null-check first"
tags:
  - quality
  - java
  - bug
  - null
rule:
  pattern: "$VAR.equals($OTHER)"
note: |
  If $VAR is null, calling .equals() throws NullPointerException.

  Safe alternatives:
  - Objects.equals(var, other) - handles null safely
  - "literal".equals(var) - put known non-null on left
  - Optional<T> - modern null-safe approach

---
id: universal-java-string-concat-loop
language: java
severity: warning
message: "String concatenation in loop - use StringBuilder"
tags:
  - quality
  - java
  - performance
rule:
  kind: ForStatement
  has:
    any:
      - pattern: "$STR += $VALUE"
      - pattern: "$STR = $STR + $VALUE"
note: |
  String concatenation in loops is O(n^2) because strings are immutable.

  Use StringBuilder:
    StringBuilder sb = new StringBuilder();
    for (String item : items) {
        sb.append(item);
    }
    return sb.toString();

---
id: universal-java-raw-type
language: java
severity: warning
message: "Raw type usage - use parameterized types for type safety"
tags:
  - quality
  - java
  - generics
rule:
  any:
    - pattern: "List $VAR"
    - pattern: "Map $VAR"
    - pattern: "Set $VAR"
    - pattern: "new ArrayList()"
    - pattern: "new HashMap()"
note: |
  Raw types bypass generic type checking, leading to ClassCastException
  at runtime.

  // Bad: List items = new ArrayList();
  // Good: List<String> items = new ArrayList<>();

# =============================================================================
# PHP-SPECIFIC QUALITY RULES
# =============================================================================

---
id: universal-php-else-if
language: php
severity: info
message: "Use 'elseif' instead of 'else if' per PSR-12"
tags:
  - quality
  - php
  - style
rule:
  pattern: "else if"
note: |
  PSR-12 (PHP Coding Style) requires 'elseif' as one word,
  not 'else if' as two words.

---
id: universal-php-short-array
language: php
severity: info
message: "Use short array syntax [] instead of array()"
tags:
  - quality
  - php
  - modern
rule:
  pattern: "array($$$)"
note: |
  Short array syntax [] is preferred over array() since PHP 5.4.

  // Old: $arr = array(1, 2, 3);
  // New: $arr = [1, 2, 3];

# =============================================================================
# RUBY-SPECIFIC QUALITY RULES
# =============================================================================

---
id: universal-ruby-double-negation-bool
language: ruby
severity: info
message: "Use explicit boolean conversion or .present? instead of !!"
tags:
  - quality
  - ruby
  - style
rule:
  pattern: "!!$VAR"
note: |
  While !! is common in Ruby for boolean conversion, consider:
  - value.present? (Rails) for nil/empty checking
  - !!value if you specifically need true/false

---
id: universal-ruby-rescue-exception
language: ruby
severity: error
message: "Don't rescue Exception - use StandardError instead"
tags:
  - quality
  - ruby
  - error-handling
rule:
  pattern: "rescue Exception"
note: |
  Exception catches everything including NoMemoryError, SystemExit,
  and Interrupt, preventing proper signal handling.

  // Bad: rescue Exception => e
  // Good: rescue StandardError => e (or just: rescue => e)
---
id: csharp-quality-pascalcase-public-members
language: csharp
severity: warning
message: "Quality: Public method/property should use PascalCase naming convention"
tags:
  - quality
  - naming
rule:
  kind: method_declaration|property_declaration
  pattern: "public [a-z]"
note: |
  Public members in C# should follow PascalCase naming convention.
  Example: `getValue()` should be `GetValue()`.
  References: CA1709, Microsoft Naming Guidelines

---
id: csharp-quality-camelcase-parameters
language: csharp
severity: warning
message: "Quality: Method parameters should use camelCase naming convention"
tags:
  - quality
  - naming
rule:
  kind: parameter_declaration
  pattern: "([A-Z][a-zA-Z0-9]*)"
note: |
  Parameters should use camelCase naming convention.
  Example: `void Method(string Name)` should be `void Method(string name)`.
  References: CA1709

---
id: csharp-quality-interface-prefix
language: csharp
severity: warning
message: "Quality: Interface should be prefixed with 'I'"
tags:
  - quality
  - naming
rule:
  kind: interface_declaration
  pattern: "interface [^I]"
note: |
  Interfaces should be prefixed with 'I' to indicate they are interfaces.
  Example: `interface Repository` should be `interface IRepository`.
  References: CA1715

---
id: csharp-quality-generic-type-prefix
language: csharp
severity: warning
message: "Quality: Generic type parameters should start with 'T'"
tags:
  - quality
  - naming
rule:
  kind: type_parameter
  pattern: "[^T][a-zA-Z0-9]*"
note: |
  Generic type parameters should start with 'T' to indicate they are types.
  Example: `class Foo<K, V>` should be `class Foo<TKey, TValue>`.
  References: CA1715

---
id: csharp-quality-async-method-suffix
language: csharp
severity: warning
message: "Quality: Async method should have 'Async' suffix"
tags:
  - quality
  - naming
  - async
rule:
  kind: method_declaration
  pattern: "async.*Task.*(?<!Async)\\("
note: |
  Async methods should end with 'Async' suffix for clarity.
  Example: `Task<int> GetData()` should be `Task<int> GetDataAsync()`.
  References: ASYNC0002

---
id: csharp-quality-boolean-property-prefix
language: csharp
severity: warning
message: "Quality: Boolean property should use Is/Has/Can prefix"
tags:
  - quality
  - naming
rule:
  kind: property_declaration
  pattern: "bool\\s+(?!Is|Has|Can)[a-zA-Z]"
note: |
  Boolean properties should indicate their boolean nature with Is/Has/Can prefix.
  Example: `bool Enabled` should be `bool IsEnabled`.
  References: Microsoft Naming Guidelines

---
id: csharp-quality-private-field-naming
language: csharp
severity: info
message: "Quality: Private field naming should be consistent (underscore prefix)"
tags:
  - quality
  - naming
  - style
rule:
  kind: field_declaration
  pattern: "private.*[^_]"
note: |
  Apply consistent naming style for private fields.
  Either use `_field` prefix or `field` without prefix consistently throughout the codebase.
  References: StyleCop SA1309

---
id: csharp-quality-hungarian-notation
language: csharp
severity: warning
message: "Quality: Avoid Hungarian notation naming style"
tags:
  - quality
  - naming
rule:
  kind: variable_declaration|parameter_declaration|field_declaration
  pattern: "(str|int|obj|btn|txt|lbl|num)[A-Z]"
note: |
  Hungarian notation is discouraged in .NET. Use descriptive names instead.
  Example: `strName` should be `name`, `intCount` should be `count`.
  References: Microsoft Naming Guidelines

---
id: csharp-quality-abbreviations-in-names
language: csharp
severity: warning
message: "Quality: Use full words instead of unclear abbreviations"
tags:
  - quality
  - naming
rule:
  kind: variable_declaration|parameter_declaration|field_declaration|method_declaration
  pattern: "[a-z]+(btn|txt|lbl|mgr|srv|util)[A-Za-z0-9]*"
note: |
  Abbreviations should be clear without context. Use full words.
  Example: `btnSubmit` should be `submitButton`.
  References: CA1704

---
id: csharp-quality-single-letter-names
language: csharp
severity: warning
message: "Quality: Variable names should be meaningful, not single letters"
tags:
  - quality
  - naming
rule:
  kind: variable_declaration
  pattern: "var\\s+[a-z]\\s*="
note: |
  Variable names should be descriptive. Exception: loop iterators like `i`, `j` are acceptable.
  Example: `var x = GetUser()` should be `var user = GetUser()`.
  References: CA1704

---
id: csharp-quality-type-name-collision
language: csharp
severity: warning
message: "Quality: Class name should not collide with namespace component"
tags:
  - quality
  - naming
rule:
  kind: class_declaration
  pattern: "class\\s+([A-Z][a-zA-Z0-9]*)\\s"
note: |
  Class names that match namespace components cause ambiguity and confusion.
  Example: `namespace Foo { class Foo { } }` should be renamed to avoid collision.
  References: CA1724

---
id: csharp-quality-constants-naming
language: csharp
severity: warning
message: "Quality: Constants should use PascalCase, not SCREAMING_CASE"
tags:
  - quality
  - naming
rule:
  kind: field_declaration
  pattern: "const\\s+[A-Z_]+"
note: |
  .NET uses PascalCase for constants, not SCREAMING_CASE.
  Example: `MAX_SIZE` should be `MaxSize`.
  References: CA1707

---
id: csharp-quality-nullable-disabled
language: csharp
severity: warning
message: "Quality: Nullable reference types should not be disabled"
tags:
  - quality
  - nullability
rule:
  kind: comment
  pattern: "#nullable disable"
note: |
  Disabling nullable reference types misses null safety benefits.
  Fix: Enable nullable and address warnings rather than disabling the feature.
  References: C# Nullable Reference Types

---
id: csharp-quality-null-dereference-without-check
language: csharp
severity: error
message: "Quality: Member access without null check on nullable reference"
tags:
  - quality
  - nullability
  - error
rule:
  kind: member_access_expression
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\.[a-zA-Z_]"
note: |
  Accessing members without null check may throw NullReferenceException.
  Fix: Add null check or use null-conditional operator (?.).
  References: CA1062

---
id: csharp-quality-null-suppression-operator
language: csharp
severity: warning
message: "Quality: Null-forgiving operator (!) hides potential null issues"
tags:
  - quality
  - nullability
rule:
  kind: postfix_unary_expression
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*!"
note: |
  Null suppression operator hides potential null dereference issues.
  Fix: Refactor to eliminate null or add proper null check instead.
  References: C# Nullable

---
id: csharp-quality-missing-null-parameter-check
language: csharp
severity: warning
message: "Quality: Public method should check for null parameters"
tags:
  - quality
  - nullability
rule:
  kind: method_declaration
  pattern: "public.*\\([^)]*\\).*\\{"
note: |
  External callers may pass null. Add null checks.
  Fix: Add `ArgumentNullException.ThrowIfNull(param)` at method start.
  References: CA1062

---
id: csharp-quality-return-null-non-nullable
language: csharp
severity: error
message: "Quality: Cannot return null from non-nullable return type"
tags:
  - quality
  - nullability
  - error
rule:
  kind: return_statement
  pattern: "return null"
note: |
  Returning null from non-nullable return type violates method contract.
  Fix: Return valid object, throw exception, or change to nullable return type.
  References: CS8603

---
id: csharp-quality-default-non-nullable
language: csharp
severity: error
message: "Quality: Cannot use default for non-nullable reference type"
tags:
  - quality
  - nullability
  - error
rule:
  kind: default_expression
  pattern: "default"
note: |
  Default value for reference types is null, which violates non-nullable contract.
  Fix: Return proper instance or make type nullable.
  References: CS8600

---
id: csharp-quality-nullable-coalescing-simplification
language: csharp
severity: info
message: "Quality: Use null-coalescing operator for simpler code"
tags:
  - quality
  - nullability
  - style
rule:
  kind: conditional_expression
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\s*!=\\s*null\\s*\\?\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*:\\s*[a-zA-Z_]"
note: |
  Null-coalescing operator is cleaner and more readable.
  Example: `x != null ? x : y` should be `x ?? y`.
  References: IDE0029

---
id: csharp-quality-null-check-inverted-logic
language: csharp
severity: error
message: "Quality: Logic error - dereferencing after null check is inverted"
tags:
  - quality
  - nullability
  - error
rule:
  kind: if_statement
  pattern: "if\\s*\\(\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*==\\s*null\\s*\\)"
note: |
  Dereferencing inside null check branch suggests inverted logic.
  Fix: Check for `!= null` instead, or ensure method is outside null check.
  References: CS0472

---
id: csharp-quality-missing-dispose-call
language: csharp
severity: error
message: "Quality: IDisposable object not properly disposed"
tags:
  - quality
  - resource-management
  - error
rule:
  kind: object_creation_expression
  pattern: "new\\s+[a-zA-Z_][a-zA-Z0-9_]*\\(.*\\)"
note: |
  Creating IDisposable without using/explicit Dispose causes resource leak.
  Fix: Wrap with `using` statement or declare with `using var`.
  References: CA2000

---
id: csharp-quality-dispose-pattern-incorrect
language: csharp
severity: warning
message: "Quality: IDisposable pattern should use protected virtual Dispose(bool)"
tags:
  - quality
  - resource-management
rule:
  kind: class_declaration
  pattern: "IDisposable"
note: |
  Standard dispose pattern allows derived classes to extend disposal properly.
  Fix: Implement protected virtual Dispose(bool disposing) method.
  References: CA1063

---
id: csharp-quality-finalizer-without-dispose
language: csharp
severity: error
message: "Quality: Class with finalizer should implement IDisposable"
tags:
  - quality
  - resource-management
  - error
rule:
  kind: destructor_declaration
  pattern: "~[a-zA-Z_]"
note: |
  Clients can't deterministically clean up resources without IDisposable.
  Fix: Implement IDisposable with finalizer pattern.
  References: CA1063

---
id: csharp-quality-dispose-not-idempotent
language: csharp
severity: warning
message: "Quality: Dispose should be idempotent (safe to call multiple times)"
tags:
  - quality
  - resource-management
rule:
  kind: method_declaration
  pattern: "void Dispose"
note: |
  Dispose should safely handle multiple calls.
  Fix: Track disposed state and return early if already disposed.
  References: CA1063

---
id: csharp-quality-using-declaration-vs-statement
language: csharp
severity: info
message: "Quality: Use using declaration for more concise code"
tags:
  - quality
  - resource-management
  - style
rule:
  kind: using_statement
  pattern: "using\\s*\\([^;]*\\)\\s*\\{"
note: |
  Using declaration form is more concise in C# 8+.
  Example: `using (var x = ...) { }` can be `using var x = ...`.
  References: IDE0063

---
id: csharp-quality-disposed-object-access
language: csharp
severity: error
message: "Quality: Accessing disposed object will throw ObjectDisposedException"
tags:
  - quality
  - resource-management
  - error
rule:
  kind: member_access_expression
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\."
note: |
  Using object after disposal throws ObjectDisposedException.
  Fix: Ensure object lifetime covers all usage.
  References: CA2213

---
id: csharp-quality-stream-not-flushed
language: csharp
severity: warning
message: "Quality: Stream should be flushed before closing"
tags:
  - quality
  - resource-management
rule:
  kind: method_call_expression
  pattern: "\\.Close\\(\\)"
note: |
  Data may not be written if not flushed before stream close.
  Fix: Call Flush or use using which handles this automatically.
  References: .NET I/O Guidelines

---
id: csharp-quality-async-dispose-not-used
language: csharp
severity: warning
message: "Quality: IAsyncDisposable should use await using, not using"
tags:
  - quality
  - resource-management
  - async
rule:
  kind: using_statement
  pattern: "using\\s+var\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*="
note: |
  Sync dispose in async context blocks thread.
  Fix: Use `await using` for IAsyncDisposable.
  References: CA2012

---
id: csharp-quality-empty-catch-block
language: csharp
severity: error
message: "Quality: Empty catch block silently swallows exception"
tags:
  - quality
  - exception-handling
  - error
rule:
  kind: catch_clause
  pattern: "catch.*\\{\\s*\\}"
note: |
  Empty catch blocks hide exceptions and make debugging difficult.
  Fix: Log exception or handle appropriately. Use `catch (Exception _)` if intentional.
  References: CA1031

---
id: csharp-quality-catch-exception-base-type
language: csharp
severity: warning
message: "Quality: Catch specific exception types, not base Exception"
tags:
  - quality
  - exception-handling
rule:
  kind: catch_clause
  pattern: "catch\\s*\\(\\s*Exception\\s*"
note: |
  Catching base Exception catches critical exceptions (OutOfMemoryException, StackOverflowException).
  Fix: Catch specific exception types.
  References: CA1031

---
id: csharp-quality-exception-variable-unused
language: csharp
severity: info
message: "Quality: Caught exception not used - use discard if intentional"
tags:
  - quality
  - exception-handling
rule:
  kind: catch_clause
  pattern: "catch\\s*\\(\\s*Exception\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*\\)\\s*\\{[^}]*\\}"
note: |
  If exception is not used for logging/handling, use discard: `catch (Exception _)`.
  References: IDE0059

---
id: csharp-quality-throw-in-finally
language: csharp
severity: error
message: "Quality: Throwing in finally overwrites original exception"
tags:
  - quality
  - exception-handling
  - error
rule:
  kind: finally_clause
  pattern: "finally\\s*\\{.*throw\\s"
note: |
  Throwing in finally block overwrites original exception, losing information.
  Fix: Catch exceptions in finally; don't throw.
  References: CA2219

---
id: csharp-quality-throw-without-inner-exception
language: csharp
severity: warning
message: "Quality: Include inner exception when re-throwing"
tags:
  - quality
  - exception-handling
rule:
  kind: throw_statement
  pattern: "throw new.*Exception\\([^,]*\\)"
note: |
  Throwing without inner exception loses original exception details.
  Fix: `throw new Exception(msg, ex)` instead of `throw new Exception(msg)`.
  References: CA2201

---
id: csharp-quality-throws-notimplementedexception
language: csharp
severity: warning
message: "Quality: NotImplementedException indicates incomplete implementation"
tags:
  - quality
  - exception-handling
rule:
  kind: throw_statement
  pattern: "throw new NotImplementedException"
note: |
  NotImplementedException should be replaced with actual implementation or tracked.
  Fix: Implement method or create issue tracking with TODO.
  References: CA1065

---
id: csharp-quality-exception-message-not-localized
language: csharp
severity: info
message: "Quality: Exception messages should be localized for internationalization"
tags:
  - quality
  - exception-handling
  - i18n
rule:
  kind: string_literal
  pattern: "\"[A-Z][^\"]*\""
note: |
  Hardcoded English exception messages prevent internationalization.
  Fix: Use resource strings for exception messages.
  References: CA1303

---
id: csharp-quality-throwing-system-exception
language: csharp
severity: warning
message: "Quality: Throw specific exception type, not base Exception"
tags:
  - quality
  - exception-handling
rule:
  kind: throw_statement
  pattern: "throw new Exception\\("
note: |
  Throwing generic Exception doesn't allow specific handling by callers.
  Fix: Throw specific exception type.
  References: CA2201

---
id: csharp-quality-exception-in-static-constructor
language: csharp
severity: error
message: "Quality: Static constructor exception makes type unusable"
tags:
  - quality
  - exception-handling
  - error
rule:
  kind: constructor_declaration
  pattern: "static\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*\\("
note: |
  Exceptions in static constructor prevent any use of the type (TypeInitializationException).
  Fix: Handle exceptions gracefully or provide initialization method.
  References: CA1065

---
id: csharp-quality-catch-log-rethrow-stack-trace
language: csharp
severity: warning
message: "Quality: Use 'throw' not 'throw ex' to preserve stack trace"
tags:
  - quality
  - exception-handling
rule:
  kind: throw_statement
  pattern: "throw\\s+[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Using `throw ex` resets stack trace, losing original error location.
  Fix: Use bare `throw;` to preserve stack trace.
  References: CA2200

---
id: csharp-quality-high-cyclomatic-complexity
language: csharp
severity: warning
message: "Quality: Method has high cyclomatic complexity (>15 paths)"
tags:
  - quality
  - complexity
rule:
  kind: method_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\s*\\("
note: |
  Complex methods are hard to test and maintain.
  Fix: Extract methods, use polymorphism, or strategy pattern.
  References: CA1502

---
id: csharp-quality-deeply-nested-code
language: csharp
severity: warning
message: "Quality: Code nesting depth exceeds 3-4 levels"
tags:
  - quality
  - complexity
rule:
  kind: block
  pattern: "\\{.*\\{.*\\{.*\\{.*\\{"
note: |
  Deep nesting reduces readability and maintainability.
  Fix: Use early returns, extract methods, or reduce conditional depth.
  References: SonarQube S134

---
id: csharp-quality-long-method
language: csharp
severity: warning
message: "Quality: Method exceeds recommended length (50-100 lines)"
tags:
  - quality
  - complexity
rule:
  kind: method_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\s*\\("
note: |
  Long methods violate single responsibility principle.
  Fix: Extract methods based on logical responsibilities.
  References: SonarQube S138

---
id: csharp-quality-too-many-parameters
language: csharp
severity: warning
message: "Quality: Method has too many parameters (>7)"
tags:
  - quality
  - complexity
rule:
  kind: method_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\s*\\([^)]{200,}\\)"
note: |
  Too many parameters indicate design issues or missing abstractions.
  Fix: Use parameter objects, builders, or records.
  References: CA1026

---
id: csharp-quality-long-parameter-list
language: csharp
severity: warning
message: "Quality: Multiple parameters of same type in sequence"
tags:
  - quality
  - complexity
rule:
  kind: parameter_list
  pattern: "\\([^)]*\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*,\\s*[a-zA-Z_]+\\s+[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Easy to mix up parameter order with many same-type parameters.
  Fix: Use named parameters, parameter objects, or builders.
  References: CA1026

---
id: csharp-quality-switch-many-cases
language: csharp
severity: warning
message: "Quality: Switch with too many cases (>10)"
tags:
  - quality
  - complexity
rule:
  kind: switch_statement
  pattern: "switch\\s*\\([^)]*\\)"
note: |
  Large switch statements suggest missing abstraction.
  Fix: Use dictionary lookup, polymorphism, or strategy pattern.
  References: SonarQube S1479

---
id: csharp-quality-magic-numbers
language: csharp
severity: info
message: "Quality: Use named constant instead of magic number"
tags:
  - quality
  - complexity
  - maintainability
rule:
  kind: numeric_literal
  pattern: "[^0-1][0-9]+"
note: |
  Magic numbers are unclear without context.
  Fix: Define named constants (except for 0, 1).
  References: CA1802

---
id: csharp-quality-magic-strings
language: csharp
severity: info
message: "Quality: Use constants or enums instead of magic strings"
tags:
  - quality
  - complexity
  - maintainability
rule:
  kind: string_literal
  pattern: "\"[a-zA-Z0-9_]+\""
note: |
  Magic strings are error-prone and hard to maintain.
  Fix: Define string constants or use enums.
  References: CA1802

---
id: csharp-quality-boolean-parameter
language: csharp
severity: info
message: "Quality: Boolean parameter is unclear at call site"
tags:
  - quality
  - complexity
rule:
  kind: parameter_declaration
  pattern: "bool\\s+[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Boolean parameters make calling code unclear: `Method(true)` vs `Method(false)`.
  Fix: Use separate methods or enums instead.
  References: Martin Fowler's Refactoring

---
id: csharp-quality-large-class
language: csharp
severity: warning
message: "Quality: Class is too large (>1000 lines or >20 methods)"
tags:
  - quality
  - complexity
rule:
  kind: class_declaration
  pattern: "class\\s+[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Large classes violate single responsibility principle.
  Fix: Extract classes based on responsibilities.
  References: SonarQube S2042

---
id: csharp-quality-god-class
language: csharp
severity: error
message: "Quality: God class with too many responsibilities"
tags:
  - quality
  - solid
  - error
rule:
  kind: class_declaration
  pattern: "class\\s+[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Classes with too many responsibilities violate Single Responsibility Principle.
  Fix: Split into focused classes with single responsibility.
  References: SOLID Principles

---
id: csharp-quality-feature-envy
language: csharp
severity: warning
message: "Quality: Method extensively accessing another class's data"
tags:
  - quality
  - solid
rule:
  kind: method_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\s*\\("
note: |
  Methods should operate on their own class's data, not others.
  Fix: Move method to the class containing the data.
  References: Martin Fowler's Refactoring

---
id: csharp-quality-inappropriate-intimacy
language: csharp
severity: warning
message: "Quality: Classes tightly coupled with each other's private details"
tags:
  - quality
  - solid
rule:
  kind: class_declaration
  pattern: "class\\s+[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Tight coupling through private access reduces maintainability.
  Fix: Extract shared logic or reduce coupling through interfaces.
  References: Martin Fowler's Refactoring

---
id: csharp-quality-interface-segregation-violation
language: csharp
severity: warning
message: "Quality: Interface has too many methods (>5-7)"
tags:
  - quality
  - solid
rule:
  kind: interface_declaration
  pattern: "interface\\s+I[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Large interfaces force unnecessary implementations on clients.
  Fix: Split into smaller, focused interfaces.
  References: Interface Segregation Principle (ISP)

---
id: csharp-quality-dependency-injection-missing
language: csharp
severity: warning
message: "Quality: Missing dependency injection - creating dependencies directly"
tags:
  - quality
  - solid
rule:
  kind: object_creation_expression
  pattern: "new\\s+[a-zA-Z_][a-zA-Z0-9_]*Service\\("
note: |
  Direct dependency creation makes testing difficult.
  Fix: Accept dependency via constructor parameter (dependency injection).
  References: DI Principles

---
id: csharp-quality-static-dependency
language: csharp
severity: warning
message: "Quality: Static dependencies cannot be mocked for testing"
tags:
  - quality
  - solid
rule:
  kind: method_call_expression
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\.[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Static method dependencies can't be mocked or substituted.
  Fix: Use instance methods with dependency injection.
  References: Testability Guidelines

---
id: csharp-quality-open-closed-principle-violation
language: csharp
severity: warning
message: "Quality: Adding new types requires modifying existing code"
tags:
  - quality
  - solid
rule:
  kind: switch_statement
  pattern: "switch"
note: |
  Type checking with switch or if-else violates Open/Closed Principle.
  Fix: Use polymorphism or strategy pattern to support new types.
  References: Open/Closed Principle (OCP)

---
id: csharp-quality-liskov-substitution-violation
language: csharp
severity: error
message: "Quality: Overridden method violates base class contract (LSP)"
tags:
  - quality
  - solid
  - error
rule:
  kind: method_declaration
  pattern: "\\boverride\\s"
note: |
  Derived types must be substitutable for base types.
  Fix: Ensure overridden methods honor base class contract and behavior.
  References: Liskov Substitution Principle (LSP)

---
id: csharp-quality-service-locator-pattern
language: csharp
severity: warning
message: "Quality: Service Locator pattern hides dependencies"
tags:
  - quality
  - solid
  - anti-pattern
rule:
  kind: method_call_expression
  pattern: "ServiceLocator\\.GetService"
note: |
  Service Locator hides dependencies and is an anti-pattern.
  Fix: Use constructor injection instead.
  References: DI vs Service Locator

---
id: csharp-quality-unused-variable
language: csharp
severity: info
message: "Quality: Variable declared but never used"
tags:
  - quality
  - dead-code
rule:
  kind: variable_declaration
  pattern: "var\\s+[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Unused variables indicate incomplete logic or dead code.
  Fix: Remove variable or implement usage.
  References: IDE0059, CS0219

---
id: csharp-quality-unused-parameter
language: csharp
severity: info
message: "Quality: Method parameter never used in body"
tags:
  - quality
  - dead-code
rule:
  kind: parameter_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Unused parameters may indicate incomplete implementation.
  Fix: Remove parameter or implement usage. Use discard `_` if intentional.
  References: IDE0060

---
id: csharp-quality-unused-private-member
language: csharp
severity: info
message: "Quality: Private method/field never referenced"
tags:
  - quality
  - dead-code
rule:
  kind: method_declaration|field_declaration
  pattern: "private"
note: |
  Dead code increases maintenance burden and causes confusion.
  Fix: Remove unused private members.
  References: IDE0051

---
id: csharp-quality-commented-out-code
language: csharp
severity: info
message: "Quality: Commented-out code should be removed"
tags:
  - quality
  - dead-code
rule:
  kind: comment
  pattern: "//\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*\\("
note: |
  Version control handles history - commented code adds clutter.
  Fix: Delete commented code and restore from VCS if needed.
  References: SonarQube S125

---
id: csharp-quality-unreachable-code
language: csharp
severity: warning
message: "Quality: Code after unconditional return/throw is unreachable"
tags:
  - quality
  - dead-code
rule:
  kind: return_statement|throw_statement
  pattern: "return|throw"
note: |
  Unreachable code never executes and may indicate logic error.
  Fix: Remove unreachable code or fix control flow logic.
  References: CS0162

---
id: csharp-quality-redundant-qualifier
language: csharp
severity: info
message: "Quality: Redundant 'this' qualifier"
tags:
  - quality
  - style
rule:
  kind: member_access_expression
  pattern: "this\\.[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Unnecessary `this` qualifier adds verbosity without clarity.
  Fix: Remove redundant `this.` when not needed for disambiguation.
  References: IDE0003

---
id: csharp-quality-redundant-type-specification
language: csharp
severity: info
message: "Quality: Type can be inferred - use 'var' or target-typed 'new'"
tags:
  - quality
  - style
rule:
  kind: variable_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*=\\s*new\\s+[a-zA-Z_]"
note: |
  Repeating type specification is redundant when type can be inferred.
  Example: `List<int> list = new List<int>()` can be `var list = new List<int>()`.
  References: IDE0001

---
id: csharp-quality-redundant-cast
language: csharp
severity: info
message: "Quality: Redundant cast to same or guaranteed type"
tags:
  - quality
  - style
rule:
  kind: cast_expression
  pattern: "\\([a-zA-Z_][a-zA-Z0-9_]*\\)\\s*[a-zA-Z_]"
note: |
  Unnecessary casts add noise without benefit.
  Fix: Remove redundant cast.
  References: IDE0004

---
id: csharp-quality-redundant-boolean-comparison
language: csharp
severity: info
message: "Quality: Boolean already evaluates to true/false"
tags:
  - quality
  - style
rule:
  kind: binary_expression
  pattern: "(==|!=)\\s*(true|false)"
note: |
  Comparing boolean to true/false is redundant.
  Example: `if (condition == true)` should be `if (condition)`.
  References: IDE0100

---
id: csharp-quality-double-negation
language: csharp
severity: info
message: "Quality: Double negation is confusing and redundant"
tags:
  - quality
  - style
rule:
  kind: prefix_unary_expression
  pattern: "!\\s*!"
note: |
  Double negation is confusing and reduces readability.
  Fix: Simplify to single expression.
  References: IDE0100

---
id: csharp-quality-empty-statement
language: csharp
severity: info
message: "Quality: Empty statement (standalone semicolon)"
tags:
  - quality
  - style
rule:
  kind: empty_statement
  pattern: ";"
note: |
  Empty statements may indicate missing code or typos.
  Fix: Remove empty statement or add intended code.
  References: CS1998

---
id: csharp-quality-inconsistent-bracing
language: csharp
severity: info
message: "Quality: Inconsistent brace style (same line vs new line)"
tags:
  - quality
  - style
rule:
  kind: block
  pattern: "\\{"
note: |
  Inconsistent style reduces readability across codebase.
  Fix: Apply consistent brace style throughout.
  References: StyleCop SA1500

---
id: csharp-quality-missing-braces
language: csharp
severity: warning
message: "Quality: Control statement without braces can lead to bugs"
tags:
  - quality
  - style
rule:
  kind: if_statement|for_statement|while_statement
  pattern: "if|for|while"
note: |
  Missing braces can cause bugs when adding statements later.
  Fix: Always use braces for control statements.
  References: StyleCop SA1503

---
id: csharp-quality-inconsistent-indentation
language: csharp
severity: info
message: "Quality: Mixed tabs and spaces for indentation"
tags:
  - quality
  - style
rule:
  kind: whitespace
  pattern: "\\t| {2,}"
note: |
  Mixed indentation causes misalignment in different editors.
  Fix: Use consistent indentation (spaces recommended).
  References: StyleCop SA1027

---
id: csharp-quality-multiple-statements-per-line
language: csharp
severity: info
message: "Quality: Multiple statements on same line"
tags:
  - quality
  - style
rule:
  kind: statement
  pattern: ";\\s*[a-zA-Z]"
note: |
  Multiple statements per line reduces readability.
  Fix: One statement per line.
  References: StyleCop SA1107

---
id: csharp-quality-missing-blank-lines
language: csharp
severity: info
message: "Quality: Missing blank lines between members"
tags:
  - quality
  - style
rule:
  kind: member_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\s*\\{"
note: |
  Blank lines improve readability and visual separation.
  Fix: Add blank lines between members.
  References: StyleCop SA1516

---
id: csharp-quality-trailing-whitespace
language: csharp
severity: info
message: "Quality: Trailing whitespace causes noise in diffs"
tags:
  - quality
  - style
rule:
  kind: whitespace
  pattern: "\\s+$"
note: |
  Trailing spaces and tabs should be removed.
  Fix: Remove trailing whitespace at end of lines.
  References: StyleCop SA1028

---
id: csharp-quality-inconsistent-naming-in-file
language: csharp
severity: info
message: "Quality: Mixed naming styles in same file"
tags:
  - quality
  - style
rule:
  kind: variable_declaration|parameter_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Inconsistency suggests rushed code and reduces maintainability.
  Fix: Apply consistent naming conventions throughout file.
  References: StyleCop

---
id: csharp-quality-long-lines
language: csharp
severity: info
message: "Quality: Line exceeds recommended length (120-150 characters)"
tags:
  - quality
  - style
rule:
  kind: line
  pattern: ".{150,}"
note: |
  Long lines require horizontal scrolling and reduce readability.
  Fix: Break into multiple lines.
  References: StyleCop SA1116

---
id: csharp-quality-missing-xml-documentation
language: csharp
severity: info
message: "Quality: Public member missing XML documentation"
tags:
  - quality
  - documentation
rule:
  kind: method_declaration|property_declaration|class_declaration
  pattern: "public"
note: |
  Public API should be documented for users.
  Fix: Add XML documentation comments (/// <summary>).
  References: CS1591

---
id: csharp-quality-empty-xml-documentation
language: csharp
severity: info
message: "Quality: Empty XML documentation comment"
tags:
  - quality
  - documentation
rule:
  kind: comment
  pattern: "///\\s*<summary>\\s*</summary>"
note: |
  Empty documentation is worse than no documentation.
  Fix: Add meaningful description or remove comment.
  References: CS1591

---
id: csharp-quality-outdated-documentation
language: csharp
severity: warning
message: "Quality: XML documentation doesn't match method signature"
tags:
  - quality
  - documentation
rule:
  kind: comment
  pattern: "///\\s*<(param|returns)>"
note: |
  Misleading documentation causes confusion and errors.
  Fix: Update documentation to match current code.
  References: SA1612

---
id: csharp-quality-todo-without-tracking
language: csharp
severity: info
message: "Quality: TODO comment should reference issue number"
tags:
  - quality
  - documentation
rule:
  kind: comment
  pattern: "//\\s*TODO"
note: |
  TODOs should be tracked externally with issue references.
  Fix: Create issue and reference: `// TODO: #123 Description`.
  References: SonarQube S1135

---
id: csharp-quality-fixme-comment
language: csharp
severity: warning
message: "Quality: FIXME/BUG comment indicates known issue"
tags:
  - quality
  - documentation
rule:
  kind: comment
  pattern: "//\\s*(FIXME|BUG)"
note: |
  Known bugs should be tracked and fixed promptly.
  Fix: Create issue and implement fix.
  References: SonarQube S1134

---
id: csharp-quality-missing-parameter-documentation
language: csharp
severity: info
message: "Quality: Parameters missing XML documentation"
tags:
  - quality
  - documentation
rule:
  kind: parameter_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  All parameters should be documented in XML comments.
  Fix: Add `<param>` element for each parameter.
  References: SA1611

---
id: csharp-quality-missing-returns-documentation
language: csharp
severity: info
message: "Quality: Non-void method missing return value documentation"
tags:
  - quality
  - documentation
rule:
  kind: method_declaration
  pattern: "\\{\\s*return"
note: |
  Return values should be documented for callers.
  Fix: Add `<returns>` element to XML documentation.
  References: SA1615

---
id: csharp-quality-missing-exception-documentation
language: csharp
severity: info
message: "Quality: Method throwing exceptions without documentation"
tags:
  - quality
  - documentation
rule:
  kind: throw_statement
  pattern: "throw new"
note: |
  Callers should know possible exceptions from method.
  Fix: Document exceptions with `<exception cref="">`.
  References: SA1629

---
id: csharp-quality-not-using-file-scoped-namespace
language: csharp
severity: info
message: "Quality: Use file-scoped namespace syntax"
tags:
  - quality
  - modern-csharp
rule:
  kind: namespace_declaration
  pattern: "namespace\\s+[a-zA-Z_][a-zA-Z0-9_.]*\\s*\\{"
note: |
  File-scoped namespaces reduce nesting and improve readability.
  Example: `namespace X;` instead of `namespace X { }`.
  References: IDE0161 (C# 10+)

---
id: csharp-quality-not-using-primary-constructor
language: csharp
severity: info
message: "Quality: Use primary constructor for simpler syntax"
tags:
  - quality
  - modern-csharp
rule:
  kind: constructor_declaration
  pattern: "\\(.*\\)\\s*\\{\\s*[a-zA-Z_][a-zA-Z0-9_]*\\s*=\\s"
note: |
  Primary constructors reduce boilerplate for field assignment.
  Fix: Convert to primary constructor (C# 12+).
  References: C# 12 features

---
id: csharp-quality-not-using-collection-expressions
language: csharp
severity: info
message: "Quality: Use collection expression syntax"
tags:
  - quality
  - modern-csharp
rule:
  kind: object_creation_expression
  pattern: "new\\s+(List|Dictionary|HashSet).*\\s*\\{.*\\}"
note: |
  Collection expressions are more concise and readable.
  Example: `[1, 2, 3]` instead of `new List<int> { 1, 2, 3 }`.
  References: IDE0300 (C# 12+)

---
id: csharp-quality-not-using-pattern-matching
language: csharp
severity: info
message: "Quality: Use pattern matching for cleaner code"
tags:
  - quality
  - modern-csharp
rule:
  kind: if_statement
  pattern: "if\\s*\\(.*is.*&&"
note: |
  Pattern matching is more concise than separate conditions.
  Example: `if (x is Type { Prop: value })` instead of complex checks.
  References: C# pattern matching

---
id: csharp-quality-not-using-switch-expression
language: csharp
severity: info
message: "Quality: Use switch expression for concise code"
tags:
  - quality
  - modern-csharp
rule:
  kind: switch_statement
  pattern: "switch"
note: |
  Switch expressions are more concise for assignments.
  Fix: Convert switch statement to switch expression.
  References: IDE0066 (C# 8+)

---
id: csharp-quality-not-using-target-typed-new
language: csharp
severity: info
message: "Quality: Use target-typed 'new' expression"
tags:
  - quality
  - modern-csharp
rule:
  kind: object_creation_expression
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*=\\s*new\\s+[a-zA-Z_]"
note: |
  Type is redundant when target type is known.
  Example: `ClassName x = new()` instead of `ClassName x = new ClassName()`.
  References: IDE0090 (C# 9+)

---
id: csharp-quality-not-using-init-only-setters
language: csharp
severity: info
message: "Quality: Use 'init' accessor for immutable properties"
tags:
  - quality
  - modern-csharp
rule:
  kind: property_declaration
  pattern: "\\{.*set"
note: |
  Init-only properties provide better immutability than public setters.
  Fix: Use `init` accessor instead of `set`.
  References: C# 9 features

---
id: csharp-quality-not-using-records
language: csharp
severity: info
message: "Quality: Use records for value semantics"
tags:
  - quality
  - modern-csharp
rule:
  kind: class_declaration
  pattern: "class.*\\{.*override.*Equals"
note: |
  Records provide value semantics automatically.
  Fix: Convert to `record` or `record struct`.
  References: C# 9/10 features

---
id: csharp-quality-not-using-raw-string-literals
language: csharp
severity: info
message: "Quality: Use raw string literals for strings with escapes"
tags:
  - quality
  - modern-csharp
rule:
  kind: string_literal
  pattern: "\\\\[\\\\\"ntr]"
note: |
  Raw string literals avoid escape sequences, improving readability.
  Example: `"""raw string"""` instead of escaped strings.
  References: C# 11 features

---
id: csharp-quality-not-using-required-members
language: csharp
severity: info
message: "Quality: Use 'required' keyword for required properties"
tags:
  - quality
  - modern-csharp
rule:
  kind: property_declaration
  pattern: "\\{.*get\\s*;\\s*set\\s*;\\s*\\}"
note: |
  Required members ensure properties are initialized.
  Fix: Add `required` modifier to enforce initialization.
  References: C# 11 features

---
id: csharp-quality-async-suffix-missing
language: csharp
severity: warning
message: "Quality: Async method should have 'Async' suffix"
tags:
  - quality
  - async
  - naming
rule:
  kind: method_declaration
  pattern: "async\\s+Task.*\\("
note: |
  Async methods should end with 'Async' for caller clarity.
  Fix: Rename to have 'Async' suffix.
  References: ASYNC0002

---
id: csharp-quality-async-suffix-non-async
language: csharp
severity: warning
message: "Quality: Method named 'Async' but doesn't return Task"
tags:
  - quality
  - async
  - naming
rule:
  kind: method_declaration
  pattern: "Async\\(\\).*\\{.*[^Task]"
note: |
  Misleading naming suggests async behavior that isn't there.
  Fix: Remove 'Async' suffix or make method actually async.
  References: ASYNC0002

---
id: csharp-quality-async-void-event-handler
language: csharp
severity: info
message: "Quality: Async void acceptable only for event handlers"
tags:
  - quality
  - async
rule:
  kind: method_declaration
  pattern: "async void"
note: |
  Async void is generally an anti-pattern except for event handlers.
  Fix: Return Task instead of void, or ensure it's an event handler.
  References: Stephen Cleary's async guidelines

---
id: csharp-quality-task-not-awaited
language: csharp
severity: error
message: "Quality: Task returned but not awaited - exceptions ignored"
tags:
  - quality
  - async
  - error
rule:
  kind: method_call_expression
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*Async\\(\\)"
note: |
  Unawaited tasks can fail silently without being observed.
  Fix: Await the task or explicitly store for later observation.
  References: CS4014

---
id: csharp-quality-async-without-await
language: csharp
severity: warning
message: "Quality: Async method without await has unnecessary overhead"
tags:
  - quality
  - async
rule:
  kind: method_declaration
  pattern: "async.*Task"
note: |
  Async without await adds overhead without benefit.
  Fix: Remove `async` or add await for actual async operation.
  References: CA1849

---
id: csharp-quality-cancellation-token-not-forwarded
language: csharp
severity: warning
message: "Quality: CancellationToken parameter not passed to async calls"
tags:
  - quality
  - async
rule:
  kind: parameter_declaration
  pattern: "CancellationToken"
note: |
  Cancellation doesn't propagate to inner async calls.
  Fix: Pass token through to all async method calls.
  References: CA1068

---
id: csharp-quality-mutable-struct
language: csharp
severity: warning
message: "Quality: Mutable struct has confusing copy-on-write semantics"
tags:
  - quality
  - type-design
rule:
  kind: struct_declaration
  pattern: "struct.*\\{.*\\{.*set"
note: |
  Mutable structs have confusing behavior due to copying.
  Fix: Use `readonly struct` or convert to class.
  References: CA1815

---
id: csharp-quality-struct-without-equals
language: csharp
severity: warning
message: "Quality: Struct should override Equals and GetHashCode"
tags:
  - quality
  - type-design
rule:
  kind: struct_declaration
  pattern: "struct\\s+[a-zA-Z_]"
note: |
  Default struct equality uses reflection, which is slow.
  Fix: Override Equals and GetHashCode.
  References: CA1815

---
id: csharp-quality-empty-interface
language: csharp
severity: info
message: "Quality: Empty interface may indicate design issue"
tags:
  - quality
  - type-design
rule:
  kind: interface_declaration
  pattern: "interface\\s+I[a-zA-Z_][a-zA-Z0-9_]*\\s*\\{\\s*\\}"
note: |
  Marker interfaces should be considered as attributes instead.
  Fix: Use attributes or add meaningful members.
  References: CA1040

---
id: csharp-quality-static-class-not-marked
language: csharp
severity: warning
message: "Quality: Class with only static members should be marked static"
tags:
  - quality
  - type-design
rule:
  kind: class_declaration
  pattern: "class\\s+[a-zA-Z_][a-zA-Z0-9_]*.*static"
note: |
  Static class prevents accidental instantiation.
  Fix: Mark class as `static`.
  References: CA1052

---
id: csharp-quality-nested-type-visibility
language: csharp
severity: info
message: "Quality: Public nested type increases complexity"
tags:
  - quality
  - type-design
rule:
  kind: class_declaration
  pattern: "public.*class\\s+[a-zA-Z_]"
note: |
  Public nested types are typically extracted to separate files.
  Fix: Extract to separate type if publicly used.
  References: CA1034

---
id: csharp-quality-enum-base-type
language: csharp
severity: info
message: "Quality: Enum base type should accommodate all values"
tags:
  - quality
  - type-design
rule:
  kind: enum_declaration
  pattern: "enum.*:\\s*(byte|short)"
note: |
  Choose base type that can hold all enum values.
  Fix: Use appropriate base type (int is default).
  References: CA1028

---
id: csharp-quality-flags-enum-zero-value
language: csharp
severity: warning
message: "Quality: Flags enum should have None = 0"
tags:
  - quality
  - type-design
rule:
  kind: enum_declaration
  pattern: "\\[Flags\\]"
note: |
  Flags enums need None = 0 to represent no flags set.
  Fix: Add `None = 0` value.
  References: CA1008

---
id: csharp-quality-sealed-class
language: csharp
severity: info
message: "Quality: Class could be sealed if not designed for inheritance"
tags:
  - quality
  - type-design
rule:
  kind: class_declaration
  pattern: "class\\s+[a-zA-Z_][a-zA-Z0-9_]*"
note: |
  Sealing improves performance slightly and prevents unintended inheritance.
  Fix: Mark as `sealed` if not designed for inheritance.
  References: CA1852

---
id: csharp-quality-test-without-assert
language: csharp
severity: error
message: "Quality: Test method without any assertions"
tags:
  - quality
  - testing
  - error
rule:
  kind: method_declaration
  pattern: "\\[Test\\]|\\[Fact\\]"
note: |
  Test doesn't verify anything if no assertions present.
  Fix: Add assertions to verify expected behavior.
  References: SonarQube S2699

---
id: csharp-quality-multiple-arrange-patterns
language: csharp
severity: warning
message: "Quality: Test with multiple unrelated scenarios"
tags:
  - quality
  - testing
rule:
  kind: method_declaration
  pattern: "\\[Test\\]"
note: |
  Tests should be focused on single scenario (Arrange-Act-Assert).
  Fix: Split into separate test methods.
  References: Testing best practices

---
id: csharp-quality-missing-test-category
language: csharp
severity: info
message: "Quality: Test should have category or trait attribute"
tags:
  - quality
  - testing
rule:
  kind: method_declaration
  pattern: "\\[Test\\]"
note: |
  Categories help organize test runs and filter results.
  Fix: Add [Category] or [Trait] attribute.
  References: Testing best practices

---
id: csharp-quality-test-method-not-public
language: csharp
severity: warning
message: "Quality: Test method should be public"
tags:
  - quality
  - testing
rule:
  kind: method_declaration
  pattern: "\\[Test\\].*(?!public)"
note: |
  Non-public test methods may not be discovered by test runners.
  Fix: Make test method public.
  References: Testing frameworks (xUnit, NUnit, MSTest)

---
id: csharp-quality-hardcoded-test-data-path
language: csharp
severity: warning
message: "Quality: Hardcoded absolute paths fail on other machines"
tags:
  - quality
  - testing
rule:
  kind: string_literal
  pattern: "([A-Z]:|/home|/root)[/\\\\]"
note: |
  Absolute paths are machine-specific and cause test failures.
  Fix: Use relative paths or test data attributes.
  References: Testing best practices

---
id: csharp-quality-thread-sleep-in-test
language: csharp
severity: error
message: "Quality: Thread.Sleep in tests makes them slow and flaky"
tags:
  - quality
  - testing
  - error
rule:
  kind: method_call_expression
  pattern: "Thread\\.Sleep"
note: |
  Fixed delays make tests slow and non-deterministic.
  Fix: Use polling with timeout or async wait patterns.
  References: Testing best practices

---
id: csharp-quality-test-depends-on-order
language: csharp
severity: error
message: "Quality: Test depends on execution order"
tags:
  - quality
  - testing
  - error
rule:
  kind: method_declaration
  pattern: "\\[Test\\]"
note: |
  Tests must be independent and runnable in any order.
  Fix: Ensure each test sets up its own state.
  References: Testing best practices

---
id: csharp-quality-string-interpolation-in-logging
language: csharp
severity: warning
message: "Quality: String interpolation in logging evaluates even when disabled"
tags:
  - quality
  - logging
rule:
  kind: method_call_expression
  pattern: "LogInformation\\(\\$"
note: |
  Interpolation happens regardless of log level, wasting CPU.
  Fix: Use structured logging: `_logger.LogInformation("User {User}", user)`.
  References: .NET Logging Guidelines

---
id: csharp-quality-exception-not-logged
language: csharp
severity: warning
message: "Quality: Exception caught but not logged"
tags:
  - quality
  - logging
rule:
  kind: catch_clause
  pattern: "catch.*\\{[^}]*\\}"
note: |
  Swallowed exceptions are hard to diagnose in production.
  Fix: Log exception with `LogError(ex, "message")`.
  References: .NET Logging Guidelines

---
id: csharp-quality-wrong-log-level
language: csharp
severity: info
message: "Quality: Log level should match severity"
tags:
  - quality
  - logging
rule:
  kind: method_call_expression
  pattern: "LogInformation|LogWarning|LogError"
note: |
  Use appropriate level: Trace, Debug, Information, Warning, Error, Critical.
  Fix: Match log level to severity of event.
  References: .NET Logging Guidelines

---
id: csharp-quality-logging-sensitive-data
language: csharp
severity: error
message: "Quality: Sensitive data (passwords, tokens, PII) in logs"
tags:
  - quality
  - logging
  - security
  - error
rule:
  kind: method_call_expression
  pattern: "Log(Information|Warning|Error)\\(.*\\$\\(.*password|token|ssn|credit|apikey"
note: |
  Sensitive data in logs creates security vulnerability.
  Fix: Remove sensitive data before logging.
  References: Security Guidelines

---
id: csharp-quality-console-writeline-in-library
language: csharp
severity: warning
message: "Quality: Use ILogger instead of Console.WriteLine"
tags:
  - quality
  - logging
rule:
  kind: method_call_expression
  pattern: "Console\\.(WriteLine|Write|Out)"
note: |
  Library code should use structured logging, not console.
  Fix: Use ILogger for proper logging framework integration.
  References: .NET Logging Guidelines

---
id: csharp-quality-hardcoded-configuration
language: csharp
severity: error
message: "Quality: Configuration hardcoded instead of externalized"
tags:
  - quality
  - configuration
  - security
  - error
rule:
  kind: string_literal
  pattern: "(Server=|Data Source=|connectionString|api.example)"
note: |
  Configuration should be externalized for different environments.
  Fix: Use IConfiguration, appsettings.json, or environment variables.
  References: .NET Configuration

---
id: csharp-quality-missing-configuration-validation
language: csharp
severity: warning
message: "Quality: Configuration not validated before use"
tags:
  - quality
  - configuration
rule:
  kind: variable_declaration
  pattern: "var.*=.*Configuration"
note: |
  Invalid configuration causes runtime errors.
  Fix: Use Options pattern with validation.
  References: .NET Options pattern (IValidateOptions)

---
id: csharp-quality-configuration-in-constructor
language: csharp
severity: info
message: "Quality: Reading configuration in constructor"
tags:
  - quality
  - configuration
rule:
  kind: constructor_declaration
  pattern: "\\{.*Configuration"
note: |
  Constructor should be lightweight; accept IOptions<T> instead.
  Fix: Move configuration to property or accept IOptions<T> via DI.
  References: .NET DI Guidelines

---
id: csharp-quality-equals-without-gethashcode
language: csharp
severity: error
message: "Quality: Override Equals without GetHashCode"
tags:
  - quality
  - equality
  - error
rule:
  kind: method_declaration
  pattern: "override.*Equals"
note: |
  Objects may behave incorrectly in HashSet, Dictionary.
  Fix: Override both Equals and GetHashCode together.
  References: CA2224

---
id: csharp-quality-gethashcode-changes
language: csharp
severity: error
message: "Quality: GetHashCode using mutable fields"
tags:
  - quality
  - equality
  - error
rule:
  kind: method_declaration
  pattern: "GetHashCode.*\\{"
note: |
  Hash codes must remain stable throughout object lifetime.
  Fix: Use only immutable fields in GetHashCode implementation.
  References: CA2218

---
id: csharp-quality-operator-equals-without-equals
language: csharp
severity: warning
message: "Quality: Overloading == without overriding Equals"
tags:
  - quality
  - equality
rule:
  kind: operator_declaration
  pattern: "operator\\s*=="
note: |
  Inconsistent equality behavior causes bugs.
  Fix: Override Equals when overloading ==.
  References: CA2231

---
id: csharp-quality-missing-iequatable
language: csharp
severity: warning
message: "Quality: Value type with Equals should implement IEquatable<T>"
tags:
  - quality
  - equality
rule:
  kind: struct_declaration
  pattern: "struct.*Equals"
note: |
  Generic equality avoids boxing overhead.
  Fix: Implement IEquatable<T>.
  References: CA1815

---
id: csharp-quality-string-comparison-culture
language: csharp
severity: warning
message: "Quality: String comparison should consider culture"
tags:
  - quality
  - equality
  - i18n
rule:
  kind: binary_expression
  pattern: "(==|!=).*string"
note: |
  String comparison may need culture-aware comparison for i18n.
  Fix: Use StringComparer with appropriate culture.
  References: CA1307

---
id: csharp-quality-empty-method
language: csharp
severity: info
message: "Quality: Empty method body may indicate incomplete code"
tags:
  - quality
  - code-smell
rule:
  kind: method_declaration
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\s*\\{\\s*\\}"
note: |
  Empty methods should be intentional and documented.
  Fix: Implement method or document why it's intentionally empty.
  References: SonarQube S1186

---
id: csharp-quality-nested-ternary
language: csharp
severity: warning
message: "Quality: Nested ternary is hard to read"
tags:
  - quality
  - code-smell
rule:
  kind: conditional_expression
  pattern: "\\?.*:"
note: |
  Nested ternaries reduce readability.
  Fix: Use if-else statements or method extraction.
  References: SonarQube S3358

---
id: csharp-quality-return-null-collection
language: csharp
severity: warning
message: "Quality: Return empty collection instead of null"
tags:
  - quality
  - code-smell
rule:
  kind: return_statement
  pattern: "return null"
note: |
  Returning null requires callers to check for null.
  Fix: Return `Array.Empty<T>()` or empty collection.
  References: CA1859

---
id: csharp-quality-public-constant-arrays
language: csharp
severity: error
message: "Quality: Arrays are mutable; constant not enforced on public"
tags:
  - quality
  - code-smell
  - error
rule:
  kind: field_declaration
  pattern: "public\\s+const\\s+[a-zA-Z_][a-zA-Z0-9_]*\\[\\]"
note: |
  Public constant arrays can be modified by callers.
  Fix: Use `ReadOnlyCollection` or return from method.
  References: CA2105

---
id: csharp-quality-datetime-now-vs-utcnow
language: csharp
severity: warning
message: "Quality: Use DateTime.UtcNow instead of Now for timestamps"
tags:
  - quality
  - code-smell
rule:
  kind: member_access_expression
  pattern: "DateTime\\.Now"
note: |
  Local time causes issues in distributed systems; use UTC.
  Fix: Use `DateTime.UtcNow` for timestamps.
  References: Best practices for distributed systems

---
id: csharp-quality-environment-newline
language: csharp
severity: info
message: "Quality: Use Environment.NewLine instead of hardcoded line endings"
tags:
  - quality
  - code-smell
rule:
  kind: string_literal
  pattern: "\\\\(r)?\\\\n|\"\\\\r\\\\n\"|\r\n"
note: |
  Different platforms have different line endings.
  Fix: Use `Environment.NewLine`.
  References: CA1057

---
id: csharp-quality-virtual-in-constructor
language: csharp
severity: error
message: "Quality: Virtual method called from constructor"
tags:
  - quality
  - code-smell
  - error
rule:
  kind: constructor_declaration
  pattern: "\\{.*[a-zA-Z_][a-zA-Z0-9_]*\\("
note: |
  May call overridden method before derived type initialization.
  Fix: Avoid virtual calls in constructors.
  References: CA2214

---
id: csharp-quality-public-fields
language: csharp
severity: warning
message: "Quality: Public fields lack encapsulation - use properties"
tags:
  - quality
  - code-smell
rule:
  kind: field_declaration
  pattern: "public\\s+[a-zA-Z_][a-zA-Z0-9_]*;(?!;)"
note: |
  Public fields should be properties for encapsulation.
  Fix: Convert to property.
  References: CA1051

---
id: csharp-quality-implicit-conversion-hiding
language: csharp
severity: warning
message: "Quality: Implicit conversion may lose data"
tags:
  - quality
  - code-smell
rule:
  kind: operator_declaration
  pattern: "implicit operator"
note: |
  Implicit conversions hiding data loss are dangerous.
  Fix: Use explicit conversion for lossy operations.
  References: CA2225

---
id: csharp-quality-static-constructor-exception
language: csharp
severity: error
message: "Quality: Exception in static constructor makes type unusable"
tags:
  - quality
  - code-smell
  - error
rule:
  kind: constructor_declaration
  pattern: "static\\s+[a-zA-Z_][a-zA-Z0-9_]*\\s*\\("
note: |
  TypeInitializationException prevents any use of the type.
  Fix: Handle errors gracefully in static constructor.
  References: CA1065

---
id: csharp-quality-unused-return-value
language: csharp
severity: warning
message: "Quality: Return value of pure method ignored"
tags:
  - quality
  - code-smell
rule:
  kind: method_call_expression
  pattern: "[a-zA-Z_][a-zA-Z0-9_]*\\(.*\\);"
note: |
  Ignoring return value suggests bug or unnecessary call.
  Fix: Use return value or remove call.
  References: CA1806

---
id: csharp-quality-assignment-in-condition
language: csharp
severity: error
message: "Quality: Assignment in condition may be typo"
tags:
  - quality
  - code-smell
  - error
rule:
  kind: if_statement
  pattern: "if\\s*\\(.*=\\s*[^=]"
note: |
  Assignment in condition is usually typo for comparison.
  Fix: Use comparison operator or make intention clear.
  References: CS0665
---
id: ruby-quality-snake-case-methods
language: ruby
severity: warning
message: "Quality: Methods should use snake_case naming convention"
tags:
  - quality
  - naming
rule:
  kind: method_definition
  pattern: "def [a-z]*[A-Z]|def [A-Z]|def [a-z]*_[A-Z]"
note: |
  Ruby convention uses snake_case for method and variable names. CamelCase or
  mixed case method names are non-idiomatic and reduce code consistency.
  Use lowercase words separated by underscores.

---
id: ruby-quality-constant-naming
language: ruby
severity: warning
message: "Quality: Constants should use SCREAMING_SNAKE_CASE"
tags:
  - quality
  - naming
rule:
  kind: constant_assignment
  pattern: "[a-z_]*=[A-Z]|[a-z]*[A-Z][a-z]*.*=|my[A-Z]"
note: |
  Ruby convention requires constants to be in SCREAMING_SNAKE_CASE (all uppercase
  with underscores). This improves readability and immediately identifies constant
  values in code.

---
id: ruby-quality-class-naming
language: ruby
severity: warning
message: "Quality: Classes and modules should use PascalCase"
tags:
  - quality
  - naming
rule:
  kind: class_definition
  pattern: "class [a-z_]|class [A-Z][a-z_]*|module [a-z_]|module [A-Z][a-z_]*"
note: |
  Ruby convention requires classes and modules to be named in PascalCase (CapitalizedWords).
  Exception: Well-known acronyms like HTTPParser are acceptable. Prefer standard capitalization
  like HttpParser for clarity unless the acronym is universally recognized.

---
id: ruby-quality-predicate-naming
language: ruby
severity: warning
message: "Quality: Predicate methods should end with ? and avoid redundant prefixes"
tags:
  - quality
  - naming
rule:
  kind: method_definition
  pattern: "def is_[a-z_]|def has_[a-z_]|def can_[a-z_]|def .*\\?.*="
note: |
  Predicate methods (methods returning boolean) should end with ? and avoid redundant
  prefixes like is_, has_, or can_. Remove the prefix and just use the core concept
  (e.g., valid? instead of is_valid?). Never use ? with assignment (setter) methods.

---
id: ruby-quality-boolean-variable-naming
language: ruby
severity: warning
message: "Quality: Boolean variables should avoid redundant prefixes and suffixes"
tags:
  - quality
  - naming
rule:
  kind: variable_assignment
  pattern: "@is_[a-z_]|[a-z_]*_flag\\s*=|[a-z_]*_boolean\\s*="
note: |
  Boolean variable names should directly indicate the state without redundant
  prefixes (is_, has_) or suffixes (flag, boolean). Use simple names like
  @active, enabled, or success instead of @is_active, enabled_flag, or success_boolean.

---
id: ruby-quality-accessor-naming
language: ruby
severity: warning
message: "Quality: Use attr_accessor or natural method names instead of get_/set_ prefixes"
tags:
  - quality
  - naming
rule:
  kind: method_definition
  pattern: "def get_[a-z_]|def set_[a-z_]"
note: |
  Ruby doesn't use get_/set_ prefixes like Java. Use attr_accessor for simple attribute
  access, or define bare method names for getters (def name) and setter names with = suffix
  (def name=(value)). This is more idiomatic and concise.

---
id: ruby-quality-block-param-naming
language: ruby
severity: warning
message: "Quality: Block parameters should have clear, appropriately-sized names"
tags:
  - quality
  - naming
rule:
  kind: block
  pattern: "\\{\\s*\\|[a-z]\\||\\|[a-z_]*_[a-z_]*_[a-z_]*\\|"
note: |
  Block parameters should be named clearly: avoid single letters (except k, v for hash),
  and avoid unnecessarily long names. Use context-appropriate names (item for collections,
  key/value for hashes). Consider using symbol-to-proc (&:method_name) for simple transforms.

---
id: ruby-quality-method-param-naming
language: ruby
severity: warning
message: "Quality: Method parameters should have meaningful, non-cryptic names"
tags:
  - quality
  - naming
rule:
  kind: method_definition
  pattern: "def \\w*\\([a-z],\\s|def \\w*\\([a-b],\\s|def \\w*\\([xyz],\\s"
note: |
  Method parameters must have descriptive names. Single-letter or cryptic names (x, y, z, a, b)
  make code hard to understand. Use descriptive names like user, amount, order to clarify intent
  and improve maintainability.

---
id: ruby-quality-method-length
language: ruby
severity: warning
message: "Quality: Method exceeds recommended length (target: ≤20 lines)"
tags:
  - quality
  - method-design
rule:
  kind: method_definition
  pattern: "[count > 20]"
note: |
  Long methods are hard to understand, test, and maintain. Extract logical units of work
  into separate methods. Aim for methods under 20 lines. This improves clarity, testability,
  and reusability.

---
id: ruby-quality-parameter-count
language: ruby
severity: warning
message: "Quality: Method has too many parameters (limit: 4-5)"
tags:
  - quality
  - method-design
rule:
  kind: method_definition
  pattern: "def \\w*\\([^)]{5,}\\)"
note: |
  Methods with many parameters are hard to call correctly and indicate mixed responsibilities.
  Use options hash, keyword arguments, or parameter objects to group related parameters.
  Example: def process(user:, order:, amount:, **options)

---
id: ruby-quality-cyclomatic-complexity
language: ruby
severity: warning
message: "Quality: Method has high cyclomatic complexity (limit: 10)"
tags:
  - quality
  - method-design
rule:
  kind: method_definition
  pattern: "[complexity > 10]"
note: |
  Cyclomatic complexity measures decision branches (if/elsif/when/&&/||). High complexity
  indicates the method is too complex. Extract conditions into separate methods, use
  polymorphism with case statement handlers, or use guard clauses to reduce nesting.

---
id: ruby-quality-abc-size
language: ruby
severity: warning
message: "Quality: Method has high ABC size (limit: 30)"
tags:
  - quality
  - method-design
rule:
  kind: method_definition
  pattern: "[abc_score > 30]"
note: |
  ABC Size = Assignments + Branches + Conditions. High ABC indicates complex logic.
  Break the method into smaller, focused methods with single responsibilities.
  This improves readability and testability.

---
id: ruby-quality-perceived-complexity
language: ruby
severity: warning
message: "Quality: Method has high perceived complexity (limit: 10)"
tags:
  - quality
  - method-design
rule:
  kind: method_definition
  pattern: "[perceived_complexity > 10]"
note: |
  Perceived complexity measures cognitive load from control structures. Simplify control
  flow by extracting methods, using guard clauses, or restructuring conditionals.
  Aim to reduce the number of decision points readers must track.

---
id: ruby-quality-missing-documentation
language: ruby
severity: info
message: "Quality: Public method lacks documentation"
tags:
  - quality
  - documentation
rule:
  kind: method_definition
  pattern: "def [^#]|def (?!#)"
note: |
  Document public methods with YARD documentation. Include @param tags for parameters,
  @return for return type, @raise for exceptions, and @example for usage examples.
  Documentation improves API usability and prevents misuse.

---
id: ruby-quality-unused-parameter
language: ruby
severity: info
message: "Quality: Method parameter is unused"
tags:
  - quality
  - method-design
rule:
  kind: method_definition
  pattern: "def \\w*\\([^)]*\\).*(?<!\\1)"
note: |
  Unused parameters waste cognitive load and signal incomplete refactoring. Either remove
  the parameter or prefix it with underscore (e.g., _options) to indicate intentional
  non-use. Use splat operators (**) to explicitly accept and discard keyword arguments.

---
id: ruby-quality-class-length
language: ruby
severity: warning
message: "Quality: Class exceeds recommended length (target: ≤200 lines)"
tags:
  - quality
  - class-design
rule:
  kind: class_definition
  pattern: "[count > 200]"
note: |
  Long classes indicate multiple responsibilities. Extract related methods into modules
  or separate classes. Use composition with mixins (include) to organize concerns.
  A focused class is easier to understand, test, and maintain.

---
id: ruby-quality-instance-variable-count
language: ruby
severity: warning
message: "Quality: Class has too many instance variables (limit: 10)"
tags:
  - quality
  - class-design
rule:
  kind: class_definition
  pattern: "[@][a-z_]+.*[@][a-z_]+.*[@][a-z_]+.*[@][a-z_]+.*[@][a-z_]+.*[@][a-z_]+.*[@][a-z_]+.*[@][a-z_]+.*[@][a-z_]+.*[@][a-z_]+"
note: |
  Many instance variables indicate the class is doing too much. Group related variables
  into separate classes (extract related state into value objects). This reduces coupling,
  improves testability, and clarifies class responsibilities.

---
id: ruby-quality-class-documentation
language: ruby
severity: info
message: "Quality: Class lacks documentation"
tags:
  - quality
  - documentation
rule:
  kind: class_definition
  pattern: "class [^#]|class (?!#)"
note: |
  Document public classes with YARD documentation explaining purpose, usage, and key examples.
  Include @example block showing typical usage patterns. Good documentation reduces confusion
  and prevents misuse of the class API.

---
id: ruby-quality-class-coupling
language: ruby
severity: warning
message: "Quality: Class is tightly coupled to too many dependencies (limit: 10)"
tags:
  - quality
  - class-design
rule:
  kind: class_definition
  pattern: "[references > 10]"
note: |
  High coupling makes code fragile and difficult to change. Use dependency injection to
  pass dependencies explicitly. Define interfaces/contracts to decouple from concrete
  implementations. Aim for loose coupling with high cohesion.

---
id: ruby-quality-missing-initialize
language: ruby
severity: info
message: "Quality: Class should have explicit initialize method"
tags:
  - quality
  - class-design
rule:
  kind: class_definition
  pattern: "class \\w+.*(?!def initialize)"
note: |
  Explicit initialize methods clarify dependencies and initialization order. Avoid lazy
  initialization in methods (@data ||= load_data) as it hides dependencies. Make all
  required state explicit in the constructor.

---
id: ruby-quality-god-class
language: ruby
severity: error
message: "Quality: God class has too many responsibilities"
tags:
  - quality
  - class-design
rule:
  kind: class_definition
  pattern: "[method_count > 20]"
note: |
  Classes with many unrelated methods violate Single Responsibility Principle. Extract
  related functionality into service objects, helpers, or concern modules. A focused class
  is easier to test, understand, and reuse.

---
id: ruby-quality-nested-blocks
language: ruby
severity: warning
message: "Quality: Nested block structure is too deep (limit: 2)"
tags:
  - quality
  - block-design
rule:
  kind: block
  pattern: "\\{.*\\{.*\\{|do.*do.*do"
note: |
  Deep nesting reduces readability and makes control flow hard to follow. Extract nested
  blocks into named methods. Use guard clauses to reduce nesting levels. Aim for flat,
  linear code flow.

---
id: ruby-quality-block-proc-lambda
language: ruby
severity: info
message: "Quality: Consider using simpler block syntax or symbol-to-proc"
tags:
  - quality
  - block-design
rule:
  kind: block
  pattern: "Proc\\.new|&->"
note: |
  Prefer blocks over explicit Proc/Lambda for simple cases. Use symbol-to-proc (&:method_name)
  for straightforward transformations. Reserve lambda for cases where strict arity checking
  or complex logic is needed.

---
id: ruby-quality-block-style
language: ruby
severity: info
message: "Quality: Use braces for single-line blocks, do/end for multi-line"
tags:
  - quality
  - block-design
rule:
  kind: block
  pattern: "do .*\n.*\nend|\\{ .*\n.*\n\\}"
note: |
  Single-expression blocks should use curly braces { }. Multi-line blocks should use do/end.
  This convention clarifies intent and maintains consistency. Single-line do/end looks awkward
  and wastes horizontal space.

---
id: ruby-quality-proc-style
language: ruby
severity: info
message: "Quality: Prefer proc { } over Proc.new { }"
tags:
  - quality
  - block-design
rule:
  kind: block
  pattern: "Proc\\.new\\s*\\{"
note: |
  Use proc { } or lambda -> syntax instead of Proc.new for consistency and readability.
  The proc keyword is shorter and more idiomatic. Reserve lambda for cases requiring
  strict argument checking.

---
id: ruby-quality-nested-conditionals
language: ruby
severity: warning
message: "Quality: Nested conditionals reduce readability"
tags:
  - quality
  - conditional-design
rule:
  kind: if_statement
  pattern: "if .* if|if .* unless"
note: |
  Use guard clauses to avoid nested if statements. Return early when preconditions aren't
  met. This reduces nesting, improves readability, and makes the happy path clearer.
  Example: return unless user; return unless user.active?

---
id: ruby-quality-unless-else
language: ruby
severity: info
message: "Quality: Avoid unless with else; use if instead"
tags:
  - quality
  - conditional-design
rule:
  kind: unless_statement
  pattern: "unless .* else"
note: |
  unless/else is confusing because the logic is inverted. Rewrite as if/else for clarity.
  Readers expect positive logic first. unless is best used alone for simple guard conditions.

---
id: ruby-quality-double-negation
language: ruby
severity: info
message: "Quality: Avoid double negation (!!)"
tags:
  - quality
  - conditional-design
rule:
  kind: expression
  pattern: "!!|not\\s+not"
note: |
  Double negation is redundant and confusing. Use .present? (Rails) or simpler alternatives
  like !value.nil? or (value ? true : false). Double negation doesn't improve clarity.

---
id: ruby-quality-ternary-usage
language: ruby
severity: info
message: "Quality: Use if/else for complex logic instead of ternary"
tags:
  - quality
  - conditional-design
rule:
  kind: ternary_expression
  pattern: "\\? .* : .*\\n|\\? \\(.*\\n"
note: |
  Ternary operators are best for simple, single-line assignments. Complex logic spanning
  multiple lines is clearer with if/else blocks. Avoid complex expressions in ternary branches.

---
id: ruby-quality-case-vs-elsif
language: ruby
severity: info
message: "Quality: Use case statement instead of multiple if/elsif for same variable"
tags:
  - quality
  - conditional-design
rule:
  kind: if_statement
  pattern: "if \\w+\\s*==|elsif \\w+\\s*=="
note: |
  When comparing one variable against multiple values, use case/when instead of if/elsif.
  Case statements are clearer, more efficient, and indicate intent better. They reduce
  repetition and improve readability.

---
id: ruby-quality-case-else
language: ruby
severity: info
message: "Quality: Case statement should have else clause for defensive programming"
tags:
  - quality
  - conditional-design
rule:
  kind: case_statement
  pattern: "case .* end(?!.*else)"
note: |
  Always include an else clause in case statements to handle unexpected values. This prevents
  silent failures and makes code more defensive. Raise an exception or provide sensible default
  behavior for unhandled cases.

---
id: ruby-quality-comparison-to-boolean
language: ruby
severity: info
message: "Quality: Avoid comparing to true/false/nil explicitly"
tags:
  - quality
  - conditional-design
rule:
  kind: comparison
  pattern: "==\\s*true|==\\s*false|==\\s*nil"
note: |
  Use truthiness instead of explicit boolean comparison: if value (for truthy), unless value
  (for falsy), if value.nil? (for nil check). Explicit comparisons are verbose and unnecessary
  in Ruby's truthiness system.

---
id: ruby-quality-bare-rescue
language: ruby
severity: error
message: "Quality: Bare rescue catches all exceptions including fatal ones"
tags:
  - quality
  - exception-handling
rule:
  kind: rescue_clause
  pattern: "rescue\\s*$|rescue\\s*\n"
note: |
  Bare rescue catches StandardError but hides the actual exception type. Be explicit:
  rescue StandardError => e or rescue SpecificError. This improves debugging, makes
  error handling intentions clear, and prevents catching unexpected exception types.

---
id: ruby-quality-exception-swallowing
language: ruby
severity: error
message: "Quality: Empty rescue block swallows exceptions silently"
tags:
  - quality
  - exception-handling
rule:
  kind: rescue_clause
  pattern: "rescue \\w+\\s*$|rescue \\w+\\s*\n"
note: |
  Never leave rescue blocks empty. Always log the error or re-raise it. Silent failures
  are debugging nightmares. Use Rails.logger.error(e) or raise to preserve the error trail
  for investigation.

---
id: ruby-quality-rescue-exception
language: ruby
severity: error
message: "Quality: Rescuing Exception catches signals and is too broad"
tags:
  - quality
  - exception-handling
rule:
  kind: rescue_clause
  pattern: "rescue\\s+Exception"
note: |
  Never rescue Exception (includes SystemExit, Interrupt, SIGTERM). Use StandardError
  or specific exceptions. Rescuing Exception can prevent proper shutdown and hide serious
  errors that shouldn't be caught.

---
id: ruby-quality-raise-string
language: ruby
severity: warning
message: "Quality: Raise exception class, not string"
tags:
  - quality
  - exception-handling
rule:
  kind: raise_statement
  pattern: "raise\\s+['\"]|raise\\s+%"
note: |
  Use raise CustomError, "message" instead of raise "string". Exception classes provide
  type information for rescue handlers and improve error categorization. Strings are
  less informative and harder to handle programmatically.

---
id: ruby-quality-fail-vs-raise
language: ruby
severity: info
message: "Quality: Use raise consistently (fail is deprecated)"
tags:
  - quality
  - exception-handling
rule:
  kind: raise_statement
  pattern: "\\bfail\\b"
note: |
  Use raise consistently throughout codebase. fail is an older alias and is being phased
  out. raise is the standard Ruby idiom. Consistent naming improves code uniformity and
  clarity.

---
id: ruby-quality-ensure-without-rescue
language: ruby
severity: info
message: "Quality: Consider if rescue is needed alongside ensure"
tags:
  - quality
  - exception-handling
rule:
  kind: ensure_block
  pattern: "ensure.*(?!rescue)"
note: |
  ensure is for cleanup (closing files, releasing resources). If you have ensure but no
  rescue, you may be swallowing errors without handling them. Ensure explicit error
  handling when needed.

---
id: ruby-quality-retry-without-limit
language: ruby
severity: warning
message: "Quality: Retry without limit causes infinite loops"
tags:
  - quality
  - exception-handling
rule:
  kind: retry_statement
  pattern: "retry\\s*$|retry\\s*\n"
note: |
  Always limit retries to prevent infinite loops. Use a counter: retries = 0; retry if retries < 3.
  Set reasonable limits based on your use case. Document why retries are needed and what
  conditions should stop retry attempts.

---
id: ruby-quality-and-or-usage
language: ruby
severity: info
message: "Quality: Use && and || instead of and/or"
tags:
  - quality
  - idioms
rule:
  kind: binary_operation
  pattern: "\\s+and\\s+|\\s+or\\s+"
note: |
  and/or have lower precedence than &&/||, causing subtle bugs. Use && and || for consistency
  and to avoid precedence issues. and/or are rarely needed except for flow control edge cases.

---
id: ruby-quality-negated-conditional
language: ruby
severity: info
message: "Quality: Use unless instead of if !"
tags:
  - quality
  - idioms
rule:
  kind: if_statement
  pattern: "if\\s+!|if\\s+not"
note: |
  unless is more idiomatic than if !. It reads more naturally: "unless condition" vs
  "if not condition". unless is preferred for simple guard conditions that negate a single check.

---
id: ruby-quality-redundant-self
language: ruby
severity: info
message: "Quality: Avoid redundant self in method calls"
tags:
  - quality
  - idioms
rule:
  kind: method_call
  pattern: "self\\.[a-z_]+[^=]|self\\s+[a-z_]+"
note: |
  self is implicit in most cases. Use self only when necessary (setter calls, passing as argument).
  Redundant self adds noise without clarity. Exception: def name=(value); self.first_name = value.

---
id: ruby-quality-explicit-return
language: ruby
severity: info
message: "Quality: Avoid redundant return statements"
tags:
  - quality
  - idioms
rule:
  kind: return_statement
  pattern: "return\\s+[^;]"
note: |
  Ruby returns the last expression by default. Explicit return adds verbosity. Use implicit
  returns for cleaner, more idiomatic code. Reserve explicit return for early exit in guard
  clauses.

---
id: ruby-quality-method-def-parentheses
language: ruby
severity: info
message: "Quality: Include parentheses for methods with arguments"
tags:
  - quality
  - idioms
rule:
  kind: method_definition
  pattern: "def \\w+\\s+[a-z_]|def \\w+\\s*\n"
note: |
  Include parentheses for methods with arguments: def method(arg1, arg2). Omit parentheses
  only for parameterless methods: def method. Consistent parentheses improve readability and
  prevent accidental issues.

---
id: ruby-quality-trailing-comma
language: ruby
severity: info
message: "Quality: Use trailing commas in multi-line collections"
tags:
  - quality
  - idioms
rule:
  kind: array_literal
  pattern: "[\\[,].*\n.*[^,][\\]]"
note: |
  Multi-line arrays, hashes, and method arguments should have trailing commas. This improves
  diffs and prevents accidentally moving items without comma issues. Single-line collections
  don't need trailing commas.

---
id: ruby-quality-string-quotes
language: ruby
severity: info
message: "Quality: Prefer single quotes for strings without interpolation"
tags:
  - quality
  - idioms
rule:
  kind: string_literal
  pattern: "\"[^#]*\"|%[wW][^%]*%"
note: |
  Use single quotes 'string' for simple strings. Use double quotes "string with #{interpolation}"
  only when needed. Single quotes are slightly faster and make intent clear. Be consistent
  throughout the codebase.

---
id: ruby-quality-frozen-string-literal
language: ruby
severity: info
message: "Quality: Add frozen_string_literal comment at file top"
tags:
  - quality
  - idioms
rule:
  kind: file
  pattern: "^(?!#\\s*frozen_string_literal)"
note: |
  Add # frozen_string_literal: true to prevent string mutation. This is Ruby 3.0+ best practice
  and prevents subtle bugs from accidental string modification. Place at the very top of the file
  before other comments.

---
id: ruby-quality-symbol-hash-keys
language: ruby
severity: info
message: "Quality: Use symbol keys in hashes instead of strings"
tags:
  - quality
  - idioms
rule:
  kind: hash_literal
  pattern: "{\\s*[\"'][a-z_]'\\s*=>|{\\s*[\"'][a-z_]':"
note: |
  Symbol keys are idiomatic for hashes: { name: "value" } or { :name => "value" }. String keys
  are slower and should only be used for dynamic key scenarios. Symbols are preferred throughout
  the Ruby ecosystem.

---
id: ruby-quality-dead-code
language: ruby
severity: warning
message: "Quality: Dead code after return/raise/break"
tags:
  - quality
  - code-smell
rule:
  kind: statement
  pattern: "(return|raise|break).*\n.*[^\\s]"
note: |
  Code after return/raise/break is unreachable and never executes. Remove it to clean up code
  and reduce confusion. Dead code indicates incomplete refactoring or copy-paste errors. Keep
  only live, reachable code.

---
id: ruby-quality-unused-variable
language: ruby
severity: info
message: "Quality: Variable is assigned but never used"
tags:
  - quality
  - code-smell
rule:
  kind: variable_assignment
  pattern: "\\w+\\s*=.*(?!\\1)"
note: |
  Unused assignments waste cognitive load. Either remove the variable or prefix with underscore
  if intentionally ignored: _ = value. This signals to reviewers that non-use is intentional,
  not an oversight.

---
id: ruby-quality-duplicate-code
language: ruby
severity: warning
message: "Quality: Code appears duplicated; extract to shared method"
tags:
  - quality
  - code-smell
rule:
  kind: method_definition
  pattern: "[similarity > 0.8]"
note: |
  Duplicated code violates DRY (Don't Repeat Yourself) principle. Extract common logic into
  a shared method. Duplication makes maintenance harder and introduces inconsistency risks.
  Aim for single source of truth for each piece of logic.

---
id: ruby-quality-magic-numbers
language: ruby
severity: info
message: "Quality: Magic numbers should be named constants"
tags:
  - quality
  - code-smell
rule:
  kind: numeric_literal
  pattern: "[0-9]{3,}|sleep\\([0-9]+\\)|> [0-9]{2}"
note: |
  Extract magic numbers into named constants. Instead of if age > 18, use MINIMUM_AGE = 18.
  Named constants clarify intent and make changes easier. Avoid hardcoding values that have
  meaning in your domain.

---
id: ruby-quality-long-parameter-list
language: ruby
severity: warning
message: "Quality: Method has too many parameters; consider parameter object"
tags:
  - quality
  - code-smell
rule:
  kind: method_definition
  pattern: "def \\w+\\([^)]{100,}\\)"
note: |
  More than 5-6 parameters indicates you should use a parameter object or keyword arguments.
  Group related parameters: def create_user(attributes) instead of create_user(name, email, ...).
  This improves readability and makes adding parameters easier.

---
id: ruby-quality-data-clumps
language: ruby
severity: warning
message: "Quality: Related data appears in multiple methods; extract to class"
tags:
  - quality
  - code-smell
rule:
  kind: method_definition
  pattern: "[shared_params > 2]"
note: |
  When the same group of parameters appears in multiple methods, extract them into a class.
  Instead of passing (first_name, last_name, email) to multiple methods, create a Person class.
  This reduces duplication and clarifies relationships between data.

---
id: ruby-quality-primitive-obsession
language: ruby
severity: info
message: "Quality: Consider extracting primitive types into value objects"
tags:
  - quality
  - code-smell
rule:
  kind: method_definition
  pattern: "def \\w+\\([^)]*\\w+:\\s*(String|Integer|Float).*\\w+:\\s*(String|Integer|Float)"
note: |
  When primitives (String, Integer) are frequently passed together with clear semantics, create
  a value object (Money, Email, Phone). Value objects provide domain language, type safety,
  and behavior organization. DDD principle: identify your domain models.

---
id: ruby-quality-fat-controller
language: ruby
severity: error
message: "Quality: Controller has too much business logic"
tags:
  - quality
  - rails
rule:
  kind: class_definition
  pattern: "Controller.*def \\w+.*[lines > 10]"
note: |
  Controllers should be thin request/response handlers. Move business logic to service objects,
  models, or form objects. Controllers shouldn't handle email, payments, validations, or workflows.
  Extract: CreateUserService.call(params).

---
id: ruby-quality-fat-model
language: ruby
severity: warning
message: "Quality: Model exceeds recommended length; extract concerns"
tags:
  - quality
  - rails
rule:
  kind: class_definition
  pattern: "ApplicationRecord.*[lines > 300]"
note: |
  Models > 300 lines usually have multiple responsibilities. Extract related methods into
  modules (concerns), decorators, or service objects. Include module for mixins: include Validatable.
  Keep models focused on data persistence and core domain logic.

---
id: ruby-quality-callback-hell
language: ruby
severity: error
message: "Quality: Too many callbacks create implicit control flow"
tags:
  - quality
  - rails
rule:
  kind: class_definition
  pattern: "before_save|after_create|after_update|after_destroy"
note: |
  Multiple callbacks make control flow implicit and testing difficult. Use service objects for
  workflows: CreateUser.call(params) instead of relying on callbacks. Reserve callbacks for
  simple state maintenance. Complex workflows need explicit, testable code.

---
id: ruby-quality-logic-in-view
language: ruby
severity: error
message: "Quality: Business logic in view template"
tags:
  - quality
  - rails
rule:
  kind: erb_template
  pattern: "<%.*\\?.*%>|<%=.*\\+|<%=.*-"
note: |
  Views should only format and display data. Move conditionals and calculations to decorators,
  presenters, or helper methods. Use Draper gem for decorators. Keep views simple and pure.
  Separation of concerns improves testability and reusability.

---
id: ruby-quality-db-in-view
language: ruby
severity: error
message: "Quality: Database query in view template"
tags:
  - quality
  - rails
rule:
  kind: erb_template
  pattern: "<%%.*where|<%%.*find|<%%.*all"
note: |
  Never query the database in views. Prepare all data in controller/action. Views should only
  iterate over pre-loaded collections (@users.each). Database queries in views cause N+1 problems
  and make testing/debugging harder.

---
id: ruby-quality-missing-index
language: ruby
severity: warning
message: "Quality: Foreign key references should have database index"
tags:
  - quality
  - rails
rule:
  kind: migration
  pattern: "add_reference.*(?!index|add_index)"
note: |
  Foreign key columns need indexes for query performance. Use add_reference :orders, :user, index: true.
  Without indexes, joins and lookups are slow. This is especially critical for production databases
  with large tables.

---
id: ruby-quality-default-scope
language: ruby
severity: warning
message: "Quality: Default scope affects all queries; use explicit scopes instead"
tags:
  - quality
  - rails
rule:
  kind: class_definition
  pattern: "default_scope"
note: |
  default_scope affects all queries globally, including associations. It's implicit and
  causes unexpected behavior. Use explicit scopes: scope :published, -> { where(published: true) }.
  Callers see what scope is applied. Easier to test and debug.

---
id: ruby-quality-skip-validation
language: ruby
severity: warning
message: "Quality: Bypassing validation risks data integrity"
tags:
  - quality
  - rails
rule:
  kind: method_call
  pattern: "save\\(validate:\\s*false\\)|update_attribute\\(|update_all\\("
note: |
  save(validate: false) and update_attribute bypass validations and risk data corruption.
  Only use when absolutely necessary and well-documented. Prefer: validate! in service objects,
  explicit before_action hooks, or fixing the validation root cause.

---
id: ruby-quality-test-no-assertion
language: ruby
severity: error
message: "Quality: Test lacks assertion/expectation"
tags:
  - quality
  - testing
rule:
  kind: test
  pattern: "it '.*' do$|it \".*\" do$"
note: |
  Every test must assert something. Include expect(), assert(), or equivalent. Tests without
  assertions always pass, giving false confidence. Write: expect(subject.method).to eq(value).
  One assertion per test is ideal; multiple is acceptable if related.

---
id: ruby-quality-multiple-expectations
language: ruby
severity: info
message: "Quality: Multiple expectations per test; consider splitting or aggregate_failures"
tags:
  - quality
  - testing
rule:
  kind: test
  pattern: "expect\\(.*\\).*expect\\("
note: |
  Multiple expectations in one test can mask failures in early assertions. Consider splitting
  into focused specs or use aggregate_failures block. Trade-off: readability vs granularity.
  Group related expectations together.

---
id: ruby-quality-mystery-guest
language: ruby
severity: warning
message: "Quality: Test data source unclear; make setup explicit"
tags:
  - quality
  - testing
rule:
  kind: test
  pattern: "it '.*' do.*expect\\(.*\\)"
note: |
  Mystery Guest pattern uses implicit test data from setup/fixtures, making tests hard to understand.
  Make all setup explicit: let(:order) { create(:order) } or inside the test. Explicit setup
  makes test intent and data dependencies clear.

---
id: ruby-quality-testing-implementation
language: ruby
severity: warning
message: "Quality: Test verifies implementation details; test behavior instead"
tags:
  - quality
  - testing
rule:
  kind: test
  pattern: "expect\\(.*\\)\\.to\\s+receive\\(\\w*private|to receive\\(['\"]_"
note: |
  Testing private methods and mocking internal calls couples tests to implementation. Test
  public behavior: what the method returns, not how it does it. When implementation changes
  but behavior stays same, tests shouldn't break.

---
id: ruby-quality-slow-test
language: ruby
severity: warning
message: "Quality: Unit test hitting database; use mocks for speed"
tags:
  - quality
  - testing
rule:
  kind: test
  pattern: "def test|it '.*'.*Model\\.create|User\\.new"
note: |
  Unit tests should avoid database access (use mocks). Database tests are integration tests
  and should be separate. Mocked tests run in milliseconds; database tests take seconds.
  Follow test pyramid: many unit, some integration, few end-to-end tests.

---
id: ruby-quality-circular-dependency
language: ruby
severity: error
message: "Quality: Circular dependency between modules"
tags:
  - quality
  - module-design
rule:
  kind: require_statement
  pattern: "require 'other'|require_relative"
note: |
  Circular dependencies (A requires B, B requires A) cause loading issues and tight coupling.
  Redesign to break the cycle: extract shared code, use late binding, pass dependencies as
  parameters. Depend on abstractions, not concrete classes.

---
id: ruby-quality-missing-namespace
language: ruby
severity: info
message: "Quality: Use module namespace to organize code"
tags:
  - quality
  - module-design
rule:
  kind: class_definition
  pattern: "class \\w+\\s*<|class \\w+\\s*#"
note: |
  Organize related classes with module namespaces: module Services; class CreateUser; end.
  Prevents naming conflicts and clarifies relationships. Rails conventions: Services::, Models::,
  Helpers::. Clear namespaces improve code organization and discoverability.

---
id: ruby-quality-module-responsibilities
language: ruby
severity: warning
message: "Quality: Module has multiple unrelated responsibilities"
tags:
  - quality
  - module-design
rule:
  kind: module_definition
  pattern: "[method_count > 10]"
note: |
  Modules should have cohesive, related methods. A module with format_date, send_email, and
  calculate_tax has mixed responsibilities. Split into DateHelpers, MailHelpers, TaxCalculations.
  Each module should have single, clear purpose.

---
id: ruby-quality-missing-yard-tags
language: ruby
severity: info
message: "Quality: Method documentation lacks @param, @return tags"
tags:
  - quality
  - documentation
rule:
  kind: method_definition
  pattern: "#.*(?!@param|@return|@raise)"
note: |
  Complete YARD documentation includes: @param for parameters (with types), @return for return
  type, @raise for exceptions, @example for usage. Tools like RubyDoc depend on these tags.
  Good tags prevent API misuse and support IDE autocomplete.

---
id: ruby-quality-outdated-comments
language: ruby
severity: warning
message: "Quality: Comment doesn't match code behavior"
tags:
  - quality
  - documentation
rule:
  kind: comment
  pattern: "#.*[mismatch]"
note: |
  Outdated comments are worse than no comments. They mislead developers. Either update comments
  when code changes or remove them. Prefer code clarity over comments. Comments should explain
  WHY, not WHAT (code shows WHAT).

---
id: ruby-quality-todo-without-ticket
language: ruby
severity: info
message: "Quality: TODO/FIXME should reference issue tracker ticket"
tags:
  - quality
  - documentation
rule:
  kind: comment
  pattern: "#\\s*(TODO|FIXME|HACK)(?!\\()"
note: |
  Link TODO/FIXME/HACK to issue tracker: # TODO(JIRA-123): Fix logic. Unlinked TODOs get lost
  and forgotten. Linking enables tracking and accountability. Make it easy to find and prioritize
  technical debt.

---
id: ruby-quality-line-length
language: ruby
severity: info
message: "Quality: Line exceeds recommended length (limit: 120 chars)"
tags:
  - quality
  - formatting
rule:
  kind: line
  pattern: "[length > 120]"
note: |
  Long lines are hard to read and wrap awkwardly in editors. Break into multiple lines, especially
  for method calls with many arguments. Use line continuation with parentheses or break before
  method chains. Aim for 80-120 characters.

---
id: ruby-quality-blank-lines
language: ruby
severity: info
message: "Quality: Add blank lines between method definitions"
tags:
  - quality
  - formatting
rule:
  kind: method_definition
  pattern: "end\\s*def|end\\s*private|end\\s*protected"
note: |
  Blank lines separate logical sections and improve readability. Add blank line between method
  definitions, between access modifiers (private/protected), and between groups of related code.
  Visual separation helps readers parse code structure quickly.

---
id: ruby-quality-trailing-whitespace
language: ruby
severity: info
message: "Quality: Remove trailing whitespace"
tags:
  - quality
  - formatting
rule:
  kind: line
  pattern: "[\\s]$"
note: |
  Trailing whitespace wastes space, causes unnecessary diffs, and is generally considered bad
  practice. Configure editor to remove on save. Git can detect trailing whitespace with --check.
  Clean whitespace improves code quality metrics.

---
id: ruby-quality-indentation
language: ruby
severity: info
message: "Quality: Use consistent 2-space indentation"
tags:
  - quality
  - formatting
rule:
  kind: line
  pattern: "\\t|    "
note: |
  Ruby convention is 2 spaces per indent level. Avoid tabs and mixed spaces/tabs. Configure
  editor to use 2-space indentation. Consistent indentation is essential for readability and
  prevents syntax errors from unexpected indentation.

---
id: ruby-quality-weak-comparison
language: ruby
severity: warning
message: "Quality: String comparison for secrets is timing-attack vulnerable"
tags:
  - quality
  - security
rule:
  kind: comparison
  pattern: "==.*password|==.*token|==.*secret|==.*api_key"
note: |
  Use secure_compare for sensitive string comparisons (passwords, tokens). Plain == is vulnerable
  to timing attacks. Use: ActiveSupport::SecurityUtils.secure_compare(provided, expected).
  Timing attack analysis takes microseconds; even imperceptible to humans, exploitable by machines.

---
id: ruby-quality-mutable-class-default
language: ruby
severity: warning
message: "Quality: Mutable class variable is shared; use frozen or instance variables"
tags:
  - quality
  - security
rule:
  kind: class_variable
  pattern: "@@\\w+\\s*=\\s*\\[|@@\\w+\\s*=\\s*\\{|@@\\w+\\s*=.*\\.new"
note: |
  Mutable class variables (@@var = []) are shared across all instances, causing unexpected
  state sharing. Use: CONSTANT = [].freeze or instance variables @var. If shared state needed,
  use class instance variables or explicit synchronization.
---
id: scala-quality-class-not-pascalcase
language: scala
severity: warning
message: "Quality: Class names should be PascalCase (UpperCamelCase)"
tags:
  - quality
  - naming
rule:
  kind: ClassDefinition
  pattern: "class [a-z_][a-z0-9_]*"
note: |
  Class names should follow PascalCase convention per Scala Style Guide.
  Improper naming reduces code readability and violates conventions.

  Correct: class HttpClient, class MyClass, class XmlParser
  Incorrect: class myClass, class my_class, class MYCLASS

---
id: scala-quality-object-not-pascalcase
language: scala
severity: warning
message: "Quality: Object names should be PascalCase (UpperCamelCase)"
tags:
  - quality
  - naming
rule:
  kind: ObjectDefinition
  pattern: "object [a-z_][a-z0-9_]*"
note: |
  Object names should follow PascalCase convention like classes.

  Correct: object StringUtils, object MyObject
  Incorrect: object myObject, object my_object

---
id: scala-quality-method-not-camelcase
language: scala
severity: warning
message: "Quality: Method names should be lowerCamelCase"
tags:
  - quality
  - naming
rule:
  kind: MethodDefinition
  pattern: "def [A-Z][a-zA-Z0-9_]*"
note: |
  Method names should use lowerCamelCase convention.

  Correct: def processData(), def calculateTotal()
  Incorrect: def MyMethod(), def my_method(), def MYMETHOD()

---
id: scala-quality-variable-not-camelcase
language: scala
severity: warning
message: "Quality: Variables should be lowerCamelCase"
tags:
  - quality
  - naming
rule:
  kind: VariableDeclaration
  pattern: "(val|var) [A-Z_][a-zA-Z0-9_]*"
note: |
  Variable and value names should use lowerCamelCase convention.
  Exception: constants in companion objects can be PascalCase.

  Correct: val myValue = 1, var myVar = 1
  Incorrect: val MyValue = 1, val my_value = 1

---
id: scala-quality-type-parameter-too-long
language: scala
severity: warning
message: "Quality: Type parameters should be single letters or short names"
tags:
  - quality
  - naming
  - generics
rule:
  kind: TypeParameter
  pattern: "[A-Z][a-z]+"
note: |
  Type parameters should use single uppercase letters or very short names.
  Standard conventions: T (Type), A (any), K (Key), V (Value), I (Input), O (Output).

  Correct: class Container[A], def process[I, O]
  Incorrect: class Container[Element], def process[InputType, OutputType]

---
id: scala-quality-package-not-lowercase
language: scala
severity: warning
message: "Quality: Package names should be all lowercase"
tags:
  - quality
  - naming
rule:
  kind: PackageDeclaration
  pattern: "package [A-Z_]"
note: |
  Package names should be all lowercase following Java conventions.

  Correct: package mypackage, package com.example.mypackage
  Incorrect: package myPackage, package My.Package, package MY_PACKAGE

---
id: scala-quality-underscore-in-name
language: scala
severity: warning
message: "Quality: Avoid underscores in names (except test methods)"
tags:
  - quality
  - naming
rule:
  kind: Identifier
  pattern: "[a-zA-Z0-9]*_[a-zA-Z0-9]*"
note: |
  Underscores are discouraged in Scala naming except for test method names.
  Use camelCase instead.

  Correct: val myValue = 1, def processData()
  Incorrect: val my_value = 1, def process_data()

---
id: scala-quality-boolean-method-without-prefix
language: scala
severity: warning
message: "Quality: Boolean methods should use is/has/can/should verb prefixes"
tags:
  - quality
  - naming
rule:
  kind: MethodDefinition
  pattern: "def [a-z]+: Boolean"
note: |
  Boolean-returning methods should use verb prefixes for clarity.
  Common prefixes: is, has, can, should, must.

  Correct: def isEmpty, def isValid, def hasElements, def canProcess
  Incorrect: def empty, def valid, def active

---
id: scala-quality-wart-any-usage
language: scala
severity: error
message: "Quality: Avoid using Any type - defeats type safety"
tags:
  - quality
  - wartremover
  - type-safety
rule:
  kind: TypeUsage
  pattern: ": Any[^a-zA-Z]"
note: |
  Using Any defeats Scala's type system benefits.
  Prefer specific types or use generics with type bounds.

  Correct: def process[A](input: A): Result[A]
  Incorrect: def process(input: Any): Any

---
id: scala-quality-wart-asinstanceof
language: scala
severity: error
message: "Quality: Avoid unsafe casts with asInstanceOf - use pattern matching"
tags:
  - quality
  - wartremover
  - type-safety
rule:
  kind: MethodCall
  pattern: "asInstanceOf\\["
note: |
  asInstanceOf can throw ClassCastException at runtime.
  Use pattern matching for safer type narrowing.

  Correct: obj match { case t: TargetType => t }
  Incorrect: obj.asInstanceOf[TargetType]

---
id: scala-quality-wart-isinstance
language: scala
severity: warning
message: "Quality: Replace isInstanceOf checks with pattern matching"
tags:
  - quality
  - wartremover
rule:
  kind: MethodCall
  pattern: "isInstanceOf\\["
note: |
  Pattern matching is more idiomatic and safer than isInstanceOf checks.

  Correct: obj match { case typed: Type => }
  Incorrect: if (obj.isInstanceOf[Type]) { val typed = obj.asInstanceOf[Type] }

---
id: scala-quality-wart-null
language: scala
severity: error
message: "Quality: Avoid null - use Option instead"
tags:
  - quality
  - wartremover
  - null-safety
rule:
  kind: NullLiteral
  pattern: "\\bnull\\b"
note: |
  null can cause NullPointerException. Use Option/Some/None pattern instead.

  Correct: val x: Option[String] = None
  Incorrect: val x: String = null

---
id: scala-quality-wart-return
language: scala
severity: error
message: "Quality: Avoid return statement - use if/else expressions"
tags:
  - quality
  - wartremover
rule:
  kind: ReturnStatement
  pattern: "\\breturn\\b"
note: |
  Early returns can behave unexpectedly in closures.
  Use if/else expressions instead for more functional style.

  Correct: if (condition) 0 else { /* code */ 1 }
  Incorrect: if (condition) return 0

---
id: scala-quality-wart-throw
language: scala
severity: warning
message: "Quality: Prefer Either or Try for error handling over throw"
tags:
  - quality
  - wartremover
  - error-handling
rule:
  kind: ThrowStatement
  pattern: "\\bthrow\\s"
note: |
  Throwing exceptions is side-effectful. Prefer Either or Try for functional error handling.

  Correct: Either[Error, Result] with Left/Right
  Incorrect: throw new RuntimeException("error")

---
id: scala-quality-wart-var
language: scala
severity: error
message: "Quality: Avoid mutable variables - use immutable values"
tags:
  - quality
  - wartremover
  - mutability
rule:
  kind: VariableDeclaration
  pattern: "\\bvar\\s"
note: |
  Mutable variables make code harder to reason about and test.
  Use immutable values with foldLeft, recursion, or functional operations.

  Correct: val result = items.foldLeft(0)(_ + _)
  Incorrect: var counter = 0; counter += 1

---
id: scala-quality-wart-while
language: scala
severity: warning
message: "Quality: Avoid while loops - use recursion or Iterator"
tags:
  - quality
  - wartremover
  - loops
rule:
  kind: WhileLoop
  pattern: "\\bwhile\\s*\\("
note: |
  While loops require mutable state. Use @tailrec recursion or Iterator.

  Correct: @tailrec def loop(state: State): Result = ...
  Incorrect: while (condition) { ... }

---
id: scala-quality-wart-mutable-datastructures
language: scala
severity: error
message: "Quality: Avoid mutable collections - use immutable equivalents"
tags:
  - quality
  - wartremover
  - mutability
rule:
  kind: Import
  pattern: "scala\\.collection\\.mutable"
note: |
  Mutable collections make code harder to reason about and parallelize.
  Use immutable collections and foldLeft for building results.

  Correct: val list = List.empty[Int]
  Incorrect: val list = mutable.ListBuffer[Int]()

---
id: scala-quality-wart-default-arguments
language: scala
severity: warning
message: "Quality: Default arguments can cause confusion with overloading"
tags:
  - quality
  - wartremover
rule:
  kind: MethodDefinition
  pattern: "def [a-zA-Z_][a-zA-Z0-9_]*\\([^)]*=[^)]*\\)"
note: |
  Default arguments can interact confusingly with overloading.
  Use method overloading or configuration objects instead.

  Correct: def process(input: String, debug: Boolean): Result
  Incorrect: def process(input: String, debug: Boolean = false)

---
id: scala-quality-wart-implicit-conversion
language: scala
severity: error
message: "Quality: Implicit conversions hide behavior - use extension methods instead"
tags:
  - quality
  - wartremover
  - implicits
rule:
  kind: ImplicitConversion
  pattern: "implicit def .*: .* ="
note: |
  Implicit conversions can cause unexpected behavior and hide bugs.
  Use extension methods (implicit class) or Scala 3 extension methods.

  Correct: implicit class StringOps(s: String) { def toIntSafe: Option[Int] }
  Incorrect: implicit def stringToInt(s: String): Int = s.toInt

---
id: scala-quality-wart-string-plus-any
language: scala
severity: warning
message: "Quality: Avoid string concatenation with Any - use string interpolation"
tags:
  - quality
  - wartremover
  - strings
rule:
  kind: BinaryOp
  pattern: '"[^"]*" \\+ '
note: |
  Concatenating strings with Any relies on toString() which may not be meaningful.
  Use string interpolation (s"...") with meaningful values.

  Correct: s"Value: ${someObject.meaningfulString}"
  Incorrect: "Value: " + someObject

---
id: scala-quality-wart-either-projection-partial
language: scala
severity: error
message: "Quality: Avoid Either projection get - use pattern matching or fold"
tags:
  - quality
  - wartremover
  - error-handling
rule:
  kind: MethodCall
  pattern: "\\.(left|right)\\.get"
note: |
  Either projections' get() throws on wrong side. Use pattern matching or fold.

  Correct: either.fold(handleLeft, handleRight)
  Incorrect: either.right.get

---
id: scala-quality-wart-option-partial
language: scala
severity: error
message: "Quality: Option.get throws on None - use safe methods"
tags:
  - quality
  - wartremover
  - null-safety
rule:
  kind: MethodCall
  pattern: "\\.get\\b"
note: |
  Option.get() throws NoSuchElementException on None.
  Use getOrElse, fold, or pattern matching instead.

  Correct: option.getOrElse(default), option match { case Some(v) => v }
  Incorrect: option.get

---
id: scala-quality-wart-try-partial
language: scala
severity: error
message: "Quality: Try.get rethrows exception - use fold or pattern matching"
tags:
  - quality
  - wartremover
  - error-handling
rule:
  kind: MethodCall
  pattern: "tryResult\\.get"
note: |
  Try.get() rethrows the exception on Failure.
  Use fold(), getOrElse(), or pattern matching.

  Correct: tryResult.fold(handleFailure, handleSuccess)
  Incorrect: tryResult.get

---
id: scala-quality-wart-traversable-ops
language: scala
severity: error
message: "Quality: List/collection head/tail/last throw on empty - use Options"
tags:
  - quality
  - wartremover
  - collections
rule:
  kind: MethodCall
  pattern: "\\.(head|tail|last|init|reduce)\\b"
note: |
  head, tail, last, init, reduce throw exceptions on empty collections.
  Use headOption, lastOption, reduceOption, or pattern matching.

  Correct: list.headOption, list.reduceOption(f)
  Incorrect: list.head, list.reduce(f)

---
id: scala-quality-wart-equals
language: scala
severity: warning
message: "Quality: Use type-safe equality (===) instead of == for compile-time checks"
tags:
  - quality
  - wartremover
rule:
  kind: BinaryOp
  pattern: " == "
note: |
  Universal equality (==) can compare unrelated types without warning.
  Use type-safe equality from Cats/Scalaz for compile-time type checking.

  Correct: import cats.syntax.eq._; x === y
  Incorrect: x == y

---
id: scala-quality-wart-serializable
language: scala
severity: warning
message: "Quality: Java serialization has security issues - use explicit serialization"
tags:
  - quality
  - wartremover
  - security
rule:
  kind: ExtendsClauses
  pattern: "extends Serializable"
note: |
  Java serialization is unsafe. Use explicit serialization formats like JSON or Protobuf.

  Correct: case class MyClass(field: String) derives Encoder, Decoder
  Incorrect: class MyClass extends Serializable

---
id: scala-quality-wart-product
language: scala
severity: warning
message: "Quality: Product type is too general - use sealed trait hierarchy"
tags:
  - quality
  - wartremover
rule:
  kind: TypeUsage
  pattern: ": Product[^a-zA-Z]"
note: |
  Using Product as a type is too general. Define proper sealed traits.

  Correct: sealed trait MyUnion; case class Option1 extends MyUnion
  Incorrect: def process(p: Product): Unit

---
id: scala-quality-line-too-long
language: scala
severity: warning
message: "Quality: Line exceeds 120 characters - break into multiple lines"
tags:
  - quality
  - formatting
rule:
  kind: Line
  pattern: ".{121,}"
note: |
  Lines over 120 characters are difficult to read and display.
  Break long lines at logical points like function parameters.

---
id: scala-quality-missing-braces-if
language: scala
severity: warning
message: "Quality: Use braces in if statements to prevent bugs"
tags:
  - quality
  - formatting
rule:
  kind: IfExpression
  pattern: "if\\s*\\([^)]+\\)\\s*[^{]"
note: |
  Missing braces can lead to subtle bugs when adding statements later.
  Always use braces for if/else blocks.

  Correct: if (condition) { doSomething() }
  Incorrect: if (condition) doSomething()

---
id: scala-quality-magic-number
language: scala
severity: warning
message: "Quality: Use named constants instead of magic numbers"
tags:
  - quality
  - maintainability
rule:
  kind: Literal
  pattern: "\\b\\d{2,}\\b"
note: |
  Magic numbers reduce code readability and maintainability.
  Extract to named constants.

  Correct: val MaxRetries = 3; if (count > MaxRetries)
  Incorrect: if (count > 42)

---
id: scala-quality-multiple-string-literals
language: scala
severity: warning
message: "Quality: Extract duplicated string literals to constants"
tags:
  - quality
  - maintainability
rule:
  kind: StringLiteral
  pattern: '"[^"]{10,}"'
note: |
  Duplicated strings should be extracted to named constants for maintainability.

  Correct: val ProcessingMsg = "Processing"; log.info(ProcessingMsg)
  Incorrect: log.info("Processing"); log.debug("Processing")

---
id: scala-quality-public-method-without-return-type
language: scala
severity: error
message: "Quality: Public methods must have explicit return types"
tags:
  - quality
  - documentation
rule:
  kind: MethodDefinition
  pattern: "def [a-z][a-zA-Z0-9_]*\\([^)]*\\) ="
note: |
  Public methods need explicit return types for API documentation and binary compatibility.

  Correct: def publicMethod(x: Int): Int = x + 1
  Incorrect: def publicMethod(x: Int) = x + 1

---
id: scala-quality-structural-type-usage
language: scala
severity: error
message: "Quality: Structural types use reflection - use traits instead"
tags:
  - quality
  - performance
rule:
  kind: TypeUsage
  pattern: ": \\{ def .* \\}"
note: |
  Structural types use reflection which is slow and fragile.
  Define proper traits for the behavior instead.

  Correct: trait Closeable { def close(): Unit }
  Incorrect: def process(obj: { def close(): Unit })

---
id: scala-quality-procedure-declaration
language: scala
severity: warning
message: "Quality: Procedure syntax is deprecated - use explicit Unit return type"
tags:
  - quality
  - scala3-migration
rule:
  kind: MethodDefinition
  pattern: "def [a-zA-Z_][a-zA-Z0-9_]*\\([^)]*\\) \\{"
note: |
  Procedure syntax (omitting = and return type) is deprecated in Scala 3.
  Use explicit Unit return type.

  Correct: def sideEffect(): Unit = { ... }
  Incorrect: def sideEffect() { ... }

---
id: scala-quality-empty-class-body
language: scala
severity: warning
message: "Quality: Remove empty braces from class definitions"
tags:
  - quality
  - formatting
rule:
  kind: ClassDefinition
  pattern: "\\{\\s*\\}"
note: |
  Empty braces are unnecessary and clutter code.

  Correct: class Empty; trait EmptyTrait
  Incorrect: class Empty {}; trait EmptyTrait {}

---
id: scala-quality-redundant-if
language: scala
severity: warning
message: "Quality: Simplify redundant if-else boolean expressions"
tags:
  - quality
  - simplification
rule:
  kind: IfExpression
  pattern: "if\\s*\\([^)]+\\)\\s*true\\s*else\\s*false"
note: |
  Redundant if-else expressions can be simplified to just the condition.

  Correct: condition; !condition
  Incorrect: if (condition) true else false

---
id: scala-quality-simplify-boolean-expression
language: scala
severity: warning
message: "Quality: Simplify boolean expressions"
tags:
  - quality
  - simplification
rule:
  kind: BinaryOp
  pattern: "(==\\s*true|!=\\s*true|==\\s*false)"
note: |
  Boolean comparisons can be simplified.

  Correct: condition; !condition
  Incorrect: condition == true; condition == false

---
id: scala-quality-remove-unused-import
language: scala
severity: info
message: "Quality: Remove unused imports to reduce compilation time"
tags:
  - quality
  - cleanup
rule:
  kind: Import
  pattern: "import .*"
note: |
  Unused imports clutter code and slow compilation.
  Remove with Scalafix or IDE tools.

---
id: scala-quality-no-auto-tupling
language: scala
severity: warning
message: "Quality: Explicit tuples - avoid auto-tupling"
tags:
  - quality
  - clarity
rule:
  kind: MethodCall
  pattern: "takeTuple\\(\\d+,\\s*\".*\"\\)"
note: |
  Auto-tupling hides intention. Always pass tuples explicitly.

  Correct: takeTuple((1, "a"))
  Incorrect: takeTuple(1, "a")

---
id: scala-quality-explicit-result-types
language: scala
severity: warning
message: "Quality: Public methods should have explicit result types"
tags:
  - quality
  - documentation
rule:
  kind: MethodDefinition
  pattern: "def [a-z][a-zA-Z0-9_]*[^:]* ="
note: |
  Public method and value definitions should have explicit types.

  Correct: def infer: Int = 42; implicit val x: String = "value"
  Incorrect: def infer = 42; implicit val x = "value"

---
id: scala-quality-leaking-implicit-class-val
language: scala
severity: error
message: "Quality: Mark implicit class constructor param as private"
tags:
  - quality
  - implicits
rule:
  kind: ImplicitClass
  pattern: "implicit class .*\\(val [a-z]"
note: |
  Implicit class public val leaks into enriched type's API.
  Mark it private or use AnyVal.

  Correct: implicit class RichString(private val s: String) extends AnyVal
  Incorrect: implicit class RichString(val s: String)

---
id: scala-quality-disable-syntax-null
language: scala
severity: error
message: "Quality: Null is forbidden - use Option instead"
tags:
  - quality
  - null-safety
rule:
  kind: NullLiteral
  pattern: "\\bnull\\b|== null|!= null"
note: |
  null usage is unsafe. Use Option/Some/None pattern exclusively.

  Correct: val x: Option[String] = None
  Incorrect: val x = null; if (y == null)

---
id: scala-quality-imperative-loop
language: scala
severity: warning
message: "Quality: Use functional operations instead of imperative loops"
tags:
  - quality
  - functional-style
rule:
  kind: ForExpression
  pattern: "var .*; for.*\\{.*= .* \\+:"
note: |
  Imperative loops with mutation are error-prone.
  Use map, filter, or List.tabulate.

  Correct: val result = (0 until 10).map(_ * 2).toList
  Incorrect: var result = List.empty; for (i <- 0 until 10) result = result :+ (i * 2)

---
id: scala-quality-nested-flatmap
language: scala
severity: warning
message: "Quality: Use for-comprehension for nested flatMap"
tags:
  - quality
  - readability
rule:
  kind: MethodCall
  pattern: "flatMap.*flatMap.*map"
note: |
  Deeply nested flatMap is hard to read. Use for-comprehensions instead.

  Correct: for { a <- opt1; b <- opt2; c <- opt3 } yield combine(a, b, c)
  Incorrect: opt1.flatMap(a => opt2.flatMap(b => opt3.map(c => combine(a, b, c))))

---
id: scala-quality-side-effect-in-map
language: scala
severity: error
message: "Quality: map should be pure - use foreach or separate concerns"
tags:
  - quality
  - functional-style
rule:
  kind: MethodCall
  pattern: "map\\s*\\{[^}]*println|map\\s*\\{[^}]*println"
note: |
  map() should be pure transformation. Use foreach() for side effects.
  Separate concerns for better clarity.

  Correct: list.foreach(println); list.map(_ * 2)
  Incorrect: list.map { x => println(x); x * 2 }

---
id: scala-quality-partial-function-not-exhaustive
language: scala
severity: error
message: "Quality: Partial function in map throws - add case to handle all inputs"
tags:
  - quality
  - pattern-matching
rule:
  kind: MethodCall
  pattern: "map\\s*\\{\\s*case"
note: |
  Non-exhaustive patterns in map throw MatchError. Handle all cases or use collect.

  Correct: list.map { case x if x > 0 => x; case x => x }
  Incorrect: list.map { case x if x > 0 => x }

---
id: scala-quality-mutable-accumulation
language: scala
severity: warning
message: "Quality: Use foldLeft instead of mutable accumulation"
tags:
  - quality
  - functional-style
rule:
  kind: VariableDeclaration
  pattern: "var .* = 0.*for.*\\+="
note: |
  Mutable accumulation is error-prone. Use functional foldLeft or fold.

  Correct: val sum = list.foldLeft(0)(_ + _)
  Incorrect: var sum = 0; for (x <- list) sum += x

---
id: scala-quality-function-side-effect-without-unit
language: scala
severity: warning
message: "Quality: Side-effecting functions should return Unit"
tags:
  - quality
  - type-correctness
rule:
  kind: MethodDefinition
  pattern: "def [a-z].*\\{[^}]*println[^}]*\\} ="
note: |
  Functions with side effects should explicitly return Unit.
  This signals that the function is impure.

  Correct: def log(msg: String): Unit = { println(msg) }
  Incorrect: def log(msg: String) = { println(msg); msg }

---
id: scala-quality-throwing-exception-in-pure
language: scala
severity: error
message: "Quality: Use Either or Option for errors instead of throw"
tags:
  - quality
  - error-handling
  - functional-style
rule:
  kind: ThrowStatement
  pattern: "\\bthrow\\s"
note: |
  Exceptions are side effects. Use Either/Option/Try for functional error handling.

  Correct: def divide(a: Int, b: Int): Either[String, Int]
  Incorrect: def divide(a: Int, b: Int): Int = if (b == 0) throw ArithmeticException()

---
id: scala-quality-catching-throwable
language: scala
severity: error
message: "Quality: Catch specific exceptions or use NonFatal, never raw Throwable"
tags:
  - quality
  - error-handling
rule:
  kind: CatchClause
  pattern: "catch.*Throwable"
note: |
  Catching Throwable catches fatal errors like OutOfMemoryError.
  Use NonFatal pattern or catch specific exceptions.

  Correct: case NonFatal(e) => handleError(e)
  Incorrect: case _: Throwable => handleError()

---
id: scala-quality-empty-catch-block
language: scala
severity: error
message: "Quality: Never swallow exceptions silently - always handle or log"
tags:
  - quality
  - error-handling
rule:
  kind: CatchClause
  pattern: "case.*=> \\s*(//)?"
note: |
  Swallowed exceptions hide bugs and make debugging difficult.
  Always log or handle appropriately.

  Correct: case e: Exception => logger.error("Failed", e); throw e
  Incorrect: case _: Exception => // swallowed

---
id: scala-quality-try-without-recovery
language: scala
severity: warning
message: "Quality: Try results should be handled with recover or pattern match"
tags:
  - quality
  - error-handling
rule:
  kind: MethodCall
  pattern: "Try\\("
note: |
  Try should be recovered or pattern matched to handle failures.

  Correct: Try(op).recover { case e => defaultValue }
  Incorrect: val result = Try(riskyOperation()) // never used

---
id: scala-quality-null-for-error
language: scala
severity: error
message: "Quality: Use Option for absent values, never null"
tags:
  - quality
  - null-safety
rule:
  kind: ReturnStatement
  pattern: "return null|else null"
note: |
  null for absent values is error-prone and breaks type safety.
  Use Option instead.

  Correct: def find(id: Long): Option[User]
  Incorrect: def find(id: Long): User = if (exists(id)) load(id) else null

---
id: scala-quality-implicit-parameter-without-type
language: scala
severity: error
message: "Quality: Implicit parameters must have explicit types"
tags:
  - quality
  - implicits
rule:
  kind: ImplicitParameter
  pattern: "implicit [a-z]"
note: |
  Implicit parameters require explicit type annotations for clarity.

  Correct: def process(implicit ctx: ExecutionContext): Future[Result]
  Incorrect: def process(implicit ctx): Result

---
id: scala-quality-implicit-in-package-object
language: scala
severity: warning
message: "Quality: Package object implicits have broad scope - use companion object"
tags:
  - quality
  - implicits
  - scope
rule:
  kind: PackageObject
  pattern: "implicit val|implicit def"
note: |
  Package object implicits affect entire package. Prefer companion objects.

  Correct: object MyService { implicit val defaultTimeout = ... }
  Incorrect: package object mypackage { implicit val defaultTimeout = ... }

---
id: scala-quality-non-implicit-extension-class
language: scala
severity: warning
message: "Quality: Extension methods require implicit class keyword"
tags:
  - quality
  - implicits
rule:
  kind: ClassDefinition
  pattern: "^(?!implicit) class .*\\(.*\\) \\{.*def"
note: |
  Extension methods must use implicit class to work as syntax enrichment.

  Correct: implicit class RichString(val s: String) extends AnyVal { ... }
  Incorrect: class RichString(s: String) { ... }

---
id: scala-quality-implicit-conversion-null-safety
language: scala
severity: error
message: "Quality: Never use implicit conversions to hide null issues"
tags:
  - quality
  - implicits
  - null-safety
rule:
  kind: ImplicitConversion
  pattern: "implicit def .* Option\\["
note: |
  Implicit conversions that mask null are dangerous and hide real issues.
  Use explicit Option wrapping.

  Correct: val opt = Option(possiblyNull)
  Incorrect: implicit def anyToOption[A](a: A): Option[A] = Option(a)

---
id: scala-quality-ad-hoc-type-class
language: scala
severity: warning
message: "Quality: Use proper type class pattern instead of ad-hoc instances"
tags:
  - quality
  - type-classes
rule:
  kind: ImplicitParameter
  pattern: "implicit .*=> "
note: |
  Ad-hoc type patterns lack coherence. Use proper type class design.

  Correct: trait Show[A]; def process[A: Show](a: A)
  Incorrect: def process[A](a: A)(implicit show: A => String)

---
id: scala-quality-missing-type-class-coherence
language: scala
severity: error
message: "Quality: Type classes must have unique instances - no duplicates"
tags:
  - quality
  - type-classes
rule:
  kind: ImplicitValue
  pattern: "implicit val [a-z]+: [^=]+ = "
note: |
  Multiple type class instances for the same type break coherence.
  Define single canonical instance in companion object.

  Correct: object Show { implicit val showInt: Show[Int] = _.toString }
  Incorrect: implicit val show1: Show[Int] = ...; implicit val show2: Show[Int] = ...

---
id: scala-quality-case-class-mutable-field
language: scala
severity: error
message: "Quality: Case class fields must be immutable"
tags:
  - quality
  - case-classes
  - mutability
rule:
  kind: CaseClass
  pattern: "var [a-z]"
note: |
  Case classes should be immutable. Use copy() method for modifications.

  Correct: case class User(name: String, age: Int) { def withAge(n: Int) = copy(age = n) }
  Incorrect: case class User(name: String, var age: Int)

---
id: scala-quality-case-class-inheritance
language: scala
severity: error
message: "Quality: Case classes should not inherit - use sealed trait + cases"
tags:
  - quality
  - case-classes
rule:
  kind: Inheritance
  pattern: "case class .* extends .*"
note: |
  Case class inheritance breaks equality contract.
  Use sealed trait hierarchy instead.

  Correct: sealed trait Base; case class V1(x: Int) extends Base
  Incorrect: case class Base(x: Int); case class Derived(x: Int, y: Int) extends Base

---
id: scala-quality-case-class-too-many-fields
language: scala
severity: warning
message: "Quality: Case classes with many fields should group data"
tags:
  - quality
  - case-classes
  - design
rule:
  kind: CaseClass
  pattern: "case class .* \\([^)]{200,}\\)"
note: |
  Case classes with many fields are hard to use. Group related fields.

  Correct: case class Address(...); case class Person(..., address: Address)
  Incorrect: case class BigClass(a, b, c, d, e, f, g, h, ...)

---
id: scala-quality-case-class-without-companion
language: scala
severity: warning
message: "Quality: Case classes benefit from companion objects with smart constructors"
tags:
  - quality
  - case-classes
  - design
rule:
  kind: CaseClass
  pattern: "case class [A-Z][a-zA-Z0-9]*.*\\n(?!object)"
note: |
  Case classes often need smart constructors for validation.

  Correct: case class Email private (...); object Email { def apply(...): Option[Email] }
  Incorrect: case class Data(value: Int) // no validation

---
id: scala-quality-cyclomatic-complexity
language: scala
severity: warning
message: "Quality: High cyclomatic complexity - refactor into smaller functions"
tags:
  - quality
  - complexity
rule:
  kind: MethodDefinition
  pattern: "def [a-z].* = \\{.*if.*if.*if.*if"
note: |
  High cyclomatic complexity makes code hard to test and maintain.
  Extract helper functions to reduce complexity.

---
id: scala-quality-method-too-long
language: scala
severity: warning
message: "Quality: Long methods are hard to understand - extract into smaller steps"
tags:
  - quality
  - complexity
  - maintainability
rule:
  kind: MethodDefinition
  pattern: "def [a-z].* = \\{(.|\\n){1000,}\\}"
note: |
  Methods over 50 lines are difficult to understand, test, and maintain.
  Extract into smaller helper methods.

---
id: scala-quality-deep-nesting
language: scala
severity: warning
message: "Quality: Reduce nesting depth - use guards or for-comprehensions"
tags:
  - quality
  - complexity
rule:
  kind: NestedBlock
  pattern: "\\{.*\\{.*\\{.*\\{.*\\{"
note: |
  Deep nesting reduces readability. Use early returns, guards, or for-comprehensions.

  Correct: for { a <- guard(a); b <- guard(b) } yield result
  Incorrect: if (a) { if (b) { if (c) { ... } } }

---
id: scala-quality-too-many-parameters
language: scala
severity: warning
message: "Quality: Functions with many parameters - use case class for grouping"
tags:
  - quality
  - design
rule:
  kind: MethodDefinition
  pattern: "def [a-z].*\\([^)]*:[^)]*:[^)]*:[^)]*:[^)]*:[^)]*:[^)]*:"
note: |
  Functions with many parameters are hard to call correctly.
  Use parameter object (case class) pattern.

  Correct: case class Config(...); def process(config: Config)
  Incorrect: def process(a, b, c, d, e, f, g)

---
id: scala-quality-public-method-without-scaladoc
language: scala
severity: warning
message: "Quality: Public methods should have Scaladoc documentation"
tags:
  - quality
  - documentation
rule:
  kind: MethodDefinition
  pattern: "^(?!\\s*/**) def [a-z]"
note: |
  Public API should be documented with Scaladoc for users.
  Include @param, @return, @throws as appropriate.

---
id: scala-quality-missing-throws-annotation
language: scala
severity: info
message: "Quality: Methods throwing exceptions should use @throws annotation"
tags:
  - quality
  - documentation
rule:
  kind: MethodDefinition
  pattern: "def .*throw new"
note: |
  Methods that throw should document exceptions with @throws.

  Correct: @throws[IOException] def riskyOp()
  Incorrect: def riskyOp() { throw new IOException() }

---
id: scala-quality-scaladoc-without-param-tags
language: scala
severity: info
message: "Quality: Scaladoc should document all parameters with @param"
tags:
  - quality
  - documentation
rule:
  kind: ScaladocComment
  pattern: "/**.*\\*/"
note: |
  Scaladoc blocks should include @param tags for each parameter.
  Also include @return and @throws as needed.

---
id: scala-quality-test-without-assertion
language: scala
severity: error
message: "Quality: Tests must have assertions to verify behavior"
tags:
  - quality
  - testing
rule:
  kind: TestFunction
  pattern: "test\\([^)]*\\) \\{[^}]*\\}"
note: |
  Tests without assertions don't verify anything.
  Include assertions or ScalaTest matchers.

  Correct: test("...") { result shouldBe expected }
  Incorrect: test("...") { val result = ... }

---
id: scala-quality-ignored-test
language: scala
severity: error
message: "Quality: Fix or remove ignored tests - they hide broken code"
tags:
  - quality
  - testing
rule:
  kind: TestFunction
  pattern: "ignore\\(|@Ignore|ignore \\{"
note: |
  Ignored tests should be fixed or removed.
  They hide broken code and create technical debt.

---
id: scala-quality-test-with-side-effects
language: scala
severity: error
message: "Quality: Tests must be independent - avoid shared mutable state"
tags:
  - quality
  - testing
rule:
  kind: TestClass
  pattern: "var .*\ntest.*test"
note: |
  Tests should not depend on shared state or execution order.
  Create fresh state in each test.

---
id: scala-quality-thread-sleep-in-test
language: scala
severity: error
message: "Quality: Never use Thread.sleep - use Await or eventually"
tags:
  - quality
  - testing
  - async
rule:
  kind: MethodCall
  pattern: "Thread\\.sleep"
note: |
  Thread.sleep makes tests slow and flaky.
  Use Await.result for futures or eventually {} for polling.

  Correct: Await.result(future, 5.seconds); eventually { assert(...) }
  Incorrect: Thread.sleep(1000); assert(...)

---
id: scala-quality-hardcoded-test-data
language: scala
severity: warning
message: "Quality: Use property-based testing or fixtures instead of hardcoded data"
tags:
  - quality
  - testing
rule:
  kind: TestFunction
  pattern: "test\\([^)]*\\) \\{.*= [\"']"
note: |
  Hardcoded test values can hide edge cases.
  Use property-based testing (ScalaCheck) or fixtures.

  Correct: forAll { (a: A, b: B) => ... }
  Incorrect: test("...") { val x = "fixed_value" }

---
id: scala-quality-deprecated-procedure-syntax
language: scala
severity: error
message: "Quality: Procedure syntax removed in Scala 3 - use explicit Unit return"
tags:
  - quality
  - scala3-migration
rule:
  kind: MethodDefinition
  pattern: "def [a-zA-Z_][a-zA-Z0-9_]*\\([^)]*\\) \\{"
note: |
  Procedure syntax (def f() {...}) is deprecated in Scala 3.
  Use explicit return type.

  Correct: def procedure(): Unit = { ... }
  Incorrect: def procedure() { ... }

---
id: scala-quality-do-while-loop
language: scala
severity: warning
message: "Quality: do-while is deprecated - restructure with while"
tags:
  - quality
  - scala3-migration
rule:
  kind: DoWhileLoop
  pattern: "do \\{.*\\} while"
note: |
  do-while loops are deprecated in Scala 3.
  Use while loop with initial action.

  Correct: action(); while (condition) { action() }
  Incorrect: do { action() } while (condition)

---
id: scala-quality-symbol-literal
language: scala
severity: warning
message: "Quality: Symbol literals removed in Scala 3 - use Symbol() or String"
tags:
  - quality
  - scala3-migration
rule:
  kind: SymbolLiteral
  pattern: "'[a-zA-Z_]"
note: |
  Symbol literals ('symbol) are removed in Scala 3.
  Use Symbol("name") or String directly.

  Correct: Symbol("name") or "name"
  Incorrect: val sym = 'symbolName

---
id: scala-quality-implicit-def-conversion-scala3
language: scala
severity: error
message: "Quality: Use given/Conversion in Scala 3 instead of implicit def"
tags:
  - quality
  - scala3-migration
  - implicits
rule:
  kind: ImplicitConversion
  pattern: "implicit def .* .* ="
note: |
  Implicit def conversions need given/Conversion syntax in Scala 3.
  Use extension methods instead.

  Correct: given Conversion[Int, String] = _.toString
  Incorrect: implicit def intToString(i: Int): String = i.toString

---
id: scala-quality-package-object
language: scala
severity: warning
message: "Quality: Package objects being replaced by top-level definitions in Scala 3"
tags:
  - quality
  - scala3-migration
rule:
  kind: PackageObject
  pattern: "package object"
note: |
  Package objects are being replaced by top-level definitions in Scala 3.
  Move contents to regular files at package level.

  Correct: // mypackage.scala; package mypackage; val x = ...
  Incorrect: package object mypackage { val x = ... }
---
id: docker-quality-missing-labels
language: dockerfile
severity: warning
message: "Quality: Dockerfile should include LABEL instructions for metadata"
tags:
  - quality
  - docker
  - documentation
rule:
  kind: instruction
  pattern: "Missing LABEL instruction"
note: |
  Labels provide metadata for image management, traceability, and automation.
  Use standard OCI labels like:
  - maintainer
  - org.opencontainers.image.title
  - org.opencontainers.image.version
  - org.opencontainers.image.description
  - org.opencontainers.image.source
  Ref: Hadolint DL3049, OCI Image Spec

---
id: docker-quality-missing-workdir
language: dockerfile
severity: warning
message: "Quality: Dockerfile should use explicit WORKDIR instruction"
tags:
  - quality
  - docker
  - structure
rule:
  kind: instruction
  pattern: "COPY without WORKDIR"
note: |
  WORKDIR establishes consistent working directory and improves readability.
  It also prevents hardcoding paths in COPY and RUN instructions.
  Ref: Hadolint DL3000

---
id: docker-quality-cd-usage
language: dockerfile
severity: warning
message: "Quality: Use WORKDIR instead of 'cd' in RUN instructions"
tags:
  - quality
  - docker
  - structure
rule:
  kind: instruction
  pattern: "RUN.*cd\\s+"
note: |
  Using 'cd' in RUN only affects that single instruction.
  WORKDIR persists across all subsequent instructions.
  Better approach: set WORKDIR once, then use relative paths.
  Ref: Hadolint DL3003

---
id: docker-quality-apt-no-y-flag
language: dockerfile
severity: error
message: "Quality: apt-get install requires -y flag in non-interactive builds"
tags:
  - quality
  - docker
  - build
rule:
  kind: instruction
  pattern: "RUN\\s+apt-get\\s+install\\s+(?!.*-y)"
note: |
  Without -y, apt-get prompts for confirmation, which fails in Docker builds.
  Always use: apt-get install -y package_name
  Ref: Hadolint DL3014

---
id: docker-quality-apt-no-update
language: dockerfile
severity: error
message: "Quality: apt-get install should follow apt-get update"
tags:
  - quality
  - docker
  - package-management
rule:
  kind: instruction
  pattern: "RUN\\s+apt-get\\s+install.*(?<!apt-get\\s+update)"
note: |
  Package lists may be stale, causing install failures.
  Always combine: RUN apt-get update && apt-get install -y package_name
  Improves caching by keeping update and install in same layer.
  Ref: Hadolint DL3009

---
id: docker-quality-multiple-cmd
language: dockerfile
severity: error
message: "Quality: Only last CMD or ENTRYPOINT takes effect; remove duplicates"
tags:
  - quality
  - docker
  - entrypoint
rule:
  kind: instruction
  pattern: "Multiple (CMD|ENTRYPOINT)"
note: |
  Docker only executes the last CMD or ENTRYPOINT instruction.
  Earlier instructions are silently overridden.
  Keep single CMD/ENTRYPOINT per Dockerfile.
  Ref: Docker Documentation

---
id: docker-quality-maintainer-deprecated
language: dockerfile
severity: warning
message: "Quality: MAINTAINER instruction is deprecated; use LABEL instead"
tags:
  - quality
  - docker
  - deprecation
rule:
  kind: instruction
  pattern: "MAINTAINER"
note: |
  MAINTAINER is deprecated in favor of LABEL.
  Use: LABEL maintainer="name@example.com"
  This integrates with OCI metadata standards.
  Ref: Hadolint DL4000

---
id: docker-quality-long-run-instruction
language: dockerfile
severity: warning
message: "Quality: Very long RUN instructions should use line breaks for readability"
tags:
  - quality
  - docker
  - style
rule:
  kind: instruction
  pattern: "RUN.*&&.*&&.*&&.*&&"
note: |
  Long RUN commands are hard to read and maintain.
  Use backslash line continuation for multiple steps:
  RUN apt-get update && \
      apt-get install -y \
        package1 \
        package2 && \
      apt-get clean
  Also consider --no-install-recommends to reduce image size.
  Ref: Docker Best Practices

---
id: docker-quality-copy-chown-separate
language: dockerfile
severity: warning
message: "Quality: Use COPY --chown instead of separate RUN chown"
tags:
  - quality
  - docker
  - optimization
rule:
  kind: instruction
  pattern: "COPY.*\\n.*RUN\\s+chown"
note: |
  Separate chown creates an extra layer and image size.
  Use: COPY --chown=user:group src dest
  More efficient and clearer intent.
  Ref: Hadolint DL3044

---
id: docker-quality-wget-and-curl
language: dockerfile
severity: warning
message: "Quality: wget and curl are largely redundant; choose one"
tags:
  - quality
  - docker
  - dependencies
rule:
  kind: instruction
  pattern: "apt-get.*install.*\\b(wget)\\b.*\\b(curl)\\b"
note: |
  wget and curl provide similar functionality with different trade-offs:
  - curl: more features, better scripting support
  - wget: simpler, good for basic HTTP/FTP
  Choose one to reduce image size.
  Ref: Hadolint DL3047

---
id: docker-quality-env-single-use
language: dockerfile
severity: warning
message: "Quality: Use ARG or inline env for build-time variables, not ENV"
tags:
  - quality
  - docker
  - layers
rule:
  kind: instruction
  pattern: "ENV\\s+\\w+=(\\w+)\\s+RUN.*\\1"
note: |
  ENV variables persist in final image and affect all subsequent layers.
  For build-time only variables:
  - Use ARG: ARG DEBIAN_FRONTEND=noninteractive
  - Or inline: RUN DEBIAN_FRONTEND=noninteractive apt-get install
  ENV is appropriate for runtime configuration.
  Ref: Hadolint DL3006

---
id: docker-quality-copy-absolute-path
language: dockerfile
severity: warning
message: "Quality: COPY should use relative paths from build context"
tags:
  - quality
  - docker
  - portability
rule:
  kind: instruction
  pattern: "COPY\\s+/[^\\s]*"
note: |
  Absolute source paths are not portable across environments.
  Always use relative paths from build context.
  Correct: COPY code /app or COPY ./code /app
  Incorrect: COPY /home/user/code /app
  Ref: Docker Build Context

---
id: docker-quality-pip-unversioned
language: dockerfile
severity: error
message: "Quality: pip install should specify package versions for reproducibility"
tags:
  - quality
  - docker
  - dependencies
rule:
  kind: instruction
  pattern: "RUN\\s+pip\\s+install\\s+[^=\\n]*(?<!==)"
note: |
  Unpinned packages make builds non-reproducible.
  Always specify versions: pip install flask==2.3.2 requests==2.31.0
  Better: Use requirements.txt with pinned versions:
  COPY requirements.txt . && pip install --no-cache-dir -r requirements.txt
  Ref: Hadolint DL3013

---
id: docker-quality-pip-as-root
language: dockerfile
severity: warning
message: "Quality: pip install as root is not recommended; consider venv"
tags:
  - quality
  - docker
  - security
rule:
  kind: instruction
  pattern: "FROM\\s+python.*\\nRUN\\s+pip"
note: |
  pip warns about running as root due to security implications.
  Consider using virtual environments:
  RUN python -m venv /opt/venv
  ENV PATH="/opt/venv/bin:$PATH"
  RUN pip install package_name
  Ref: Hadolint DL3042

---
id: docker-quality-npm-no-lock
language: dockerfile
severity: error
message: "Quality: npm install should use lock file for reproducible builds"
tags:
  - quality
  - docker
  - dependencies
rule:
  kind: instruction
  pattern: "COPY\\s+package\\.json.*\\nRUN\\s+npm\\s+install"
note: |
  Without package-lock.json, builds are not reproducible.
  npm can select different minor/patch versions on each run.
  Use npm ci (clean install) instead:
  COPY package.json package-lock.json ./
  RUN npm ci
  Ref: npm ci Documentation

---
id: docker-quality-missing-shell
language: dockerfile
severity: warning
message: "Quality: Use SHELL instruction for bash-specific features"
tags:
  - quality
  - docker
  - shell
rule:
  kind: instruction
  pattern: "RUN\\s+\\[\\["
note: |
  Default shell is /bin/sh (POSIX), which doesn't support bash features like [[ ]].
  Use explicit SHELL instruction:
  SHELL ["/bin/bash", "-c"]
  Or use POSIX-compatible syntax in /bin/sh.
  Ref: Docker SHELL Instruction

---
id: docker-quality-expose-protocol
language: dockerfile
severity: info
message: "Quality: EXPOSE should include protocol specification"
tags:
  - quality
  - docker
  - documentation
rule:
  kind: instruction
  pattern: "EXPOSE\\s+\\d+(?!/)"
note: |
  Explicit protocol improves documentation and clarity.
  Recommended: EXPOSE 80/tcp 443/tcp 53/udp
  Without protocol, TCP is assumed but explicit is better.
  Ref: Docker EXPOSE Documentation

---
id: docker-quality-instruction-ordering
language: dockerfile
severity: info
message: "Quality: Use recommended instruction ordering for consistency"
tags:
  - quality
  - docker
  - style
rule:
  kind: instruction
  pattern: "Inconsistent instruction sequence"
note: |
  Recommended order improves readability and consistency:
  1. FROM
  2. ARG (build arguments)
  3. LABEL (metadata)
  4. ENV (environment)
  5. RUN (build commands)
  6. COPY (copy files)
  7. EXPOSE (ports)
  8. ENTRYPOINT/CMD (startup)
  This reduces layer rebuilds on changes.
  Ref: Docker Best Practices

---
id: terraform-quality-var-no-description
language: terraform
severity: warning
message: "Quality: Variable should include description for documentation"
tags:
  - quality
  - terraform
  - documentation
rule:
  kind: block
  pattern: "variable.*type.*(?!description)"
note: |
  Variable descriptions help users understand purpose and usage.
  Format:
  variable "instance_type" {
    type        = string
    description = "EC2 instance type for web servers"
    default     = "t3.micro"
  }
  Descriptions are essential for documentation generation.
  Ref: Terraform Variable Documentation

---
id: terraform-quality-var-no-type
language: terraform
severity: error
message: "Quality: Variable must include explicit type constraint"
tags:
  - quality
  - terraform
  - validation
rule:
  kind: block
  pattern: "variable.*(?!type)"
note: |
  Explicit types catch configuration errors early and improve validation.
  Always specify type: string, number, bool, list, map, or object.
  variable "enabled" {
    type    = bool
    default = true
  }
  Types enable terraform to validate inputs before applying.
  Ref: Terraform Type Constraints

---
id: terraform-quality-unused-variable
language: terraform
severity: warning
message: "Quality: Variable is declared but never referenced"
tags:
  - quality
  - terraform
  - maintenance
rule:
  kind: block
  pattern: "variable.*never used"
note: |
  Unused variables create confusion and maintenance burden.
  Either:
  1. Remove the variable entirely
  2. Add references in resources that should use it
  3. Add to outputs for parent module consumption
  Unused variables make modules harder to understand.
  Ref: Terraform Best Practices

---
id: terraform-quality-output-no-description
language: terraform
severity: warning
message: "Quality: Output should include description explaining its value"
tags:
  - quality
  - terraform
  - documentation
rule:
  kind: block
  pattern: "output.*value.*(?!description)"
note: |
  Output descriptions explain what values represent and their purpose.
  Format:
  output "instance_ip" {
    value       = aws_instance.main.public_ip
    description = "Public IP address of the web server"
  }
  Descriptions appear in terraform output documentation.
  Ref: Terraform Output Documentation

---
id: terraform-quality-resource-no-tags
language: terraform
severity: error
message: "Quality: AWS resources should include tags for management"
tags:
  - quality
  - terraform
  - governance
rule:
  kind: block
  pattern: "resource \"aws_.*\".*(?!tags)"
note: |
  Tags are essential for cost tracking, automation, and organization.
  Minimum recommended tags:
  tags = {
    Name        = "resource-name"
    Environment = var.environment
    Project     = var.project
    ManagedBy   = "terraform"
  }
  Use provider default_tags to apply consistently.
  Ref: AWS Tagging Best Practices

---
id: terraform-quality-hardcoded-values
language: terraform
severity: error
message: "Quality: Values should be variables/data sources, not hardcoded"
tags:
  - quality
  - terraform
  - reusability
rule:
  kind: value
  pattern: "\"(t3\\.micro|ami-[0-9a-f]{8}|[0-9]{1,3}\\.[0-9]{1,3})\".*="
note: |
  Hardcoded values reduce reusability and flexibility.
  Move values to variables:
  variable "instance_type" { type = string; default = "t3.micro" }
  Or use data sources:
  data "aws_ami" "ubuntu" { ... }
  This improves module portability across environments.
  Ref: Terraform Variables, Data Sources

---
id: terraform-quality-no-required-version
language: terraform
severity: error
message: "Quality: Terraform should specify required version constraints"
tags:
  - quality
  - terraform
  - compatibility
rule:
  kind: block
  pattern: "terraform block without required_version"
note: |
  Version constraints ensure consistent behavior across environments.
  Format:
  terraform {
    required_version = ">= 1.5.0"
    required_providers {
      aws = {
        source  = "hashicorp/aws"
        version = "~> 5.0"
      }
    }
  }
  Prevents unexpected behavior from version mismatches.
  Ref: Terraform Version Constraints

---
id: terraform-quality-naming-convention
language: terraform
severity: warning
message: "Quality: Use consistent snake_case naming for resources"
tags:
  - quality
  - terraform
  - style
rule:
  kind: identifier
  pattern: "[A-Z][a-zA-Z]*|.*-[a-z]*"
note: |
  Inconsistent naming reduces readability and searchability.
  Terraform convention: snake_case for all identifiers
  Correct: web_server, database_server, cache_server
  Avoid: WebServer, web-server, web_Server
  Consistent naming improves team collaboration.
  Ref: Terraform Naming Conventions

---
id: terraform-quality-no-default-tags
language: terraform
severity: warning
message: "Quality: AWS provider should use default_tags for consistency"
tags:
  - quality
  - terraform
  - governance
rule:
  kind: block
  pattern: "provider \"aws\".*(?!default_tags)"
note: |
  default_tags automatically apply to all resources, ensuring consistency.
  Format:
  provider "aws" {
    region = "us-east-1"
    default_tags {
      tags = {
        Environment = var.environment
        Project     = var.project
        ManagedBy   = "terraform"
      }
    }
  }
  Eliminates tag duplication across multiple resources.
  Ref: AWS Provider default_tags

---
id: terraform-quality-long-resource-block
language: terraform
severity: warning
message: "Quality: Resource blocks > 100 lines should be refactored to modules"
tags:
  - quality
  - terraform
  - maintainability
rule:
  kind: block
  pattern: "resource.*{.*}{100,}"
note: |
  Long resources are hard to maintain and understand.
  Extract common patterns into reusable modules.
  This improves:
  - Readability and code organization
  - Reusability across projects
  - Testing and validation
  - Team collaboration
  Ref: Terraform Modules

---
id: terraform-quality-duplicate-configuration
language: terraform
severity: error
message: "Quality: Similar resource blocks should use for_each"
tags:
  - quality
  - terraform
  - dry
rule:
  kind: block
  pattern: "resource.*similar config.*resource.*similar config"
note: |
  Duplication increases maintenance burden and consistency risk.
  Use for_each to iterate over similar configurations:
  locals {
    ports = {
      http  = 80
      https = 443
    }
  }
  resource "aws_security_group_rule" "ingress" {
    for_each = local.ports
    from_port = each.value
    ...
  }
  Eliminates copy-paste errors and simplifies updates.
  Ref: Terraform for_each

---
id: terraform-quality-magic-numbers
language: terraform
severity: warning
message: "Quality: Unexplained numeric values should use named locals"
tags:
  - quality
  - terraform
  - clarity
rule:
  kind: value
  pattern: "\\b\\d{2,}\\b\\s*#.*(?!comment explaining)"
note: |
  Magic numbers lack context and intent.
  Use locals with descriptive names:
  locals {
    asg_min     = 2   # Minimum for HA
    asg_max     = 10  # Cost ceiling
    asg_desired = 4   # Normal load
  }
  Improves maintainability and makes intent clear.
  Ref: Clean Code Practices

---
id: terraform-quality-no-lifecycle-block
language: terraform
severity: warning
message: "Quality: Critical resources should have lifecycle protection"
tags:
  - quality
  - terraform
  - safety
rule:
  kind: block
  pattern: "resource \"aws_(db|rds|efs).*(?!lifecycle)"
note: |
  Lifecycle blocks protect against accidental destruction.
  Use prevent_destroy for critical resources:
  lifecycle {
    prevent_destroy = true
  }
  This prevents terraform destroy from removing:
  - Databases
  - EFS volumes
  - Load balancers
  - Other stateful resources
  Ref: Terraform Lifecycle

---
id: terraform-quality-complex-expressions
language: terraform
severity: warning
message: "Quality: Complex expressions should be extracted to locals"
tags:
  - quality
  - terraform
  - readability
rule:
  kind: expression
  pattern: "merge\\(|interpolation.*\\$\\{.*\\$\\{"
note: |
  Complex expressions are clearer when extracted to locals.
  Before:
  tags = merge(var.common_tags, { Name = "${var.project}-${var.env}" })
  After:
  locals {
    name_prefix = "${var.project}-${var.environment}"
    tags = merge(var.common_tags, { Name = local.name_prefix })
  }
  Improves readability and enables reuse.
  Ref: Terraform Locals

---
id: terraform-quality-module-no-version
language: terraform
severity: error
message: "Quality: Module sources should specify version for reproducibility"
tags:
  - quality
  - terraform
  - dependencies
rule:
  kind: block
  pattern: "module.*source.*(?!version)"
note: |
  Unpinned modules may introduce breaking changes.
  Always specify version:
  module "vpc" {
    source  = "terraform-aws-modules/vpc/aws"
    version = "5.1.0"
  }
  Pinning versions ensures predictable behavior.
  Use ~> for compatible versions: "~> 5.0"
  Ref: Terraform Module Sources

---
id: terraform-quality-empty-resource
language: terraform
severity: warning
message: "Quality: Resources with minimal configuration are likely incomplete"
tags:
  - quality
  - terraform
  - validation
rule:
  kind: block
  pattern: "resource.*{\\s*}"
note: |
  Empty or minimal resources indicate incomplete configuration.
  Either:
  1. Complete the resource configuration
  2. Remove if no longer needed
  3. Add data source instead if using existing resource
  Incomplete resources may cause subtle failures.
  Ref: Terraform Resources

---
id: terraform-quality-commented-code
language: terraform
severity: info
message: "Quality: Remove commented-out code; use version control for history"
tags:
  - quality
  - terraform
  - maintenance
rule:
  kind: comment
  pattern: "^\\s*#\\s*(resource|module|variable).*{.*}.*"
note: |
  Commented code adds noise and confusion.
  Use version control (git) to access historical code.
  If code is needed, uncomment it.
  If it's for reference, move to documentation.
  Simplifies code review and maintenance.
  Ref: Clean Code Practices

---
id: kubernetes-quality-missing-labels
language: yaml
severity: error
message: "Quality: Kubernetes resources should include standard labels"
tags:
  - quality
  - kubernetes
  - governance
rule:
  kind: mapping
  pattern: "metadata.*(?!labels)"
note: |
  Labels enable selection, grouping, and management in Kubernetes.
  Use standard OCI/Kubernetes labels:
  labels:
    app.kubernetes.io/name: myapp
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/component: backend
    app.kubernetes.io/part-of: myplatform
    app.kubernetes.io/managed-by: kubectl
  Required for service discovery and resource organization.
  Ref: Kubernetes Recommended Labels

---
id: kubernetes-quality-missing-annotations
language: yaml
severity: info
message: "Quality: Resources should include annotations for documentation"
tags:
  - quality
  - kubernetes
  - documentation
rule:
  kind: mapping
  pattern: "metadata.*(?!annotations)"
note: |
  Annotations document purpose, ownership, and metadata without affecting scheduling.
  Examples:
  annotations:
    description: "Main application backend service"
    owner: "platform-team@example.com"
    docs: "https://wiki.example.com/myapp"
    prometheus.io/scrape: "true"
  Improve observability and team communication.
  Ref: Kubernetes Annotations

---
id: kubernetes-quality-selector-mismatch
language: yaml
severity: error
message: "Quality: Deployment selector must match pod template labels"
tags:
  - quality
  - kubernetes
  - validation
rule:
  kind: mapping
  pattern: "selector.*matchLabels.*!=.*template.*metadata.*labels"
note: |
  Mismatched selectors prevent Deployment from managing pods.
  Deployment won't create or manage pods if selector doesn't match template labels.
  Must match exactly:
  spec:
    selector:
      matchLabels:
        app: myapp
    template:
      metadata:
        labels:
          app: myapp  # Must match selector
  Common cause of pod creation failures.
  Ref: Kubernetes Deployments

---
id: kubernetes-quality-default-namespace
language: yaml
severity: error
message: "Quality: Use dedicated namespaces, not default"
tags:
  - quality
  - kubernetes
  - organization
rule:
  kind: value
  pattern: "namespace:\\s*(default|(?!\\w+-\\w+))"
note: |
  default namespace should be reserved for testing.
  Use dedicated namespaces for each application/environment:
  metadata:
    name: myapp
    namespace: myapp-production
  Improves:
  - Resource isolation
  - Access control
  - Team organization
  - Quota management
  Ref: Kubernetes Namespaces Best Practices

---
id: kubernetes-quality-no-namespace
language: yaml
severity: warning
message: "Quality: Explicitly specify namespace to prevent deployment errors"
tags:
  - quality
  - kubernetes
  - clarity
rule:
  kind: mapping
  pattern: "metadata.*(?!namespace)"
note: |
  Explicit namespaces prevent deployment to wrong cluster/namespace.
  Always include:
  metadata:
    name: myapp
    namespace: myapp-production
  Prevents accidental deployment to default namespace.
  Ref: Kubernetes Namespaces

---
id: kubernetes-quality-single-replica
language: yaml
severity: error
message: "Quality: Production deployments require multiple replicas for HA"
tags:
  - quality
  - kubernetes
  - reliability
rule:
  kind: value
  pattern: "replicas:\\s*1(?=\\s*#.*prod)"
note: |
  Single replicas have no redundancy; failures cause immediate downtime.
  Minimum for production: 3 replicas
  spec:
    replicas: 3  # Or use Horizontal Pod Autoscaler
  Or use HPA for dynamic scaling:
  kind: HorizontalPodAutoscaler
  Ensures service availability.
  Ref: Kubernetes High Availability

---
id: kubernetes-quality-no-service-account
language: yaml
severity: warning
message: "Quality: Pods should use explicit service accounts"
tags:
  - quality
  - kubernetes
  - security
rule:
  kind: mapping
  pattern: "spec.*(?!serviceAccountName)"
note: |
  Explicit service accounts improve security and clarity.
  Define and reference service accounts:
  spec:
    serviceAccountName: myapp-sa
    automountServiceAccountToken: false
  Benefits:
  - RBAC enforcement
  - Clear permissions
  - Audit trails
  Ref: Kubernetes Service Accounts

---
id: kubernetes-quality-latest-image-tag
language: yaml
severity: error
message: "Quality: Never use :latest tag; specify explicit version"
tags:
  - quality
  - kubernetes
  - immutability
rule:
  kind: value
  pattern: "image:\\s*\\w+(:latest|:(?!.*\\d+.*\\d))"
note: |
  :latest tag is mutable and breaks reproducibility and debugging.
  Always use explicit semantic version:
  image: myapp:1.2.3
  Or use image digest for maximum immutability:
  image: myapp:1.2.3@sha256:abc123def456...
  Ensures predictable deployments and rollbacks.
  Ref: Kubernetes Container Images

---
id: kubernetes-quality-no-container-name
language: yaml
severity: warning
message: "Quality: Use meaningful container names for clarity"
tags:
  - quality
  - kubernetes
  - debugging
rule:
  kind: value
  pattern: "name:\\s*container-\\d+|name:\\s*app"
note: |
  Meaningful names improve debugging and observability.
  Use application-specific names:
  containers:
  - name: myapp  # Not 'container-1' or 'app'
    image: myapp:1.2.3
  Improves:
  - Log identification
  - Debugging
  - Metrics association
  Ref: Kubernetes Best Practices

---
id: kubernetes-quality-no-termination-grace
language: yaml
severity: info
message: "Quality: Set appropriate terminationGracePeriodSeconds"
tags:
  - quality
  - kubernetes
  - lifecycle
rule:
  kind: mapping
  pattern: "spec.*(?!terminationGracePeriodSeconds)"
note: |
  Default 30s may not be appropriate for all applications.
  Applications that need graceful shutdown should specify:
  spec:
    terminationGracePeriodSeconds: 60
  Time for application to:
  - Close connections
  - Write state
  - Cleanup resources
  Too short causes errors; too long delays pod eviction.
  Ref: Kubernetes Pod Lifecycle

---
id: kubernetes-quality-no-deployment-strategy
language: yaml
severity: info
message: "Quality: Explicitly define deployment update strategy"
tags:
  - quality
  - kubernetes
  - deployment
rule:
  kind: mapping
  pattern: "kind:\\s*Deployment.*(?!strategy)"
note: |
  Explicit strategy documents rollout behavior.
  RollingUpdate example:
  spec:
    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 25%
        maxUnavailable: 25%
  Strategies:
  - RollingUpdate: gradual replacement (default)
  - Recreate: stop all, start new
  Improves availability during updates.
  Ref: Kubernetes Deployment Strategies

---
id: kubernetes-quality-unused-configmap
language: yaml
severity: warning
message: "Quality: Remove unused ConfigMaps and Secrets"
tags:
  - quality
  - kubernetes
  - maintenance
rule:
  kind: block
  pattern: "kind:\\s*(ConfigMap|Secret).*(?!referenced)"
note: |
  Unused ConfigMaps/Secrets add confusion and maintenance overhead.
  Verify usage in:
  - volumeMounts
  - env/envFrom references
  - argument bindings
  If unused:
  1. Remove the resource
  2. Or add explicit references
  Reduces confusion and simplifies audits.
  Ref: Kubernetes ConfigMaps, Secrets

---
id: kubernetes-quality-deprecated-api-version
language: yaml
severity: error
message: "Quality: Use current API versions; avoid deprecated versions"
tags:
  - quality
  - kubernetes
  - compatibility
rule:
  kind: value
  pattern: "apiVersion:\\s*(extensions/v1beta1|apps/v1beta1|batch/v1beta1)"
note: |
  Deprecated API versions will be removed in future Kubernetes versions.
  Current versions:
  - apiVersion: apps/v1 (Deployment, StatefulSet, DaemonSet)
  - apiVersion: batch/v1 (Job, CronJob)
  - apiVersion: v1 (Pod, Service, ConfigMap)
  Check Kubernetes API Deprecation policy.
  Update manifests before clusters drop support.
  Ref: Kubernetes API Deprecation

---
id: kubernetes-quality-missing-probes
language: yaml
severity: error
message: "Quality: Containers should include liveness and readiness probes"
tags:
  - quality
  - kubernetes
  - reliability
rule:
  kind: mapping
  pattern: "containers.*(?!livenessProbe|readinessProbe)"
note: |
  Probes enable Kubernetes to manage container health automatically.
  Minimum configuration:
  containers:
  - name: myapp
    livenessProbe:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 5
  Enables automatic restart and load balancing.
  Ref: Kubernetes Probes

---
id: kubernetes-quality-duplicate-ports
language: yaml
severity: error
message: "Quality: Multiple containers must not expose same port"
tags:
  - quality
  - kubernetes
  - networking
rule:
  kind: value
  pattern: "containerPort:\\s*(\\d+).*containerPort:\\s*\\1"
note: |
  Port conflicts cause container startup failures.
  Each container must use unique ports:
  containers:
  - name: app
    ports:
    - containerPort: 8080
  - name: sidecar
    ports:
    - containerPort: 8081  # Different port
  Kubernetes cannot bind multiple containers to same port.
  Ref: Kubernetes Container Ports

---
id: ansible-quality-missing-task-name
language: yaml
severity: error
message: "Quality: Tasks must have descriptive name for readability"
tags:
  - quality
  - ansible
  - documentation
rule:
  kind: mapping
  pattern: "^\\s*-\\s+\\w+:\\s+(?!name:)"
note: |
  Task names make playbook output readable and self-documenting.
  Format:
  - name: Copy configuration file
    copy:
      src: file.txt
      dest: /tmp/file.txt
  Benefits:
  - Clear execution logs
  - Debugging aid
  - Documentation
  Ref: ansible-lint name[missing]

---
id: ansible-quality-command-instead-of-module
language: yaml
severity: error
message: "Quality: Use Ansible modules instead of shell/command"
tags:
  - quality
  - ansible
  - idempotency
rule:
  kind: mapping
  pattern: "(shell|command):\\s+.*"
note: |
  shell/command modules are not idempotent and lack error handling.
  Modules are idempotent and provide better control:
  Instead of:
  - name: Install package
    command: yum install -y nginx
  Use:
  - name: Install package
    yum:
      name: nginx
      state: present
  Modules:
  - Only run on change
  - Better error handling
  - Declarative
  Ref: ansible-lint command-instead-of-module

---
id: ansible-quality-deprecated-module
language: yaml
severity: warning
message: "Quality: Avoid deprecated modules; use recommended replacements"
tags:
  - quality
  - ansible
  - maintenance
rule:
  kind: mapping
  pattern: "yum:|apt:|zypper:"
note: |
  Some modules are deprecated in favor of newer alternatives.
  Examples of deprecation:
  - yum (old) → ansible.builtin.dnf or yum (newer)
  - apt (old) → ansible.builtin.apt (newer)
  Check Ansible documentation for:
  - Recommended replacements
  - API changes
  - New features
  Ensure playbooks remain compatible with future versions.
  Ref: ansible-lint deprecated-module

---
id: ansible-quality-empty-string-compare
language: yaml
severity: warning
message: "Quality: Use length filter instead of comparing to empty string"
tags:
  - quality
  - ansible
  - clarity
rule:
  kind: value
  pattern: "when:\\s+\\w+\\s*(==|!=)\\s+['\"]\\s*['\"]"
note: |
  Comparing to empty string is less clear than using length filters.
  Instead of:
  when: var == ""
  when: var != ""
  Use:
  when: var | length == 0
  when: var | length > 0
  Or:
  when: var is defined and var
  Improves semantic clarity.
  Ref: ansible-lint empty-string-compare

---
id: ansible-quality-long-lines
language: yaml
severity: info
message: "Quality: Avoid lines exceeding 160 characters for readability"
tags:
  - quality
  - ansible
  - style
rule:
  kind: line
  pattern: "^.{160,}$"
note: |
  Long lines are hard to read and review.
  Use YAML multi-line syntax:
  - name: Run command
    command: >-
      long command here
      continues on next line
  Improves:
  - Readability in code review
  - Display in terminals
  - Diff quality
  Ref: ansible-lint yaml[line-length]

---
id: ansible-quality-literal-compare
language: yaml
severity: warning
message: "Quality: Use direct boolean tests instead of literal comparison"
tags:
  - quality
  - ansible
  - clarity
rule:
  kind: value
  pattern: "when:\\s+\\w+\\s*(==|!=)\\s+(True|False)"
note: |
  Direct boolean tests are cleaner and more idiomatic.
  Instead of:
  when: var == True
  when: var == False
  Use:
  when: var
  when: not var
  Improves readability and follows Ansible style guide.
  Ref: ansible-lint literal-compare

---
id: ansible-quality-jinja2-spacing
language: yaml
severity: info
message: "Quality: Use consistent spacing in Jinja2 templates"
tags:
  - quality
  - ansible
  - style
rule:
  kind: value
  pattern: "{{\\w+}}|{{\\s{2,}\\w+"
note: |
  Consistent Jinja2 spacing improves readability.
  Standard format: {{ var }}
  With spaces:
  msg: "{{ var }}"
  msg: "{{ list_var | join(', ') }}"
  Inconsistent:
  msg: "{{var}}"  # No spaces
  msg: "{{  var  }}"  # Extra spaces
  Enforce with ansible-lint.
  Ref: ansible-lint jinja[spacing]

---
id: ansible-quality-truthy-value
language: yaml
severity: warning
message: "Quality: Use lowercase true/false for YAML compatibility"
tags:
  - quality
  - ansible
  - style
rule:
  kind: value
  pattern: "(yes|no|Yes|No|True|False)"
note: |
  Use lowercase true/false for YAML 1.1 compatibility.
  Standard format:
  become: true
  ignore_errors: false
  skip_tags: true
  Avoid:
  become: yes      # Old Ansible convention
  become: True     # Python convention
  become: Yes      # Ambiguous
  Improves YAML standards compliance.
  Ref: ansible-lint yaml[truthy]

---
id: ansible-quality-fqcn-not-used
language: yaml
severity: warning
message: "Quality: Use Fully Qualified Collection Name (FQCN) for modules"
tags:
  - quality
  - ansible
  - clarity
rule:
  kind: value
  pattern: "^\\s*(copy|file|yum|apt|shell|command):"
note: |
  Short module names can be ambiguous with collection modules.
  Use FQCN format:
  - name: Copy file
    ansible.builtin.copy:
      src: file.txt
      dest: /tmp/
  Benefits:
  - No ambiguity
  - Clear provenance
  - Better collection support
  Format: collection.module
  Ref: ansible-lint fqcn[action-core]

---
id: ansible-quality-no-changed-when
language: yaml
severity: warning
message: "Quality: command/shell tasks should define changed_when"
tags:
  - quality
  - ansible
  - idempotency
rule:
  kind: mapping
  pattern: "(command|shell):(.*(?!changed_when))"
note: |
  By default, command/shell modules always report 'changed'.
  Set changed_when to make tasks idempotent:
  - name: Check status
    command: systemctl status nginx
    register: result
    changed_when: false
  Or check output:
  - name: Run migration
    command: migrate.sh
    register: result
    changed_when: "'no migrations needed' not in result.stdout"
  Prevents unnecessary task runs and clearer idempotency.
  Ref: ansible-lint no-changed-when

---
id: ansible-quality-risky-file-permissions
language: yaml
severity: error
message: "Quality: File operations should explicitly define mode"
tags:
  - quality
  - ansible
  - security
rule:
  kind: mapping
  pattern: "(copy|file):(.*(?!mode))"
note: |
  Default file permissions may be too permissive or inconsistent.
  Always set explicit mode:
  - name: Copy script
    copy:
      src: script.sh
      dest: /usr/local/bin/script.sh
      mode: '0755'
  - name: Copy config
    copy:
      src: config.conf
      dest: /etc/app/config.conf
      mode: '0644'
  Standard modes:
  - '0755': Executable scripts
  - '0644': Configuration files
  - '0600': Sensitive files
  Ref: ansible-lint risky-file-permissions

---
id: ansible-quality-playbook-extension
language: yaml
severity: info
message: "Quality: Use consistent playbook file extensions"
tags:
  - quality
  - ansible
  - style
rule:
  kind: file
  pattern: "\\.(yaml|yml)$"
note: |
  Consistent extensions improve discoverability.
  Ansible convention: .yml (preferred)
  Either is valid, but pick one and stick with it.
  Recommended: .yml for consistency with community
  Improves:
  - File discovery
  - CI/CD patterns
  - Tool integration
  Benefits from .yml: shorter, historical convention
  Ref: ansible-lint playbook-extension

---
id: ansible-quality-handler-no-notify
language: yaml
severity: warning
message: "Quality: Remove unused handlers that are never notified"
tags:
  - quality
  - ansible
  - maintenance
rule:
  kind: block
  pattern: "handlers:.*never notified"
note: |
  Unused handlers add confusion and maintenance burden.
  Handlers must be triggered by notify:
  - name: Install package
    yum:
      name: nginx
      state: present
    notify: restart nginx
  handlers:
  - name: restart nginx
    service:
      name: nginx
      state: restarted
  If handler unused:
  1. Remove handler
  2. Or add notify to relevant task
  Reduces playbook complexity.
  Ref: Ansible Handlers

---
id: ansible-quality-role-no-meta
language: yaml
severity: warning
message: "Quality: Roles should include meta/main.yml for documentation"
tags:
  - quality
  - ansible
  - documentation
rule:
  kind: file
  pattern: "roles/\\w+/(?!meta/main\\.yml)"
note: |
  meta/main.yml documents role dependencies and metadata.
  Essential for roles:
  galaxy_info:
    author: 'Team Name'
    description: 'Role description'
    company: 'Company'
    license: 'MIT'
    min_ansible_version: '2.9'
    platforms:
      - name: CentOS
        versions:
          - '8'
  dependencies:
    - role: common
  Improves:
  - Ansible Galaxy integration
  - Dependency management
  - Role reusability
  Ref: Ansible Role Structure

---
id: ansible-quality-var-naming-convention
language: yaml
severity: warning
message: "Quality: Use snake_case for variable names"
tags:
  - quality
  - ansible
  - style
rule:
  kind: identifier
  pattern: "[A-Z][a-zA-Z]*|\\w+-\\w+"
note: |
  Consistent naming (snake_case) improves maintainability.
  Standard format: lowercase with underscores
  Correct:
  vars:
    my_variable: value
    app_port: 8080
  Avoid:
  vars:
    MyVariable: value  # PascalCase
    some-var: value    # Hyphens invalid
  Improves:
  - Team consistency
  - Code readability
  - Variable scoping
  Ref: ansible-lint var-naming
---
id: bash-quality-uppercase-constants
language: bash
severity: info
message: "Quality: Constants should be UPPERCASE; local variables lowercase"
tags:
  - quality
  - naming
rule:
  kind: variable_declaration
  pattern: "readonly\\s+[a-z][a-z0-9_]*=|declare\\s+-r\\s+[a-z][a-z0-9_]*="
note: |
  Constants and environment variables should be UPPERCASE by convention.
  Local variables should be lowercase. This improves code readability and
  makes it clear when a value is immutable.

---
id: bash-quality-function-names-snake-case
language: bash
severity: info
message: "Quality: Function names should use lowercase with underscores (snake_case)"
tags:
  - quality
  - naming
rule:
  kind: function_declaration
  pattern: "^[a-z][a-z0-9]*[A-Z].*\\(\\)\\s*\\{|function\\s+[a-z][a-z0-9]*[A-Z]"
note: |
  Function names should follow snake_case convention with lowercase letters
  and underscores. This provides consistency with shell scripting conventions
  and improves readability. Avoid camelCase naming.

---
id: bash-quality-private-functions-underscore-prefix
language: bash
severity: info
message: "Quality: Private/internal functions should have underscore prefix"
tags:
  - quality
  - naming
rule:
  kind: function_definition
  pattern: ""
note: |
  Functions that are only used internally within a script should be prefixed
  with an underscore to distinguish them from public API functions. Example:
  _setup(), _cleanup(). Public functions like main() or process_files()
  should not have the underscore prefix.

---
id: bash-quality-descriptive-variable-names
language: bash
severity: info
message: "Quality: Avoid single-letter variables except for loop counters"
tags:
  - quality
  - naming
rule:
  kind: variable_assignment
  pattern: "(?<!for\\s)\\b[a-z]=[^=]|\\b[a-z]=[^=].*\\n[^\\n]*\\$\\1"
note: |
  Single-letter variables (except loop counters like 'i', 'j', 'k') reduce
  code readability. Use descriptive names: 'file' instead of 'f', 'directory'
  instead of 'd'. This makes code self-documenting and easier to maintain.

---
id: bash-quality-boolean-variable-prefix
language: bash
severity: info
message: "Quality: Boolean variables should use is_, has_, can_, should_ prefixes"
tags:
  - quality
  - naming
rule:
  kind: variable_assignment
  pattern: "[a-z_]+=\\s*(true|false|0|1)(?!\\s*#.*bool)"
note: |
  Boolean variables should be clearly identified with prefixes: is_*, has_*,
  can_*, should_*. Examples: is_verbose, has_permission, can_proceed.
  This makes it immediately clear when a variable holds a boolean value.

---
id: bash-quality-unquoted-variable-expansion
language: bash
severity: warning
message: "Quality: Variables should be quoted to prevent word splitting and globbing"
tags:
  - quality
  - quoting
rule:
  kind: variable_expansion
  pattern: "\\$[a-zA-Z_][a-zA-Z0-9_]*(?![a-zA-Z0-9_\"'])|\\$\\{[a-zA-Z_][a-zA-Z0-9_]*\\}(?![a-zA-Z0-9_\"'])"
note: |
  Unquoted variables undergo word splitting and pathname expansion. Always
  quote variables: "$var" or "${var}". Exception: intentional word splitting
  should be documented. Related to ShellCheck SC2086 and SC2248.

---
id: bash-quality-missing-quotes-in-test
language: bash
severity: warning
message: "Quality: Variables in [ ] must be quoted; [[ ]] is safer"
tags:
  - quality
  - quoting
rule:
  kind: conditional
  pattern: "\\[\\s+(-[a-z]\\s+)?\\$[a-zA-Z_]|\\[\\s+\\$[a-zA-Z_].*\\s+[!=]="
note: |
  Variables in [ ] test bracket must be quoted to handle empty values
  and spaces correctly. Use [ "$var" = "value" ] not [ $var = "value" ].
  [[ ]] is bash-specific but safer: [[ $var = "value" ]] doesn't require quotes.
  References: ShellCheck SC2070, SC2086.

---
id: bash-quality-single-vs-double-quotes
language: bash
severity: info
message: "Quality: Use double quotes for variable expansion, single quotes for literals"
tags:
  - quality
  - quoting
rule:
  kind: string_literal
  pattern: "'.*\\$[a-zA-Z_].*'|\"[^$`\\\\]*\"(?!\\s*$)"
note: |
  Double quotes allow variable expansion and command substitution: "Hello, $name".
  Single quotes prevent expansion (faster, safer): 'literal text'. Use double
  quotes when variables are present, single quotes for literal strings.

---
id: bash-quality-command-substitution-quoting
language: bash
severity: warning
message: "Quality: Command substitution should be quoted"
tags:
  - quality
  - quoting
rule:
  kind: command_substitution
  pattern: "[^\"']\\$\\([^)]+\\)[^\"']"
note: |
  Unquoted command substitution: count=$(wc -l < file) should be quoted:
  count="$(wc -l < file)" to prevent word splitting. Exception: intentional
  word splitting should be documented. Related to ShellCheck SC2046.

---
id: bash-quality-array-element-quoting
language: bash
severity: warning
message: "Quality: Array elements should be quoted during assignment and expansion"
tags:
  - quality
  - quoting
rule:
  kind: array_literal
  pattern: "\\(\\s*[^\"'\\)]+\\s+[^\"'\\)]+\\s*\\)|\\$\\{[a-zA-Z_]+\\[\\*\\]\\}"
note: |
  Unquoted array elements: arr=(item with spaces) creates 3 elements instead of
  1 with spaces. Use: arr=("item" "with spaces"). Array expansion ${arr[*]}
  should use ${arr[@]} and be quoted: "${arr[@]}". Prevents word splitting.
  Related to ShellCheck SC2068.

---
id: bash-quality-missing-set-e
language: bash
severity: warning
message: "Quality: Scripts should use set -e to exit on errors"
tags:
  - quality
  - error-handling
rule:
  kind: script_directive
  pattern: "^#!.*\\n(?!.*set\\s+-e)"
note: |
  set -e causes script to exit immediately if any command exits with non-zero
  status. Prevents silent failures where errors are ignored. Note: set -e has
  caveats (doesn't work after || or && in some contexts). Modern approach is
  set -eo pipefail with careful || true usage. ShellCheck SC2310.

---
id: bash-quality-missing-set-u
language: bash
severity: warning
message: "Quality: Use set -u to error on unset variables"
tags:
  - quality
  - error-handling
rule:
  kind: script_directive
  pattern: "^#!.*\\n(?!.*set\\s+.*u)"
note: |
  set -u (or set -o nounset) causes script to error if undefined variables are
  used. Prevents silent errors like rm -rf "$undefined_var/" deleting wrong path.
  Use parameter expansion with defaults: "${1:?Error: arg required}".

---
id: bash-quality-missing-pipefail
language: bash
severity: warning
message: "Quality: Use set -o pipefail to catch errors in pipelines"
tags:
  - quality
  - error-handling
rule:
  kind: script_directive
  pattern: "^#!.*\\n(?!.*set\\s+-o\\s+pipefail).*\\|"
note: |
  Without pipefail, 'set -e' doesn't work correctly with pipes: false | true
  returns success. With 'set -eo pipefail', the pipeline fails if any command fails.
  Best practice: use 'set -eo pipefail' at script start after shebang.

---
id: bash-quality-missing-error-trap
language: bash
severity: warning
message: "Quality: Use trap to handle errors and cleanup"
tags:
  - quality
  - error-handling
rule:
  kind: function_call
  pattern: "mktemp(?!.*trap)|tmpfile=.*(?!.*trap)"
note: |
  Temporary files created with mktemp should have corresponding trap cleanup:
  tmpfile=$(mktemp); trap 'rm -f "$tmpfile"' EXIT
  This ensures cleanup happens even if script exits early due to error or signal.

---
id: bash-quality-unchecked-exit-codes
language: bash
severity: warning
message: "Quality: Critical commands should have their exit codes checked"
tags:
  - quality
  - error-handling
rule:
  kind: command
  pattern: "(cd|mkdir|rm|cp|mv)\\s+[^|&;\\n]+$"
note: |
  Critical operations like cd, mkdir, rm, cp, mv must check exit status:
  cd /dir || { echo "Failed" >&2; exit 1; }
  Without checking, cd failure is ignored and subsequent commands run in
  wrong directory. ShellCheck SC2164.

---
id: bash-quality-silent-failure-pattern
language: bash
severity: warning
message: "Quality: Using || true hides errors; use only when intentional"
tags:
  - quality
  - error-handling
rule:
  kind: command
  pattern: "\\|\\|\\s*true\\s*$|\\|\\|\\s*:\\s*$"
note: |
  The pattern 'command || true' silently ignores all errors. Only use when
  failure is explicitly acceptable, and add comment explaining why:
  rm file.txt 2>/dev/null || true  # File might not exist, OK to fail
  Better: use rm -f (idempotent) instead of || true.

---
id: bash-quality-standard-exit-codes
language: bash
severity: info
message: "Quality: Use standard exit codes (0-255, with conventions)"
tags:
  - quality
  - error-handling
rule:
  kind: return_statement
  pattern: "exit\\s+[0-9]{3,}|exit\\s+-[0-9]+"
note: |
  Exit codes must be 0-255. Conventions: 0=success, 1=general error, 2=misuse
  of shell command, 126=invoked cannot execute, 127=command not found,
  128=invalid exit argument, 130=terminated by Ctrl+C (128+2).

---
id: bash-quality-error-messages-to-stderr
language: bash
severity: warning
message: "Quality: Error messages should go to stderr, not stdout"
tags:
  - quality
  - error-handling
rule:
  kind: function_call
  pattern: "echo\\s+[\"']?(Error|ERROR|Warning|WARNING|Failed|FAILED)"
note: |
  Error messages must be redirected to stderr using >&2 so they don't get
  piped to next command or captured by command substitution. Define error
  function: error() { echo "Error: $*" >&2; }. Enables proper error handling
  and filtering.

---
id: bash-quality-function-declaration-style
language: bash
severity: info
message: "Quality: Use consistent function declaration style"
tags:
  - quality
  - function-design
rule:
  kind: function_definition
  pattern: "function\\s+[a-zA-Z_]+\\s*\\(\\)"
note: |
  POSIX style 'foo() { ... }' is preferred for portability. Bash style
  'function foo { ... }' works but is less portable. Never mix styles in
  same script. POSIX style is also 4 characters shorter. ShellCheck SC2112.

---
id: bash-quality-local-variables-in-functions
language: bash
severity: warning
message: "Quality: Variables in functions should be declared local"
tags:
  - quality
  - function-design
rule:
  kind: function_body
  pattern: "[a-zA-Z_]+\\(\\).*\\{[^}]*[^l][^o][^c][^a][^l]\\s+[a-z_]+="
note: |
  Variables without 'local' keyword pollute global namespace, causing bugs
  when variable names collide. Always: local var=$1; local result="";
  This scopes variables to function and prevents side effects. ShellCheck SC2034.

---
id: bash-quality-function-return-values
language: bash
severity: warning
message: "Quality: Functions should use return for status, echo/printf for output"
tags:
  - quality
  - function-design
rule:
  kind: return_statement
  pattern: "return\\s+[\"']|echo.*return\\s+\\$\\?"
note: |
  'return' is for status codes (0-255). Output goes via stdout with echo/printf.
  Wrong: return "result" (return is for status). Correct: echo "result"; return 0.
  This maintains separation of concerns: return code for success/failure,
  stdout for actual output.

---
id: bash-quality-function-documentation
language: bash
severity: info
message: "Quality: Functions should have documentation comments"
tags:
  - quality
  - function-design
rule:
  kind: function_definition
  pattern: "^[a-zA-Z_]+\\(\\)\\s*\\{(?!\\s*#)"
note: |
  Function documentation should include: purpose, arguments with descriptions,
  output description, return codes. Example:
  # Process file and output results
  # Args: $1=file path
  # Output: Writes to stdout
  # Returns: 0=success, 1=error

---
id: bash-quality-function-argument-validation
language: bash
severity: warning
message: "Quality: Functions should validate their arguments"
tags:
  - quality
  - function-design
rule:
  kind: function_body
  pattern: "[a-zA-Z_]+\\(\\)\\s*\\{[^}]*\\$[0-9](?!.*-z|\\s*:-|\\s*:=|\\s*:\\?)"
note: |
  Functions receiving arguments must validate them: local file="${1:?Error: filename required}"
  This prevents silent failures when arguments are missing. Check argument count,
  types, and preconditions at function start.

---
id: bash-quality-main-function-pattern
language: bash
severity: info
message: "Quality: Scripts should use a main function pattern"
tags:
  - quality
  - function-design
rule:
  kind: script_structure
  pattern: "^#!.*\\n[^#f]"
note: |
  Wrap script logic in main() function, call it at end with: main "$@"
  Benefits: scopes variables, prevents accidental code execution, allows
  re-sourcing without side effects, separates initialization from execution.
  Structure: shebang → source files → function definitions → main "$@"

---
id: bash-quality-shebang-line
language: bash
severity: warning
message: "Quality: Scripts should have appropriate shebang"
tags:
  - quality
  - script-structure
rule:
  kind: shebang
  pattern: "^(?!#!)|^#!\\s*/bin/sh\\s*$(?=.*\\[\\[)"
note: |
  First line must be #!/bin/bash or #!/usr/bin/env bash (portable) or #!/bin/sh
  (POSIX). Don't use #!/bin/sh if script uses bash features like [[ ]].
  #!/usr/bin/env bash is preferred for portability. ShellCheck SC2148.

---
id: bash-quality-script-header
language: bash
severity: info
message: "Quality: Scripts should have descriptive headers"
tags:
  - quality
  - script-structure
rule:
  kind: script_header
  pattern: "^#!.*\\n(?!#)"
note: |
  After shebang, add descriptive header with: script name, description, author,
  date, version, usage, and options. Format:
  #!/bin/bash
  # Script: backup.sh
  # Description: Daily backup
  # Author: Name; Date: YYYY-MM-DD; Version: 1.0.0
  # Usage: backup.sh [options]

---
id: bash-quality-consistent-indentation
language: bash
severity: info
message: "Quality: Use consistent indentation (spaces preferred)"
tags:
  - quality
  - script-structure
rule:
  kind: whitespace
  pattern: "^(\\t+ +| +\\t+)"
note: |
  Never mix tabs and spaces on same line. Pick one: 4 spaces (recommended) or
  tabs consistently. Inconsistent indentation causes parsing issues and
  readability problems. Configure editor to show whitespace.

---
id: bash-quality-script-organization
language: bash
severity: info
message: "Quality: Scripts should be organized in logical sections"
tags:
  - quality
  - script-structure
rule:
  kind: script_organization
  pattern: "function.*\\{.*\\n.*=.*\\n.*function"
note: |
  Organize scripts with clear sections separated by comments:
  1. Shebang and header
  2. Constants (readonly VARS)
  3. Global variables
  4. Function definitions
  5. Main function
  6. Call main "$@"
  This structure makes scripts easier to navigate and understand.

---
id: bash-quality-line-length
language: bash
severity: info
message: "Quality: Lines should not exceed 80 characters"
tags:
  - quality
  - script-structure
rule:
  kind: line_length
  pattern: "^.{81,}$"
note: |
  Enforce 80-character line limit for readability. Long lines should be wrapped
  with backslash continuation or heredoc. Benefits: fits on standard terminals,
  easier to review, better for splitting/merging in version control.

---
id: bash-quality-bashisms-in-posix-scripts
language: bash
severity: warning
message: "Quality: Scripts with #!/bin/sh should not use Bash-specific features"
tags:
  - quality
  - portability
rule:
  kind: script_compatibility
  pattern: "^#!/bin/sh.*\\n.*(\\[\\[|source\\s|\\(\\(|declare\\s|local\\s|function\\s|<<<)"
note: |
  POSIX scripts (#!/bin/sh) must not use bash-specific: [[ ]] use [ ],
  'source' use '.', (( )) use [ ] or $(()), declare use no local declarations,
  local use no local vars, function use func() {}, <<< use pipes.
  ShellCheck SC2039.

---
id: bash-quality-array-usage-portability
language: bash
severity: warning
message: "Quality: Arrays are not POSIX; use only in Bash scripts"
tags:
  - quality
  - portability
rule:
  kind: array_usage
  pattern: "^#!/bin/sh.*\\n.*(\\[@\\]|\\[0\\]|declare\\s+-a)"
note: |
  Arrays are bash-specific, not POSIX. In POSIX scripts use positional args:
  set -- one two three; echo "$@". In bash: arr=(one two); echo "${arr[@]}".
  If portability needed, use positional parameters instead of arrays.

---
id: bash-quality-process-substitution-portability
language: bash
severity: warning
message: "Quality: Process substitution <() is Bash-specific"
tags:
  - quality
  - portability
rule:
  kind: process_substitution
  pattern: "<\\(|>\\("
note: |
  Process substitution like diff <(sort f1) <(sort f2) is bash-only.
  POSIX alternative: create temp files, sort to them, diff, cleanup.
  Or use pipes if output order doesn't matter. ShellCheck SC3001.

---
id: bash-quality-brace-expansion-portability
language: bash
severity: info
message: "Quality: Brace expansion is Bash-specific"
tags:
  - quality
  - portability
rule:
  kind: brace_expansion
  pattern: "\\{[0-9]+\\.\\.[0-9]+\\}|\\{[a-z]+\\.\\.[a-z]+\\}"
note: |
  Bash brace expansion: for i in {1..10} doesn't work in POSIX sh.
  Use 'while [ $i -le 10 ]' or 'seq 1 10' loop instead.
  ShellCheck SC3009.

---
id: bash-quality-here-string-portability
language: bash
severity: info
message: "Quality: Here-strings (<<<) are Bash-specific"
tags:
  - quality
  - portability
rule:
  kind: here_string
  pattern: "<<<"
note: |
  Bash here-strings: grep pattern <<< "$string" not POSIX.
  Alternative: echo "$string" | grep pattern.
  Here-documents (<<EOF) are POSIX and preferred anyway.
  ShellCheck SC3011.

---
id: bash-quality-test-bracket-portability
language: bash
severity: warning
message: "Quality: [[ ]] is Bash-specific; use [ ] for POSIX"
tags:
  - quality
  - portability
rule:
  kind: conditional
  pattern: "^#!/bin/sh.*\\n.*\\[\\["
note: |
  POSIX scripts must use [ ] not [[ ]]. [[ ]] adds bash features like =~, -v,
  pattern matching. Use [ ] with -z, -n for string tests, -eq for numeric.
  Quote variables in [ ]: [ "$var" = "value" ]. ShellCheck SC3010.

---
id: bash-quality-usage-message
language: bash
severity: warning
message: "Quality: Scripts should provide usage information"
tags:
  - quality
  - documentation
rule:
  kind: argument_handling
  pattern: "getopts(?!.*usage|help)|\\$1(?!.*usage|help|--help)"
note: |
  Scripts using arguments need usage() function describing options and args.
  Support -h, --help flags. Print usage on error. Helps users understand
  script behavior without reading source code.

---
id: bash-quality-version-information
language: bash
severity: info
message: "Quality: Scripts should support version flag"
tags:
  - quality
  - documentation
rule:
  kind: command_option
  pattern: ""
note: |
  Support -V or --version flag that outputs script version:
  readonly VERSION="1.0.0"
  Helps track which version is running, useful for debugging.

---
id: bash-quality-inline-comments
language: bash
severity: info
message: "Quality: Complex logic should have inline comments"
tags:
  - quality
  - documentation
rule:
  kind: comment
  pattern: ""
note: |
  Complex operations need comments explaining intent. Examples:
  # Calculate weighted average with modulo - explains what complex math does
  # Validate email format: user@domain - explains what regex checks
  Self-documenting code + strategic comments = maintainability.

---
id: bash-quality-todo-fixme-comments
language: bash
severity: info
message: "Quality: TODO/FIXME comments should be tracked"
tags:
  - quality
  - documentation
rule:
  kind: comment
  pattern: "#\\s*(TODO|FIXME|HACK|XXX|BUG):?"
note: |
  Mark technical debt: # TODO(user): description
  Track in issue system. Examples:
  # TODO(alice): Add retry logic for network failures
  # FIXME: Breaks with filenames containing spaces
  # HACK: Workaround for shellcheck false positive

---
id: bash-quality-testable-function-design
language: bash
severity: warning
message: "Quality: Functions should be designed for testability"
tags:
  - quality
  - testing
rule:
  kind: function_design
  pattern: ""
note: |
  Separate concerns for testability: fetch_data(), write_config(), restart_service()
  should be separate functions. Avoid mixing IO, logic, and side effects.
  Testable functions take arguments, return output, don't depend on global state.

---
id: bash-quality-bats-test-structure
language: bash
severity: info
message: "Quality: Use proper Bats test structure"
tags:
  - quality
  - testing
rule:
  kind: test_framework
  pattern: ""
note: |
  Bats tests should have setup(), teardown(), @test() blocks.
  setup() runs before each test, teardown() after.
  @test "description" { ... } is individual test.
  Use run function_name to capture output and status.

---
id: bash-quality-mock-external-commands
language: bash
severity: warning
message: "Quality: Tests should mock external commands"
tags:
  - quality
  - testing
rule:
  kind: test_practice
  pattern: ""
note: |
  Tests must not call real curl, network, or file commands.
  Mock them in setup(): curl() { echo '{"status": "ok"}'; }
  export -f curl to make available to subshells.
  Isolates tests from environment and makes them fast/reliable.

---
id: bash-quality-deep-nesting
language: bash
severity: warning
message: "Quality: Avoid deeply nested control structures (max 4 levels)"
tags:
  - quality
  - complexity
rule:
  kind: nesting_depth
  pattern: "(\\s{8,}|\\t{4,})(if|for|while|case)"
note: |
  Deep nesting (5+ levels) reduces readability. Extract to functions:
  process_item() handles the inner logic. Keep nesting ≤4 levels.
  Benefits: easier to understand, test, modify.

---
id: bash-quality-long-functions
language: bash
severity: warning
message: "Quality: Functions should be short (max ~50 lines)"
tags:
  - quality
  - complexity
rule:
  kind: function_size
  pattern: "[a-zA-Z_]+\\(\\)\\s*\\{[^}]{3000,}\\}"
note: |
  Long functions (100+ lines) are hard to understand, test, reuse.
  Split into smaller functions: validate(), process(), format().
  Benefits: each function does one thing, easier to understand and test.

---
id: bash-quality-complex-conditionals
language: bash
severity: warning
message: "Quality: Simplify complex boolean expressions"
tags:
  - quality
  - complexity
rule:
  kind: conditional
  pattern: "\\[\\[.*&&.*&&.*&&|\\[\\[.*\\|\\|.*\\|\\|.*\\|\\|"
note: |
  Extract complex conditions to functions: all_conditions_met() { ... }
  If [ "$x" -gt 1 ] && [ "$x" -lt 10 ] should be: is_valid_range() { ... }
  Benefits: readability, reusability, easier to test.

---
id: bash-quality-magic-numbers
language: bash
severity: info
message: "Quality: Replace magic numbers with named constants"
tags:
  - quality
  - complexity
rule:
  kind: numeric_literal
  pattern: "sleep\\s+[0-9]{2,}|retry.*[0-9]{2,}|timeout.*[0-9]{2,}"
note: |
  Define constants: readonly WAIT_SECONDS=300; readonly MAX_RETRIES=10
  Then use them: sleep "$WAIT_SECONDS"; for i in $(seq 1 "$MAX_RETRIES")
  Benefits: easier to adjust values, self-documenting, single source of truth.

---
id: bash-quality-shellcheck-sc1xxx
language: bash
severity: warning
message: "Quality: ShellCheck 1000-series are syntax/parsing issues"
tags:
  - quality
  - shellcheck
rule:
  kind: syntax_error
  pattern: ""
note: |
  SC1xxx errors indicate syntax problems: SC1009=parser error, SC1035=unexpected ),
  SC1073=expected 'fi' but found 'done', SC1091=not following sourced file.
  These prevent script from running - must fix immediately.

---
id: bash-quality-shellcheck-sc2xxx
language: bash
severity: warning
message: "Quality: ShellCheck 2000-series are semantic/logic issues"
tags:
  - quality
  - shellcheck
rule:
  kind: semantic_issue
  pattern: ""
note: |
  SC2xxx are logic problems: SC2046=quote to prevent word splitting,
  SC2086=double quote to prevent globbing, SC2164=use cd || exit,
  SC2034=variable appears unused, SC2162=read without -r.
  Fix these to prevent runtime bugs.

---
id: bash-quality-shellcheck-sc3xxx
language: bash
severity: warning
message: "Quality: ShellCheck 3000-series are portability warnings"
tags:
  - quality
  - shellcheck
rule:
  kind: portability_issue
  pattern: ""
note: |
  SC3xxx warn about non-POSIX features: SC3001=process substitution,
  SC3010=[[ ]] syntax, SC3011=here-string, SC3030=arrays, SC3043=local.
  Fix if script must run on POSIX shells (#!/bin/sh).

---
id: bash-quality-disable-shellcheck-warnings
language: bash
severity: info
message: "Quality: When disabling ShellCheck, add justification"
tags:
  - quality
  - shellcheck
rule:
  kind: shellcheck_directive
  pattern: "#\\s*shellcheck\\s+disable=SC[0-9]+$"
note: |
  If disabling ShellCheck rule, explain why:
  # shellcheck disable=SC2086 -- Word splitting intentional for args
  Not just bare disable. Add comment explaining exception.
  Helps future maintainers understand intent.

---
id: bash-quality-trailing-whitespace
language: bash
severity: info
message: "Quality: Remove trailing whitespace"
tags:
  - quality
  - formatting
rule:
  kind: whitespace
  pattern: "[ \\t]+$"
note: |
  Trailing spaces/tabs are invisible and serve no purpose. Configure editor
  to auto-trim or use: sed 's/[[:space:]]*$//'. Clean whitespace improves
  diffs and version control history.

---
id: bash-quality-semicolon-usage
language: bash
severity: info
message: "Quality: Use semicolons appropriately in compound commands"
tags:
  - quality
  - formatting
rule:
  kind: compound_command
  pattern: "then\\s*$|do\\s*$"
note: |
  Compound commands need semicolons or newlines: if cond; then (semicolon)
  or 'if cond' with 'then' on next line. Google style: then/do on same line
  with semicolon: if condition; then ... fi

---
id: bash-quality-blank-line-consistency
language: bash
severity: info
message: "Quality: Use consistent blank lines between sections"
tags:
  - quality
  - formatting
rule:
  kind: blank_lines
  pattern: "\\n{4,}"
note: |
  One blank line between functions, two between major sections. Multiple
  consecutive blank lines create visual clutter. Organize sections:
  constants, globals, functions, main. Separate each with blank lines.

---
id: bash-quality-command-substitution-style
language: bash
severity: info
message: "Quality: Use $() instead of backticks consistently"
tags:
  - quality
  - formatting
rule:
  kind: command_substitution
  pattern: "`[^`]+`"
note: |
  Modern style: result=$(command) not result=`command`.
  Backticks are legacy. Advantages of $(): nests easily, more readable,
  recommended by shellcheck SC2006.

---
id: bash-quality-operator-spacing
language: bash
severity: info
message: "Quality: Use consistent spacing around operators"
tags:
  - quality
  - formatting
rule:
  kind: operator
  pattern: "=[^\\s=]|[^\\s]=|\\$\\(\\(.*[^ ]+[\\+\\-\\*/%][^ ]+.*\\)\\)"
note: |
  Consistent spacing improves readability: x=$((1 + 2)) not x=$((1+2)).
  result=$((a + b * c)) not result=$((a+b*c)).
  In [ ], use spaces: [ "$var" = "value" ] not [ "$var"="value" ].

---
id: bash-quality-structured-logging
language: bash
severity: info
message: "Quality: Use structured, leveled logging"
tags:
  - quality
  - logging
rule:
  kind: logging_call
  pattern: "echo\\s+[\"']ERROR|echo\\s+[\"']INFO|echo\\s+[\"']DEBUG"
note: |
  Define log functions with levels: log_info(), log_warn(), log_error().
  Include timestamp: timestamp=$(date '+%Y-%m-%d %H:%M:%S').
  Output to stderr: echo "[timestamp] [LEVEL] message" >&2
  Benefits: machine-parseable, consistent format, supports log analysis.

---
id: bash-quality-log-file-handling
language: bash
severity: warning
message: "Quality: Handle log files properly"
tags:
  - quality
  - logging
rule:
  kind: file_append
  pattern: ">>\\s*/var/log/.*(?!.*logrotate)"
note: |
  Logs that append forever cause disk space issues. Use:
  1. logger command (sends to syslog, handled by logrotate)
  2. Implement rotation: check size, mv old, create new
  3. Configure logrotate in /etc/logrotate.d/
  Never just echo >> /var/log/file.log without rotation.

---
id: bash-quality-verbose-mode
language: bash
severity: info
message: "Quality: Implement verbose mode for debugging"
tags:
  - quality
  - logging
rule:
  kind: function_feature
  pattern: ""
note: |
  Add -v flag to enable verbose output. Store in VERBOSE=false variable.
  Use: $VERBOSE && echo "[VERBOSE] message" >&2
  Or set -x for shell debugging. Helps users troubleshoot without reading code.

---
id: bash-quality-progress-indication
language: bash
severity: info
message: "Quality: Provide progress for long operations"
tags:
  - quality
  - logging
rule:
  kind: loop
  pattern: "for.*in.*do.*\\n.*done(?!.*echo|printf)"
note: |
  Long loops should show progress: printf '\\rProcessing: %d/%d' "$curr" "$total"
  Or use pv: find . | pv -l | while read file. Users get feedback that
  script is working (not hung). Use \\r to overwrite same line.

---
id: bash-quality-audit-logging
language: bash
severity: warning
message: "Quality: Log security-relevant operations"
tags:
  - quality
  - logging
rule:
  kind: security_operation
  pattern: "(rm|chmod|chown|sudo).*(?!.*log)"
note: |
  Destructive operations (rm, chmod, chown) and privilege operations (sudo)
  should be logged for audit: audit_log() { logger -t app-audit "$(whoami): $*"; }
  Use auth.info facility: logger -t app -p auth.info "message".
  Benefits: security auditing, compliance, incident investigation.
# Python Code Quality Rules - Anti-patterns and Best Practices
# Comprehensive ruleset covering PEP 8, type hints, docstrings, exception handling,
# complexity, magic numbers, mutable defaults, global state, class design, testing,
# imports, and Pythonic idioms
# Rules: 78 total

---
id: python-quality-line-length
language: python
severity: warning
message: "PEP 8: Line exceeds 79 characters (hard limit) or 99 characters (soft limit)"
tags:
  - quality
  - pep8
  - style
rule:
  kind: any
  pattern: |
    def check_line_length(line):
      return len(line) > 79
note: |
  PEP 8 recommends maximum line length of 79 characters for code and 72 for comments/docstrings.
  Many teams use 99 as a practical limit. Consistent line length improves readability.
  BEST PRACTICE: Use a formatter like black (88 chars) or autopep8 automatically.

---
id: python-quality-trailing-whitespace
language: python
severity: info
message: "Style: Remove trailing whitespace"
tags:
  - quality
  - pep8
  - style
rule:
  kind: any
  pattern: |
    / +$/
note: |
  Trailing whitespace is unnecessary and can cause issues with version control.
  Use editor settings or pre-commit hooks to strip automatically.

---
id: python-quality-missing-docstring-module
language: python
severity: warning
message: "Docstring: Module-level docstring is missing"
tags:
  - quality
  - docstrings
rule:
  kind: module
  pattern: |
    module without string_literal at position 0
note: |
  Every module should have a docstring describing its purpose.
  Place a docstring as the first statement in the file.
  EXAMPLE:
    '''
    This module provides utilities for data validation.
    '''

---
id: python-quality-missing-docstring-function
language: python
severity: warning
message: "Docstring: Function missing docstring"
tags:
  - quality
  - docstrings
rule:
  kind: function_definition
  pattern: |
    function_definition without docstring
note: |
  Public functions should have docstrings explaining parameters, return value, and purpose.
  Use Google, NumPy, or Sphinx style consistently across the project.
  EXAMPLE:
    def calculate_sum(a, b):
        '''Calculate sum of two numbers.

        Args:
            a: First number
            b: Second number

        Returns:
            Sum of a and b
        '''
        return a + b

---
id: python-quality-missing-docstring-class
language: python
severity: warning
message: "Docstring: Class missing docstring"
tags:
  - quality
  - docstrings
rule:
  kind: class_definition
  pattern: |
    class_definition without docstring
note: |
  Classes should document their purpose, attributes, and usage.
  Include information about initialization parameters.

---
id: python-quality-incomplete-docstring
language: python
severity: warning
message: "Docstring: Incomplete docstring (missing Args/Returns sections)"
tags:
  - quality
  - docstrings
rule:
  kind: function_definition
  pattern: |
    docstring without "Args:" and "Returns:"
note: |
  Complete docstrings should document all parameters and return values.
  Incomplete documentation can lead to misuse of functions.

---
id: python-quality-bare-except
language: python
severity: error
message: "Exception: Bare except clause catches all exceptions including SystemExit and KeyboardInterrupt"
tags:
  - quality
  - exception-handling
rule:
  kind: except_clause
  pattern: |
    except:
note: |
  NEVER use bare except:. It catches BaseException, including SystemExit, KeyboardInterrupt, etc.
  Catch specific exceptions or use 'except Exception:' as minimum.
  ANTI-PATTERN:
    try:
        risky_operation()
    except:
        pass

  BEST PRACTICE:
    try:
        risky_operation()
    except ValueError as e:
        logger.error(f"Invalid input: {e}")

---
id: python-quality-broad-exception
language: python
severity: warning
message: "Exception: Catching Exception is too broad, catch specific exceptions"
tags:
  - quality
  - exception-handling
rule:
  kind: except_clause
  pattern: |
    except Exception as $VAR
note: |
  Catching all Exception instances masks bugs and makes debugging harder.
  Catch specific exceptions or use logging to understand what went wrong.
  BETTER:
    except (ValueError, KeyError) as e:
        handle_error(e)

---
id: python-quality-silent-except
language: python
severity: error
message: "Exception: Except clause silently ignores exceptions, should log or handle"
tags:
  - quality
  - exception-handling
rule:
  kind: except_clause
  pattern: |
    except:
        pass
note: |
  Silently ignoring exceptions makes bugs impossible to track.
  At minimum, use logging to record what failed.
  ANTI-PATTERN:
    try:
        connect_to_database()
    except Exception:
        pass  # BUG: Database failure hidden!

  BEST PRACTICE:
    try:
        connect_to_database()
    except DatabaseError as e:
        logger.error(f"Failed to connect: {e}")
        raise  # Re-raise or handle appropriately

---
id: python-quality-except-without-as
language: python
severity: info
message: "Exception: Capture exception in 'as' variable for debugging"
tags:
  - quality
  - exception-handling
rule:
  kind: except_clause
  pattern: |
    except $TYPE:
note: |
  Without capturing the exception, you lose the traceback and message.
  Use 'except Type as e:' to access error details.

---
id: python-quality-missing-type-hints
language: python
severity: info
message: "Type Hints: Function missing parameter or return type annotations"
tags:
  - quality
  - type-hints
rule:
  kind: function_definition
  pattern: |
    function_definition without type_annotation
note: |
  Type hints improve code clarity, enable static type checking (mypy, pyright),
  and help IDEs provide better autocomplete.
  ANTI-PATTERN:
    def process_data(items, max_size):
        return [x for x in items if len(x) <= max_size]

  BEST PRACTICE:
    def process_data(items: list[str], max_size: int) -> list[str]:
        return [x for x in items if len(x) <= max_size]

---
id: python-quality-any-type-hint
language: python
severity: warning
message: "Type Hints: Avoid using 'Any' type, prefer specific types"
tags:
  - quality
  - type-hints
rule:
  kind: any
  pattern: |
    : Any
note: |
  Using 'Any' defeats the purpose of type checking and hides bugs.
  Use Union types, TypeVar, or Protocol for flexibility when needed.
  ANTI-PATTERN:
    def process(data: Any) -> Any:
        return data

  BETTER:
    from typing import TypeVar
    T = TypeVar('T')
    def process(data: T) -> T:
        return data

---
id: python-quality-untyped-parameter
language: python
severity: info
message: "Type Hints: Parameter '$1' lacks type annotation"
tags:
  - quality
  - type-hints
rule:
  kind: function_definition
  pattern: |
    parameters without type annotation
note: |
  All function parameters should have type hints for clarity and static analysis.
  This is especially important in public APIs.

---
id: python-quality-untyped-return
language: python
severity: info
message: "Type Hints: Function return type not annotated"
tags:
  - quality
  - type-hints
rule:
  kind: function_definition
  pattern: |
    return_type not annotated
note: |
  Documenting return types helps users understand what a function produces.
  Include -> ReturnType before the colon in function definition.

---
id: python-quality-magic-number
language: python
severity: warning
message: "Magic Number: Hardcoded numeric constant '$1' should be a named constant"
tags:
  - quality
  - magic-numbers
rule:
  kind: any
  pattern: |
    ([-+]?[0-9]+(\.[0-9]+)?) [^=] (except for 0, 1, 2, -1)
note: |
  Magic numbers make code hard to maintain. Use named constants to clarify intent.
  ANTI-PATTERN:
    if user_age > 18:
        if connection_attempts > 5:
            timeout = 300

  BEST PRACTICE:
    MIN_AGE = 18
    MAX_RETRIES = 5
    TIMEOUT_SECONDS = 300

    if user_age > MIN_AGE:
        if connection_attempts > MAX_RETRIES:
            timeout = TIMEOUT_SECONDS

---
id: python-quality-magic-string
language: python
severity: warning
message: "Magic String: Hardcoded string literal should be a named constant"
tags:
  - quality
  - magic-numbers
rule:
  kind: any
  pattern: |
    "([a-zA-Z_][a-zA-Z0-9_]*\.)+[a-zA-Z_]"
note: |
  Hardcoded strings for configuration, status codes, etc. should be constants.
  ANTI-PATTERN:
    if status == "pending":
        process()
    if status == "pending":  # Repeated magic string!
        notify()

  BEST PRACTICE:
    STATUS_PENDING = "pending"
    if status == STATUS_PENDING:
        process()
    if status == STATUS_PENDING:
        notify()

---
id: python-quality-mutable-default-argument
language: python
severity: error
message: "Mutable Default: Function uses mutable default argument (list, dict, set)"
tags:
  - quality
  - mutable-defaults
rule:
  kind: function_definition
  pattern: |
    default_argument with (list|dict|set) literal
note: |
  Mutable default arguments are shared between function calls, causing subtle bugs.
  ANTI-PATTERN (BUG):
    def append_item(item, items=[]):
        items.append(item)
        return items

    list1 = append_item(1)  # [1]
    list2 = append_item(2)  # [1, 2] -- BUG! Same list!

  BEST PRACTICE:
    def append_item(item, items=None):
        if items is None:
            items = []
        items.append(item)
        return items

---
id: python-quality-global-variable
language: python
severity: warning
message: "Global State: Global variable declaration reduces testability and causes side effects"
tags:
  - quality
  - global-state
rule:
  kind: global_statement
  pattern: |
    global $VAR
note: |
  Global variables make code hard to test and reason about.
  Use class attributes, function parameters, or dependency injection instead.
  ANTI-PATTERN:
    cache = {}

    def get_data(key):
        if key in cache:
            return cache[key]
        # ... fetch ...
        cache[key] = result
        return result

  BEST PRACTICE:
    class DataFetcher:
        def __init__(self):
            self.cache = {}

        def get_data(self, key):
            if key in self.cache:
                return self.cache[key]
            # ... fetch ...
            self.cache[key] = result
            return result

---
id: python-quality-long-function
language: python
severity: warning
message: "Complexity: Function is too long (>50 lines), should be refactored"
tags:
  - quality
  - complexity
rule:
  kind: function_definition
  pattern: |
    function_definition with body > 50 lines
note: |
  Long functions are harder to test, understand, and maintain.
  Extract logical units into separate functions.
  GUIDELINE: Aim for functions <30 lines. Breaking at 50 is urgent.
  Use extract_method refactoring to create focused helper functions.

---
id: python-quality-deep-nesting
language: python
severity: warning
message: "Complexity: Code nested >3 levels deep, consider refactoring"
tags:
  - quality
  - complexity
rule:
  kind: any
  pattern: |
    indentation_level > 3
note: |
  Deep nesting indicates complex control flow. Extract into helper functions or use early returns.
  ANTI-PATTERN:
    def process():
        for item in items:
            if item.is_valid():
                if item.is_active():
                    if item.has_data():
                        if item.data_is_clean():
                            process_item(item)

  BEST PRACTICE:
    def process():
        for item in items:
            if should_process(item):
                process_item(item)

    def should_process(item):
        return (item.is_valid() and item.is_active() and
                item.has_data() and item.data_is_clean())

---
id: python-quality-cyclomatic-complexity
language: python
severity: warning
message: "Complexity: High cyclomatic complexity (>10), function too complex"
tags:
  - quality
  - complexity
rule:
  kind: function_definition
  pattern: |
    function_definition with (if|elif|for|while|and|or) count > 10
note: |
  High cyclomatic complexity means many code paths and test cases needed.
  Break into smaller functions with single responsibility.
  Use decision tables, polymorphism, or state machines for complex logic.

---
id: python-quality-god-class
language: python
severity: warning
message: "Class Design: Class has too many methods (>15), violates single responsibility"
tags:
  - quality
  - class-design
rule:
  kind: class_definition
  pattern: |
    class_definition with method_count > 15
note: |
  Classes with too many methods are often god objects doing too much.
  Split into smaller, focused classes using composition.
  ANTI-PATTERN:
    class UserManager:
        def validate_email(self): ...
        def hash_password(self): ...
        def send_email(self): ...
        def log_activity(self): ...
        def update_database(self): ...
        # ... 10+ more methods

  BETTER:
    class UserValidator:
        def validate_email(self): ...

    class PasswordManager:
        def hash_password(self): ...

    class UserRepository:
        def save(self): ...

---
id: python-quality-class-too-many-attributes
language: python
severity: warning
message: "Class Design: Class has too many attributes (>10), consider grouping"
tags:
  - quality
  - class-design
rule:
  kind: class_definition
  pattern: |
    class_definition with attribute_count > 10
note: |
  Classes with many attributes are often doing too much.
  Group related attributes into sub-objects.

---
id: python-quality-missing-init
language: python
severity: info
message: "Class Design: Class attributes should be initialized in __init__"
tags:
  - quality
  - class-design
rule:
  kind: class_definition
  pattern: |
    class_attribute assignment outside __init__
note: |
  Class variables can be accidentally shared between instances. Use __init__ for instance attributes.
  ANTI-PATTERN:
    class User:
        friends = []  # Shared between all instances!

  BETTER:
    class User:
        def __init__(self):
            self.friends = []

---
id: python-quality-unused-import
language: python
severity: info
message: "Imports: Unused import '$1' should be removed"
tags:
  - quality
  - imports
rule:
  kind: import_statement
  pattern: |
    import not referenced in code
note: |
  Unused imports clutter code and slow down startup.
  Use tools like autoflake or isort to clean automatically.
  Most IDEs highlight unused imports.

---
id: python-quality-circular-import
language: python
severity: error
message: "Imports: Circular import detected between modules"
tags:
  - quality
  - imports
rule:
  kind: import_statement
  pattern: |
    imports creating cycle
note: |
  Circular imports cause "partially initialized module" errors at runtime.
  SOLUTIONS:
  1. Move shared code to a third module
  2. Use TYPE_CHECKING guard for forward references
  3. Import inside functions (lazy import)
  4. Refactor to eliminate dependency

  EXAMPLE (circular):
    # user.py
    from order import Order

    # order.py
    from user import User  # CYCLE!

  SOLUTION:
    # user.py
    if TYPE_CHECKING:
        from order import Order

---
id: python-quality-import-order
language: python
severity: info
message: "Imports: Imports not organized (stdlib, 3rd party, local)"
tags:
  - quality
  - imports
rule:
  kind: module
  pattern: |
    imports not grouped correctly
note: |
  PEP 8 recommends organizing imports:
  1. Standard library (os, sys, json, ...)
  2. Third-party (requests, numpy, ...)
  3. Local (from . import utils)

  Separate groups with blank lines. Use isort tool to fix automatically.

---
id: python-quality-import-star
language: python
severity: warning
message: "Imports: Avoid 'from module import *', import specific names"
tags:
  - quality
  - imports
rule:
  kind: import_statement
  pattern: |
    from $module import \*
note: |
  'import *' pollutes namespace, makes dependencies unclear, and breaks refactoring.
  ANTI-PATTERN:
    from utils import *  # What's imported? Where do functions come from?

  BETTER:
    from utils import format_name, validate_email

---
id: python-quality-lbyl-over-eafp
language: python
severity: info
message: "Pythonic: LBYL pattern, use EAFP (Easier to Ask for Forgiveness than Permission)"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    if hasattr or if isinstance checking before use
note: |
  Python favors EAFP (try/except) over LBYL (check before use).
  LBYL (not Pythonic):
    if isinstance(obj, dict) and 'key' in obj:
        value = obj['key']

  EAFP (Pythonic):
    try:
        value = obj['key']
    except (TypeError, KeyError) as e:
        handle_error(e)

---
id: python-quality-len-for-empty-check
language: python
severity: info
message: "Pythonic: Avoid 'len(seq) > 0', use truthiness directly"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    len($VAR) (==|!=|>|<) 0
note: |
  Sequences are truthy if non-empty, falsy if empty.
  ANTI-PATTERN:
    if len(items) > 0:
        process(items)

  PYTHONIC:
    if items:
        process(items)

---
id: python-quality-comparison-to-none
language: python
severity: warning
message: "Pythonic: Use 'is None', not '== None'"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    \s==\s*None|\s!=\s*None
note: |
  None is a singleton. Use 'is' and 'is not' for identity comparison.
  ANTI-PATTERN:
    if value == None:
        do_something()

  CORRECT:
    if value is None:
        do_something()

---
id: python-quality-comparison-to-true-false
language: python
severity: warning
message: "Pythonic: Avoid '== True/False', use truthiness directly"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    (==|!=)\s*(True|False)
note: |
  Booleans are already truthy/falsy. Direct comparison is redundant.
  ANTI-PATTERN:
    if result == True:
        proceed()

  PYTHONIC:
    if result:
        proceed()

---
id: python-quality-comprehension-over-map
language: python
severity: info
message: "Pythonic: Use list/dict comprehension instead of map/filter"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    map\(|filter\(
note: |
  List comprehensions are more readable, faster, and more Pythonic than map/filter.
  ANTI-PATTERN:
    result = list(map(lambda x: x*2, items))

  PYTHONIC:
    result = [x*2 for x in items]

---
id: python-quality-enumerate-over-range-len
language: python
severity: info
message: "Pythonic: Use enumerate() instead of range(len())"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    for.*in range\(len\(
note: |
  enumerate() provides both index and value, cleaner and faster.
  ANTI-PATTERN:
    for i in range(len(items)):
        print(i, items[i])

  PYTHONIC:
    for i, item in enumerate(items):
        print(i, item)

---
id: python-quality-zip-over-zip-longest
language: python
severity: info
message: "Pythonic: Consider zip() vs zip_longest() based on intent"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    zip\(.*\)
note: |
  zip() stops at shortest sequence, zip_longest() pads with fillvalue.
  Choose based on whether mismatched lengths are an error or acceptable.

---
id: python-quality-f-string-over-format
language: python
severity: info
message: "Pythonic: Use f-strings instead of .format() or % formatting"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    \.format\(|%\s+\(
note: |
  F-strings (Python 3.6+) are faster, more readable, and less error-prone.
  ANTI-PATTERN:
    message = "Hello, {}".format(name)
    message = "Hello, %s" % name

  PYTHONIC:
    message = f"Hello, {name}"

---
id: python-quality-context-manager-file
language: python
severity: error
message: "Resource: File opened without 'with' statement, resource leak risk"
tags:
  - quality
  - resources
rule:
  kind: any
  pattern: |
    open\([^)]*\) (without with)
note: |
  Files must be closed properly. Use 'with' statement for automatic cleanup.
  ANTI-PATTERN (resource leak):
    f = open("data.txt")
    data = f.read()
    # File not closed if exception occurs!

  CORRECT:
    with open("data.txt") as f:
        data = f.read()
    # Guaranteed to close, even on exception

---
id: python-quality-missing-init-subclass
language: python
severity: info
message: "Class Design: Subclass should call super().__init__()"
tags:
  - quality
  - class-design
rule:
  kind: class_definition
  pattern: |
    __init__ without super().__init__() call
note: |
  Not calling super() can break initialization of parent classes.
  CORRECT:
    class Child(Parent):
        def __init__(self, value):
            super().__init__()
            self.value = value

---
id: python-quality-assert-in-production
language: python
severity: warning
message: "Testing: 'assert' in production code, use proper validation and exceptions"
tags:
  - quality
  - testing
rule:
  kind: any
  pattern: |
    assert
note: |
  Assertions are removed with 'python -O', unreliable for validation.
  Use explicit exception raising and validation.
  ANTI-PATTERN:
    def process(data):
        assert data is not None  # Can be disabled!

  CORRECT:
    def process(data):
        if data is None:
            raise ValueError("data cannot be None")

---
id: python-quality-fixture-scope
language: python
severity: info
message: "Testing: pytest fixture scope unclear, consider session/module/function"
tags:
  - quality
  - testing
rule:
  kind: any
  pattern: |
    @pytest\.fixture without scope parameter
note: |
  Explicitly specify fixture scope for clarity and correct cleanup.
  - 'function': Re-created for each test (default)
  - 'module': Shared across module
  - 'session': Shared across entire test run

  BETTER:
    @pytest.fixture(scope="function")
    def fresh_db():
        ...

---
id: python-quality-test-without-assertion
language: python
severity: error
message: "Testing: Test function has no assertions, won't verify anything"
tags:
  - quality
  - testing
rule:
  kind: function_definition
  pattern: |
    test_.*\(.*\) without assert
note: |
  Tests without assertions can't fail, making them useless.
  Every test should verify expected behavior with assert or pytest.raises().

---
id: python-quality-hardcoded-test-paths
language: python
severity: warning
message: "Testing: Hardcoded file path in test, use fixtures or tmpdir"
tags:
  - quality
  - testing
rule:
  kind: any
  pattern: |
    "/home/user|C:\\\\Users|/Users"
note: |
  Hardcoded paths break tests on different machines.
  Use pytest's tmpdir, tmp_path, or monkeypatch fixtures.

---
id: python-quality-print-instead-of-logging
language: python
severity: warning
message: "Logging: Use logging module instead of print()"
tags:
  - quality
  - logging
rule:
  kind: any
  pattern: |
    print\(
note: |
  print() can't be configured or disabled. Use logging for production code.
  ANTI-PATTERN:
    print("Error:", e)

  CORRECT:
    logger.error(f"Error: {e}")

---
id: python-quality-string-concatenation-in-loop
language: python
severity: warning
message: "Performance: String concatenation in loop, use list and join()"
tags:
  - quality
  - performance
rule:
  kind: any
  pattern: |
    \+= (inside for|while loop) with string
note: |
  String concatenation creates new strings each iteration (quadratic time).
  ANTI-PATTERN (slow):
    result = ""
    for word in words:
        result += word + " "  # O(n²)

  FASTER:
    result = " ".join(words)  # O(n)

---
id: python-quality-dict-get-over-indexing
language: python
severity: info
message: "Pythonic: Use dict.get() instead of indexing with try/except"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    \[$VAR\] (inside try)
note: |
  dict.get() is clearer and more concise than try/except for optional keys.
  ANTI-PATTERN:
    try:
        value = config['timeout']
    except KeyError:
        value = 30

  PYTHONIC:
    value = config.get('timeout', 30)

---
id: python-quality-unpacking-over-indexing
language: python
severity: info
message: "Pythonic: Use unpacking instead of indexing tuples/lists"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    \[0\].*=.*|tuple_var\[1\]
note: |
  Unpacking is more readable and self-documenting.
  ANTI-PATTERN:
    name = data[0]
    age = data[1]

  PYTHONIC:
    name, age = data

---
id: python-quality-walrus-operator
language: python
severity: info
message: "Pythonic: Consider walrus operator :=  for assignment in expressions"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    if.*in.*\(
note: |
  Walrus operator (Python 3.8+) can simplify code that assigns and tests.
  BEFORE:
    if match := regex.search(text):
        process(match)

  MODERN:
    if (match := regex.search(text)):
        process(match)

---
id: python-quality-missing-slots
language: python
severity: info
message: "Performance: Class might benefit from __slots__ to reduce memory"
tags:
  - quality
  - performance
rule:
  kind: class_definition
  pattern: |
    class with many simple attributes and no __slots__
note: |
  __slots__ prevents __dict__ creation, saving memory for simple classes.
  Useful for classes with many instances and few attributes.
  EXAMPLE:
    class Point:
        __slots__ = ('x', 'y')
        def __init__(self, x, y):
            self.x = x
            self.y = y

---
id: python-quality-method-could-be-static
language: python
severity: info
message: "Class Design: Method doesn't use 'self', should be @staticmethod"
tags:
  - quality
  - class-design
rule:
  kind: method_definition
  pattern: |
    method without 'self' parameter usage
note: |
  Methods not using 'self' should be static methods or module functions.
  ANTI-PATTERN:
    class Utils:
        def format_date(date):
            return date.strftime("%Y-%m-%d")

  BETTER:
    class Utils:
        @staticmethod
        def format_date(date):
            return date.strftime("%Y-%m-%d")

---
id: python-quality-classmethod-vs-staticmethod
language: python
severity: info
message: "Class Design: Consider @classmethod vs @staticmethod intent"
tags:
  - quality
  - class-design
rule:
  kind: any
  pattern: |
    @staticmethod
note: |
  @classmethod for factory methods and operations on class.
  @staticmethod for utility functions grouped in a class.
  Choose based on whether you need class context.

---
id: python-quality-property-setter-complexity
language: python
severity: warning
message: "Class Design: @property setter too complex, should be a method"
tags:
  - quality
  - class-design
rule:
  kind: property_definition
  pattern: |
    setter with complex logic
note: |
  Properties should be simple attribute access. Complex validation/computation
  should use explicit methods for clarity.
  ANTI-PATTERN:
    @value.setter
    def value(self, v):
        if not self.is_valid(v):
            raise ValueError()
        self._value = v
        self.update_cache()
        self.notify_observers()

  BETTER:
    def set_value(self, v):
        """Explicitly named for complex operation."""
        if not self.is_valid(v):
            raise ValueError()
        self._value = v
        self.update_cache()
        self.notify_observers()

---
id: python-quality-exception-hierarchy
language: python
severity: warning
message: "Exception: Custom exceptions should inherit from Exception, not BaseException"
tags:
  - quality
  - exception-handling
rule:
  kind: class_definition
  pattern: |
    class $NAME(BaseException)
note: |
  Only SystemExit, KeyboardInterrupt, GeneratorExit should inherit BaseException.
  Custom exceptions should inherit from Exception or more specific built-ins.

---
id: python-quality-too-many-arguments
language: python
severity: warning
message: "Function: Too many parameters (>5), consider using configuration object"
tags:
  - quality
  - complexity
rule:
  kind: function_definition
  pattern: |
    function_definition with parameter_count > 5
note: |
  Functions with many parameters are hard to use and understand.
  Group related parameters into a configuration class or dataclass.
  ANTI-PATTERN:
    def create_user(name, email, age, address, phone, bio, website, github):
        ...

  BETTER:
    @dataclass
    class UserProfile:
        name: str
        email: str
        age: int
        address: str
        phone: str
        bio: str
        website: str
        github: str

    def create_user(profile: UserProfile):
        ...

---
id: python-quality-side-effect-in-init
language: python
severity: warning
message: "Class Design: __init__ has side effects (I/O, network), should be lazy"
tags:
  - quality
  - global-state
rule:
  kind: function_definition
  pattern: |
    __init__ with (network|file|database|external) operation
note: |
  __init__ should initialize state, not perform I/O. Makes testing and composition harder.
  Use separate initialization method or lazy loading.
  ANTI-PATTERN:
    class Database:
        def __init__(self, connection_string):
            self.conn = psycopg2.connect(connection_string)
            self.cursor = self.conn.cursor()

  BETTER:
    class Database:
        def __init__(self, connection_string):
            self.connection_string = connection_string
            self._conn = None

        def connect(self):
            self._conn = psycopg2.connect(self.connection_string)
            return self._conn.cursor()

---
id: python-quality-isinstance-over-type-checking
language: python
severity: info
message: "Pythonic: Use isinstance() instead of type() for checks"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    type\($VAR\) ==
note: |
  isinstance() respects inheritance, type() doesn't.
  ANTI-PATTERN:
    if type(obj) == MyClass:  # Fails for subclasses

  PYTHONIC:
    if isinstance(obj, MyClass):  # Works with inheritance

---
id: python-quality-bare-raise
language: python
severity: info
message: "Exception: Use bare 'raise' in except clause to preserve traceback"
tags:
  - quality
  - exception-handling
rule:
  kind: any
  pattern: |
    raise $exception (in except clause without bare raise)
note: |
  Bare 'raise' preserves original traceback. Raising new exception loses context.
  ANTI-PATTERN (loses traceback):
    except ValueError as e:
        raise RuntimeError("Bad value")  # Original traceback lost

  BETTER (preserves traceback):
    except ValueError as e:
        logger.error(f"Bad value: {e}")
        raise  # Re-raises original exception with traceback

---
id: python-quality-raise-without-context
language: python
severity: warning
message: "Exception: Use 'raise ... from e' to preserve exception chain"
tags:
  - quality
  - exception-handling
rule:
  kind: any
  pattern: |
    raise $new_exception (without from)
note: |
  'raise from' documents the exception chain and is clearer for debugging.
  ANTI-PATTERN:
    except DatabaseError as e:
        raise ApplicationError("Database failed")  # Chain lost

  BETTER:
    except DatabaseError as e:
        raise ApplicationError("Database failed") from e

---
id: python-quality-complex-lambda
language: python
severity: warning
message: "Code Quality: Lambda too complex, should be a named function"
tags:
  - quality
  - complexity
rule:
  kind: lambda_expression
  pattern: |
    lambda with multiple statements or complex logic
note: |
  Lambdas should be simple. Use def for readable, reusable logic.
  ANTI-PATTERN:
    f = lambda x: x*2 if x > 0 else -x if x < 0 else 0

  BETTER:
    def normalize(x):
        if x > 0:
            return x * 2
        elif x < 0:
            return -x
        return 0

---
id: python-quality-mutable-constant
language: python
severity: warning
message: "Code Quality: Mutable value assigned to constant (all-caps), should use immutable"
tags:
  - quality
  - magic-numbers
rule:
  kind: any
  pattern: |
    [A-Z_]+ = \[|[A-Z_]+ = \{
note: |
  ALL_CAPS convention suggests constants, but lists/dicts are mutable.
  Use tuples for immutable collections, or clarify intent.
  ANTI-PATTERN:
    VALID_NAMES = ["john", "jane"]  # Could be accidentally modified

  BETTER:
    VALID_NAMES = ("john", "jane")  # Immutable tuple

---
id: python-quality-default-mutable-in-function
language: python
severity: error
message: "Mutable Default: Parameters like list/dict default to shared instance"
tags:
  - quality
  - mutable-defaults
rule:
  kind: function_definition
  pattern: |
    default parameter is list|dict|set literal
note: |
  This is a classic Python gotcha. Same mutable object reused across calls.
  See: python-quality-mutable-default-argument rule for examples.

---
id: python-quality-tuple-unpacking-in-except
language: python
severity: warning
message: "Exception: Tuple unpacking in except clause may not work as expected"
tags:
  - quality
  - exception-handling
rule:
  kind: except_clause
  pattern: |
    except \(.*,.*\):
note: |
  'except (ValueError, TypeError):' is correct for multiple exceptions.
  'except ValueError, TypeError:' is Python 2 syntax, invalid in Python 3.
  Always use parentheses.

---
id: python-quality-unreachable-code
language: python
severity: warning
message: "Code Quality: Unreachable code after return/raise/break/continue"
tags:
  - quality
  - complexity
rule:
  kind: any
  pattern: |
    (return|raise|break|continue) followed by statements
note: |
  Code after final return/raise/break/continue never executes.
  Remove or move to separate function/block.

---
id: python-quality-dict-creation
language: python
severity: info
message: "Pythonic: Use dict comprehension or dict() constructor instead of loop"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    d = {}.*for
note: |
  Dict comprehensions are faster and more Pythonic.
  ANTI-PATTERN:
    d = {}
    for key, value in items:
        d[key] = value

  PYTHONIC:
    d = {key: value for key, value in items}

---
id: python-quality-identity-vs-equality
language: python
severity: warning
message: "Pythonic: Use 'is' for singleton comparison, '==' for value comparison"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    == with (True|False|None)
note: |
  'is' checks identity (same object), '==' checks equality (same value).
  None, True, False are singletons - use 'is'.
  Custom objects: use '==' unless checking same object in memory.

---
id: python-quality-attribute-access-safety
language: python
severity: info
message: "Pythonic: Use getattr() with default instead of hasattr() + getattr()"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    hasattr\(\$obj, \$attr\).*getattr\(\$obj, \$attr\)
note: |
  Two calls is redundant. getattr() with default does both atomically.
  ANTI-PATTERN:
    if hasattr(obj, 'method'):
        result = getattr(obj, 'method')()

  PYTHONIC:
    method = getattr(obj, 'method', None)
    if method:
        result = method()

---
id: python-quality-with-statement-multiple
language: python
severity: info
message: "Pythonic: Use multiple context managers in one 'with' statement"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    with.*with nested
note: |
  Python 3.1+ supports multiple context managers in one 'with'.
  ANTI-PATTERN:
    with open("in.txt") as inp:
        with open("out.txt", "w") as out:
            ...

  PYTHONIC (Python 3.1+):
    with open("in.txt") as inp, open("out.txt", "w") as out:
        ...

---
id: python-quality-super-usage
language: python
severity: info
message: "Python 3: Use parameterless super() instead of super(ClassName, self)"
tags:
  - quality
  - pythonic-idioms
rule:
  kind: any
  pattern: |
    super\([A-Za-z_], self\)
note: |
  Python 3 allows parameterless super() which is cleaner and works with metaclasses.
  PYTHON 2 STYLE:
    super(MyClass, self).__init__()

  PYTHON 3 STYLE:
    super().__init__()

---
id: python-quality-return-outside-function
language: python
severity: error
message: "Syntax: 'return' used outside function, only valid in function/method"
tags:
  - quality
  - syntax
rule:
  kind: return_statement
  pattern: |
    return outside function_definition
note: |
  'return' can only appear inside functions. Use 'raise SystemExit' for scripts or exit().
  Check indentation - may indicate missing function definition.

---
id: python-quality-yield-in-finally
language: python
severity: warning
message: "Code Quality: 'yield' in finally block, unpredictable behavior"
tags:
  - quality
  - complexity
rule:
  kind: function_definition
  pattern: |
    finally block containing yield
note: |
  Yielding in finally causes strange control flow. Avoid mixing generators and cleanup.

---
id: python-quality-division-by-zero-risk
language: python
severity: warning
message: "Code Quality: Division operation, ensure divisor is not zero"
tags:
  - quality
  - runtime-safety
rule:
  kind: any
  pattern: |
    / 0|// 0|% 0
note: |
  Division by zero raises ZeroDivisionError. Validate denominator.
  ANTI-PATTERN:
    result = total / count  # What if count is 0?

  SAFE:
    result = total / count if count else 0

---
id: python-quality-list-modification-during-iteration
language: python
severity: error
message: "Runtime Safety: Modifying list during iteration causes undefined behavior"
tags:
  - quality
  - runtime-safety
rule:
  kind: any
  pattern: |
    for.*in (list|items).*\.append\(|\.remove\(
note: |
  Modifying a list while iterating skips elements or raises errors.
  ANTI-PATTERN (BUG):
    for item in items:
        if is_invalid(item):
            items.remove(item)  # Changes list during iteration!

  CORRECT:
    items = [item for item in items if not is_invalid(item)]

---
id: python-quality-shadowing-builtin
language: python
severity: warning
message: "Code Quality: Local variable shadows built-in function"
tags:
  - quality
  - naming
rule:
  kind: assignment_statement
  pattern: |
    variable named (list|dict|tuple|str|int|float|type|object|input|open|len|sum|any|all)
note: |
  Shadowing builtins makes code confusing and prevents using the builtin.
  ANTI-PATTERN:
    list = [1, 2, 3]  # Now can't use list() constructor
    type = str  # Can't use type() function

  CORRECT:
    items = [1, 2, 3]
    data_type = str

---
id: python-quality-docstring-formatting
language: python
severity: info
message: "Docstring: Use consistent format (Google, NumPy, or Sphinx)"
tags:
  - quality
  - docstrings
rule:
  kind: function_definition
  pattern: |
    docstring without consistent format
note: |
  Pick one docstring style and use consistently. Common choices:
  - Google style: Args:, Returns:, Raises:
  - NumPy style: Parameters, Returns, Raises
  - Sphinx style: :param, :type, :return:
  Tools like sphinx-autodoc can auto-generate docs from docstrings.

---
id: python-quality-parameter-mutation
language: python
severity: warning
message: "Code Quality: Modifying parameter, can confuse caller about side effects"
tags:
  - quality
  - side-effects
rule:
  kind: assignment_statement
  pattern: |
    parameter modified in function body
note: |
  Modifying parameters (especially mutable ones) can confuse callers.
  Use local variables for modifications.
  ANTI-PATTERN (confusing):
    def process(data):
        data = data.upper()  # Reassigns parameter
        data = data.strip()  # Misleading - looks like mutation

  CLEARER:
    def process(data):
        result = data.upper().strip()
        return result

---
id: python-quality-recursive-without-base-case
language: python
severity: error
message: "Code Quality: Recursive function may lack base case, risk of infinite recursion"
tags:
  - quality
  - complexity
rule:
  kind: function_definition
  pattern: |
    recursive function without base case guard
note: |
  Recursion without proper base case causes stack overflow.
  Always have exit condition and progress toward it.
  ANTI-PATTERN (infinite recursion):
    def countdown(n):
        print(n)
        countdown(n)  # No base case!

  CORRECT:
    def countdown(n):
        if n == 0:
            return
        print(n)
        countdown(n - 1)

---
id: python-quality-hardcoded-config
language: python
severity: warning
message: "Code Quality: Hardcoded configuration values, use environment variables or config files"
tags:
  - quality
  - configuration
rule:
  kind: any
  pattern: |
    (API_KEY|PASSWORD|SECRET|TOKEN|DATABASE_URL) = "[^"]*"
note: |
  Hardcoded secrets in source code are security risks and deployment problems.
  Use environment variables, config files, or secret management.
  ANTI-PATTERN (SECURITY RISK):
    API_KEY = "sk_live_abc123def456"
    DATABASE_URL = "postgres://admin:password@localhost"

  BETTER:
    import os
    API_KEY = os.getenv("API_KEY")
    DATABASE_URL = os.getenv("DATABASE_URL")

---
id: python-quality-regex-not-compiled
language: python
severity: warning
message: "Performance: Regex pattern used in loop without compiling"
tags:
  - quality
  - performance
rule:
  kind: any
  pattern: |
    re\.(search|match|findall) in loop
note: |
  Compiling regex once is faster than recompiling in each loop iteration.
  ANTI-PATTERN (slow):
    for line in lines:
        if re.search(r"\d+", line):  # Recompiles each iteration
            process(line)

  FASTER:
    pattern = re.compile(r"\d+")
    for line in lines:
        if pattern.search(line):  # Compiled once
            process(line)

---
id: python-quality-json-without-encoding
language: python
severity: info
message: "JSON: Specify encoding parameter for json.dump/load"
tags:
  - quality
  - encoding
rule:
  kind: any
  pattern: |
    json\.(dump|load)
note: |
  Explicitly specifying encoding (utf-8) makes intent clear and ensures compatibility.
  BETTER:
    with open("data.json", "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False)

---
id: javascript-quality-naming-camel-case-variables
language: javascript
severity: warning
message: "Quality: Variables should use camelCase naming convention"
tags:
  - quality
  - naming
  - style
rule:
  kind: variable_declarator
  pattern: "const [A-Z][a-z_]+ = $value"
note: |
  Variable names should follow camelCase convention (e.g., userName, productId).
  PascalCase is reserved for classes and React components.
  This improves code consistency and readability across teams.
  Exception: Constants using CONSTANT_CASE are acceptable for module-level constants.

---
id: javascript-quality-naming-class-pascal-case
language: javascript
severity: warning
message: "Quality: Classes should use PascalCase naming convention"
tags:
  - quality
  - naming
  - style
rule:
  kind: class_declaration
  pattern: "class [a-z][a-zA-Z]+ {}"
note: |
  Class names must use PascalCase (e.g., UserManager, DataProcessor).
  This is a JavaScript convention that signals this is a constructor/class.
  Helps distinguish classes from regular variables at a glance.
  Apply to React components, API classes, and utility classes.

---
id: javascript-quality-naming-constant-upper-snake-case
language: javascript
severity: info
message: "Quality: Module-level constants should use CONSTANT_UPPER_CASE"
tags:
  - quality
  - naming
  - style
rule:
  kind: variable_declarator
  pattern: "const [a-z_]+ = (\\d+|'[^']*'|\"[^\"]*\")"
note: |
  Module-level constants (API_KEY, MAX_RETRIES) should use UPPER_SNAKE_CASE.
  This signals to developers that a value is immutable across the entire module.
  Local constants within functions can use camelCase.
  Makes it clear which values are configuration vs computed.

---
id: javascript-quality-naming-function-descriptive
language: javascript
severity: warning
message: "Quality: Functions should have descriptive names starting with verb"
tags:
  - quality
  - naming
  - clarity
rule:
  kind: function_declaration
  pattern: "function [a-z]{1,3}\\(|function \\$[a-zA-Z]+"
note: |
  Functions should use descriptive names that indicate what they do.
  Prefer verbs: get, set, fetch, process, validate, handle, create, update, delete.
  Avoid single-letter names (x, y, f) except in mathematical contexts or lambdas.
  Examples: getUserData(), isValidEmail(), processPayment().
  Single-letter functions or unclear names reduce maintainability.

---
id: javascript-quality-no-magic-numbers
language: javascript
severity: warning
message: "Quality: Magic numbers should be extracted to named constants"
tags:
  - quality
  - complexity
  - maintainability
rule:
  kind: binary_expression
  pattern: "[a-zA-Z_]+ [<>=!]+ \\d{2,}|\\d{2,} [<>=!]+ [a-zA-Z_]+"
note: |
  Magic numbers (hard-coded numeric literals) reduce code clarity.
  Extract to constants: const MAX_ATTEMPTS = 3; const TIMEOUT_MS = 5000;
  Exception: 0, 1, -1 in simple loops are acceptable.
  Makes code self-documenting and easier to maintain when values need updates.

---
id: javascript-quality-no-nested-ternary
language: javascript
severity: warning
message: "Quality: Avoid nested ternary operators; use if/else or switch"
tags:
  - quality
  - readability
  - complexity
rule:
  kind: conditional_expression
  pattern: "\\? .* \\? .* : .* : .*"
note: |
  Nested ternaries (a ? b : c ? d : e) are hard to read and error-prone.
  Replace with: if/else blocks, switch statements, or helper functions.
  Single-level ternaries (a ? b : c) are acceptable for simple cases.
  Improves cognitive load and reduces bugs during refactoring.

---
id: javascript-quality-no-reassign-function-parameters
language: javascript
severity: warning
message: "Quality: Avoid reassigning function parameters; use local variables instead"
tags:
  - quality
  - maintainability
  - side-effects
rule:
  kind: assignment_expression
  pattern: "function \\$func\\([a-zA-Z_]+ ([a-zA-Z_]+).*\\) \\{[^}]*\\1 ="
note: |
  Reassigning parameters makes code harder to understand and debug.
  Create a new variable: const result = param; result = newValue;
  Preserves function's intent and makes data flow clearer.
  Prevents accidental side effects and improves function purity.

---
id: javascript-quality-consistent-return-type
language: javascript
severity: warning
message: "Quality: Functions should consistently return same type or always return"
tags:
  - quality
  - type-safety
  - clarity
rule:
  kind: function_declaration
  pattern: "function \\$name\\([^)]*\\) \\{[^}]*(return [a-zA-Z_]+[^;]*;)?[^}]*(return|})?"
note: |
  Inconsistent returns (sometimes null, sometimes undefined, sometimes value) cause bugs.
  Choose one: always return a value, use void, or use optional with ?.
  In TypeScript, use explicit return types: function getValue(): string | null {}.
  Improves predictability and reduces null-checking bugs.

---
id: javascript-quality-avoid-var-use-const-let
language: javascript
severity: error
message: "Quality: Use 'const' or 'let'; avoid 'var' for better scoping"
tags:
  - quality
  - modern-javascript
  - scope-safety
rule:
  kind: variable_declaration
  pattern: "var [a-zA-Z_]+"
note: |
  'var' has function-level scope and hoisting quirks causing bugs.
  Use 'const' by default (prevents accidental reassignment).
  Use 'let' only when reassignment is intentional.
  var is deprecated in modern JavaScript; ES6+ (const/let) are safer.

---
id: javascript-quality-const-before-let
language: javascript
severity: info
message: "Quality: Prefer 'const' over 'let' to reduce mutation"
tags:
  - quality
  - immutability
  - modern-javascript
rule:
  kind: variable_declaration
  pattern: "let [a-zA-Z_]+ = [a-zA-Z_0-9']+(;| )"
note: |
  Default to 'const' for variables that don't reassign.
  Only use 'let' when you genuinely reassign a variable.
  Reduces cognitive load and prevents accidental mutations.
  Aligns with functional programming best practices.

# ============================================================================
# TYPESCRIPT STRICTNESS RULES
# ============================================================================

---
id: typescript-quality-no-any-type
language: typescript
severity: error
message: "TypeScript: Avoid 'any' type; use explicit types or 'unknown'"
tags:
  - quality
  - type-safety
  - typescript
rule:
  kind: type_annotation
  pattern: ": any[,;)]|: any\\["
note: |
  'any' disables TypeScript checking and hides type errors until runtime.
  Use explicit types (string, number, User) or 'unknown' if type is uncertain.
  If type is truly dynamic, document why and consider using generics.
  TypeScript strict mode (-noImplicitAny) makes this an error.

---
id: typescript-quality-no-implicit-any
language: typescript
severity: error
message: "TypeScript: Add explicit type annotations; don't rely on inference"
tags:
  - quality
  - type-safety
  - typescript
rule:
  kind: parameter
  pattern: "function [a-zA-Z_]+\\([a-zA-Z_]+(?!:).*\\)|([a-zA-Z_]+)(?!:).*=>"
note: |
  Function parameters without type annotations are implicitly 'any'.
  Always annotate: function fetch(url: string, options?: RequestInit) {}.
  Enables catch type errors at compile time, not runtime.
  Makes function contracts explicit and self-documenting.

---
id: typescript-quality-strict-null-checks
language: typescript
severity: warning
message: "TypeScript: Always check for null/undefined before using values"
tags:
  - quality
  - type-safety
  - null-safety
rule:
  kind: property_access
  pattern: "[a-zA-Z_]+\\.[a-zA-Z_]+|[a-zA-Z_]+\\[.*\\]"
note: |
  In strict mode, values can be null/undefined; access without checking causes runtime errors.
  Check first: if (user?.name) { } or if (user !== null) { user.name; }.
  Use optional chaining (?.) and nullish coalescing (??) when appropriate.
  TypeScript strict mode (-strictNullChecks) enforces this check.

---
id: typescript-quality-no-type-assertion-any
language: typescript
severity: warning
message: "TypeScript: Avoid 'as any' type assertions; prefer proper typing"
tags:
  - quality
  - type-safety
  - typescript
rule:
  kind: type_assertion
  pattern: " as any| as any[,;)]"
note: |
  'as any' bypasses type checking like using 'any' directly.
  Instead: use generics, extend types, or use 'as unknown' with proper checking.
  If you need 'as any', add a // @ts-ignore comment explaining why.
  Disabling type checking is a code smell; fix the root cause.

---
id: typescript-quality-unknown-before-any
language: typescript
severity: warning
message: "TypeScript: Use 'unknown' instead of 'any' for truly dynamic types"
tags:
  - quality
  - type-safety
  - typescript
rule:
  kind: type_annotation
  pattern: ": any(?=[^a-zA-Z])"
note: |
  'unknown' is a safer 'any' that requires type checking before use.
  Pattern: const value: unknown = getData(); if (typeof value === 'string') { ... }
  'unknown' forces you to narrow the type, catching errors early.
  Use 'unknown' for JSON parsing, dynamic APIs, or external data.

---
id: typescript-quality-explicit-return-types-public-api
language: typescript
severity: warning
message: "TypeScript: Add explicit return types to public functions and exports"
tags:
  - quality
  - type-safety
  - documentation
rule:
  kind: function_declaration
  pattern: "export (function|const) [a-zA-Z_]+\\([^)]*\\)(?!:)\\s*[={]"
note: |
  Public functions should declare return types explicitly: function fetch(): Promise<Data> {}.
  Helps prevent accidental API changes and documents intent.
  IDE autocompletion and refactoring tools work better with explicit types.
  Exception: Simple helpers with obvious return types may be inferred.

---
id: typescript-quality-generic-constraints
language: typescript
severity: info
message: "TypeScript: Use generic constraints to specify what types are accepted"
tags:
  - quality
  - type-safety
  - typescript
rule:
  kind: generic_type_parameter
  pattern: "<T>|<T,.*>"
note: |
  Unconstrained generics (function foo<T>(x: T)) accept any type, reducing safety.
  Add constraints: function foo<T extends string | number>(x: T) { } or <T extends { id: string }>.
  Constraints document what operations are legal on the generic type.
  Makes errors clearer and prevents misuse of generic functions.

---
id: typescript-quality-discriminated-unions-over-any
language: typescript
severity: warning
message: "TypeScript: Use discriminated unions instead of 'any' for variants"
tags:
  - quality
  - type-safety
  - typescript
rule:
  kind: type_alias
  pattern: "type [a-zA-Z_]+ = .*\\| .*"
note: |
  Instead of response: any, use discriminated unions: type Response = Success | Error.
  Enables TypeScript to narrow types with type guards: if (resp.status === 'ok').
  More type-safe, self-documenting, and prevents invalid state combinations.
  Common in domain modeling, API responses, and state machines.

# ============================================================================
# ERROR HANDLING RULES
# ============================================================================

---
id: javascript-quality-unhandled-promise-rejection
language: javascript
severity: error
message: "Quality: Async functions must use try/catch or .catch() handler"
tags:
  - quality
  - error-handling
  - async
rule:
  kind: call_expression
  pattern: "await [a-zA-Z_]+\\([^)]*\\)(?!.*catch|.*try)|.then\\([^)]*\\)(?!.*catch)"
note: |
  Unhandled promise rejections crash the process in Node.js (future versions).
  Always use: try { await foo(); } catch (err) { handleError(err); }
  Or chain: foo().catch(handleError);
  Missing handlers cause DeprecationWarning and silent failures.

---
id: javascript-quality-return-vs-await-in-try
language: javascript
severity: error
message: "Quality: Use 'await' not 'return' in try block to catch rejections"
tags:
  - quality
  - error-handling
  - async
rule:
  kind: return_statement
  pattern: "try \\{[^}]*return (await )?[a-zA-Z_]+\\([^)]*\\)"
note: |
  'return promise' vs 'await promise' behaves differently in try/catch.
  'return' skips the catch block; 'await' doesn't.
  Pattern: try { await asyncFn(); } catch { } not try { return asyncFn(); }
  This is a subtle bug that causes unhandled rejections.

---
id: javascript-quality-try-catch-in-async
language: javascript
severity: warning
message: "Quality: Wrap async operations in try/catch blocks"
tags:
  - quality
  - error-handling
  - async
rule:
  kind: await_expression
  pattern: "await [a-zA-Z_]+\\(.*\\)(?!.*try)"
note: |
  Async code without try/catch is unpredictable.
  Pattern: async function getData() { try { const data = await fetch(...); } catch (err) { ... } }
  Prevents unhandled rejections and enables graceful error recovery.
  Always plan for failure in async operations.

---
id: javascript-quality-error-handling-granular
language: javascript
severity: warning
message: "Quality: Handle specific errors; avoid catch-all silently swallowing errors"
tags:
  - quality
  - error-handling
  - debugging
rule:
  kind: catch_clause
  pattern: "catch \\([a-zA-Z_]+\\) \\{[ ]*\\}"
note: |
  Empty catch blocks hide errors and make debugging harder.
  Log errors: catch (err) { console.error(err); throw; } or handle specifically.
  If you must swallow an error, add a comment explaining why.
  Silent failures are security and maintainability risks.

---
id: javascript-quality-error-types-checking
language: javascript
severity: info
message: "Quality: Check error type before accessing error properties"
tags:
  - quality
  - error-handling
  - type-safety
rule:
  kind: member_expression
  pattern: "[a-zA-Z_]+\\.(message|stack|code)(?!.*instanceof)"
note: |
  Not all thrown values are Error objects (could be strings, numbers, null).
  Pattern: catch (err) { const msg = err instanceof Error ? err.message : String(err); }
  Prevents crashes from TypeError: Cannot read property 'message' of null.
  Type-guard error handling for robustness.

---
id: javascript-quality-promise-all-settled
language: javascript
severity: info
message: "Quality: Use Promise.allSettled() for parallel operations requiring all results"
tags:
  - quality
  - error-handling
  - async
rule:
  kind: call_expression
  pattern: "Promise\\.all\\("
note: |
  Promise.all() fails if ANY promise rejects (fast-fail).
  Use Promise.allSettled() if you need all results regardless of failures.
  Pattern: const results = await Promise.allSettled([p1, p2, p3]);
  Prevents cascade failures when one async operation fails.

---
id: javascript-quality-no-empty-finally
language: javascript
severity: info
message: "Quality: Finally blocks should clean up resources, not catch errors"
tags:
  - quality
  - error-handling
rule:
  kind: finally_clause
  pattern: "finally \\{[ ]*\\}"
note: |
  Empty finally blocks are dead code; remove them.
  Finally is for cleanup: closing connections, releasing locks, timers.
  Error handling goes in catch, not finally.
  Cleanup should happen regardless of success/failure.

# ============================================================================
# CODE COMPLEXITY RULES
# ============================================================================

---
id: javascript-quality-function-complexity-cyclomatic
language: javascript
severity: warning
message: "Quality: Function cyclomatic complexity exceeds recommended threshold (10)"
tags:
  - quality
  - complexity
  - maintainability
rule:
  kind: function_declaration
  pattern: "function .*\\{.*if.*if.*if.*if.*if.*if.*if.*if.*if.*if.*\\}"
note: |
  Cyclomatic complexity > 10 means too many decision points (if/switch/loops).
  Each if/else, switch case, and loop increases complexity by 1.
  Complex functions are hard to test, understand, and maintain.
  Solution: Split into smaller, single-responsibility functions.
  ESLint rule: "complexity": ["warn", 10]

---
id: javascript-quality-function-length-max
language: javascript
severity: warning
message: "Quality: Function is too long (recommended max 50-100 lines)"
tags:
  - quality
  - complexity
  - maintainability
rule:
  kind: function_declaration
  pattern: "function .*\\{[^}]{500,}\\}"
note: |
  Long functions (100+ lines) are hard to understand and test.
  Extract smaller functions with single responsibilities.
  Aim for <50 lines for most functions; <100 for complex ones.
  Use helper functions to break up logic into steps.

---
id: javascript-quality-nested-callback-depth
language: javascript
severity: warning
message: "Quality: Callback nesting is too deep; use async/await or promises"
tags:
  - quality
  - complexity
  - readability
rule:
  kind: call_expression
  pattern: "\\([^)]*\\([^)]*\\([^)]*\\([^)]*\\(.*\\).*\\).*\\).*\\)"
note: |
  Deeply nested callbacks (>3 levels) are "callback hell" (pyramid of doom).
  Refactor to async/await: const data = await fetch(...); const json = await data.json();
  Or use .then() chains: fetch(...).then(r => r.json()).then(data => {...});
  Improves readability and error handling.

---
id: javascript-quality-nested-if-depth
language: javascript
severity: warning
message: "Quality: Conditional nesting too deep; consider early returns or guards"
tags:
  - quality
  - complexity
  - readability
rule:
  kind: if_statement
  pattern: "if \\(.*\\) \\{.*if \\(.*\\) \\{.*if \\(.*\\) \\{.*\\}.*\\}.*\\}"
note: |
  Nested if statements (>3 levels) reduce readability.
  Use early returns to flatten: if (!condition) return; if (!other) return; doWork();
  Or use guard clauses and logical operators.
  Makes code read top-to-bottom like a checklist.

---
id: javascript-quality-parameter-count
language: javascript
severity: warning
message: "Quality: Function has too many parameters (max 4 recommended)"
tags:
  - quality
  - complexity
  - maintainability
rule:
  kind: function_declaration
  pattern: "function [a-zA-Z_]+\\([^)]*,[^)]*,[^)]*,[^)]*,[^)]*\\)"
note: |
  Functions with 5+ parameters are hard to call and understand.
  Use an options object: function render({ width, height, color, border }) { }
  Or create a Config class: new Renderer(config).render();
  Makes API clearer and future-proofs against parameter additions.

---
id: javascript-quality-avoid-else-ladder
language: javascript
severity: info
message: "Quality: Long else-if chains should use switch or object dispatch"
tags:
  - quality
  - complexity
  - readability
rule:
  kind: if_statement
  pattern: "if .* else if .* else if .* else if .*"
note: |
  Multiple else-if chains are repetitive and error-prone.
  Refactor to switch: switch (type) { case 'A': ...; case 'B': ...; }
  Or object dispatch: const handlers = { A: () => {}, B: () => {} }; handlers[type]();
  Object dispatch is extensible and more maintainable.

---
id: javascript-quality-switch-no-fall-through
language: javascript
severity: error
message: "Quality: Switch case must have 'break', 'return', or 'throw' (no fall-through)"
tags:
  - quality
  - error-prevention
  - bug-prevention
rule:
  kind: switch_case
  pattern: "case .*:(?!.*break|.*return|.*throw)[^}]*case"
note: |
  Unintended fall-through in switch statements is a common bug.
  Always end cases with: break; return value; throw error;
  Exception: Intentional fall-through should have // falls through comment.
  Missing break causes unexpected code to execute.

# ============================================================================
# MODULE ORGANIZATION RULES
# ============================================================================

---
id: javascript-quality-circular-dependency-detection
language: javascript
severity: error
message: "Quality: Circular dependency detected; module A imports B and B imports A"
tags:
  - quality
  - module-organization
  - architecture
rule:
  kind: import_declaration
  pattern: "import.*from.*|export.*from.*"
note: |
  Circular dependencies cause unpredictable initialization order.
  Tools: eslint-plugin-import (import/no-cycle), dpdm, madge.
  Solution: Extract shared code to third module or reorder dependencies.
  Pattern: Create utils.ts for shared code; both A and B import from utils.
  Can hide in monorepos; use 'dpdm' tool to visualize dependency tree.

---
id: javascript-quality-barrel-file-tree-shaking
language: javascript
severity: warning
message: "Quality: Barrel file (index.ts) may prevent tree-shaking; consider direct imports"
tags:
  - quality
  - module-organization
  - bundle-size
rule:
  kind: import_declaration
  pattern: "import.*from.*['\"]\\.[/]?index['\"]|import \\{.*\\} from ['\"]\\.[/]?['\"]"
note: |
  Barrel files (export * from './module') can prevent tree-shaking.
  Bundlers must parse entire barrel file even if only one export is used.
  Prefer direct imports: import { UserCard } from './components/UserCard';
  Barrel files reduce bundle size. Use 'sideEffects: false' in package.json for tree-shaking.
  Next.js provides 'optimizePackageImports' experimental feature for this.

---
id: javascript-quality-no-internal-cycles-in-barrel
language: javascript
severity: error
message: "Quality: Module imports barrel file that re-exports it (circular pattern)"
tags:
  - quality
  - module-organization
  - architecture
rule:
  kind: import_declaration
  pattern: "import.*from ['\"][./]*index['\"]"
note: |
  If moduleA is in src/components, it should not import from src/components/index.
  Pattern: Move shared code to src/utils; both A and B import from utils.
  Or use 'internal.js' pattern: internal.js imports all, modules import from internal.
  Prevents circular dependencies in barrel structures.

---
id: javascript-quality-single-responsibility-per-file
language: javascript
severity: info
message: "Quality: File should export one main export (class, component, or function)"
tags:
  - quality
  - module-organization
  - maintainability
rule:
  kind: export_statement
  pattern: "export (class|function|const) [a-zA-Z_]+.*export (class|function|const) [a-zA-Z_]+"
note: |
  Multiple exports per file make it harder to find and refactor code.
  Pattern: One main export per file: export default UserCard; or export { UserCard };
  Other exports can be helpers/internal implementations.
  Easier to navigate codebase when file structure mirrors module structure.

---
id: javascript-quality-no-default-export-with-named
language: javascript
severity: warning
message: "Quality: Mix of default and named exports in one file is confusing"
tags:
  - quality
  - module-organization
  - consistency
rule:
  kind: export_statement
  pattern: "export default.*export \\{|export \\{.*export default"
note: |
  Mixing default and named exports confuses import syntax.
  Choose one: either export default MyComponent; or export { MyComponent, helper };
  Consistency across codebase makes imports predictable.
  Refactor: separate file for default export or use named exports only.

---
id: javascript-quality-explicit-dependencies-in-package-json
language: javascript
severity: warning
message: "Quality: All imports must have corresponding entries in package.json"
tags:
  - quality
  - module-organization
  - maintainability
rule:
  kind: import_declaration
  pattern: "import.*from ['\"]([a-z@][a-z0-9@/-]*)['\"]"
note: |
  Importing packages not listed in dependencies causes build failures.
  Verify each external import: npm list <package>
  Pattern: List dependencies explicitly, remove unused ones.
  Enables reproducible builds and clear dependency graph.

# ============================================================================
# REACT PATTERNS RULES
# ============================================================================

---
id: javascript-quality-react-hooks-rules-of-hooks
language: javascript
severity: error
message: "React: Hooks must be called at top level of component, not conditionally"
tags:
  - quality
  - react
  - hooks
rule:
  kind: call_expression
  pattern: "if \\(.*\\) \\{.*useState|useEffect|useMemo|useCallback|useContext"
note: |
  Calling hooks inside conditionals breaks React's hook ordering.
  React expects same number and order of hooks on every render.
  Pattern: Move hook outside conditional: const [state, setState] = useState(); if (cond) { ... }
  Use eslint-plugin-react-hooks to enforce this rule.

---
id: javascript-quality-react-exhaustive-deps
language: javascript
severity: warning
message: "React: useEffect dependency array must include all dependencies"
tags:
  - quality
  - react
  - hooks
rule:
  kind: call_expression
  pattern: "useEffect\\(.*=>.*[a-zA-Z_]+.*\\],[ ]*\\[(?!.*[a-zA-Z_]+).*\\]"
note: |
  Missing dependencies in useEffect cause stale closures and bugs.
  Example: useEffect(() => { console.log(userId); }, []) logs old userId.
  Fix: useEffect(() => { console.log(userId); }, [userId])
  Use eslint-plugin-react-hooks/exhaustive-deps rule to catch this.

---
id: javascript-quality-react-key-prop-in-lists
language: javascript
severity: error
message: "React: List items must have stable 'key' prop (not index)"
tags:
  - quality
  - react
  - rendering
rule:
  kind: call_expression
  pattern: "\\.map\\(\\([^)]*,[ ]?index[^)]*\\).*<.*key=\\{index\\}|<.*key=\\{i\\}"
note: |
  Using array index as key breaks React reconciliation when list reorders.
  Pattern: Use unique, stable id: items.map(item => <Item key={item.id} />)
  Index as key causes: lost component state, wrong animations, incorrect updates.
  Effects: Can cause bugs with forms, animations, and state loss.

---
id: javascript-quality-react-avoid-inline-functions
language: javascript
severity: warning
message: "React: Avoid defining functions in render/JSX; causes re-renders"
tags:
  - quality
  - react
  - performance
rule:
  kind: arrow_function
  pattern: "return \\(.*<.*onClick=\\{[^}]*=>|<.*onChange=\\{[^}]*=>"
note: |
  Inline functions in JSX create new function on every render.
  Causes: Child re-renders, losing focus, animation resets.
  Pattern: Define handler outside or use useCallback: const handleClick = useCallback(() => {}, [])
  Or useMemo for callbacks: const handler = useMemo(() => () => {...}, [deps])

---
id: javascript-quality-react-props-spread-carefully
language: javascript
severity: info
message: "React: Using spread operator on props may pass unexpected props"
tags:
  - quality
  - react
  - maintainability
rule:
  kind: jsx_attribute
  pattern: "\\{\\.\\.\\.[a-zA-Z_]+\\}"
note: |
  Spreading all props ({{ ...props }}) can pass HTML attributes unintentionally.
  Pattern: Destructure intentionally: const { children, ...rest } = props; <div {...rest}>
  Or be explicit: <input type="text" name={name} value={value} />
  Better for documentation and preventing unintended prop passing.

---
id: javascript-quality-react-useeffect-async-wrapper
language: javascript
severity: error
message: "React: useEffect callback cannot be async; wrap async code inside"
tags:
  - quality
  - react
  - hooks
rule:
  kind: call_expression
  pattern: "useEffect\\(async \\(|useEffect\\(async \\).*=>|useCallback\\(async \\("
note: |
  useEffect callback must return cleanup function, not a Promise.
  Pattern: useEffect(() => { async function fetch() { } fetch(); }, [])
  Or: useEffect(() => { (async () => {})(); }, [])
  Enables proper cleanup and prevents warnings from React.

---
id: javascript-quality-react-hooks-custom-return-object
language: javascript
severity: info
message: "React: Custom hook should return destructurable values, not object"
tags:
  - quality
  - react
  - hooks
rule:
  kind: return_statement
  pattern: "return \\{.*\\}"
note: |
  Custom hooks returning { state, setState } match React's pattern.
  Pattern: return [state, setState]; or return { state, setState };
  Array return (like useState) enables renaming: const [count, setCount] = useCount();
  Object return (like useReducer) enables destructuring: const { state, dispatch } = useForm();
  Consistency with React's conventions.

---
id: javascript-quality-react-conditional-rendering-fragments
language: javascript
severity: info
message: "React: Use fragments (<> </>) or ternary for conditional JSX rendering"
tags:
  - quality
  - react
  - rendering
rule:
  kind: return_statement
  pattern: "return [a-zA-Z_]+.*[?:]|return \\(.*[?:].*\\)"
note: |
  Conditional rendering should be clear: isLoading ? <Spinner /> : <Content />
  Or use &&: {isOpen && <Modal />} but be careful with falsy values.
  Pattern: return isLoading ? <Spinner /> : <Content />;
  Fragments avoid wrapper divs: return <>{items}</>;
  Prevents layout issues and DOM bloat.

---
id: javascript-quality-react-list-component-key-prop-required
language: javascript
severity: error
message: "React: Rendering .map() must include key prop on root element"
tags:
  - quality
  - react
  - rendering
rule:
  kind: call_expression
  pattern: "\\{[a-zA-Z_]+\\.map\\([^)]*\\)[^}]*\\}|\\[.*\\.map\\([^)]*\\).*\\]"
note: |
  Each rendered item in a list must have a unique, stable key.
  Pattern: {items.map(item => <Card key={item.id} {...item} />)}
  Enables React to track which items changed, added, or removed.
  Without keys: reordering causes state/animation/focus loss.

# ============================================================================
# TESTING RULES
# ============================================================================

---
id: javascript-quality-test-expect-assertions
language: javascript
severity: warning
message: "Jest: Use expect.assertions() in async tests to ensure assertions run"
tags:
  - quality
  - testing
  - jest
rule:
  kind: call_expression
  pattern: "test\\(['\"].*async.*['\"]|test\\(['\"].*\\(\\)[ ]*=>.*await"
note: |
  Async tests without expect.assertions() can silently pass without running assertions.
  Pattern: test('fetches data', async () => { expect.assertions(1); const data = await fetch(...); })
  Or: test('name', async () => { expect.hasAssertions(); ... })
  Prevents false positives where test completes before assertions run.

---
id: javascript-quality-test-return-or-await-promise
language: javascript
severity: error
message: "Jest: Return or await promise in test; don't let it hang"
tags:
  - quality
  - testing
  - jest
rule:
  kind: call_expression
  pattern: "test\\(['\"].*['\"],.*\\) \\{[^}]*\\.then\\(|test\\(['\"].*['\"],.*\\) \\{[^}]*Promise\\.resolve"
note: |
  Tests that use .then() without return/await exit before assertion.
  Pattern: test('name', () => { return promise.then(...); })
  Or async: test('name', async () => { await promise; expect(...); })
  Missing return/await causes test to exit before .then() callback runs.

---
id: javascript-quality-test-resolve-rejects-matchers
language: javascript
severity: info
message: "Jest: Use .resolves/.rejects matchers for promise testing"
tags:
  - quality
  - testing
  - jest
rule:
  kind: call_expression
  pattern: "expect\\(.*Promise|expect\\(.*async.*\\)(?!\\.resolves|\\.rejects)"
note: |
  .resolves and .rejects matchers simplify promise testing.
  Pattern: await expect(promise).resolves.toBe(value);
  Or: await expect(promise).rejects.toThrow(Error);
  More readable than .then(data => expect(data).toBe(...))

---
id: javascript-quality-test-use-object-matcher
language: javascript
severity: info
message: "Jest: Use toEqual() for objects, not toBe() (reference vs value equality)"
tags:
  - quality
  - testing
  - jest
rule:
  kind: call_expression
  pattern: "expect\\(\\{[^}]*\\}\\)\\.toBe\\(|expect\\(\\[[^\\]]*\\]\\)\\.toBe\\("
note: |
  toBe() checks reference equality; toEqual() checks value equality.
  Pattern: expect(obj).toEqual({ x: 1 }); not expect(obj).toBe({ x: 1 });
  For arrays: expect(arr).toEqual([1, 2]); not toBe([1, 2]);
  Prevents flaky tests and confusing failures.

---
id: javascript-quality-test-descriptive-test-names
language: javascript
severity: info
message: "Quality: Test names should describe behavior, not just 'should work'"
tags:
  - quality
  - testing
  - documentation
rule:
  kind: call_expression
  pattern: "test\\(['\"]should work['\"]|it\\(['\"]works['\"]|test\\(['\"]test [a-z]"
note: |
  Test names should be clear: "should return user when ID is valid"
  Not: "should work", "test user", "works correctly"
  Good names document expected behavior and help find failing tests.
  Pattern: test('should return 404 when user not found', () => { ... })

---
id: javascript-quality-test-no-test-only-left-behind
language: javascript
severity: error
message: "Jest: Remove .only() from tests before committing (runs only that test)"
tags:
  - quality
  - testing
  - debugging
rule:
  kind: call_expression
  pattern: "test\\.only\\(|it\\.only\\(|describe\\.only\\("
note: |
  .only() is for local debugging; left behind skips all other tests.
  Pattern: test('name', () => { }); not test.only('name', () => { });
  CI will silently pass while other tests are skipped (hidden failures).
  Remove before git push or use pre-commit hooks to prevent.

---
id: javascript-quality-test-no-skip-test
language: javascript
severity: warning
message: "Jest: Remove .skip() from tests; indicate why if needed"
tags:
  - quality
  - testing
  - maintenance
rule:
  kind: call_expression
  pattern: "test\\.skip\\(|it\\.skip\\(|describe\\.skip\\("
note: |
  .skip() is for temporary disabling; can hide bugs if forgotten.
  If necessary, add TODO comment: // TODO: Fix flaky test; skip for now
  Pattern: Skip sparingly and with reason.
  Better: Fix flaky tests, don't skip them long-term.

---
id: javascript-quality-test-mock-vs-stub-clarity
language: javascript
severity: info
message: "Jest: Use jest.mock() for module-level; jest.fn() for specific function mocks"
tags:
  - quality
  - testing
  - jest
rule:
  kind: call_expression
  pattern: "jest\\.mock\\(.*jest\\.mock|jest\\.fn\\([^)]*jest\\.fn"
note: |
  jest.mock(): Mocks entire module, affects all tests in file.
  jest.fn(): Mocks single function, more granular control.
  jest.spyOn(): Spies on existing function, can call original.
  Pattern: Use least-powerful option (jest.fn() > jest.spyOn() > jest.mock()).
  Prevents test pollution and hidden dependencies.

---
id: javascript-quality-test-setup-teardown
language: javascript
severity: info
message: "Jest: Use beforeEach/afterEach for setup/cleanup, not repeated in tests"
tags:
  - quality
  - testing
  - jest
rule:
  kind: call_expression
  pattern: "test\\([^)]*=>.*const [a-zA-Z_]+ =.*test\\([^)]*=>.*const \\1"
note: |
  Setup/teardown logic repeated in tests should move to beforeEach/afterEach.
  Pattern: beforeEach(() => { db = new Database(); }); afterEach(() => { db.close(); });
  Reduces duplication and ensures cleanup runs even if test fails.
  Prevents resource leaks and test interdependencies.

# ============================================================================
# SECURITY-ADJACENT RULES
# ============================================================================

---
id: javascript-quality-no-console-log-production
language: javascript
severity: warning
message: "Security: Remove console.log() from production code (info leakage risk)"
tags:
  - quality
  - security
  - debugging
rule:
  kind: call_expression
  pattern: "console\\.(log|info|debug|warn|error)\\("
note: |
  console.log() can leak sensitive data (passwords, tokens, user info) to users.
  Risks: Performance (millions of logs), debugger console exposure, info disclosure.
  Solution: Use proper logging (Winston, Pino) with log levels.
  Pattern: Replace with: logger.debug(), logger.error() with structured logging.
  Development: OK for debugging; must remove before production build.

---
id: javascript-quality-no-debugger-statement
language: javascript
severity: error
message: "Security: Remove debugger statement; it's a debugging tool not for prod"
tags:
  - quality
  - security
  - debugging
rule:
  kind: debugger_statement
  pattern: "debugger"
note: |
  debugger; pauses execution when DevTools open; should not ship to production.
  Risks: Users can step through code, inspect memory, steal secrets.
  Pattern: Use console-based debugging or DevTools breakpoints locally.
  ESLint rule: "no-debugger": "error"
  Remove before git commit or add pre-commit hooks.

---
id: javascript-quality-no-eval-dynamic-code
language: javascript
severity: error
message: "Security: Never use eval() or Function() constructor (code injection risk)"
tags:
  - quality
  - security
  - injection
rule:
  kind: call_expression
  pattern: "eval\\(|new Function\\(|Function\\(['\"][^']*['\"]|eval\\(['\"]"
note: |
  eval() executes arbitrary code and is a major security vulnerability.
  Risks: Code injection, XSS attacks, data theft, complete system compromise.
  Pattern: Use JSON.parse() for JSON, .map()/.filter() for logic, template engines for HTML.
  Alternatives: Use Function.constructor carefully with static strings only.
  Impact Severity: CRITICAL - Consider as high-risk vulnerability.

---
id: javascript-quality-no-unsafe-regex
language: javascript
severity: warning
message: "Security: Regex may cause ReDoS (Regular Expression Denial of Service)"
tags:
  - quality
  - security
  - performance
rule:
  kind: regex_literal
  pattern: "/(.*\\*.*\\+|.*\\+.*\\*|\\(.*[|].*\\).*\\*)/|test\\('.*\\([^)]*\\*[^)]*\\*"
note: |
  Complex regex with nested quantifiers can cause exponential backtracking.
  Example: /(a+)+b/ with input "aaaaaaaaaaaaaaaaaaaaaaaac" causes ReDoS.
  Risks: Crashes server, CPU 100%, denial of service.
  Solution: Simplify regex, use regex validator (safe-regex npm package).
  Pattern: Avoid nested quantifiers (*+, ++, *?, etc.).

---
id: javascript-quality-no-hardcoded-secrets
language: javascript
severity: error
message: "Security: Don't hardcode secrets (API keys, passwords, tokens) in code"
tags:
  - quality
  - security
  - secrets
rule:
  kind: variable_declarator
  pattern: "(const|let) [a-zA-Z_]+ = ['\"]([a-zA-Z0-9]{20,}|sk_test_|pk_test_)"
note: |
  Hardcoded secrets are leaked if code is public or in version control.
  Risks: Account takeover, API abuse, data breach, infrastructure access.
  Solution: Use environment variables: const token = process.env.API_TOKEN;
  Tools: git-secrets, truffleHog detect common secret patterns.
  Pattern: ALL secrets -> environment variables, .env files (not in git).

---
id: javascript-quality-validate-user-input
language: javascript
severity: warning
message: "Security: Validate/sanitize user input before using in queries or DOM"
tags:
  - quality
  - security
  - injection
rule:
  kind: member_expression
  pattern: "innerHTML =|dangerouslySetInnerHTML|query\\(.*[a-zA-Z_]+\\)|exec\\("
note: |
  Unsanitized user input in DOM/SQL/regex causes: XSS, SQL injection, ReDoS.
  Pattern: Use textContent not innerHTML; DOMPurify for rich HTML; parameterized queries.
  Example: el.textContent = userInput; (safe) not el.innerHTML = userInput; (XSS risk)
  Validation: Use schema libraries (zod, joi) or strict type checking.

---
id: javascript-quality-no-cross-site-scripting
language: javascript
severity: error
message: "Security: Beware XSS when rendering user-provided HTML"
tags:
  - quality
  - security
  - xss
rule:
  kind: call_expression
  pattern: "dangerouslySetInnerHTML|innerHTML =|document\\.write|innerHTML.*[a-zA-Z_]+"
note: |
  Setting innerHTML with user data allows XSS attacks.
  Attack: userInput = '<img src=x onerror=steal()>'; el.innerHTML = userInput;
  Safe alternatives: Use textContent, DOMPurify.sanitize(), or JSX (React escapes).
  Pattern: Treat all user input as untrusted; sanitize/escape before rendering.

# ============================================================================
# MODERN JAVASCRIPT PATTERNS
# ============================================================================

---
id: javascript-quality-template-literals-over-concatenation
language: javascript
severity: info
message: "Quality: Use template literals for string interpolation, not concatenation"
tags:
  - quality
  - modern-javascript
  - readability
rule:
  kind: binary_expression
  pattern: "['\"][^'\"]*['\"] \\+ [a-zA-Z_]+|[a-zA-Z_]+ \\+ ['\"][^'\"]*['\"]"
note: |
  Template literals are more readable than string concatenation.
  Pattern: `Hello ${name}, you are ${age} years old.`
  Not: 'Hello ' + name + ', you are ' + age + ' years old.'
  Benefits: Easier to read, supports multiline, supports expressions.

---
id: javascript-quality-destructuring-assignment
language: javascript
severity: info
message: "Quality: Use destructuring for objects and arrays, not sequential access"
tags:
  - quality
  - modern-javascript
  - readability
rule:
  kind: variable_declarator
  pattern: "const [a-zA-Z_]+ = obj\\.[a-zA-Z_]+;.*const [a-zA-Z_]+ = obj\\.[a-zA-Z_]+"
note: |
  Destructuring reduces boilerplate and is more readable.
  Pattern: const { name, email, age } = user; not const name = user.name; const email = user.email;
  Array: const [first, second] = arr; not const first = arr[0]; const second = arr[1];
  Cleaner code with less repetition.

---
id: javascript-quality-optional-chaining
language: javascript
severity: info
message: "Quality: Use optional chaining (?.) to safely access nested properties"
tags:
  - quality
  - modern-javascript
  - null-safety
rule:
  kind: member_expression
  pattern: "[a-zA-Z_]+\\.[a-zA-Z_]+\\.[a-zA-Z_]+(?!\\?)|user\\.address\\.street"
note: |
  Optional chaining prevents crashes from null/undefined properties.
  Pattern: user?.address?.street (returns undefined if any step is null).
  Without: user.address.street (crashes if user or address is null).
  Modern, readable way to handle potentially missing data.

---
id: javascript-quality-nullish-coalescing
language: javascript
severity: info
message: "Quality: Use nullish coalescing (??) for null/undefined defaults"
tags:
  - quality
  - modern-javascript
  - clarity
rule:
  kind: conditional_expression
  pattern: "[a-zA-Z_]+ \\|\\| |value || defaultValue"
note: |
  Nullish coalescing (??) is better than || for null/undefined defaults.
  Pattern: const name = user.name ?? 'Anonymous';
  Issue with ||: Treats 0, '', false as falsy, might not be intended.
  ?? only uses default if value is null/undefined, not falsy.

---
id: javascript-quality-spread-operator
language: javascript
severity: info
message: "Quality: Use spread operator to clone/merge objects and arrays"
tags:
  - quality
  - modern-javascript
  - readability
rule:
  kind: spread_element
  pattern: "\\{\\.\\.\\.[a-zA-Z_]+\\}|\\[\\.\\.\\.[a-zA-Z_]+\\]"
note: |
  Spread operator is clean syntax for copying/merging.
  Objects: const updated = { ...obj, newProp: value };
  Arrays: const combined = [...arr1, ...arr2];
  Prevents mutation and is more readable than Object.assign() or concat().

---
id: javascript-quality-arrow-functions-concise
language: javascript
severity: info
message: "Quality: Use concise arrow functions for simple callbacks"
tags:
  - quality
  - modern-javascript
  - readability
rule:
  kind: arrow_function
  pattern: "[a-zA-Z_]+ => \\{ return [a-zA-Z_]+[;.]? \\}"
note: |
  Concise arrow functions remove boilerplate.
  Pattern: items.map(x => x.id) not items.map(x => { return x.id; })
  Multi-line arrows use blocks: items.map(x => { const y = x * 2; return y; })
  More readable and idiomatic JavaScript.

---
id: javascript-quality-for-of-vs-for-each
language: javascript
severity: info
message: "Quality: Use for...of for iteration when you need break/continue"
tags:
  - quality
  - modern-javascript
  - control-flow
rule:
  kind: call_expression
  pattern: "\\.forEach\\([^)]*=>.*break|\\.[a-zA-Z_]*\\(.*=>.*continue"
note: |
  for...of enables break/continue; forEach doesn't.
  Pattern: for (const item of items) { if (condition) break; } not items.forEach(item => { break; })
  forEach with break requires refactoring to for...of or Array.some()/every().
  Cleaner control flow when you need to exit early.

---
id: javascript-quality-const-immutable-structure
language: javascript
severity: info
message: "Quality: Const prevents reassignment but not mutation; use Object.freeze for immutability"
tags:
  - quality
  - modern-javascript
  - immutability
rule:
  kind: variable_declarator
  pattern: "const [a-zA-Z_]+ = \\{.*\\};.*\\1\\[[a-zA-Z_]+\\] ="
note: |
  const prevents reassignment but allows mutation.
  const obj = { x: 1 }; obj.x = 2; is legal (mutation allowed).
  For true immutability: const obj = Object.freeze({ x: 1 });
  Or use structural copying: const updated = { ...obj, x: 2 };
  Prevents accidental modifications to shared data.

# ============================================================================
# DOCUMENTATION RULES
# ============================================================================

---
id: javascript-quality-jsdoc-public-functions
language: javascript
severity: info
message: "Documentation: Public functions should have JSDoc comments"
tags:
  - quality
  - documentation
  - maintainability
rule:
  kind: function_declaration
  pattern: "^export (function|const|class) [a-zA-Z_]+[^/]*function"
note: |
  JSDoc documents purpose, parameters, return type, and examples.
  Pattern: /**\n * Calculates sum of numbers.\n * @param {number[]} nums - Array of numbers\n * @returns {number} Sum\n */\n function sum(nums) { ... }
  IDE autocompletion uses JSDoc for hints.
  Benefits: Self-documenting code, better IDE support, easier onboarding.

---
id: javascript-quality-readme-installation-usage
language: javascript
severity: info
message: "Documentation: README should include installation, usage, and examples"
tags:
  - quality
  - documentation
  - project-setup
rule:
  kind: file_path
  pattern: "README\\.(md|txt)"
note: |
  README is first impression; should clearly explain: what, why, how.
  Sections: Overview, Installation, Usage, API, Examples, Contributing, License.
  Example: npm install package-name; import { fn } from 'package-name'; fn(args);
  Makes project accessible to new users and contributors.

---
id: javascript-quality-type-definitions-exported
language: javascript
severity: warning
message: "TypeScript: Export types alongside implementations for external consumers"
tags:
  - quality
  - documentation
  - typescript
rule:
  kind: export_statement
  pattern: "export interface [a-zA-Z_]+|export type [a-zA-Z_]+(?!.*function|.*class)"
note: |
  Consumers need type definitions to use your library in TypeScript.
  Pattern: export type UserData = { id: string; name: string; };
  Or generate types: tsc --declaration, typedoc for API docs.
  Helps TypeScript users integrate without 'any' types.

---
id: javascript-quality-example-in-jsdoc
language: javascript
severity: info
message: "Documentation: JSDoc should include @example usage for complex functions"
tags:
  - quality
  - documentation
  - usability
rule:
  kind: comment
  pattern: "/\\*\\*.*@param|/\\*\\*.*@returns(?!.*@example)"
note: |
  Examples in JSDoc show real usage and reduce onboarding time.
  Pattern: /**\n * @example\n * const result = myFunction(data);\n * console.log(result); // outputs...\n */
  Shows expected behavior and demonstrates API.

---
id: javascript-quality-changelog-major-releases
language: javascript
severity: info
message: "Documentation: Major releases should have CHANGELOG.md documenting changes"
tags:
  - quality
  - documentation
  - maintenance
rule:
  kind: file_path
  pattern: "CHANGELOG\\.(md|txt)|HISTORY\\.(md|txt)"
note: |
  Changelog helps users understand breaking changes and new features.
  Format: Keep a Changelog (https://keepachangelog.com/)
  Sections: Added, Changed, Deprecated, Removed, Fixed, Security.
  Example: ## [2.0.0] - 2026-01-04\n### Breaking\n - Removed deprecated API
  Critical for library maintainers and project transparency.

---
id: javascript-quality-error-message-descriptive
language: javascript
severity: warning
message: "Documentation: Error messages should be descriptive and actionable"
tags:
  - quality
  - documentation
  - debugging
rule:
  kind: call_expression
  pattern: "throw new Error\\(['\"][A-Z][a-z]|console\\.error\\(['\"][A-Z]"
note: |
  Vague errors ('Invalid input', 'Error') waste debugging time.
  Pattern: throw new Error('Expected userId to be string, got: ' + typeof userId);
  Actionable: Include what went wrong, why, and how to fix.
  Example: 'Missing required config option REDIS_URL; set environment variable'

---
id: javascript-quality-commit-messages-conventional
language: javascript
severity: info
message: "Documentation: Use Conventional Commits for clear commit history"
tags:
  - quality
  - documentation
  - git
rule:
  kind: commit_message
  pattern: "^(fix|feat|docs|style|refactor|perf|test|chore): "
note: |
  Conventional Commits (feat:, fix:, docs:) make git history readable.
  Pattern: git commit -m "feat: add user authentication" not "update code"
  Enables automated changelog generation and semantic versioning.
  Format: <type>(<scope>): <subject>\n\n<body>\n\n<footer>
  Improves project professionalism and maintainability.

---
id: javascript-quality-api-documentation-swagger
language: javascript
severity: info
message: "Documentation: REST APIs should have OpenAPI/Swagger documentation"
tags:
  - quality
  - documentation
  - api
rule:
  kind: call_expression
  pattern: "app\\.get\\(|app\\.post\\(|router\\.get\\(|router\\.post\\("
note: |
  API documentation enables consumers to understand endpoints.
  Tools: Swagger UI, OpenAPI, Postman collections.
  Pattern: Annotate routes with @swagger or generate from code.
  Includes: Endpoints, parameters, responses, authentication, examples.
  Reduces integration time and support requests.

# ============================================================================
# PERFORMANCE & OPTIMIZATION RULES (Bonus Section)
# ============================================================================

---
id: javascript-quality-lazy-loading-heavy-imports
language: javascript
severity: info
message: "Performance: Use dynamic imports for large libraries loaded conditionally"
tags:
  - quality
  - performance
  - bundle-size
rule:
  kind: import_declaration
  pattern: "import .* from ['\"](react|lodash|moment)['\"]"
note: |
  Static imports increase initial bundle size even if not used.
  Pattern: const lodash = await import('lodash'); or dynamic require.
  Delays loading until needed, reduces Time to Interactive.
  Example: admin panel code: const AdminUI = React.lazy(() => import('./AdminUI'));
  Critical for bundle optimization in large apps.

---
id: javascript-quality-avoid-n-plus-one-queries
language: javascript
severity: warning
message: "Performance: Avoid N+1 queries; load related data in one batch"
tags:
  - quality
  - performance
  - data-fetching
rule:
  kind: call_expression
  pattern: "for.*await.*fetch|forEach.*await.*fetch|map.*await.*fetch"
note: |
  Loop with async call per item (N+1) is very slow: 1000 items = 1000 requests.
  Pattern: Promise.all([item1, item2, item3].map(fetch)) or batch query.
  Or use SQL joins/includes: User.find().include('posts').
  Reduces API calls from thousands to one, massive performance gain.

---
id: javascript-quality-memoization-expensive-operations
language: javascript
severity: info
message: "Performance: Memoize expensive computations or API calls"
tags:
  - quality
  - performance
  - optimization
rule:
  kind: call_expression
  pattern: "function [a-zA-Z_]+\\([^)]*\\) \\{[^}]*(forEach|map|filter|reduce).*("
note: |
  Repeated expensive operations should cache results.
  Pattern: const memoized = new Map(); if (!memoized.has(key)) { memoized.set(key, compute()); }
  React: useMemo, useCallback to memoize values/functions.
  Libraries: memoizee, lodash.memoize, or custom caching.
  Can reduce execution time from seconds to microseconds.

---
id: javascript-quality-avoid-blocking-main-thread
language: javascript
severity: warning
message: "Performance: Expensive calculations should use Web Workers or async"
tags:
  - quality
  - performance
  - responsiveness
rule:
  kind: call_expression
  pattern: "function .*\\{[^}]{1000,}\\}|while.*i\\+\\+.*\\{[^}]{500,}\\}"
note: |
  Long-running sync code blocks UI (freezes app).
  Solution: Web Workers for heavy computation or setTimeout chunking.
  Pattern: new Worker('worker.js'); or: async function slowOp() { const result = await heavyCompute(); }
  Keeps UI responsive even during large data processing.

---
id: javascript-quality-connection-pooling-databases
language: javascript
severity: warning
message: "Performance: Use connection pooling for database connections, not 1 per request"
tags:
  - quality
  - performance
  - scalability
rule:
  kind: call_expression
  pattern: "new.*Connection\\(|createConnection\\(|connect\\(.*await"
note: |
  Creating new DB connection per request is slow and resource-intensive.
  Pattern: const pool = new ConnectionPool({ max: 10 }); const conn = await pool.get();
  Reuses connections, reduces latency from seconds to milliseconds.
  Libraries: node-pg-pool, mysql2/promise with pooling, Sequelize.
  Essential for production apps with high concurrency.
---
id: java-quality-constant-naming
language: java
severity: warning
message: "Quality: Static final fields should use UPPER_SNAKE_CASE"
tags: [quality, naming, constants]
rule:
  kind: field_declaration
  pattern: |
    static final $TYPE $NAME = ...
  constraints:
    - pattern: $NAME
      regex: "^(?![A-Z][A-Z0-9_]*$)"
note: |
  Constant naming convention improves code readability and immediately identifies immutable fields.
  Static final fields should use UPPER_SNAKE_CASE (e.g., MAX_BUFFER_SIZE, DEFAULT_TIMEOUT).
  This helps developers recognize compile-time constants and prevents accidental mutation.

---
id: java-quality-field-naming
language: java
severity: warning
message: "Quality: Instance fields should use lowerCamelCase"
tags: [quality, naming, fields]
rule:
  kind: field_declaration
  pattern: |
    private $TYPE $NAME;
  constraints:
    - pattern: $NAME
      regex: "^(?![a-z][a-zA-Z0-9]*$)"
note: |
  Instance field naming should follow lowerCamelCase convention (e.g., userId, accountBalance).
  This distinguishes instance fields from constants and method parameters, improving code clarity.

---
id: java-quality-null-pointer-exception
language: java
severity: error
message: "Quality: Potential NullPointerException - null check missing"
tags: [quality, null-safety, correctness]
rule:
  kind: method_invocation
  pattern: |
    $OBJ.$METHOD(...)
  constraints:
    - pattern: $OBJ
      not_matches: "^(this|super|Objects\\.requireNonNull|Optional).*"
    - pattern: $OBJ
      regex: "(?:get|find|retrieve|load).*"
note: |
  Methods returning nullable values (like get/find/retrieve) may return null.
  Always check for null before dereferencing or use Optional/null-coalescing patterns.
  Unchecked null dereferences are a leading cause of runtime exceptions.
  Use Objects.requireNonNull() for defensive programming or wrap with Optional.

---
id: java-quality-catch-generic-exception
language: java
severity: warning
message: "Quality: Catching generic Exception masks specific error handling"
tags: [quality, exception-handling, maintainability]
rule:
  kind: catch_clause
  pattern: |
    catch (Exception $E) {
      ...
    }
note: |
  Catching generic Exception swallows specific error types and hides the actual failure.
  This makes debugging harder and violates the "fail fast" principle.
  Instead, catch specific exceptions (IOException, SQLException, etc.) or use
  multi-catch for related exceptions: catch (IOException | SQLException e).
  Only catch Exception as a last resort for unexpected failures with proper logging.

---
id: java-quality-empty-catch-block
language: java
severity: error
message: "Quality: Empty catch block silently ignores errors"
tags: [quality, exception-handling, debugging]
rule:
  kind: catch_clause
  pattern: |
    catch ($TYPE $E) {
    }
note: |
  Empty catch blocks hide errors and make debugging nearly impossible.
  At minimum, log the exception with the actual error message and stack trace.
  If truly intentional, add a comment explaining why the exception is ignored.
  Pattern: catch (SpecificException e) { /* Expected in X scenario */ }
  Better pattern: Use try-with-resources for resource cleanup instead.

---
id: java-quality-resource-leak
language: java
severity: error
message: "Quality: Resource not closed - missing try-with-resources"
tags: [quality, resource-management, correctness]
rule:
  kind: variable_declaration
  pattern: |
    $TYPE $VAR = new $CLASS(...);
  constraints:
    - pattern: $CLASS
      regex: "(FileInputStream|FileOutputStream|BufferedReader|BufferedWriter|Connection|Statement|ResultSet|Stream)"
note: |
  AutoCloseable resources (streams, connections, etc.) must be closed to prevent leaks.
  Use try-with-resources syntax which guarantees closure even on exception:
    try (BufferedReader reader = new BufferedReader(...)) { ... }
  This is safer than try-finally and handles exceptions during close automatically.
  Exception: Only skip try-with-resources if provably returned or delegated to caller.

---
id: java-quality-static-field-mutation
language: java
severity: warning
message: "Quality: Static field should not be mutable - consider immutable or accessor"
tags: [quality, immutability, thread-safety]
rule:
  kind: field_declaration
  pattern: |
    static $TYPE $NAME;
  constraints:
    - pattern: $TYPE
      not_matches: "^(String|int|long|boolean|double|final).*"
note: |
  Mutable static fields create thread-safety issues and global state side effects.
  If mutation is needed, use thread-safe collections (ConcurrentHashMap) or synchronize access.
  If no mutation needed, declare final: static final MyType INSTANCE = ...
  Immutable statics are safer and can be aggressively optimized by JVM.
  If design requires per-instance state, use instance fields instead.

---
id: java-quality-equals-without-hashcode
language: java
severity: error
message: "Quality: equals() implemented without hashCode() - violates contract"
tags: [quality, correctness, collections]
rule:
  kind: method_declaration
  pattern: |
    public boolean equals(Object $O) {
      ...
    }
  constraints:
    - not_contains: "@Override"
    - sibling_not_contains: |
        public int hashCode() {
          ...
        }
note: |
  Java contract: if a.equals(b), then a.hashCode() == b.hashCode().
  Not implementing hashCode() when overriding equals() breaks collections:
  the object won't be found in HashSet/HashMap even if equals() returns true.
  Always implement both or neither. Both should consider the same fields.
  IDEs can auto-generate correct implementations (Alt+Ins in IntelliJ).

---
id: java-quality-hashcode-uses-mutable
language: java
severity: warning
message: "Quality: hashCode() depends on mutable field - object may behave incorrectly in collections"
tags: [quality, correctness, collections, immutability]
rule:
  kind: method_declaration
  pattern: |
    public int hashCode() {
      ...
    }
  constraints:
    - contains_pattern: "\\.hashCode\\(\\)|Objects\\.hash\\(.*\\w+.*\\)"
note: |
  If an object's hash code changes after insertion in a HashSet/HashMap,
  the object becomes "lost" in the collection - lookup fails even if equals() returns true.
  Solution: base hashCode() only on immutable fields (final fields, primitives, strings).
  If using mutable fields in equals(), use an immutable ID instead for hashing.
  Common issue: including List/Map fields in hashCode() when they can be modified.

---
id: java-quality-mutable-default-argument
language: java
severity: warning
message: "Quality: Returning mutable default may expose internal state to modification"
tags: [quality, immutability, encapsulation]
rule:
  kind: method_declaration
  pattern: |
    public $TYPE $METHOD(...) {
      if (...) return $FIELD;
      ...
    }
  constraints:
    - pattern: $TYPE
      regex: "(ArrayList|HashMap|HashSet|List|Map|Set)(?<!^(Collections\\.unmodifiableList|Collections\\.unmodifiableMap|Collections\\.unmodifiableSet))"
note: |
  Returning mutable collections directly exposes internal state.
  Caller can modify the returned collection, corrupting internal data.
  Solutions:
    1. Return unmodifiable wrapper: return Collections.unmodifiableList(items);
    2. Return defensive copy: return new ArrayList<>(items);
    3. Return immutable: return List.copyOf(items); [Java 10+]
  This is critical for library APIs where you control invariants.

---
id: java-quality-string-concatenation-loop
language: java
severity: warning
message: "Quality: String concatenation in loop creates excessive objects - use StringBuilder"
tags: [quality, performance, string-handling]
rule:
  kind: for_statement|while_statement
  pattern: |
    $STR = $STR + ...
note: |
  String concatenation (+=) in loops creates O(n) temporary objects.
  Each concatenation allocates a new String and copies old content.
  This is 10-100x slower than StringBuilder.
  Use StringBuilder for loops:
    StringBuilder sb = new StringBuilder();
    for (...) { sb.append(...); }
    String result = sb.toString();
  For single concatenations, += is fine (compiler optimizes to StringBuilder).

---
id: java-quality-method-complexity-high
language: java
severity: warning
message: "Quality: Method is too complex - consider breaking into smaller pieces"
tags: [quality, complexity, maintainability]
rule:
  kind: method_declaration
  pattern: |
    $MODIFIER $TYPE $METHOD(...) {
      ...
    }
  constraints:
    - cyclomatic_complexity: "> 10"
note: |
  High cyclomatic complexity (many branches) indicates the method does too much.
  Complex methods are harder to test, understand, and maintain.
  Target: keep cyclomatic complexity ≤ 10 (roughly, 10 branches/decision points).
  Solutions:
    1. Extract conditional branches into private helper methods
    2. Use strategy pattern for different behaviors
    3. Simplify control flow (combine conditions, use early returns)
  Testability: for n branches, need 2^n test cases to cover all paths.

---
id: java-quality-parameter-count
language: java
severity: warning
message: "Quality: Too many parameters - consider using builder or parameter object"
tags: [quality, complexity, maintainability]
rule:
  kind: method_declaration
  pattern: |
    $MODIFIER $TYPE $METHOD($PARAM1, $PARAM2, $PARAM3, $PARAM4, $PARAM5, ...) {
      ...
    }
note: |
  Methods with >4 parameters are harder to call correctly and maintain.
  Callers must remember parameter order; easy to pass wrong value.
  Solutions:
    1. Builder pattern: new UserBuilder().name("Bob").age(30).build()
    2. Parameter object: new UserRequest(name, age, email, phone)
    3. Split method: smaller methods focused on specific parameters
  Benefits: improves readability, enables extensibility, reduces caller errors.

---
id: java-quality-synchronized-block
language: java
severity: warning
message: "Quality: Raw synchronization is error-prone - consider java.util.concurrent"
tags: [quality, thread-safety, concurrency]
rule:
  kind: synchronized_statement
  pattern: |
    synchronized($LOCK) {
      ...
    }
note: |
  Raw synchronized blocks are easy to misuse and hard to debug.
  Modern alternatives are safer and more efficient:
    1. ConcurrentHashMap instead of synchronized HashMap
    2. ReentrantLock for complex locking scenarios
    3. Atomic* classes for single variable updates
    4. ReadWriteLock for read-heavy workloads
  Advantages of java.util.concurrent:
    - Clearer intent
    - Better performance (lock striping, atomic operations)
    - Easier testing and reasoning about deadlocks
  Use synchronized only for simple, short critical sections or when legacy compatibility required.

---
id: java-quality-thread-safety-field
language: java
severity: warning
message: "Quality: Field accessed by multiple threads without synchronization"
tags: [quality, thread-safety, concurrency]
rule:
  kind: field_declaration
  pattern: |
    private $TYPE $FIELD;
  constraints:
    - not_contains: "volatile|final|Atomic|synchronized"
note: |
  If a field is accessed by multiple threads without synchronization or volatile,
  visibility issues can occur: one thread's changes may not be seen by another.
  Solutions:
    1. Make it final: private final Type field;
    2. Use volatile: private volatile Type field; (for simple flags, primitives)
    3. Wrap in Atomic*: private AtomicReference<Type> field;
    4. Guard with synchronized/Lock in accessor methods
  Volatile prevents reordering and ensures visibility but not atomicity.
  For atomic operations, use AtomicInteger, AtomicReference, etc.

---
id: java-quality-weak-random
language: java
severity: warning
message: "Quality: Using Random for security/crypto - use java.security.SecureRandom"
tags: [quality, security, cryptography]
rule:
  kind: object_creation
  pattern: |
    new Random()
note: |
  java.util.Random is not cryptographically secure - predictable and weak.
  Using Random for security tokens, IDs, or encryption is a vulnerability.
  Use SecureRandom instead:
    SecureRandom random = new SecureRandom();
    byte[] bytes = new byte[16];
    random.nextBytes(bytes);
  SecureRandom uses system entropy and is suitable for security-sensitive values.
  Also suitable: ThreadLocalRandom for non-security performance-critical randomness.

---
id: java-quality-default-charset
language: java
severity: warning
message: "Quality: Using default charset is platform-dependent - specify explicit charset"
tags: [quality, portability, internationalization]
rule:
  kind: method_invocation
  pattern: |
    $OBJ.getBytes()|new String($BYTES)|new FileInputStream(...)|new InputStreamReader(...)
  constraints:
    - not_contains: "StandardCharsets|Charset\\.forName|UTF-8"
note: |
  Using default charset (varies by platform/JVM) causes bugs in different environments.
  Windows might default to CP1252, Linux to UTF-8 - same code behaves differently.
  Always specify explicit charset:
    str.getBytes(StandardCharsets.UTF_8)
    new String(bytes, StandardCharsets.UTF_8)
    new InputStreamReader(stream, StandardCharsets.UTF_8)
  Preferred: StandardCharsets.UTF_8 (immutable, pre-constructed, no exceptions).
  This ensures consistent behavior across all platforms and environments.

---
id: java-quality-null-object-antipattern
language: java
severity: warning
message: "Quality: Use Optional instead of null return - clearer intent and prevents NPE"
tags: [quality, null-safety, api-design]
rule:
  kind: method_declaration
  pattern: |
    public $TYPE get$METHOD() {
      if (...) return null;
      return ...;
    }
note: |
  Returning null for "not found" is error-prone - callers forget null checks.
  Use Optional<T> to explicitly signal "value may be absent":
    Optional<User> getUser(int id) { ... }
    user.ifPresent(u -> process(u));
    User u = user.orElseThrow();
  Benefits:
    1. Compiler catches forgetting null checks (cannot call .get() without handling empty)
    2. Clear API contract: "this method may not return a value"
    3. Chaining: optional.map(...).filter(...).orElse(default)
  Note: Do not use Optional for fields or method parameters (use non-null instead).

---
id: java-quality-exception-in-finally
language: java
severity: error
message: "Quality: Exception in finally block masks original exception"
tags: [quality, exception-handling, correctness]
rule:
  kind: finally_clause
  pattern: |
    finally {
      $RISKY_METHOD(...)
    }
note: |
  If finally block throws an exception, it replaces the exception from try block.
  Original exception is lost, making debugging impossible.
  Example (BAD):
    try { ... throw new IOException("original"); }
    finally { resource.close(); } // if close() throws, IOException is hidden

  Solutions:
    1. Use try-with-resources (handles close exceptions properly)
    2. Guard cleanup code: try { resource.close(); } catch (Exception e) { log(e); }
    3. Use try-finally-catch to rethrow original:
       catch (Exception ignored) { }
  Best practice: try-with-resources handles this automatically.

---
id: java-quality-mutable-static-collection
language: java
severity: error
message: "Quality: Static mutable collection is unsafe - use synchronized/unmodifiable/final"
tags: [quality, thread-safety, immutability]
rule:
  kind: field_declaration
  pattern: |
    static $COLLECTION $NAME = new (ArrayList|HashMap|HashSet)(...);
note: |
  Static mutable collections are shared across all instances and threads.
  Without synchronization, concurrent access causes data corruption.
  Without final, someone may reassign the reference entirely.
  Solutions (in priority order):
    1. static final: static final List<Item> ITEMS = new ArrayList<>();
       Then synchronize access: synchronized(ITEMS) { ITEMS.add(...); }
    2. Immutable: static final List<Item> ITEMS = List.of(...);
    3. Thread-safe wrapper: static final List<Item> ITEMS = Collections.synchronizedList(new ArrayList<>());
    4. ConcurrentCollection: static final ConcurrentHashMap<K,V> MAP = new ConcurrentHashMap<>();
  If truly static and immutable, use Collections.unmodifiableList(items).

---
id: java-quality-equals-identity-check
language: java
severity: warning
message: "Quality: equals() using identity (==) for reference types - use field comparison"
tags: [quality, correctness, equality]
rule:
  kind: method_declaration
  pattern: |
    public boolean equals(Object obj) {
      if (this == obj) return true;
      return this.$FIELD == obj.$FIELD;
    }
note: |
  Using == for reference types in equals() is incorrect - checks object identity, not value.
  Two different objects with the same field values should be equal but == returns false.
  Correct pattern:
    public boolean equals(Object obj) {
      if (this == obj) return true;
      if (obj == null || getClass() != obj.getClass()) return false;
      MyClass other = (MyClass) obj;
      return Objects.equals(this.field, other.field) &&
             this.primitive == other.primitive;
    }
  Use Objects.equals() which handles null safely (a.equals(null) returns false, not NPE).
  For non-null fields, use .equals(); for primitives, use ==.

---
id: java-quality-primitive-wrapper-equality
language: java
severity: warning
message: "Quality: Comparing primitive wrappers with == - use equals() or unbox"
tags: [quality, correctness, performance]
rule:
  kind: binary_expression
  pattern: |
    $WRAPPER1 == $WRAPPER2
  constraints:
    - pattern: $WRAPPER1
      regex: "(Integer|Long|Boolean|Double|Float).*"
note: |
  Integer/Long/Boolean wrappers use == for identity, not value comparison.
  Integer a = 100; Integer b = 100; a == b may be true (cached) but unreliable.
  Integer c = 1000; Integer d = 1000; c == d is false (no caching for large values).
  Solutions:
    1. Use .equals(): a.equals(b)
    2. Unbox to primitive: a.intValue() == b.intValue()
    3. Use compareTo(): a.compareTo(b) == 0
  Correct: use == only for null checks (a == null), equals() for values.

---
id: java-quality-type-cast-safety
language: java
severity: warning
message: "Quality: Unchecked type cast - verify instance type first"
tags: [quality, correctness, type-safety]
rule:
  kind: type_cast
  pattern: |
    ($TYPE) $OBJ
  constraints:
    - not_preceded_by: "instanceof"
note: |
  Type casts without instanceof check risk ClassCastException at runtime.
  If $OBJ is wrong type, the cast succeeds but usage fails later (bad error message).
  Safe pattern:
    if (obj instanceof MyType) {
      MyType typed = (MyType) obj;
      // ... use typed safely
    }
  Better (Java 16+) with pattern matching:
    if (obj instanceof MyType typed) {
      // ... use typed directly
    }
  Always check type before casting, especially in generic code or when processing
  collections that should contain single type but lack compile-time verification.

---
id: java-quality-raw-type-usage
language: java
severity: warning
message: "Quality: Using raw type - specify generic type parameters"
tags: [quality, type-safety, generics]
rule:
  kind: type_reference
  pattern: |
    ArrayList|HashMap|HashSet|List|Map|Set
  constraints:
    - not_contains: "<.*>"
note: |
  Raw types (ArrayList instead of ArrayList<String>) lose compile-time type safety.
  Causes unchecked cast warnings and bugs when retrieving elements.
  ArrayList list = new ArrayList(); // raw type - contains Object
  String s = (String) list.get(0); // unchecked cast

  Better:
  ArrayList<String> list = new ArrayList<>();
  String s = list.get(0); // safe, no cast needed

  Benefits:
    1. Compiler catches type mismatches
    2. No unchecked casts
    3. Self-documenting code (clear what type is stored)
  Exception: only raw types allowed in legacy code or instanceof (can't use generics in instanceof).

---
id: java-quality-incomplete-switch
language: java
severity: warning
message: "Quality: Switch missing default case - may miss enum values or unexpected cases"
tags: [quality, correctness, maintainability]
rule:
  kind: switch_statement
  pattern: |
    switch ($EXPR) {
      case ...: break;
    }
  constraints:
    - not_contains: "default:"
note: |
  Switch without default case may silently ignore unexpected values.
  If enum is extended later, switch fails silently without warning.

  Safe patterns:
    1. Add default with exception: default: throw new IllegalArgumentException(...);
    2. Add default with assertion: default: assert false : "unexpected " + expr;
    3. Use exhaustive switch (Java 17+) with sealed types/enums

  For enums especially, missing default can mask evolution issues:
    enum Color { RED, GREEN; } // later someone adds BLUE
    switch (color) {
      case RED: ...; break;
      case GREEN: ...; break;
      // BLUE falls through, unhandled!
    }

  Best practice: always include default, even if empty (with comment why).

---
id: java-quality-public-mutable-field
language: java
severity: error
message: "Quality: Public mutable field breaks encapsulation - use private with accessor"
tags: [quality, encapsulation, design]
rule:
  kind: field_declaration
  pattern: |
    public $TYPE $FIELD;
  constraints:
    - not_contains: "final"
note: |
  Public mutable fields break encapsulation - callers can modify internal state directly.
  This makes evolution impossible: if you later need validation/side-effects, you break all callers.
  Pattern (BAD):
    public class User {
      public String name;
    }
    user.name = ""; // no validation!

  Pattern (GOOD):
    public class User {
      private String name;
      public String getName() { return name; }
      public void setName(String name) {
        if (name == null || name.isEmpty()) throw new IllegalArgumentException(...);
        this.name = name;
      }
    }

  Exceptions (acceptable):
    1. public static final constants (immutable)
    2. Immutable value objects: public final String name;
    3. Record classes (Java 16+): record User(String name) { }
       - Records auto-generate accessors, but fields are effectively final

---
id: java-quality-unused-variable
language: java
severity: info
message: "Quality: Unused variable wastes memory and indicates dead code"
tags: [quality, code-smell, maintainability]
rule:
  kind: variable_declaration
  pattern: |
    $TYPE $VAR = ...;
  constraints:
    - not_used_in: "scope"
note: |
  Unused variables indicate dead code or incomplete refactoring.
  They waste memory and confuse readers about intent.
  Solutions:
    1. Remove the variable entirely if not needed
    2. Use underscore if intentionally unused (Java 9+): for (var _ : list) { ... }
    3. If capture is needed but unused, document: var unused = obj.expensiveInit(); // triggers side effect

  Common causes:
    - Incomplete refactoring (moved code elsewhere)
    - Try-catch with unused exception: catch (Exception e) { }
      Better: catch (IOException ignored) { } or catch (IOException | SQLException e) { }
    - Loop variable not needed: for (int i = 0; i < n; i++) can use enhanced for

  IDEs warn by default - fix these to keep codebase clean.

---
id: java-quality-duplicate-code
language: java
severity: warning
message: "Quality: Duplicated code should be extracted to method - violates DRY"
tags: [quality, maintainability, code-smell]
rule:
  kind: block
  pattern: |
    {
      $STMT1
      $STMT2
      ...
    }
note: |
  Duplicated code blocks are maintenance nightmares - fix one, miss the other.
  Violates DRY (Don't Repeat Yourself) principle.
  Solutions:
    1. Extract to private method:
       private void commonLogic() { /* duplicated code */ }
    2. Use inheritance if pattern is in superclass
    3. Composition: use helper class if not inheritance hierarchy
    4. Aspect-oriented: @Transactional, @Cacheable for cross-cutting concerns

  Duplicated code causes bugs: fix one location, others still broken.
  Copy-paste errors are common when changing one instance.
  Even slight variations should be extracted and parameterized.

  Tools like SonarQube detect duplication automatically.

---
id: java-quality-magic-number
language: java
severity: info
message: "Quality: Magic number - extract to named constant for clarity"
tags: [quality, readability, maintainability]
rule:
  kind: numeric_literal
  pattern: |
    [0-9]+
  constraints:
    - not_in: "for loop|array index|return 0|return 1"
    - value_not_in: "0|1|2|10|100"
note: |
  Magic numbers (unnamed constants) make code hard to understand.
  What does 86400 mean? 1024? -1? Readers must reverse-engineer intent.
  Solution: extract to named constant:
    private static final int SECONDS_PER_DAY = 86400;
    private static final int KILOBYTES_TO_BYTES = 1024;
    private static final int NOT_FOUND = -1;

  Benefits:
    1. Code is self-documenting
    2. Change in one place (if requirement changes)
    3. Prevents typos (use constant name, not mistyped number)

  Exceptions (acceptable):
    - 0, 1, -1, 2, 10, 100: universally understood as loop bounds, offsets
    - Array indices in iteration
    - Loop increment/decrement

  Use constants for anything else: timeouts, buffer sizes, thresholds, codes.

---
id: java-quality-method-should-be-static
language: java
severity: info
message: "Quality: Method doesn't use instance state - consider making static"
tags: [quality, code-smell, design]
rule:
  kind: method_declaration
  pattern: |
    private $TYPE $METHOD() {
      ...
    }
  constraints:
    - not_uses: "this|this\\."
note: |
  Methods that don't reference instance state (this.field) can be static.
  Making them static clarifies intent: "no dependency on instance state."
  Callers don't need to create instances for utility methods.

  Example (BAD):
    public class StringUtils {
      public String reverseString(String s) { // doesn't use this
        return new StringBuilder(s).reverse().toString();
      }
    }
    // Caller must do: new StringUtils().reverseString(s);

  Example (GOOD):
    public class StringUtils {
      public static String reverseString(String s) {
        return new StringBuilder(s).reverse().toString();
      }
    }
    // Caller: StringUtils.reverseString(s);

  Benefits:
    1. Clear that method has no side effects on instance
    2. Can call without instantiation
    3. Better for testing (no mock instance needed)
    4. Thread-safe by design (no mutable state)

  Tool: IDEs suggest this automatically.

---
id: java-quality-instanceof-then-cast
language: java
severity: info
message: "Quality: Use pattern matching (instanceof) instead of redundant cast"
tags: [quality, readability, modern-java]
rule:
  kind: if_statement
  pattern: |
    if ($OBJ instanceof $TYPE) {
      $TYPE casted = ($TYPE) $OBJ;
      ...
    }
note: |
  Verbose instanceof check followed by explicit cast is redundant.
  Java 16+ introduces pattern matching which combines both:
    if (obj instanceof MyType typed) {
      // use typed directly
    }

  This is cleaner, shorter, and eliminates the redundant cast.
  Older Java (pre-16):
    if (obj instanceof MyType) {
      MyType typed = (MyType) obj;
      ...
    }

  Modern Java (16+):
    if (obj instanceof MyType typed) {
      ...
    }

  Pattern matching also works with guards (Java 17+):
    if (obj instanceof String s && s.length() > 5) { ... }

  Benefits:
    1. Less boilerplate
    2. Variable scoped to if block (no leaking into outer scope)
    3. Compiler ensures safety

---
id: java-quality-immutable-class-incomplete
language: java
severity: warning
message: "Quality: Immutable class is mutable - ensure all fields final and no setters"
tags: [quality, immutability, design]
rule:
  kind: class_declaration
  pattern: |
    public class $CLASS {
      $MODIFIERS $TYPE $FIELD;
      ...
    }
  constraints:
    - contains: "private final"
    - not_contains: "public.*set"
note: |
  To be truly immutable:
    1. All fields must be private final
    2. No setters
    3. No methods that modify state
    4. If field is mutable (List, Date), return defensive copy
    5. Class should be final (prevent subclass from adding mutability)

  Example (GOOD):
    public final class ImmutableUser {
      private final String name;
      private final int age;
      public ImmutableUser(String name, int age) {
        this.name = name; this.age = age;
      }
      public String getName() { return name; }
      public int getAge() { return age; }
    }

  Benefits:
    1. Thread-safe by design (no synchronization needed)
    2. Can be safely shared and cached
    3. Hash code never changes (safe in HashMaps)
    4. Better for functional programming style

  Pattern: use records (Java 16+) for automatic immutability:
    record User(String name, int age) { }

---
id: java-quality-comment-wrong
language: java
severity: info
message: "Quality: Outdated comment - may mislead readers if code changed"
tags: [quality, documentation, maintainability]
rule:
  kind: comment
  pattern: |
    //.*TODO|FIXME|XXX|HACK|BUG
note: |
  Outdated or misleading comments are worse than no comment.
  Developers trust comments; wrong comments cause bugs.

  Best practices:
    1. Remove obvious comments: // i++  (comment doesn't add value)
    2. Remove outdated comments: // old approach (irrelevant history)
    3. Update comments when code changes
    4. Use TODO/FIXME for known issues, not as permanent comments

  Good comments explain "why" not "what":
    GOOD:  // Cache invalidated at midnight to reflect daily pricing updates
    BAD:   // Call updateCache()

    GOOD:  // Retry with exponential backoff - prevents thundering herd
    BAD:   // Retry

  Markers (actionable):
    TODO: Work not yet done (include owner: @author or timeline)
    FIXME: Known issue to fix (include description)
    XXX: Unclear/fragile code (explain the problem)
    HACK: Temporary workaround (explain the real solution)

  Example:
    // TODO: (John) Replace with proper database query after schema migration
    // FIXME: NPE when user == null, caused by incomplete refactoring

---
id: java-quality-field-initialization-race
language: java
severity: warning
message: "Quality: Non-volatile field initialization may have race condition in lazy loading"
tags: [quality, thread-safety, concurrency]
rule:
  kind: field_declaration
  pattern: |
    private $TYPE $FIELD;
    ...
    if ($FIELD == null) {
      $FIELD = new $CLASS(...);
    }
note: |
  Double-checked locking anti-pattern without volatile causes data races.
  Between null check and assignment, another thread may also initialize.
  Both threads allocate resources, one assignment is lost (memory leak).

  Correct patterns:
    1. Eager initialization: private final Type field = new Type();
    2. Lazy with synchronized:
       synchronized(this) {
         if (field == null) field = new Type();
       }
    3. Lazy with volatile (double-checked locking):
       private volatile Type field; // MUST be volatile!
       if (field == null) {
         synchronized(this) {
           if (field == null) field = new Type();
         }
       }
    4. Holder pattern (best for static):
       class Holder {
         static final Type FIELD = new Type();
       }
       // Access: Holder.FIELD

  Without volatile, JVM can reorder: assignment visible to one thread, not another.
  volatile forces memory barrier: write is immediately visible to all threads.

---
id: java-quality-varargs-safety
language: java
severity: warning
message: "Quality: Varargs parameter should be last and not mutable"
tags: [quality, design, safety]
rule:
  kind: method_declaration
  pattern: |
    $TYPE $METHOD($TYPE... $VARARGS, $PARAM)
  constraints:
    - varargs_not_last: true
note: |
  Varargs (...) parameter creates an array internally.
  If not last, syntax becomes confusing - where does varargs end?
  If mutable (List, Date), caller can modify array after method returns.

  Bad:
    void method(String... names, int count) // varargs not last - confusing!
    void method(int[] data, int... moreData) // caller can mutate moreData after call

  Good:
    void method(int count, String... names) // varargs last
    void method(String... names) // only varargs

  If you need mutable varargs safety, copy: int[] copy = data.clone();

  Benefits of varargs last:
    1. Clear syntax - everything after is varargs
    2. Caller understands array creation
    3. JVM handles array creation safely

---
id: java-quality-float-equality
language: java
severity: error
message: "Quality: Comparing floats/doubles with == is unreliable - use tolerance or BigDecimal"
tags: [quality, correctness, floating-point]
rule:
  kind: binary_expression
  pattern: |
    $FLOAT == $FLOAT|$DOUBLE == $DOUBLE
  constraints:
    - not_contains: "0.0"
note: |
  Floating-point arithmetic is imprecise - 0.1 + 0.2 != 0.3 (not equal).
  Using == for float/double comparison fails frequently:
    float a = 0.1f + 0.2f;
    if (a == 0.3f) { } // false! (a is 0.30000004)

  Solutions:
    1. Tolerance-based comparison:
       if (Math.abs(a - b) < 1e-6) { /* equal within tolerance */ }
    2. BigDecimal for exact values:
       BigDecimal a = new BigDecimal("0.1").add(new BigDecimal("0.2"));
       if (a.equals(new BigDecimal("0.3"))) { }
    3. Use integer arithmetic if possible (avoid floats entirely)

  Exception: == 0.0 is safe (zero is exactly representable)

  Performance: avoid BigDecimal in tight loops (slower), use tolerance instead.
  Monetary calculations: always use BigDecimal (floats lose precision).

---
id: go-quality-naked-return
language: go
severity: error
message: "Quality: Naked return in function with >1 return value reduces readability"
tags: [quality, readability, naming]
rule:
  kind: function_decl
  pattern: |
    func $NAME($PARAMS) ($RETURNS) {
      $$BODY
      return
    }
note: |
  Naked return (bare 'return' without values) is error-prone when a function has
  multiple named return values. It works but obscures the actual values being returned.

  BAD:
    func divide(a, b int) (result int, err error) {
      if b == 0 {
        return  // What are we returning?
      }
      result = a / b
      return   // Same here
    }

  GOOD:
    func divide(a, b int) (result int, err error) {
      if b == 0 {
        return 0, errors.New("division by zero")
      }
      return a / b, nil
    }

  When to use naked return:
  - Only in simple functions with single or obvious return values
  - Acceptable when value is calculated once at end of function

  See: https://golang.org/doc/effective_go#named-results

---
id: go-quality-interface-satisfaction
language: go
severity: warning
message: "Quality: Interface larger than 3 methods without clear cohesion - consider splitting"
tags: [quality, interface-design, maintenance]
rule:
  kind: interface_type
  pattern: |
    interface {
      $METHOD1($ARGS1) $RET1
      $METHOD2($ARGS2) $RET2
      $METHOD3($ARGS3) $RET3
      $METHOD4($ARGS4) $RET4
    }
note: |
  Large interfaces become "fat interfaces" - they're harder to implement, test, and mock.
  Go's interface segregation principle: prefer small, focused interfaces.

  BAD:
    type Database interface {
      Query(sql string, args ...interface{}) (Rows, error)
      Exec(sql string, args ...interface{}) (Result, error)
      Prepare(query string) (Stmt, error)
      Close() error
      Ping() error
      Begin() (Tx, error)
    }

  GOOD:
    type Querier interface {
      Query(sql string, args ...interface{}) (Rows, error)
    }
    type Execer interface {
      Exec(sql string, args ...interface{}) (Result, error)
    }
    type Closer interface {
      Close() error
    }

  Benefits:
  - Easier to mock for testing
  - Types can satisfy multiple small interfaces
  - Clear, single responsibility
  - Better composition

  See: https://golang.org/doc/effective_go#interfaces

---
id: go-quality-error-wrapping-chain
language: go
severity: warning
message: "Quality: Error not wrapped - caller cannot check cause with errors.Is/As"
tags: [quality, error-handling, debugging]
rule:
  kind: return_statement
  pattern: |
    return fmt.Errorf($MSG)
note: |
  Errors should be wrapped to preserve the error chain for errors.Is() and errors.As().
  When you return fmt.Errorf() without wrapping, you lose the original error context.

  BAD:
    if err != nil {
      return fmt.Errorf("failed to connect: %v", err)  // Error chain lost
    }

  GOOD:
    if err != nil {
      return fmt.Errorf("failed to connect: %w", err)  // %w preserves error
    }

  Usage:
    err := someOperation()
    if err != nil {
      return fmt.Errorf("wrapper: %w", err)  // Wraps error preserving chain
    }

    // Caller can check:
    if errors.Is(err, specificError) { }
    if errors.As(err, &customErr) { }

  See: https://golang.org/pkg/errors/

---
id: go-quality-error-nil-check
language: go
severity: error
message: "Quality: Error returned but not checked - deferred cleanup may fail silently"
tags: [quality, error-handling, reliability]
rule:
  kind: expression_statement
  pattern: |
    defer $FUNC($ARGS)
note: |
  Deferred functions that return errors should be explicitly handled.
  Silent error loss in deferred Close() calls can mask resource leaks.

  BAD:
    func processFile(path string) error {
      f, err := os.Open(path)
      if err != nil {
        return err
      }
      defer f.Close()  // Error silently lost

      // ... use f
      return nil
    }

  GOOD:
    func processFile(path string) error {
      f, err := os.Open(path)
      if err != nil {
        return err
      }
      defer func() {
        if err := f.Close(); err != nil {
          log.Printf("warning: close failed: %v", err)
        }
      }()

      // ... use f
      return nil
    }

  Or for critical operations:
    defer func() {
      if err := f.Close(); err != nil {
        return fmt.Errorf("close failed: %w", err)
      }
    }()

  See: https://golang.org/doc/effective_go#defer

---
id: go-quality-receiver-consistency
language: go
severity: warning
message: "Quality: Receiver type inconsistent - method has pointer receiver but type often passed by value"
tags: [quality, api-design, consistency]
rule:
  kind: method_decl
  pattern: |
    func ($RECV *$TYPE) $METHOD($PARAMS) $RET {
      $$BODY
    }
note: |
  Be consistent with receiver types (value vs pointer) across all methods on a type.
  Mixed receivers confuse callers and can lead to unexpected behavior.

  Rules:
  1. Use pointer receivers if ANY method modifies the receiver
  2. Use pointer receivers for large structs (avoid copying)
  3. Use value receivers for small, immutable values (time.Time, math.Vec3)

  BAD:
    type Counter struct { n int }

    func (c Counter) Inc() { c.n++ }      // Value receiver - modification lost
    func (c *Counter) Reset() { c.n = 0 } // Pointer receiver
    func (c Counter) Get() int { return c.n } // Value receiver

    // Confusing for callers

  GOOD:
    type Counter struct { n int }

    func (c *Counter) Inc() { c.n++ }
    func (c *Counter) Reset() { c.n = 0 }
    func (c *Counter) Get() int { return c.n }

    // Consistent: always pointer receiver when modification needed

  ALSO GOOD (immutable):
    type Point struct { X, Y float64 }

    func (p Point) Distance(q Point) float64 { ... }
    func (p Point) Scale(factor float64) Point { ... }

    // All value receivers work - immutable semantics

  See: https://golang.org/doc/effective_go#pointers_vs_values

---
id: go-quality-interface-empty-check
language: go
severity: warning
message: "Quality: Empty interface{} used - consider using concrete type or constrained generic"
tags: [quality, type-safety, readability]
rule:
  kind: field_decl
  pattern: |
    $NAME interface{}
note: |
  Overuse of empty interface{} loses type safety and clarity.
  Go 1.18+ generics and type parameters provide better alternatives.

  BAD:
    type Config struct {
      Values map[string]interface{}  // No type info
    }

    func process(data interface{}) {  // Requires runtime type assertions
      if v, ok := data.(string); ok {
        // Handle string
      } else if v, ok := data.(int); ok {
        // Handle int
      }
    }

  GOOD (Go 1.18+):
    type Config struct {
      Values map[string]string      // Clear intent
    }

    func process[T comparable](data T) {  // Generic with constraint
      // Type safe at compile time
    }

  GOOD (before 1.18):
    type Config struct {
      StringValues map[string]string
      IntValues map[string]int
    }

  Valid uses for interface{}:
  - Serialization (JSON marshaling needs flexibility)
  - Runtime plugin systems
  - Reflection-based frameworks
  - Constraint-free mapping (but document the expected types)

  See: https://go.dev/doc/tutorial/generics

---
id: go-quality-goroutine-leak
language: go
severity: error
message: "Quality: Goroutine spawned without cancellation context - potential resource leak"
tags: [quality, concurrency, resource-leak]
rule:
  kind: go_statement
  pattern: |
    go $FUNC($ARGS)
note: |
  Every goroutine should have a way to be cancelled/stopped to prevent leaks.
  Goroutines without context can keep running indefinitely.

  BAD:
    func listen() {
      go func() {
        for {
          msg := <-ch
          process(msg)
        }
      }()
      // Goroutine runs forever - no way to stop it
    }

  GOOD:
    func listen(ctx context.Context, ch <-chan Message) {
      go func() {
        for {
          select {
          case msg := <-ch:
            process(msg)
          case <-ctx.Done():
            return  // Clean exit
          }
        }
      }()
    }

  GOOD (channels with signal):
    func listen(stop <-chan struct{}, ch <-chan Message) {
      go func() {
        for {
          select {
          case msg := <-ch:
            process(msg)
          case <-stop:
            return
          }
        }
      }()
    }

  Testing goroutine leaks:
    func TestNoLeaks(t *testing.T) {
      before := runtime.NumGoroutine()
      defer func() {
        // Give goroutines time to exit
        time.Sleep(100 * time.Millisecond)
        after := runtime.NumGoroutine()
        if after > before {
          t.Fatalf("goroutine leak: %d extra goroutines", after-before)
        }
      }()
      // Your test
    }

  See: https://go.dev/blog/context

---
id: go-quality-race-condition
language: go
severity: error
message: "Quality: Shared variable accessed without synchronization - potential race condition"
tags: [quality, concurrency, thread-safety]
rule:
  kind: block
  pattern: |
    go func() {
      $$BODY
    }()
note: |
  Variables modified in goroutines must be protected with sync.Mutex, channels, or atomics.
  Use `go test -race` to detect races at test time.

  BAD:
    var counter int  // Shared mutable state

    func increment() {
      go func() { counter++ }()
      go func() { counter++ }()
      // Data race: both goroutines write to counter simultaneously
    }

  GOOD (Mutex):
    var (
      mu sync.Mutex
      counter int
    )

    func increment() {
      mu.Lock()
      counter++
      mu.Unlock()
    }

  GOOD (Atomic):
    var counter atomic.Int32

    func increment() {
      counter.Add(1)
    }

  GOOD (Channel):
    func increment(ch chan int) {
      go func() { ch <- 1 }()
      go func() { ch <- 1 }()
      counter := 0
      counter += <-ch
      counter += <-ch
    }

  Testing for races:
    go test -race ./...

  See: https://go.dev/doc/effective_go#concurrency

---
id: go-quality-channel-close-panic
language: go
severity: error
message: "Quality: Channel closed multiple times or by receiver - causes panic"
tags: [quality, concurrency, panic]
rule:
  kind: call_expression
  pattern: |
    close($CHAN)
note: |
  Only the sender should close a channel. Closing an already-closed channel panics.
  Establish clear ownership: sender closes, receiver does not.

  BAD:
    func process(ch chan int) {
      go func() {
        for v := range ch {
          fmt.Println(v)
        }
        close(ch)  // Receiver closing - if sender also closes, panic!
      }()
    }

  BAD (multiple closes):
    func cleanup(ch chan int) {
      close(ch)
      close(ch)  // PANIC: close of closed channel
    }

  GOOD (clear ownership):
    func send(ch chan int) {
      go func() {
        ch <- 1
        ch <- 2
        close(ch)  // ONLY sender closes
      }()
    }

    func receive(ch chan int) {
      for v := range ch {  // Receiver doesn't need to close
        fmt.Println(v)
      }
    }

  GOOD (multiple senders):
    type Hub struct {
      done <-chan struct{}
      ch   chan int
    }

    func (h *Hub) Send(v int) {
      select {
      case h.ch <- v:
      case <-h.done:
        return  // Closed by controller, don't send
      }
    }

  Safe pattern (sync.Once):
    var (
      mu sync.Mutex
      closed bool
      ch chan int
    )

    func safeClose() {
      mu.Lock()
      defer mu.Unlock()
      if !closed {
        close(ch)
        closed = true
      }
    }

  See: https://go.dev/blog/pipelines

---
id: go-quality-buffered-channel-deadlock
language: go
severity: warning
message: "Quality: Buffered channel receive not in select/goroutine - may deadlock if buffer exceeded"
tags: [quality, concurrency, deadlock]
rule:
  kind: expression_statement
  pattern: |
    <- $CHAN
note: |
  Blocking channel receive in main goroutine can deadlock if buffer is full
  or if no sender is available. Use select, timeout, or goroutines.

  BAD (potential deadlock):
    func process() {
      ch := make(chan int, 10)

      // Main goroutine blocks if nothing sends
      v := <-ch  // Can block indefinitely
      fmt.Println(v)
    }

  GOOD (with timeout):
    func process() {
      ch := make(chan int, 10)

      select {
      case v := <-ch:
        fmt.Println(v)
      case <-time.After(5 * time.Second):
        log.Fatal("timeout: no message received")
      }
    }

  GOOD (with context):
    func process(ctx context.Context) {
      ch := make(chan int, 10)

      select {
      case v := <-ch:
        fmt.Println(v)
      case <-ctx.Done():
        return  // Context cancelled
      }
    }

  GOOD (spawn sender goroutine):
    func process() {
      ch := make(chan int)

      go func() {
        ch <- 42
      }()

      v := <-ch  // Sender will deliver
      fmt.Println(v)
    }

  See: https://go.dev/blog/select

---
id: go-quality-testing-table-driven
language: go
severity: info
message: "Quality: Consider table-driven tests for multiple input scenarios"
tags: [quality, testing, best-practice]
rule:
  kind: function_decl
  pattern: |
    func $TEST(t *testing.T) {
      $$BODY
    }
note: |
  Table-driven tests reduce duplication, improve maintainability, and make it easy
  to add new test cases without repeating boilerplate.

  BAD (repeated test structure):
    func TestAdd(t *testing.T) {
      if add(1, 2) != 3 {
        t.Errorf("expected 3, got %d", add(1, 2))
      }
    }

    func TestAddNegative(t *testing.T) {
      if add(-1, 2) != 1 {
        t.Errorf("expected 1, got %d", add(-1, 2))
      }
    }

    func TestAddZero(t *testing.T) {
      if add(0, 0) != 0 {
        t.Errorf("expected 0, got %d", add(0, 0))
      }
    }

  GOOD (table-driven):
    func TestAdd(t *testing.T) {
      tests := []struct {
        name string
        a, b int
        want int
      }{
        {"positive", 1, 2, 3},
        {"negative", -1, 2, 1},
        {"zero", 0, 0, 0},
      }

      for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
          got := add(tt.a, tt.b)
          if got != tt.want {
            t.Errorf("add(%d, %d) = %d, want %d", tt.a, tt.b, got, tt.want)
          }
        })
      }
    }

  Benefits:
  - Single test function, multiple cases
  - Easy to add new test cases
  - Clear input/output pairs
  - Better failure messages (subtests show which case failed)
  - Easier to spot patterns in test data

  See: https://golang.org/wiki/TableDrivenTests

---
id: go-quality-test-helpers-defer-cleanup
language: go
severity: warning
message: "Quality: Test helper should use t.Cleanup() instead of defer for resource cleanup"
tags: [quality, testing, resource-management]
rule:
  kind: function_decl
  pattern: |
    func $HELPER(t *testing.T, $ARGS) {
      $$SETUP
      defer $$CLEANUP
    }
note: |
  Use t.Cleanup() in test helpers to ensure cleanup runs at the right time
  and with clear semantics. Cleanup functions run in LIFO order.

  BAD:
    func setupDB(t *testing.T) *DB {
      db := openDB()
      defer func() {
        if err := db.Close(); err != nil {
          t.Logf("close failed: %v", err)
        }
      }()
      return db
      // Problem: defer runs after helper returns, before test ends
    }

  GOOD:
    func setupDB(t *testing.T) *DB {
      db := openDB()
      t.Cleanup(func() {
        if err := db.Close(); err != nil {
          t.Logf("close failed: %v", err)
        }
      })
      return db
      // Cleanup guaranteed to run after test finishes
    }

  Multiple cleanups (LIFO order):
    func setupTest(t *testing.T) (*DB, *Cache) {
      db := openDB()
      t.Cleanup(func() { db.Close() })  // Runs 3rd

      cache := newCache(db)
      t.Cleanup(func() { cache.Close() })  // Runs 2nd

      tmpdir := t.TempDir()  // Automatically cleaned

      return db, cache
    }

  See: https://pkg.go.dev/testing#T.Cleanup

---
id: go-quality-test-coverage-assertion
language: go
severity: info
message: "Quality: Consider coverage targets (benchmarks, fuzzing, error cases)"
tags: [quality, testing, coverage]
rule:
  kind: source_file
  pattern: |
    file
note: |
  Good test coverage includes happy path, error conditions, edge cases, and concurrency.
  Avoid 100% line coverage (often pointless) - focus on behavior coverage.

  Complete test suite should include:
  1. Happy path (normal operation)
  2. Error cases (invalid input, I/O failures)
  3. Edge cases (empty, nil, boundary values)
  4. Concurrency (race detector with -race)
  5. Benchmarks (performance-critical code)
  6. Fuzz testing (Go 1.18+, API stability)

  EXAMPLE (happy path):
    func TestNewConfig(t *testing.T) {
      cfg, err := NewConfig("testdata/valid.yaml")
      if err != nil {
        t.Fatalf("unexpected error: %v", err)
      }
      if cfg.Port != 8080 {
        t.Errorf("expected port 8080, got %d", cfg.Port)
      }
    }

  EXAMPLE (error cases):
    func TestNewConfigFileNotFound(t *testing.T) {
      _, err := NewConfig("nonexistent.yaml")
      if err == nil {
        t.Errorf("expected error, got nil")
      }
      if !errors.Is(err, fs.ErrNotExist) {
        t.Errorf("expected ErrNotExist, got %v", err)
      }
    }

  EXAMPLE (benchmarks):
    func BenchmarkParse(b *testing.B) {
      data := loadLargeDataset()
      b.ResetTimer()
      for i := 0; i < b.N; i++ {
        Parse(data)
      }
    }

  EXAMPLE (fuzz testing, Go 1.18+):
    func FuzzParser(f *testing.F) {
      f.Add([]byte("valid input"))
      f.Fuzz(func(t *testing.T, data []byte) {
        Parse(data)  // Must not panic
      })
    }

  Running tests:
    go test ./... -race -count=2 -cover
    go test ./... -bench=. -benchtime=10s
    go test ./... -fuzz=FuzzParser -fuzztime=10s

  See: https://golang.org/doc/tutorial/add-a-test
       https://golang.org/doc/tutorial/fuzz

---
id: go-quality-package-organization
language: go
severity: warning
message: "Quality: Package name doesn't match directory name or exports are unclear"
tags: [quality, package-organization, api-design]
rule:
  kind: package_clause
  pattern: |
    package $PKG
note: |
  Package names should be short, concise, and match the directory name.
  Clear exports (CamelCase public, lowercase private) make the API obvious.

  Guidelines:
  1. Directory name = package name (no _test packages in production)
  2. Short names (5-8 chars): net, json, crypto (not networking, jsonhandler)
  3. Plural only if imports read naturally: import "strings" reads well
  4. No underscores, hyphens, or numbers
  5. Public API via exported identifiers (CamelCase)
  6. Private via lowercase (unexported)

  BAD:
    // Directory: my_networking_utils/
    package networking_utils

    // Directory: config_parser/
    package cfgparser

    // Unclear exports:
    type model struct {  // Private - can't be used outside package
      ID int
    }

  GOOD:
    // Directory: net/
    package net

    // Directory: config/
    package config

    // Clear exports:
    type Config struct {  // Public
      ID int
    }
    type model struct {  // Private
      internal int
    }

  GOOD (api.go pattern):
    // Directory: database/
    package database

    // database/api.go - exports public types
    type DB struct { ... }
    func (d *DB) Query(query string) (*Rows, error) { ... }

    // database/internal.go - private helpers
    func (d *DB) validateQuery(query string) error { ... }

  Import grouping (in order):
    import (
      "fmt"           // Standard library

      "github.com/...",
      "github.com/...",

      "./internal"    // Local
    )

  See: https://golang.org/doc/effective_go#package-names

---
id: go-quality-documentation
language: go
severity: info
message: "Quality: Exported identifier should have doc comment for godoc"
tags: [quality, documentation, maintainability]
rule:
  kind: function_decl
  pattern: |
    func $NAME($ARGS) $RET {
      $$BODY
    }
note: |
  Every exported (CamelCase) identifier must have a doc comment for godoc.
  Comments should explain the "why" and include examples for complex APIs.

  GOOD doc comment format:
  1. Start with function name: "// Query executes..."
  2. One-line summary (can be multi-sentence)
  3. Additional context (optional)
  4. Examples (for public APIs)
  5. Error cases (important!)

  BAD (no comment):
    func Process(data []byte) error {
      return nil
    }

  BAD (uninformative):
    // Process processes the data
    func Process(data []byte) error {
      return nil
    }

  GOOD (clear, actionable):
    // Process validates and transforms the input data.
    //
    // It removes whitespace, applies transformations, and returns
    // an error if the data format is invalid.
    func Process(data []byte) error {
      return nil
    }

  GOOD (with examples):
    // Lookup finds the value associated with the given key.
    //
    // If the key is not found, it returns an empty string and false.
    //
    // Example:
    //
    //  value, ok := cache.Lookup("user:123")
    //  if !ok {
    //    return errors.New("user not found")
    //  }
    func (c *Cache) Lookup(key string) (string, bool) {
      return "", false
    }

  GOOD (error documentation):
    // Save writes the configuration to disk.
    //
    // It returns ErrInvalid if the configuration is incomplete,
    // and ErrPermission if the file cannot be written.
    func (c *Config) Save(path string) error {
      return nil
    }

  Running godoc locally:
    godoc -h
    go install golang.org/x/tools/cmd/godoc@latest
    godoc -http=:6060

  See: https://golang.org/doc/comment

---
id: go-quality-panic-recovery
language: go
severity: error
message: "Quality: Panic used for control flow - should return error instead"
tags: [quality, error-handling, panic]
rule:
  kind: call_expression
  pattern: |
    panic($MSG)
note: |
  Panic should only be used for truly exceptional, unrecoverable conditions.
  Using panic for normal error handling (invalid input, missing file) is bad practice.

  RULES:
  1. panic() for programmer errors (nil dereference, out-of-bounds in own code)
  2. panic() for initialization failures (in init() functions only)
  3. Error returns for operational errors (I/O, invalid input, missing resources)

  BAD (control flow via panic):
    func ParseInt(s string) int {
      n, err := strconv.Atoi(s)
      if err != nil {
        panic(err)  // Caller can't handle this gracefully
      }
      return n
    }

  GOOD (error return):
    func ParseInt(s string) (int, error) {
      n, err := strconv.Atoi(s)
      if err != nil {
        return 0, fmt.Errorf("invalid integer: %w", err)
      }
      return n, nil
    }

  BAD (check precondition with panic):
    func NewServer(port int) *Server {
      if port <= 0 {
        panic("port must be positive")  // Recoverable error
      }
      return &Server{Port: port}
    }

  GOOD (precondition validation):
    func NewServer(port int) (*Server, error) {
      if port <= 0 || port > 65535 {
        return nil, fmt.Errorf("invalid port: %d", port)
      }
      return &Server{Port: port}, nil
    }

  OKAY (initialization panic):
    func init() {
      // Panic here is acceptable - prevents program start
      var err error
      globalConfig, err = LoadConfig()
      if err != nil {
        panic(fmt.Sprintf("failed to load config: %v", err))
      }
    }

  OKAY (defensive panic):
    // After defensive checks, panic is acceptable
    func findItem(items []Item, id int) Item {
      for _, item := range items {
        if item.ID == id {
          return item
        }
      }
      panic("item not found - this should have been caught by caller")
    }

  See: https://golang.org/doc/effective_go#panic

---
id: go-quality-copy-semantics
language: go
severity: warning
message: "Quality: Large struct copied by value - consider pointer receiver or pass by pointer"
tags: [quality, performance, memory]
rule:
  kind: parameter_decl
  pattern: |
    $NAME $STRUCT
note: |
  Copying large structs (>256 bytes) is expensive. Pass by pointer for performance.
  Small immutable values should be passed by value.

  BAD (large copy):
    type Config struct {
      Data [1024]byte
      Name string
      Value int
      // ... many more fields
    }

    func Process(cfg Config) {  // Copies entire struct
      fmt.Println(cfg.Name)
    }

  GOOD (pointer):
    func Process(cfg *Config) {  // Only copies pointer
      fmt.Println(cfg.Name)
    }

  GOOD (small value):
    type Point struct {
      X, Y float64  // Small, immutable
    }

    func Distance(p1, p2 Point) float64 {  // Fine to copy
      return math.Sqrt((p1.X-p2.X)*(p1.X-p2.X) + (p1.Y-p2.Y)*(p1.Y-p2.Y))
    }

  Rules of thumb:
  - Struct < 128 bytes: pass by value
  - Struct > 256 bytes: pass by pointer
  - Mutable struct: always use pointer
  - Immutable, small: pass by value

  See: https://golang.org/doc/effective_go#pointers_vs_values

---
id: go-quality-init-side-effects
language: go
severity: warning
message: "Quality: init() function has I/O or other side effects - difficult to test"
tags: [quality, testability, initialization]
rule:
  kind: function_decl
  pattern: |
    func init() {
      $$BODY
    }
note: |
  init() functions run at program startup and can't be controlled in tests.
  Minimize I/O, external dependencies, and side effects in init().
  Use constructor functions instead for better testability.

  BAD (I/O in init):
    var config *Config

    func init() {
      var err error
      config, err = LoadConfig("config.yaml")  // Hard to test
      if err != nil {
        panic(err)
      }
    }

    func main() {
      fmt.Println(config.Port)
    }

  GOOD (testable):
    var config *Config

    func init() {
      var err error
      config, err = loadConfigOrDie()
      if err != nil {
        panic(err)
      }
    }

    func loadConfigOrDie() (*Config, error) {
      return LoadConfig("config.yaml")
    }

    func main() {
      fmt.Println(config.Port)
    }

    // In tests:
    func TestWithConfig(t *testing.T) {
      // Can mock/inject configuration
    }

  GOOD (constructor pattern):
    type App struct {
      config *Config
    }

    // No init() needed - constructor handles setup
    func NewApp(configPath string) (*App, error) {
      cfg, err := LoadConfig(configPath)
      if err != nil {
        return nil, err
      }
      return &App{config: cfg}, nil
    }

    func main() {
      app, err := NewApp("config.yaml")
      if err != nil {
        log.Fatal(err)
      }
      fmt.Println(app.config.Port)
    }

    // In tests:
    func TestApp(t *testing.T) {
      app, err := NewApp("testdata/config.yaml")
      // Full control over initialization
    }

  Acceptable in init():
  - Setting type accelerators
  - Registering codecs/formats
  - Initializing immutable lookups/caches
  - Registering SQL drivers

  See: https://golang.org/doc/effective_go#init

---
id: go-quality-slice-append-capacity
language: go
severity: warning
message: "Quality: Repeated append to slice without pre-allocation - inefficient growth"
tags: [quality, performance, memory]
rule:
  kind: block
  pattern: |
    for _ := range $$RANGE {
      $SLICE = append($SLICE, $VALUE)
    }
note: |
  Appending to a slice repeatedly without pre-allocation causes multiple allocations
  as the slice grows. Pre-allocate the capacity for known sizes.

  BAD (multiple allocations):
    func filterNumbers(nums []int, threshold int) []int {
      var result []int  // Capacity = 0

      for _, n := range nums {
        if n > threshold {
          result = append(result, n)  // Reallocates as it grows
        }
      }
      return result
    }

  GOOD (pre-allocated):
    func filterNumbers(nums []int, threshold int) []int {
      result := make([]int, 0, len(nums))  // Reserve capacity

      for _, n := range nums {
        if n > threshold {
          result = append(result, n)  // Won't reallocate
        }
      }
      return result
    }

  GOOD (exact size known):
    func makeRange(n int) []int {
      result := make([]int, n)  // Exact size

      for i := 0; i < n; i++ {
        result[i] = i
      }
      return result
    }

  Capacity growth in Go:
    len=0, cap=0 -> append -> cap=1
    len=1, cap=1 -> append -> cap=2
    len=2, cap=2 -> append -> cap=4
    len=4, cap=4 -> append -> cap=8

    // Each capacity increase reallocates and copies all elements

  Performance difference (from microbenchmark):
    BenchmarkNoPrealloc:     1000000 allocations, 10ms
    BenchmarkPrealloc:       1 allocation, 0.1ms

  See: https://golang.org/doc/effective_go#slices

---
id: go-quality-defer-in-loop
language: go
severity: warning
message: "Quality: defer in loop - deferred functions don't run until function exits"
tags: [quality, resource-management, correctness]
rule:
  kind: defer_statement
  pattern: |
    defer $FUNC()
note: |
  Deferred functions run when the enclosing function returns, not immediately.
  Using defer in loops delays cleanup until all iterations complete, holding resources.

  BAD (resource leak risk):
    func processFiles(paths []string) error {
      for _, path := range paths {
        f, err := os.Open(path)
        if err != nil {
          return err
        }
        defer f.Close()  // Doesn't close until processFiles() returns

        // Process file
      }
      // All files closed here after loop completes
      // If there are 1000 files, all are open simultaneously
      return nil
    }

  GOOD (extract to function):
    func processFiles(paths []string) error {
      for _, path := range paths {
        if err := processFile(path); err != nil {
          return err
        }
        // File is closed here (in processFile)
      }
      return nil
    }

    func processFile(path string) error {
      f, err := os.Open(path)
      if err != nil {
        return err
      }
      defer f.Close()  // Closes immediately when processFile returns

      // Process file
      return nil
    }

  GOOD (explicit cleanup):
    func processFiles(paths []string) error {
      for _, path := range paths {
        f, err := os.Open(path)
        if err != nil {
          return err
        }

        if err := process(f); err != nil {
          f.Close()
          return err
        }

        f.Close()  // Close immediately, not at function end
      }
      return nil
    }

  OKAY (if loop is small):
    func closeAll(files []*os.File) error {
      for _, f := range files {
        defer f.Close()  // Acceptable if file list is small
      }
      return nil
    }

  See: https://golang.org/doc/effective_go#defer

---
id: go-quality-shadowing
language: go
severity: warning
message: "Quality: Variable shadowing - redefines name from outer scope"
tags: [quality, readability, maintenance]
rule:
  kind: short_var_decl
  pattern: |
    $VAR := $$EXPR
note: |
  Shadowing makes code confusing. Avoid reusing variable names in nested scopes.
  Use the `-shadow` linter (golang.org/x/tools/go/analysis/passes/shadow) to detect.

  BAD (shadowing):
    func Process(data []byte) error {
      if data == nil {
        return errors.New("nil data")
      }

      if len(data) > 0 {
        data := parseData(data)  // Shadows outer 'data'
        return handle(data)
      }

      return nil
    }

  GOOD (clear names):
    func Process(data []byte) error {
      if data == nil {
        return errors.New("nil data")
      }

      if len(data) > 0 {
        parsed := parseData(data)  // Different name
        return handle(parsed)
      }

      return nil
    }

  BAD (shadowing with error):
    func ReadFile(path string) ([]byte, error) {
      f, err := os.Open(path)
      if err != nil {
        return nil, err
      }
      defer f.Close()

      data, err := ioutil.ReadAll(f)  // Shadows outer 'err'
      if err != nil {
        return nil, err  // Which error?
      }

      return data, nil
    }

  GOOD (avoid shadowing):
    func ReadFile(path string) ([]byte, error) {
      f, err := os.Open(path)
      if err != nil {
        return nil, err
      }
      defer f.Close()

      data, readErr := ioutil.ReadAll(f)  // Different name
      if readErr != nil {
        return nil, readErr
      }

      return data, nil
    }

  Finding shadow issues:
    go install golang.org/x/tools/go/analysis/passes/shadow/cmd/shadow@latest
    shadow ./...

  See: https://golang.org/doc/effective_go#blank_identifier

---
id: go-quality-blank-identifier-check
language: go
severity: warning
message: "Quality: Error return value discarded without explicit blank identifier"
tags: [quality, error-handling, maintenance]
rule:
  kind: call_expression
  pattern: |
    $FUNC($ARGS)
note: |
  When intentionally ignoring a return value (especially errors), use the blank
  identifier _. This makes the intent explicit and passes linters.

  BAD (error silently lost):
    func processData() {
      db.Close()  // Error ignored, looks accidental
    }

  GOOD (explicit intent):
    func processData() {
      _ = db.Close()  // Explicitly ignoring
    }

  GOOD (log if suspicious):
    func processData() {
      if err := db.Close(); err != nil {
        log.Printf("warning: close failed: %v", err)
      }
    }

  Multiple returns:
    BAD:
      value, _ := someFunc()  // Is the error intentionally ignored?

    GOOD:
      value, _ := someFunc()  // Acceptable - error expected to be nil
      // Comment if intent is unclear:
      value, _ := someFunc()  // Error indicates not found, which is okay

  Linter for unused returns:
    go install honnef.co/go/tools/cmd/staticcheck@latest
    staticcheck ./...

  See: https://golang.org/doc/effective_go#blank_identifier

---
id: go-quality-context-timeout
language: go
severity: warning
message: "Quality: Function accepts context but doesn't check ctx.Done()"
tags: [quality, concurrency, resource-management]
rule:
  kind: function_decl
  pattern: |
    func $NAME(ctx context.Context, $ARGS) $RET {
      $$BODY
    }
note: |
  If a function accepts context.Context, it should respect the cancellation/timeout
  by checking ctx.Done() or passing it to called functions.

  BAD (ignores context):
    func Download(ctx context.Context, url string) ([]byte, error) {
      resp, err := http.Get(url)  // Doesn't use ctx
      if err != nil {
        return nil, err
      }
      defer resp.Body.Close()

      return ioutil.ReadAll(resp.Body)
    }

  GOOD (respects context):
    func Download(ctx context.Context, url string) ([]byte, error) {
      req, err := http.NewRequestWithContext(ctx, "GET", url, nil)
      if err != nil {
        return nil, err
      }

      resp, err := http.DefaultClient.Do(req)
      if err != nil {
        return nil, err
      }
      defer resp.Body.Close()

      return ioutil.ReadAll(resp.Body)
    }

  GOOD (checks cancellation in long operation):
    func Process(ctx context.Context, items []Item) error {
      for _, item := range items {
        select {
        case <-ctx.Done():
          return ctx.Err()  // Cancelled
        default:
        }

        if err := processItem(ctx, item); err != nil {
          return err
        }
      }
      return nil
    }

  Rules:
  1. Always pass ctx to called functions
  2. Check ctx.Done() in loops/long operations
  3. Never ignore context timeouts
  4. Use context.TODO() if context not available (mark for fix)
  5. Never store context in struct fields

  See: https://go.dev/blog/context

---
id: go-quality-range-value-copy
language: go
severity: info
message: "Quality: Range loop creates value copy - consider pointer if modifying"
tags: [quality, performance, memory]
rule:
  kind: range_clause
  pattern: |
    for $VAR := range $COLLECTION {
      $$BODY
    }
note: |
  Range loops create copies of each element. If you're modifying or copying large
  values, use index access or slice of pointers instead.

  BAD (inefficient copy):
    type User struct {
      Name string
      Age int
      // ... many fields
    }

    func updateAll(users []User) {
      for _, user := range users {
        user.Age++  // Modifies copy, not original
      }
    }

  GOOD (index access):
    func updateAll(users []User) {
      for i := range users {
        users[i].Age++  // Modifies original
      }
    }

  GOOD (pointer slice):
    func updateAll(users []*User) {
      for _, user := range users {
        user.Age++  // Modifies via pointer
      }
    }

  GOOD (small value):
    func printNumbers(nums []int) {
      for _, n := range nums {  // Copy is cheap (8 bytes)
        fmt.Println(n)
      }
    }

  Keys for maps:
    func printKeys(m map[string]int) {
      for key := range m {  // No copy needed, same as range m
        fmt.Println(key)
      }
    }

  See: https://golang.org/doc/effective_go#range

---
id: go-quality-constant-expression
language: go
severity: warning
message: "Quality: Magic number/string should be a named constant"
tags: [quality, readability, maintainability]
rule:
  kind: literal
  pattern: |
    $VALUE
note: |
  Magic numbers and strings without context are hard to understand.
  Use named constants for any value that has meaning or appears multiple times.

  BAD (magic numbers):
    func validateAge(age int) bool {
      return age >= 18  // What's 18? Voting age? Driving age?
    }

    func allocateBuffer() []byte {
      return make([]byte, 4096)  // Why 4096?
    }

  GOOD (named constants):
    const MinimumVotingAge = 18

    func validateAge(age int) bool {
      return age >= MinimumVotingAge
    }

    const DefaultBufferSize = 4096  // Standard page size

    func allocateBuffer() []byte {
      return make([]byte, DefaultBufferSize)
    }

  BAD (magic string):
    if status == "PENDING" {  // What are valid statuses?
      // ...
    }

  GOOD (enum-like constant):
    const (
      StatusPending = "PENDING"
      StatusActive  = "ACTIVE"
      StatusClosed  = "CLOSED"
    )

    if status == StatusPending {
      // ...
    }

  BAD (magic in iteration):
    for i := 0; i < 10; i++ {  // Why 10?
      // ...
    }

  GOOD:
    const MaxRetries = 10

    for i := 0; i < MaxRetries; i++ {
      // ...
    }

  Exception: Loop indices and simple counters don't need constants
    for i := 0; i < len(items); i++ {  // 0 and len are obvious
      // ...
    }

  See: https://golang.org/doc/effective_go#constants

---
id: go-quality-assertion-not-ok
language: go
severity: error
message: "Quality: Type assertion without ok check - panics if assertion fails"
tags: [quality, error-handling, panic]
rule:
  kind: type_assertion
  pattern: |
    $EXPR.($TYPE)
note: |
  Always check the ok value when doing type assertions. Unchecked assertions panic.

  BAD (panics if wrong type):
    func process(v interface{}) {
      s := v.(string)  // Panics if v is not string
      fmt.Println(s)
    }

  GOOD (explicit check):
    func process(v interface{}) error {
      s, ok := v.(string)
      if !ok {
        return fmt.Errorf("expected string, got %T", v)
      }
      fmt.Println(s)
      return nil
    }

  Exception: Panicking is acceptable if precondition is guaranteed:
    func unsafeAssert(v interface{}) string {
      // Only call this if you know v is a string
      s, _ := v.(string)  // Documented contract
      return s
    }

  For type switches (preferred for multiple types):
    func process(v interface{}) {
      switch val := v.(type) {
      case string:
        fmt.Println("string:", val)
      case int:
        fmt.Println("int:", val)
      default:
        fmt.Printf("unknown type: %T\n", v)
      }
    }

  See: https://golang.org/doc/effective_go#interface_conversions

---
id: go-quality-http-client-timeout
language: go
severity: warning
message: "Quality: HTTP client without timeout - can hang indefinitely"
tags: [quality, concurrency, resource-management]
rule:
  kind: call_expression
  pattern: |
    http.Get($URL)
note: |
  HTTP clients should always have a timeout to prevent hanging indefinitely.
  Use a custom http.Client with timeout configured.

  BAD (no timeout):
    func Fetch(url string) ([]byte, error) {
      resp, err := http.Get(url)  // Can hang forever
      if err != nil {
        return nil, err
      }
      defer resp.Body.Close()

      return ioutil.ReadAll(resp.Body)
    }

  GOOD (with timeout):
    func Fetch(url string) ([]byte, error) {
      client := &http.Client{
        Timeout: 10 * time.Second,
      }

      resp, err := client.Get(url)
      if err != nil {
        return nil, err
      }
      defer resp.Body.Close()

      return ioutil.ReadAll(resp.Body)
    }

  GOOD (with context timeout):
    func Fetch(ctx context.Context, url string) ([]byte, error) {
      client := &http.Client{
        Timeout: 10 * time.Second,
      }

      req, err := http.NewRequestWithContext(ctx, "GET", url, nil)
      if err != nil {
        return nil, err
      }

      resp, err := client.Do(req)
      if err != nil {
        return nil, err
      }
      defer resp.Body.Close()

      return ioutil.ReadAll(resp.Body)
    }

  Timeout covers:
    - Connection establishment
    - Reading response body
    - Entire request-response cycle

  Fine-grained control:
    transport := &http.Transport{
      DialContext:     dialer with timeout
      TLSHandshakeTimeout: 5 * time.Second
      ResponseHeaderTimeout: 10 * time.Second
    }

    client := &http.Client{
      Transport: transport,
      Timeout:   30 * time.Second,  // Overall timeout
    }

  See: https://golang.org/pkg/net/http/#Client

---
id: go-quality-sql-injection
language: go
severity: error
message: "Quality: SQL constructed with string concatenation - SQL injection risk"
tags: [quality, security, sql]
rule:
  kind: call_expression
  pattern: |
    $DB.Query($QUERY)
note: |
  Never construct SQL queries by concatenating user input. Always use parameterized
  queries with placeholders and pass parameters separately.

  BAD (SQL injection):
    func GetUser(db *sql.DB, userID string) (*User, error) {
      query := "SELECT id, name FROM users WHERE id = '" + userID + "'"

      var user User
      err := db.QueryRow(query).Scan(&user.ID, &user.Name)
      return &user, err

      // Attacker sends: userID = "' OR '1'='1"
      // Query becomes: SELECT id, name FROM users WHERE id = '' OR '1'='1'
    }

  GOOD (parameterized):
    func GetUser(db *sql.DB, userID string) (*User, error) {
      query := "SELECT id, name FROM users WHERE id = ?"

      var user User
      err := db.QueryRow(query, userID).Scan(&user.ID, &user.Name)
      return &user, err
    }

  Using parameters:
    // Named parameters (PostgreSQL)
    db.QueryRow("SELECT ... WHERE id = $1 AND status = $2", userID, "active")

    // Question mark placeholders (MySQL, SQLite)
    db.QueryRow("SELECT ... WHERE id = ? AND status = ?", userID, "active")

    // Named parameters with library like sqlc
    // Compile-time verified queries

  Safe libraries:
  - sqlc (compile-time SQL verification)
  - sqlx (typed queries)
  - GORM (ORM with parameterization)
  - ent (entity framework)

  See: https://golang.org/pkg/database/sql/

---
id: go-quality-slice-bounds-check
language: go
severity: error
message: "Quality: Slice/array access without bounds check - potential panic"
tags: [quality, safety, panic]
rule:
  kind: index_expression
  pattern: |
    $SLICE[$INDEX]
note: |
  Always check slice length before accessing by index to prevent panic.

  BAD (panics if empty):
    func First(items []int) int {
      return items[0]  // Panics if items is empty
    }

  GOOD (bounds check):
    func First(items []int) (int, error) {
      if len(items) == 0 {
        return 0, errors.New("empty slice")
      }
      return items[0], nil
    }

  GOOD (range safely):
    func processAll(items []int) {
      for _, item := range items {  // Safe - handles empty slice
        fmt.Println(item)
      }
    }

  GOOD (check index):
    func GetItem(items []int, index int) (int, error) {
      if index < 0 || index >= len(items) {
        return 0, fmt.Errorf("index out of range: %d", index)
      }
      return items[index], nil
    }

  Exception: Safe inside loops where bounds are guaranteed:
    for i := 0; i < len(items); i++ {
      x := items[i]  // Safe - loop ensures i < len(items)
    }

  See: https://golang.org/doc/effective_go#slices

---
id: go-quality-struct-embedding
language: go
severity: info
message: "Quality: Consider composition over embedding for loose coupling"
tags: [quality, design, maintainability]
rule:
  kind: struct_type
  pattern: |
    struct {
      $EMBEDDED
    }
note: |
  While embedding is convenient, composition is more explicit and flexible.
  Use embedding for "is-a" relationships; use composition for "has-a".

  BAD (embedding can be confusing):
    type Reader interface {
      Read(p []byte) (n int, err error)
    }

    type MyReader struct {
      io.Reader  // Embedded interface
    }

    func (m *MyReader) Read(p []byte) (int, error) {
      // Delegates to embedded Reader - implicit
      return m.Reader.Read(p)
    }

  GOOD (composition is explicit):
    type MyReader struct {
      reader io.Reader  // Explicit field
    }

    func (m *MyReader) Read(p []byte) (int, error) {
      return m.reader.Read(p)  // Explicit delegation
    }

  Embedding for true "is-a":
    type Logger interface {
      Log(string)
    }

    type DatabaseError struct {
      error          // Is-an error
      Logger         // Is-a logger
      Code int
    }

    // OK: real is-a relationship

  Benefits of composition:
  - Explicit what fields are being used
  - Easier to test (can mock individual fields)
  - Clearer API (no magic method promotion)
  - More flexible (can change implementation)

  See: https://golang.org/doc/effective_go#embedding

---
id: go-quality-build-constraints
language: go
severity: info
message: "Quality: Platform-specific code should use build constraints"
tags: [quality, portability, build]
rule:
  kind: comment
  pattern: |
    // +build
note: |
  Use build constraints (+build or //go:build) to conditionally compile code
  for different platforms, architectures, or build modes.

  BAD (runtime checks):
    func getPath(filename string) string {
      if runtime.GOOS == "windows" {
        return "C:\\data\\" + filename
      } else {
        return "/data/" + filename
      }
    }

  GOOD (build constraints):
    // file_windows.go
    // +build windows
    //go:build windows

    package myapp

    func getPath(filename string) string {
      return "C:\\data\\" + filename
    }

    // file_unix.go
    // +build linux darwin
    //go:build linux || darwin

    package myapp

    func getPath(filename string) string {
      return "/data/" + filename
    }

  Build constraints:
    +build windows           // Windows only
    +build linux,amd64       // Linux on x86-64
    +build linux darwin      // Linux or macOS
    +build !windows          // Not Windows
    +build cgo               // CGO enabled
    +build !race             // Race detector disabled

  Modern syntax (Go 1.16+):
    //go:build windows
    //go:build linux && amd64
    //go:build (linux || darwin) && !race

  Conditional imports:
    // +build ignore

    package main

    func unusedInCurrentBuild() {}

  See: https://golang.org/cmd/go/#hdr-Build_constraints

---
id: go-quality-cgo-safety
language: go
severity: error
message: "Quality: CGO pointer passing - lifetime management required"
tags: [quality, safety, cgo]
rule:
  kind: call_expression
  pattern: |
    C.$FUNC($ARGS)
note: |
  When using CGO, be extremely careful with pointer lifetime. C code cannot
  hold pointers to Go memory that might be garbage collected.

  RULE: C code can safely hold:
  1. Pointers to C-allocated memory (C.malloc)
  2. Pointers to Go memory ONLY during the C function call
  3. NOT pointers to Go heap after the call returns

  BAD (dangling pointer):
    package main

    import "C"

    func dangerous(slice []int) {
      // BAD: C code holds pointer to Go memory
      C.process(unsafe.Pointer(&slice[0]))
      // Go GC can move/free slice[0] after this returns
    }

  GOOD (temporary only):
    func safe(slice []int) {
      // OK: C code only uses pointer during the call
      result := C.process(unsafe.Pointer(&slice[0]))
      // Pointer is forgotten when function returns
      _ = result
    }

  GOOD (C-allocated memory):
    func managed() *C.int {
      // OK: C code holds pointer to C-allocated memory
      ptr := C.malloc(C.sizeof_int)
      return (*C.int)(ptr)
      // Caller must free with C.free()
    }

  Safe pattern:
    func processCData(data []byte) (int, error) {
      // Convert Go slice to C only for the call
      cData := C.CBytes(data)  // C-allocated copy
      defer C.free(cData)

      result := C.process(cData)
      return int(result), nil
    }

  See: https://pkg.go.dev/cmd/cgo

---
id: go-quality-nil-dereference
language: go
severity: error
message: "Quality: Potential nil dereference - should check for nil first"
tags: [quality, safety, nil-checking]
rule:
  kind: member_expression
  pattern: |
    $POINTER.$FIELD
note: |
  Always check for nil before dereferencing a pointer. Go doesn't have null safety.

  BAD (potential nil dereference):
    func getName(user *User) string {
      return user.Name  // Panics if user is nil
    }

  GOOD (nil check):
    func getName(user *User) string {
      if user == nil {
        return "Unknown"
      }
      return user.Name
    }

  GOOD (idiomatic error return):
    func GetUser(db *sql.DB, id int) (*User, error) {
      user := &User{}
      err := db.QueryRow("SELECT name FROM users WHERE id = ?", id).Scan(&user.Name)
      if err != nil {
        return nil, err  // Don't return partial user
      }
      return user, nil
    }

    user, err := GetUser(db, 123)
    if err != nil {
      // Don't use user
    }
    // user is guaranteed non-nil here

  Optional types pattern:
    type OptionalUser struct {
      Value *User
      Valid bool
    }

    func GetUser(id int) OptionalUser {
      if found {
        return OptionalUser{Value: &user, Valid: true}
      }
      return OptionalUser{Valid: false}
    }

    opt := GetUser(123)
    if opt.Valid {
      fmt.Println(opt.Value.Name)
    }

  See: https://golang.org/doc/effective_go#pointers_vs_values

---
id: go-quality-zero-value-safety
language: go
severity: warning
message: "Quality: Type zero value might not be safe - consider requiring constructor"
tags: [quality, safety, design]
rule:
  kind: struct_type
  pattern: |
    type $NAME struct {
      $$FIELDS
    }
note: |
  Some types have unsafe zero values. If a zero struct is dangerous, make sure
  the constructor is called. Consider making the type unexported and requiring NewX().

  BAD (unsafe zero value):
    type Pool struct {
      mu    sync.Mutex
      items []Item
    }

    // Zero value has a broken mutex!
    var p Pool  // p.mu is broken (can't be copied)

    func (p *Pool) Get() Item {
      p.mu.Lock()  // Race condition
      defer p.mu.Unlock()
      // ...
    }

  GOOD (require constructor):
    type Pool struct {
      mu    sync.Mutex
      items []Item
    }

    func NewPool() *Pool {
      return &Pool{
        items: make([]Item, 0),
      }
    }

    p := NewPool()  // Must use constructor

  BAD (unexported zero value):
    type config struct {
      timeout time.Duration
    }

    // Zero value: 0 nanoseconds timeout - broken!
    var cfg config

  GOOD (default values):
    func NewConfig() *config {
      return &config{
        timeout: 30 * time.Second,
      }
    }

  Types with unsafe zero values:
  - sync.Mutex (can't be copied after first use)
  - sync.RWMutex (can't be copied)
  - sync.WaitGroup (can't be reused)
  - channels (can deadlock if not properly initialized)
  - slices without capacity (will reallocate)
  - pointers (nil is different from valid pointer)

  Exception: Types where zero value is safe and useful:
    var i int       // 0 is fine
    var s string    // "" is fine
    var m map[K]V   // nil is fine, grows as needed
    var sl []T      // nil is fine, grows as needed

  See: https://golang.org/ref/spec#The_zero_value

...
# End of Go Quality Rules
---
id: rust-quality-naming-non-snake-case-fn
language: rust
severity: warning
message: "Quality: Function names should use snake_case, not camelCase or PascalCase"
tags: [quality, naming, convention]
rule:
  kind: function_item
  pattern: |
    (fn $NAME:ident)
    @constraint { regex_not_match($NAME, /^[a-z][a-z0-9]*(_[a-z0-9]+)*$/) }
note: |
  Rust convention uses snake_case for function names. This improves consistency across
  the ecosystem and makes code easier to read for other Rust developers.

  Affected patterns: camelCase (myFunction), PascalCase (MyFunction), kebab-case

  Example (wrong):
    fn getUserData() { }
    fn GetUserData() { }

  Example (correct):
    fn get_user_data() { }

---
id: rust-quality-naming-non-screaming-snake-case-const
language: rust
severity: warning
message: "Quality: Constant names should use SCREAMING_SNAKE_CASE"
tags: [quality, naming, convention]
rule:
  kind: const_item
  pattern: |
    (const $NAME:ident $REST)
    @constraint { regex_not_match($NAME, /^[A-Z][A-Z0-9]*(_[A-Z0-9]+)*$/) }
note: |
  Rust constants should use SCREAMING_SNAKE_CASE to distinguish them from regular
  variables and improve readability. This is enforced by clippy.

  Exception: Single-letter constants (e.g., `const N: usize`) may be acceptable
  in mathematical contexts, but should still follow the pattern.

  Example (wrong):
    const maxConnections: u32 = 100;
    const MAX_connections: u32 = 100;

  Example (correct):
    const MAX_CONNECTIONS: u32 = 100;

---
id: rust-quality-naming-non-pascal-case-type
language: rust
severity: warning
message: "Quality: Type/struct/enum names should use PascalCase"
tags: [quality, naming, convention]
rule:
  kind: struct_item | enum_item | type_alias
  pattern: |
    (struct $NAME:ident)|(enum $NAME:ident)|(type $NAME:ident)
    @constraint { regex_not_match($NAME, /^[A-Z][a-zA-Z0-9]*$/) }
note: |
  Rust types should use PascalCase. This improves consistency and makes it clear
  when you're dealing with a type versus a value/function.

  Example (wrong):
    struct user_data { }
    enum error_type { }
    type point_t = (f64, f64);

  Example (correct):
    struct UserData { }
    enum ErrorType { }
    type Point = (f64, f64);

---
id: rust-quality-naming-underscore-prefix-unused
language: rust
severity: info
message: "Quality: Use underscore prefix for intentionally unused variables instead of @allow attributes"
tags: [quality, naming, best-practice]
rule:
  kind: let_declaration
  pattern: |
    (let $NAME:ident = $EXPR)
    @constraint { not_used($NAME) }
note: |
  When you intentionally don't use a variable, prefix it with underscore to suppress
  warnings. This is more idiomatic than using #[allow(unused_variables)].

  Example (suboptimal):
    #[allow(unused_variables)]
    let config = load_config()?;

  Example (correct):
    let _config = load_config()?;

  If you might use it later, use a proper binding. The underscore prefix signals
  intentional non-use to readers.

---
id: rust-quality-naming-avoid-generic-param-letters
language: rust
severity: info
message: "Quality: Use descriptive names for generic parameters instead of single letters"
tags: [quality, naming, readability]
rule:
  kind: function_item | struct_item | impl_item
  pattern: |
    <$LETTER:ident>
    @constraint {
      length($LETTER) == 1 AND
      regex_match($LETTER, /^[A-Z]$/) AND
      $LETTER not_in [T, S, E]
    }
note: |
  Single-letter generic parameters are only acceptable for very common cases:
  - T for a single generic type
  - S for string-like types
  - E for error types in Result<T, E>

  For other generics, use descriptive names to improve code clarity.

  Example (poor):
    fn process<I, O>(input: I) -> O { }

  Example (better):
    fn process<Input, Output>(input: Input) -> Output { }

  Exception: T, S, E are so convention-bound they're acceptable. Other single
  letters confuse readers.

# ERROR HANDLING
---
id: rust-quality-error-unwrap-in-library
language: rust
severity: error
message: "Quality: Don't use unwrap() in library code; propagate errors instead"
tags: [quality, error-handling, correctness]
rule:
  kind: method_call
  pattern: |
    $OBJ:expr.unwrap()
note: |
  unwrap() panics when the value is None/Err. In library code, this crashes the
  entire application, denying the caller the chance to handle the error gracefully.

  Only use unwrap() in:
  - Tests
  - Examples
  - Binary applications (where panic is acceptable)
  - Code where you can prove it's impossible to fail (rare)

  Example (wrong in library):
    pub fn parse_config(path: &str) -> Config {
        let content = std::fs::read_to_string(path).unwrap();
        serde_json::from_str(&content).unwrap()
    }

  Example (correct):
    pub fn parse_config(path: &str) -> Result<Config, Box<dyn Error>> {
        let content = std::fs::read_to_string(path)?;
        serde_json::from_str(&content).map_err(|e| e.into())
    }

---
id: rust-quality-error-expect-in-library
language: rust
severity: warning
message: "Quality: expect() with generic message is often better as ? or map_err()"
tags: [quality, error-handling, maintainability]
rule:
  kind: method_call
  pattern: |
    $OBJ:expr.expect($MESSAGE:string_literal)
note: |
  expect() is slightly better than unwrap() because it provides a message, but
  in library code it still panics, denying error handling to the caller.

  Use expect() only for:
  - Impossible conditions with clear failure messages
  - Tests where panic is acceptable
  - Code where you've verified the condition can't fail

  Prefer the ? operator or map_err() in library code.

  Example (wrong):
    pub fn load_user(id: u32) -> User {
        db.query(id).expect("User must exist")
    }

  Example (better):
    pub fn load_user(id: u32) -> Result<User, DbError> {
        db.query(id)
    }

  If expect() makes sense, ensure the message explains WHY it's impossible to fail,
  not just THAT it failed.

---
id: rust-quality-error-catch-all-match
language: rust
severity: warning
message: "Quality: Avoid catch-all patterns in match statements over errors; handle specific variants"
tags: [quality, error-handling, maintainability]
rule:
  kind: match_expression
  pattern: |
    (match $OBJ { _ => $HANDLER })
note: |
  Catch-all patterns (_) in error matches silently ignore new error types. This
  makes the code brittle when error types are extended.

  Instead, explicitly match known variants and handle unexpected ones clearly.

  Example (problematic):
    match file.read_to_string() {
        Ok(content) => process(content),
        Err(_) => eprintln!("Failed"),  // Loses error detail
    }

  Example (better):
    match file.read_to_string() {
        Ok(content) => process(content),
        Err(e) => eprintln!("Failed to read file: {}", e),
    }

  Or with ? operator (best):
    let content = file.read_to_string()?;
    process(content)

  For non-error matches, catch-all is often acceptable if you've handled all
  important cases.

---
id: rust-quality-error-result-in-void-function
language: rust
severity: warning
message: "Quality: Functions that can fail should return Result, not ignore errors"
tags: [quality, error-handling, correctness]
rule:
  kind: function_item
  pattern: |
    (fn $NAME($PARAMS) -> $RETURN_TYPE $BODY)
    @constraint {
      $RETURN_TYPE NOT_CONTAINS Result AND
      function_contains_method_call(call_on_result, "is_err|unwrap|expect")
    }
note: |
  If a function calls fallible operations and checks/ignores errors, it should
  return Result to let the caller handle the error.

  Ignoring errors with if/unwrap/expect is a code smell that the function is
  trying to hide failure modes.

  Example (wrong):
    fn save_file(path: &str, content: &str) {
        std::fs::write(path, content).unwrap();
    }

  Example (correct):
    fn save_file(path: &str, content: &str) -> std::io::Result<()> {
        std::fs::write(path, content)
    }

# OWNERSHIP & BORROWING
---
id: rust-quality-ownership-unnecessary-clone
language: rust
severity: warning
message: "Quality: Avoid unnecessary clone(); use references or move semantics"
tags: [quality, ownership, performance]
rule:
  kind: method_call
  pattern: |
    $OBJ:expr.clone()
    @constraint {
      NOT is_expensive_type($OBJ) AND
      $OBJ could_be_borrowed_instead
    }
note: |
  clone() copies heap-allocated data, which is expensive. Before cloning, ask:
  - Can I use a reference (&T) instead?
  - Can I move the value instead of copying?
  - Is the caller expecting to mutate the original?

  Legitimate uses of clone():
  - Modifying a value without affecting the original
  - Storing data in a collection that requires owned values
  - Expensive data that's intentionally copied (Arc<T>, etc.)

  Example (unnecessary):
    fn process(data: Vec<String>) {
        let copy = data.clone();  // Just moved, doesn't need clone
        process_data(&copy);
    }
    process(my_vec);  // Moves my_vec; copy is unused

  Example (better):
    fn process(data: &[String]) {
        process_data(data);  // Borrows instead
    }
    process(&my_vec);

---
id: rust-quality-ownership-deref-coercion-abuse
language: rust
severity: info
message: "Quality: Deref coercion to String/Vec is convenient but clarifies intent to take references"
tags: [quality, ownership, best-practice]
rule:
  kind: function_item
  pattern: |
    (fn $NAME($ARG: String | Vec<$T>) $BODY)
note: |
  Functions accepting String or Vec when they only need to read/iterate should
  accept &str or &[T] instead. This is more flexible (works with owned and
  borrowed) and clarifies that the function doesn't need ownership.

  Deref coercion allows &String to be used as &str, and &Vec<T> as &[T], so
  callers can pass references. But the signature should express the requirement.

  Example (overly restrictive):
    fn count_lines(text: String) -> usize {
        text.lines().count()
    }
    count_lines(my_string);  // Must move
    count_lines(&my_string);  // Also works via Deref coercion

  Example (correct):
    fn count_lines(text: &str) -> usize {
        text.lines().count()
    }
    count_lines(&my_string);  // Clear intent

---
id: rust-quality-ownership-self-copy-impl
language: rust
severity: warning
message: "Quality: Types implementing Copy should be small (typically <2 * usize)"
tags: [quality, ownership, performance]
rule:
  kind: derive_attribute | impl_item
  pattern: |
    #[derive(Copy, Clone)] struct $NAME { $FIELDS }
    @constraint { size_of($NAME) > 32 }
note: |
  Copy makes implicit shallow copies on every use. Large types should use Clone
  (explicit copies) or move semantics (cheaper).

  Guidelines for Copy types:
  - Primitives (integers, floats, bools, chars) - always safe
  - Small wrappers around primitives - okay
  - Types > 2 * usize (16-32 bytes) - probably shouldn't be Copy

  The tradeoff: implicit copies are convenient but can hide expensive operations.
  Larger types should require explicit cloning/moving to make the cost visible.

  Example (wrong):
    #[derive(Copy, Clone)]
    struct LargeConfig {
        settings: [u32; 256],  // 1024 bytes copied implicitly
        cache: HashMap<String, String>,  // Doesn't implement Copy anyway
    }

  Example (correct):
    #[derive(Clone)]
    struct LargeConfig {
        settings: [u32; 256],
    }

    // Or use reference semantics:
    fn process(config: &LargeConfig) { }

---
id: rust-quality-ownership-lifetime-elision
language: rust
severity: info
message: "Quality: Be explicit with lifetimes when the elision rule is ambiguous"
tags: [quality, ownership, clarity]
rule:
  kind: function_item
  pattern: |
    (fn $NAME(&$ARG1, &$ARG2) -> &$RET_TYPE $BODY)
    @constraint { more_than_one_input_reference AND no_explicit_lifetime }
note: |
  Rust's lifetime elision hides lifetimes when it's obvious, but with multiple
  input references, the output lifetime is ambiguous. Be explicit about which
  input the output borrows from.

  Example (unclear):
    fn first_word(s: &str, separator: &str) -> &str {
        // Which does the return borrow from?
    }

  Example (explicit and clear):
    fn first_word<'a>(s: &'a str, separator: &str) -> &'a str {
        // Clearly borrows from s
    }

# API DESIGN
---
id: rust-quality-api-builder-without-setter-validation
language: rust
severity: warning
message: "Quality: Builder pattern should validate state before build()"
tags: [quality, api-design, correctness]
rule:
  kind: method_item
  pattern: |
    (fn build(&self) -> $TYPE $BODY)
    @constraint {
      is_builder_pattern AND
      NOT validates_required_fields
    }
note: |
  Builder patterns often accept optional fields but may have required state.
  The build() method should validate that all required fields are set before
  constructing the final object.

  Example (wrong):
    pub struct ConfigBuilder {
        timeout: Option<u32>,
        host: Option<String>,
    }
    impl ConfigBuilder {
        pub fn build(self) -> Config {
            Config {
                timeout: self.timeout.unwrap_or(30),
                host: self.host.unwrap_or_default(),  // Empty host!
            }
        }
    }

  Example (correct):
    impl ConfigBuilder {
        pub fn build(self) -> Result<Config, &'static str> {
            let host = self.host.ok_or("host is required")?;
            Ok(Config {
                timeout: self.timeout.unwrap_or(30),
                host,
            })
        }
    }

---
id: rust-quality-api-bool-param-instead-of-enum
language: rust
severity: warning
message: "Quality: Avoid bool parameters; use enums to clarify intent"
tags: [quality, api-design, readability]
rule:
  kind: function_item
  pattern: |
    (fn $NAME($ARG: bool, ...) $BODY)
note: |
  Boolean parameters are unclear at the call site. What does true/false mean?
  Enums make the intent explicit and prevent mistakes.

  Example (unclear):
    fn fetch_data(cached: bool) { }

    fetch_data(true);   // True = use cache?
    fetch_data(false);  // False = don't use cache?

  Example (clear):
    enum CacheMode { UseCache, SkipCache }
    fn fetch_data(mode: CacheMode) { }

    fetch_data(CacheMode::UseCache);
    fetch_data(CacheMode::SkipCache);

---
id: rust-quality-api-string-instead-of-typed-id
language: rust
severity: warning
message: "Quality: Use newtypes instead of String/u32 for identifiers to prevent mixing"
tags: [quality, api-design, type-safety]
rule:
  kind: function_item
  pattern: |
    (fn $NAME($ARG: String | u32 | u64, ...) $BODY)
    @constraint {
      is_identifier($ARG) AND
      NOT is_newtype_wrapper
    }
note: |
  Using String or u32 for IDs is error-prone. You can accidentally pass the
  wrong ID to the wrong function. Newtypes prevent this with zero runtime cost.

  Example (prone to errors):
    fn get_user(user_id: u32) -> Result<User, Error> { }
    fn get_post(post_id: u32) -> Result<Post, Error> { }

    let user = get_user(post_123)?;  // Oops! Compiled fine but wrong

  Example (type-safe):
    #[derive(Copy, Clone, Debug)]
    struct UserId(u32);

    #[derive(Copy, Clone, Debug)]
    struct PostId(u32);

    fn get_user(user_id: UserId) -> Result<User, Error> { }
    fn get_post(post_id: PostId) -> Result<Post, Error> { }

    let user = get_user(post_123)?;  // Compiler error!

---
id: rust-quality-api-deprecated-without-replacement
language: rust
severity: warning
message: "Quality: Deprecation messages should suggest a replacement function"
tags: [quality, api-design, maintainability]
rule:
  kind: attribute
  pattern: |
    #[deprecated(since = $VER, note = $MSG)]
    @constraint {
      NOT contains_replacement_suggestion($MSG) AND
      is_public_function
    }
note: |
  When deprecating code, tell users what to use instead. Otherwise, they have to
  hunt for a replacement or guess.

  Example (unhelpful):
    #[deprecated(since = "0.2.0", note = "Use new API")]
    pub fn old_function() { }

  Example (helpful):
    #[deprecated(since = "0.2.0", note = "Use `new_function()` instead")]
    pub fn old_function() { }

# MODULE ORGANIZATION
---
id: rust-quality-modules-large-file
language: rust
severity: info
message: "Quality: Consider splitting large modules (>500 lines) into submodules"
tags: [quality, organization, maintainability]
rule:
  kind: source_file
  pattern: |
    $FILE
    @constraint { line_count($FILE) > 500 }
note: |
  Very large files become harder to navigate and understand. Consider splitting
  into submodules when a file exceeds 500 lines.

  Guidelines:
  - 200-300 lines: reasonable for a single module
  - 300-500 lines: consider splitting if coherent submodules exist
  - 500+ lines: likely needs refactoring into submodules

  Refactoring improves:
  - Code navigation and discovery
  - Coherence (each module has a clear purpose)
  - Reusability (submodules can be tested/used independently)

---
id: rust-quality-modules-private-by-default
language: rust
severity: info
message: "Quality: Keep items private by default; only expose public APIs"
tags: [quality, organization, encapsulation]
rule:
  kind: function_item | struct_item | enum_item
  pattern: |
    (pub fn | pub struct | pub enum) $NAME
note: |
  Public items create API contracts that must be maintained. Keeping things
  private gives you freedom to refactor without breaking users.

  Ask: Does this item need to be part of the public API, or is it an implementation
  detail? If implementation detail, make it private or pub(crate).

  Visibility levels:
  - `pub`: Part of public API, visible everywhere
  - `pub(crate)`: Visible within the crate, good for internal APIs
  - `pub(super)`: Visible in parent module and siblings
  - (private): Internal implementation only

---
id: rust-quality-modules-mod-organization
language: rust
severity: info
message: "Quality: Use mod.rs or single-file module conventions consistently"
tags: [quality, organization, consistency]
rule:
  kind: module_declaration
  pattern: |
    (mod $NAME)
note: |
  Rust supports two styles for modules:
  1. Single file: `my_module.rs`
  2. Directory: `my_module/mod.rs`

  Use one style consistently within your crate. The single-file style is modern
  and preferred in recent Rust editions.

  Directory structure (preferred):
    src/
    ├── main.rs
    ├── lib.rs
    ├── parser.rs
    ├── codegen.rs
    └── utils.rs

  Not mixed:
    src/
    ├── lib.rs
    ├── parser.rs
    └── codegen/
        └── mod.rs

# CLIPPY LINTS & COMMON MISTAKES
---
id: rust-quality-clippy-manual-bounds-check
language: rust
severity: warning
message: "Quality: Use saturating/wrapping arithmetic instead of manual bounds checks"
tags: [quality, performance, idiomatic]
rule:
  kind: binary_expression
  pattern: |
    (if $LEFT > $RIGHT { $MAX } else { $LEFT })
note: |
  Rust provides saturating_add, wrapping_add, and checked_add for safe arithmetic.
  Manual bounds checks are more verbose and less clear.

  Example (verbose):
    let result = if value + 1 > MAX {
        MAX
    } else {
        value + 1
    };

  Example (idiomatic):
    let result = value.saturating_add(1);

  Methods to consider:
  - saturating_add/sub/mul: Clamp to min/max
  - wrapping_add/sub/mul: Wrap on overflow
  - checked_add/sub/mul: Return Option for manual handling

---
id: rust-quality-clippy-string-from-str
language: rust
severity: info
message: "Quality: Use String::from() or to_string() instead of String::new() + push_str()"
tags: [quality, idiomatic, readability]
rule:
  kind: method_call
  pattern: |
    (String::new().push_str($S))
note: |
  Idiomatic Rust prefers into() or to_string() over manual string building for
  simple cases.

  Example (verbose):
    let s = String::new();
    s.push_str("hello");

  Example (concise):
    let s = "hello".to_string();
    // or
    let s: String = "hello".into();

---
id: rust-quality-clippy-single-char-pattern
language: rust
severity: info
message: "Quality: Use char instead of single-character string for split/match operations"
tags: [quality, performance, idiomatic]
rule:
  kind: method_call
  pattern: |
    .split("$CHAR") | .trim_start_matches("$CHAR") | .contains("$CHAR")
    @constraint { length($CHAR) == 1 }
note: |
  String patterns create unnecessary overhead. Use char patterns instead.

  Example (inefficient):
    let parts = text.split(",").collect::<Vec<_>>();

  Example (efficient):
    let parts = text.split(',').collect::<Vec<_>>();

  This applies to: split, trim_*, contains, starts_with, ends_with, and similar.

---
id: rust-quality-clippy-trivial-bound-check
language: rust
severity: info
message: "Quality: Avoid type bounds on T that match the trait requirement already"
tags: [quality, readability, reduction]
rule:
  kind: where_clause
  pattern: |
    where T: Trait, T: Trait
note: |
  Duplicate bounds are redundant and add clutter. Keep trait bounds minimal.

  Example (redundant):
    fn process<T>(data: T)
    where
        T: Iterator,
        T: Iterator,  // Duplicate!
        T: Clone,
    { }

  Example (clean):
    fn process<T>(data: T)
    where
        T: Iterator + Clone,
    { }

---
id: rust-quality-clippy-needless-borrow
language: rust
severity: info
message: "Quality: Avoid borrowing when the same effect is achieved without"
tags: [quality, idiomatic, clarity]
rule:
  kind: method_call | function_call
  pattern: |
    $FUNC(&$ARG)
    @constraint {
      NOT requires_reference($FUNC) AND
      $ARG could_be_moved
    }
note: |
  Sometimes we borrow unnecessarily, adding noise to the code. Let the type system
  handle borrowing through deref coercion when possible.

  Example (unnecessarily explicit):
    let v = vec![1, 2, 3];
    process(&v);  // Could just be v if process accepts Into<Vec<T>>

  Example (cleaner):
    let v = vec![1, 2, 3];
    process(v);

# TESTING & DOCUMENTATION
---
id: rust-quality-testing-missing-tests
language: rust
severity: info
message: "Quality: Public APIs should have at least basic tests"
tags: [quality, testing, best-practice]
rule:
  kind: function_item
  pattern: |
    (pub fn $NAME)
    @constraint {
      is_public AND
      NOT has_test_coverage
    }
note: |
  Public functions create contracts with users. Tests verify those contracts
  and catch regressions. Every public API should have at least:
  - Happy path tests
  - Error/edge case tests

  Tip: If a function is hard to test, that's a sign it does too much (God
  function) or has tangled dependencies. Refactor.

---
id: rust-quality-documentation-public-api-missing
language: rust
severity: warning
message: "Quality: Public items should be documented with doc comments"
tags: [quality, documentation, api-clarity]
rule:
  kind: function_item | struct_item | enum_item
  pattern: |
    (pub fn | pub struct | pub enum) $NAME
    @constraint { NOT has_doc_comment }
note: |
  Doc comments (///) are parsed by rustdoc and visible in generated documentation.
  Every public item should explain its purpose, parameters, and behavior.

  Example (undocumented):
    pub fn process(data: &str) -> Result<Data, Error> { }

  Example (documented):
    /// Processes a string into structured data.
    ///
    /// # Arguments
    /// * `data` - The input string to process
    ///
    /// # Returns
    /// Returns the processed data or an error if parsing fails.
    ///
    /// # Example
    /// ```
    /// let result = process("example")?;
    /// ```
    pub fn process(data: &str) -> Result<Data, Error> { }

---
id: rust-quality-documentation-example-missing
language: rust
severity: info
message: "Quality: Complex public functions should include usage examples in docs"
tags: [quality, documentation, usability]
rule:
  kind: function_item
  pattern: |
    (pub fn $NAME)
    @constraint {
      is_complex_signature AND
      NOT has_example_in_doc_comment
    }
note: |
  Examples in documentation show users how to use your API. This is especially
  important for functions with:
  - Multiple generic parameters
  - Complex return types (Result, Option, etc.)
  - Non-obvious usage patterns

  Example (missing example):
    /// Parses configuration from a file.
    pub fn parse_config<P: AsRef<Path>>(path: P) -> Result<Config, ParseError> { }

  Example (with example):
    /// Parses configuration from a file.
    ///
    /// # Example
    /// ```
    /// let config = parse_config("config.yaml")?;
    /// ```
    pub fn parse_config<P: AsRef<Path>>(path: P) -> Result<Config, ParseError> { }

---
id: rust-quality-documentation-panic-behavior
language: rust
severity: warning
message: "Quality: Document when and why a function might panic"
tags: [quality, documentation, safety]
rule:
  kind: function_item
  pattern: |
    (pub fn $NAME $BODY)
    @constraint {
      function_contains_panic OR
      function_contains_unwrap
    }
note: |
  If a public function can panic, document it in a "# Panics" section. This tells
  users when the function is safe and when they need error handling.

  Example (panic undocumented):
    pub fn get_nth(items: &[T], n: usize) -> &T {
        &items[n]  // Panics if n >= items.len()
    }

  Example (panic documented):
    /// Returns the nth item.
    ///
    /// # Panics
    /// Panics if n >= items.len()
    pub fn get_nth(items: &[T], n: usize) -> &T {
        &items[n]
    }

  Better: Return Option or Result instead of panicking in library code.

# IDIOMATIC PATTERNS
---
id: rust-quality-idiom-unnecessary-mut
language: rust
severity: info
message: "Quality: Remove unnecessary mut declarations"
tags: [quality, idiom, clarity]
rule:
  kind: let_declaration | function_parameter
  pattern: |
    (let mut $NAME = $EXPR)
    @constraint { $NAME is_not_mutated }
note: |
  mut signals that a variable is mutated. If it never changes, remove mut to
  clarify intent and reduce cognitive load.

  Example (confusing):
    let mut items = vec![1, 2, 3];
    println!("{:?}", items);  // Never mutated

  Example (clear):
    let items = vec![1, 2, 3];
    println!("{:?}", items);

---
id: rust-quality-idiom-early-return
language: rust
severity: info
message: "Quality: Use early returns to reduce nesting"
tags: [quality, idiom, readability]
rule:
  kind: function_item
  pattern: |
    (fn $NAME $BODY)
    @constraint { excessive_nesting_depth($BODY) > 3 }
note: |
  Deeply nested conditionals are hard to follow. Use early returns to reduce nesting
  and improve readability.

  Example (nested):
    fn process(x: Option<u32>) -> Result<u32, Error> {
        if let Some(val) = x {
            if val > 0 {
                if val < 100 {
                    Ok(val * 2)
                } else {
                    Err(Error::TooLarge)
                }
            } else {
                Err(Error::NonPositive)
            }
        } else {
            Err(Error::Missing)
        }
    }

  Example (flat with early returns):
    fn process(x: Option<u32>) -> Result<u32, Error> {
        let val = x.ok_or(Error::Missing)?;
        if val == 0 { return Err(Error::NonPositive); }
        if val >= 100 { return Err(Error::TooLarge); }
        Ok(val * 2)
    }

---
id: rust-quality-idiom-option-and-then-vs-match
language: rust
severity: info
message: "Quality: Use and_then, map, and_then chains instead of nested matches"
tags: [quality, idiom, readability]
rule:
  kind: match_expression
  pattern: |
    (match $OPT { Some(x) => match $OPT2 { ... } None => ... })
note: |
  Composing Option/Result operations with combinators (map, and_then, etc.) is
  more idiomatic and easier to read than nested matches.

  Example (nested matches):
    match get_user(id) {
        Some(user) => match get_posts(user.id) {
            Some(posts) => Some(posts.len()),
            None => None,
        },
        None => None,
    }

  Example (chained combinators):
    get_user(id)
        .and_then(|user| get_posts(user.id))
        .map(|posts| posts.len())

---
id: rust-quality-idiom-match-on-references
language: rust
severity: info
message: "Quality: Match on references to avoid unnecessary moves"
tags: [quality, idiom, ownership]
rule:
  kind: match_expression
  pattern: |
    (match $OWNED_VAL { ... })
    @constraint {
      $OWNED_VAL is_owned_value AND
      pattern_moves_value
    }
note: |
  When matching on an owned value, you move it into the match arms. If you don't
  need ownership, match on &value instead.

  Example (moves unnecessarily):
    let items = vec![1, 2, 3];
    match items {
        vec => println!("{:?}", vec),  // Moves items
    }

  Example (borrows):
    let items = vec![1, 2, 3];
    match &items {
        vec => println!("{:?}", vec),  // Borrows items
    }

---
id: rust-quality-idiom-if-let-simple-match
language: rust
severity: info
message: "Quality: Use if let for single pattern matches"
tags: [quality, idiom, conciseness]
rule:
  kind: match_expression
  pattern: |
    (match $VAL { $PATTERN => $BODY, _ => {} })
note: |
  If you're only interested in one pattern and the else is empty or simple,
  use if let.

  Example (verbose):
    match opt {
        Some(x) => println!("{}", x),
        None => {},
    }

  Example (concise):
    if let Some(x) = opt {
        println!("{}", x);
    }

---
id: rust-quality-idiom-while-let
language: rust
severity: info
message: "Quality: Use while let for looping over iterator options"
tags: [quality, idiom, idiomatic]
rule:
  kind: loop_expression | while_expression
  pattern: |
    (loop { match $ITER.next() { Some(x) => ... None => break } })
note: |
  while let is the idiomatic way to loop until a pattern fails (like None).

  Example (verbose):
    loop {
        match iter.next() {
            Some(item) => println!("{}", item),
            None => break,
        }
    }

  Example (idiomatic):
    while let Some(item) = iter.next() {
        println!("{}", item);
    }

---
id: rust-quality-idiom-into-instead-of-from
language: rust
severity: info
message: "Quality: Prefer into() over from() for type conversions"
tags: [quality, idiom, readability]
rule:
  kind: function_call
  pattern: |
    $TYPE::from($VAL)
note: |
  into() is often more idiomatic than from() because it defers the type to the
  type inference system, reducing clutter.

  Example (explicit):
    let s: String = String::from("hello");

  Example (idiomatic):
    let s: String = "hello".into();

  Note: Both are equally valid; this is a style preference. Use what's clearer
  in context.

# CONCURRENCY & PERFORMANCE
---
id: rust-quality-concurrency-shared-mut-state
language: rust
severity: error
message: "Quality: Use Mutex/Arc instead of shared mutable state"
tags: [quality, concurrency, safety]
rule:
  kind: static_item | struct_item
  pattern: |
    (static mut $VAR | struct $NAME { $FIELDS })
    @constraint { contains_mut_reference AND is_shared_context }
note: |
  Shared mutable state is a data race waiting to happen. In Rust:
  - Use Mutex<T> for shared mutable access
  - Use Arc<Mutex<T>> for shared ownership + mutation
  - Use RwLock<T> if you need many readers + few writers

  Example (unsafe):
    static mut COUNTER: u32 = 0;

    fn increment() {
        unsafe { COUNTER += 1; }  // Race condition!
    }

  Example (safe):
    use std::sync::{Arc, Mutex};

    let counter = Arc::new(Mutex::new(0));
    let counter_clone = Arc::clone(&counter);

    std::thread::spawn(move || {
        let mut count = counter_clone.lock().unwrap();
        *count += 1;
    });

---
id: rust-quality-performance-allocation-in-loop
language: rust
severity: warning
message: "Quality: Avoid allocations in hot loops; move to outer scope or use object pools"
tags: [quality, performance, optimization]
rule:
  kind: for_expression | while_expression
  pattern: |
    (for|while $LOOP { $BODY })
    @constraint {
      $BODY contains_allocation AND
      is_likely_hot_path
    }
note: |
  Allocating memory in a hot loop can be slow due to heap fragmentation and
  garbage collection pressure. Move allocations outside the loop when possible.

  Example (inefficient):
    for item in items {
        let buffer = Vec::new();  // Allocates every iteration
        process(item, &mut buffer);
    }

  Example (efficient):
    let mut buffer = Vec::new();
    for item in items {
        buffer.clear();  // Reuse allocation
        process(item, &mut buffer);
    }

---
id: rust-quality-performance-vector-contains-inefficient
language: rust
severity: warning
message: "Quality: Use HashSet for contains() checks; Vec is O(n)"
tags: [quality, performance, data-structure]
rule:
  kind: method_call
  pattern: |
    $VEC:expr.contains($ITEM)
    @constraint { is_vector AND inside_loop }
note: |
  Vec::contains() is O(n) - it scans linearly. For repeated checks, use HashSet
  which is O(1) average case.

  Example (slow):
    let allowed: Vec<u32> = vec![1, 2, 3, 4, 5];
    for item in items {
        if allowed.contains(&item) {  // O(n) per iteration
            process(item);
        }
    }

  Example (fast):
    use std::collections::HashSet;
    let allowed: HashSet<u32> = vec![1, 2, 3, 4, 5].into_iter().collect();
    for item in items {
        if allowed.contains(&item) {  // O(1) per iteration
            process(item);
        }
    }

---
id: rust-quality-performance-collect-when-iterator-sufficient
language: rust
severity: info
message: "Quality: Avoid .collect() when an iterator is sufficient"
tags: [quality, performance, memory]
rule:
  kind: method_call
  pattern: |
    $ITER.collect::<Vec<_>>()
    @constraint {
      only_iterated_once AND
      NOT needs_multiple_passes
    }
note: |
  Collecting into Vec allocates memory for all elements. If you only iterate
  once, use the iterator directly to save allocation.

  Example (unnecessary allocation):
    let squared: Vec<u32> = numbers.iter().map(|x| x * x).collect();
    for s in squared { println!("{}", s); }

  Example (lazy evaluation):
    let squared = numbers.iter().map(|x| x * x);
    for s in squared { println!("{}", s); }

---
id: rust-quality-performance-format-string-overhead
language: rust
severity: info
message: "Quality: Use write! macro for formatting to avoid string allocation"
tags: [quality, performance, idiom]
rule:
  kind: method_call
  pattern: |
    format!($PATTERN)
    @constraint { used_in_write_context }
note: |
  format!() allocates a String. If you're writing to a buffer/file, use write!()
  directly to avoid the intermediate allocation.

  Example (allocates):
    let s = format!("Value: {}", x);
    println!("{}", s);

  Example (direct):
    println!("Value: {}", x);

  Or when writing to buffer:
    use std::io::Write;
    let mut buf = Vec::new();
    write!(&mut buf, "Value: {}", x).unwrap();

# SECURITY & SAFETY
---
id: rust-quality-security-hardcoded-secrets
language: rust
severity: error
message: "Quality: Don't hardcode secrets; use environment variables or secure vaults"
tags: [quality, security, correctness]
rule:
  kind: string_literal | variable_declaration
  pattern: |
    ($STRING_LITERAL | $VAR_INIT)
    @constraint {
      looks_like_secret($STRING_LITERAL | $VAR_INIT) AND
      NOT loaded_from_env_var
    }
note: |
  Hardcoded secrets (API keys, passwords, tokens) leak when code is shared or
  stored in version control. Use environment variables, secret managers, or
  configuration files instead.

  Example (dangerous):
    const API_KEY: &str = "sk_live_abc123xyz789";

    fn call_api() {
        client.set_header("Authorization", format!("Bearer {}", API_KEY));
    }

  Example (secure):
    fn call_api() -> Result<()> {
        let api_key = std::env::var("API_KEY")?;
        client.set_header("Authorization", format!("Bearer {}", api_key));
        Ok(())
    }

  Tools: use keyring, secret-vault, or standard env vars.

---
id: rust-quality-security-unsafe-without-comment
language: rust
severity: warning
message: "Quality: Justify every unsafe block with a comment explaining why it's safe"
tags: [quality, security, safety]
rule:
  kind: unsafe_block
  pattern: |
    (unsafe { $BODY })
    @constraint { NOT preceded_by_safety_comment }
note: |
  unsafe {} disables compiler safety checks. Document WHY it's safe to help
  future maintainers and catch safety bugs.

  Example (unjustified):
    unsafe { ptr.as_ref() }  // Is this safe?

  Example (justified):
    // Safe because ptr is guaranteed to be valid and properly aligned
    // (validated in the preceding bounds check)
    unsafe { ptr.as_ref() }

---
id: rust-quality-security-unrestricted-panic
language: rust
severity: warning
message: "Quality: Consider using catch_unwind or limiting panic scope in library code"
tags: [quality, security, stability]
rule:
  kind: function_item
  pattern: |
    (pub fn $NAME $BODY)
    @constraint {
      NOT is_test AND
      NOT uses_catch_unwind
    }
note: |
  In library code, a panic from the library can crash the entire application.
  Consider:
  - Using Result instead of panic for recoverable errors
  - Using catch_unwind for untrusted code (closures, plugins)
  - Documenting panic conditions clearly

  Example (risky):
    pub fn process_user_code(f: impl Fn()) {
        f();  // User's closure panics → library crashes
    }

  Example (safe):
    use std::panic::catch_unwind;
    pub fn process_user_code(f: impl Fn()) -> Result<(), &'static str> {
        catch_unwind(f).map_err(|_| "User code panicked")
    }

---
id: typescript-security-any-type-abuse
message: 'Quality: Prevent any type abuse for injection and security bypasses'
tags:
- security
severity: error
rule:
  pattern: :\s*any\s*[=;,\)]
note: '|'
language: typescript

---
id: typescript-security-type-assertion-bypass
message: 'Quality: Prevent type assertions (as/angle-bracket) that bypass security
  checks'
tags:
- security
severity: error
rule:
  pattern: (as\s+\w+|<\w+>.*as\w+)
note: '|'
language: typescript

---
id: typescript-security-ts-ignore-hiding
message: 'Quality: Prohibit @ts-ignore without security audit and comment'
tags:
- security
severity: error
rule:
  pattern: '@ts-ignore\s*(?![\s\S]*?SECURITY|[\s\S]*?AUDIT)'
note: '|'
language: typescript

---
id: typescript-security-module-augmentation
message: 'Quality: Validate module augmentation to prevent scope pollution and monkey-patching'
tags:
- security
severity: error
rule:
  pattern: declare\s+module\s+["\']
note: '|'
language: typescript

---
id: typescript-security-unsafe-json-parse
message: 'Quality: Validate JSON.parse results with schema validation'
tags:
- security
severity: error
rule:
  pattern: JSON\.parse\s*\([^)]*\)\s*(?!\.)
note: '|'
language: typescript

---
id: typescript-security-eval-dynamic-code
message: 'Quality: Prohibit eval, Function constructor, and dynamic code execution'
tags:
- security
severity: error
rule:
  pattern: (eval\s*\(|new\s+Function\s*\(|Function\s*\()
note: '|'
language: typescript

---
id: typescript-security-nostore-unsafe-global
message: 'Quality: Prevent global state modification without isolation'
tags:
- security
severity: error
rule:
  pattern: (globalThis\.|global\.|Object\.defineProperty\s*\(\s*Object\.prototype)
note: '|'
language: typescript

---
id: typescript-security-object-freeze-enforcement
message: 'Quality: Use Object.freeze on security-critical immutable data'
tags:
- security
severity: warning
rule:
  pattern: const\s+(\w+)\s*=\s*\{\s*[^}]*(?:password|secret|apiKey|token)[^}]*\}
note: '|'
language: typescript

---
id: typescript-security-sql-injection-template
message: 'Quality: Use parameterized queries, never string interpolation for SQL'
tags:
- security
severity: error
rule:
  pattern: (sql`|query\s*\(.*\$\{|`.*SELECT.*\$\{)
note: '|'
language: typescript

---
id: typescript-security-xss-innerHTML
message: 'Quality: Never use innerHTML with untrusted data'
tags:
- security
severity: error
rule:
  pattern: innerHTML\s*=\s*[^;]*(?!DOMPurify|sanitize)
note: '|'
language: typescript

---
id: typescript-performance-excessive-type-complexity
message: 'Quality: Avoid excessively complex generic/conditional types'
tags:
- performance
severity: warning
rule:
  pattern: (?:extends.*\?.*:.*extends.*\?)
note: '|'
language: typescript

---
id: typescript-performance-const-enum-removal
message: 'Quality: Use const enum for compile-time elimination'
tags:
- performance
severity: info
rule:
  pattern: enum\s+\w+\s*\{
note: '|'
language: typescript

---
id: typescript-performance-namespace-overhead
message: 'Quality: Prefer modules over namespaces for runtime efficiency'
tags:
- performance
severity: info
rule:
  pattern: namespace\s+\w+
note: '|'
language: typescript

---
id: typescript-performance-declaration-merging
message: 'Quality: Avoid declaration merging that increases module size'
tags:
- performance
severity: warning
rule:
  pattern: declare\s+(class|function|interface)\s+\w+|interface\s+\w+\s*\{.*\}\s*interface\s+\w+\s*\{
note: '|'
language: typescript

---
id: typescript-performance-tsconfig-module-resolution
message: 'Quality: Optimize tsconfig moduleResolution and noResolve'
tags:
- performance
severity: info
rule:
  pattern: '"moduleResolution":\s*"(classic|node)"'
note: '|'
language: typescript

---
id: typescript-performance-excessive-overloads
message: 'Quality: Limit function overload count (max 3-5 signatures)'
tags:
- performance
severity: warning
rule:
  pattern: function\s+\w+.*\{[^}]*function\s+\w+.*\{[^}]*function\s+\w+
note: '|'
language: typescript

---
id: typescript-performance-large-union-types
message: 'Quality: Avoid unions with 20+ members; use discriminated unions instead'
tags:
- performance
severity: warning
rule:
  pattern: type\s+\w+\s*=\s*.*\|.*\|.*\|.*\|.*\|.*\|.*\|.*\|.*\|.*\|
note: '|'
language: typescript

---
id: typescript-performance-nocompile-without-incremental
message: 'Quality: Enable incremental compilation for large projects'
tags:
- performance
severity: info
rule:
  pattern: '"incremental":\s*false|"noEmit":\s*true'
note: '|'
language: typescript

---
id: typescript-quality-strict-mode-off
message: 'Quality: Enable strict mode in tsconfig.json'
tags:
- quality
severity: error
rule:
  pattern: '"strict":\s*false|"noImplicitAny":\s*false'
note: '|'
language: typescript

---
id: typescript-quality-implicit-any
message: 'Quality: Eliminate implicit any types; add explicit types'
tags:
- quality
severity: error
rule:
  pattern: (?<!:\s)[,\)]\s*(?!.*:\s)
note: '|'
language: typescript

---
id: typescript-quality-missing-return-types
message: 'Quality: Add explicit return type annotations to all functions'
tags:
- quality
severity: error
rule:
  pattern: (?:function|=>|catch)\s+\w+\s*\([^)]*\)(?!\s*:\s*(?:void|Promise|boolean|string|number|unknown|[\w\.]+))
note: '|'
language: typescript

---
id: typescript-quality-unknown-vs-any
message: 'Quality: Use unknown instead of any; forces type narrowing'
tags:
- quality
severity: error
rule:
  pattern: :\s*any(?!\s*\[|\s*\()
note: '|'
language: typescript

---
id: typescript-quality-interface-vs-type
message: 'Quality: Use interface for object shapes; type for unions/aliases'
tags:
- quality
severity: warning
rule:
  pattern: type\s+\w+\s*=\s*\{[^}]*\}
note: '|'
language: typescript

---
id: typescript-quality-generic-constraints
message: 'Quality: Add constraints to generics; avoid unconstrained generics'
tags:
- quality
severity: warning
rule:
  pattern: <\w+\s*(?![^>]*extends)(?:>|,)
note: '|'
language: typescript

---
id: typescript-quality-utility-types
message: 'Quality: Use utility types (Pick, Omit, Partial, Required, Readonly)'
tags:
- quality
severity: warning
rule:
  pattern: interface\s+\w+\s*\{(?!.*Omit|.*Pick|.*Partial|.*Required)[^}]*\}
note: '|'
language: typescript

---
id: typescript-quality-discriminated-unions
message: 'Quality: Use discriminated unions for safe polymorphism'
tags:
- quality
severity: error
rule:
  pattern: type\s+\w+\s*=\s*.*\|\s*.*(?!type\s*:|kind\s*:|kind:|type:|status\s*:|status:)
note: '|'
language: typescript

---
id: typescript-quality-readonly-properties
message: 'Quality: Mark immutable properties as readonly'
tags:
- quality
severity: warning
rule:
  pattern: interface\s+\w+\s*\{(?!.*readonly)[^}]*\s+\w+\s*:[^}]*\}
note: '|'
language: typescript

---
id: typescript-quality-exhaustiveness-checking
message: 'Quality: Use exhaustiveness checking in switch/if-else chains'
tags:
- quality
severity: error
rule:
  pattern: switch\s*\([^)]*\)\s*\{(?!.*default\s*:|_:\s*)
note: '|'
language: typescript

---
id: typescript-quality-avoid-boolean-params
message: 'Quality: Avoid boolean function parameters; use objects or enums'
tags:
- quality
severity: warning
rule:
  pattern: function\s+\w+\s*\([^)]*:\s*boolean
note: '|'
language: typescript

---
id: typescript-quality-nullish-coalescing
message: 'Quality: Use nullish coalescing (??) instead of || for defaults'
tags:
- quality
severity: warning
rule:
  pattern: '([^|]|[^|]\|) \|\| '
note: '|'
language: typescript

---
id: typescript-quality-optional-chaining
message: 'Quality: Use optional chaining (?.) for safe property access'
tags:
- quality
severity: warning
rule:
  pattern: (?!.*\?\.).*\.[a-zA-Z_]\w*\s*(?:\?|\.)
note: '|'
language: typescript

---
id: typescript-quality-avoid-vague-types
message: 'Quality: Avoid vague types like object, {} (empty object)'
tags:
- quality
severity: warning
rule:
  pattern: :\s*(?:object|{}|Object)(?![<\[])
note: '|'
language: typescript

---
id: typescript-quality-enums-const-or-union
message: 'Quality: Prefer const enum or string union over regular enum'
tags:
- quality
severity: info
rule:
  pattern: enum\s+\w+\s*\{[^}]*=[^}]*\}
note: '|'
language: typescript

---
id: typescript-quality-null-checking-order
message: 'Quality: Check null/undefined before type narrowing'
tags:
- quality
severity: warning
rule:
  pattern: (?!if.*null)if.*typeof
note: '|'
language: typescript

---
id: typescript-quality-class-access-modifiers
message: 'Quality: Use access modifiers (public, private, protected) in classes'
tags:
- quality
severity: warning
rule:
  pattern: class\s+\w+\s*\{(?!.*(?:public|private|protected))[^}]*\s+\w+\s*[=;:]
note: '|'
language: typescript

---
id: typescript-quality-unused-variables
message: 'Quality: Remove or prefix unused variables with underscore'
tags:
- quality
severity: info
rule:
  pattern: (?<!_)\b[a-zA-Z_]\w*\b(?!.*=)\s*[:=]
note: '|'
language: typescript

---
id: php-sec-001
language: php
severity: error
message: SQL Injection - Unparameterized Queries
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'SQL Injection - Unparameterized Queries

  '

---
id: php-sec-002
language: php
severity: error
message: SQL Injection - Concatenated WHERE Clauses
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'SQL Injection - Concatenated WHERE Clauses

  '

---
id: php-sec-003
language: php
severity: error
message: XSS - Unescaped Output in HTML Context
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'XSS - Unescaped Output in HTML Context

  '

---
id: php-sec-004
language: php
severity: error
message: XSS - Unescaped Output in JavaScript Context
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'XSS - Unescaped Output in JavaScript Context

  '

---
id: php-sec-005
language: php
severity: error
message: XSS - Unescaped Output in URL Attribute
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'XSS - Unescaped Output in URL Attribute

  '

---
id: php-sec-006
language: php
severity: error
message: XSS - DOM-based XSS via JavaScript Variable Injection
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'XSS - DOM-based XSS via JavaScript Variable Injection

  '

---
id: php-sec-007
language: php
severity: error
message: Command Injection - Unescaped Shell Commands
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Command Injection - Unescaped Shell Commands

  '

---
id: php-sec-008
language: php
severity: error
message: Command Injection - shell_exec with String Concatenation
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Command Injection - shell_exec with String Concatenation

  '

---
id: php-sec-010
language: php
severity: error
message: Remote File Inclusion (RFI) - External URL Inclusion
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Remote File Inclusion (RFI) - External URL Inclusion

  '

---
id: php-sec-011
language: php
severity: error
message: File Inclusion - Path Traversal via Directory Traversal
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'File Inclusion - Path Traversal via Directory Traversal

  '

---
id: php-sec-013
language: php
severity: error
message: Insecure Deserialization - Magic Methods Abuse
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Insecure Deserialization - Magic Methods Abuse

  '

---
id: php-sec-014
language: php
severity: error
message: Session Fixation - Static Session ID
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Session Fixation - Static Session ID

  '

---
id: php-sec-015
language: php
severity: error
message: Session Security - Missing HttpOnly Flag
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Session Security - Missing HttpOnly Flag

  '

---
id: php-sec-016
language: php
severity: error
message: Session Security - Missing SameSite Attribute
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Session Security - Missing SameSite Attribute

  '

---
id: php-sec-017
language: php
severity: error
message: Weak Hashing - MD5 or SHA1 for Passwords
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Weak Hashing - MD5 or SHA1 for Passwords

  '

---
id: php-sec-018
language: php
severity: error
message: Weak Hashing - Hash Function Without Salt
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Weak Hashing - Hash Function Without Salt

  '

---
id: php-sec-019
language: php
severity: error
message: Weak Encryption - Hardcoded Encryption Keys
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Weak Encryption - Hardcoded Encryption Keys

  '

---
id: php-sec-021
language: php
severity: error
message: Authentication - Hardcoded Credentials
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Authentication - Hardcoded Credentials

  '

---
id: php-sec-022
language: php
severity: error
message: Authentication - Weak Login Check
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Authentication - Weak Login Check

  '

---
id: php-sec-023
language: php
severity: error
message: Authorization - Missing Access Control Checks
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Authorization - Missing Access Control Checks

  '

---
id: php-sec-024
language: php
severity: error
message: Unsafe Functions - eval() Usage
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Unsafe Functions - eval() Usage

  '

---
id: php-sec-025
language: php
severity: error
message: Unsafe Functions - assert() with Dynamic Code
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Unsafe Functions - assert() with Dynamic Code

  '

---
id: php-sec-026
language: php
severity: warning
message: Unsafe Functions - create_function() Deprecated
tags:
- security
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Unsafe Functions - create_function() Deprecated

  '

---
id: php-perf-001
language: php
severity: error
message: String Concatenation in Loops
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'String Concatenation in Loops

  '

---
id: php-perf-003
language: php
severity: warning
message: Repeated str_replace() Calls
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Repeated str_replace() Calls

  '

---
id: php-perf-004
language: php
severity: warning
message: Inefficient Regular Expressions
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Inefficient Regular Expressions

  '

---
id: php-perf-005
language: php
severity: error
message: Inefficient Array Searches
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Inefficient Array Searches

  '

---
id: php-perf-006
language: php
severity: error
message: Multiple array_merge() in Loops
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Multiple array_merge() in Loops

  '

---
id: php-perf-007
language: php
severity: warning
message: Inefficient Array Filtering
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Inefficient Array Filtering

  '

---
id: php-perf-009
language: php
severity: error
message: N+1 Query Problem
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'N+1 Query Problem

  '

---
id: php-perf-010
language: php
severity: warning
message: SELECT * in Queries
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'SELECT * in Queries

  '

---
id: php-perf-012
language: php
severity: error
message: Unbounded Query Results
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Unbounded Query Results

  '

---
id: php-perf-013
language: php
severity: warning
message: Redundant require/include Statements
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Redundant require/include Statements

  '

---
id: php-perf-015
language: php
severity: error
message: OPcache Not Enabled or Configured
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'OPcache Not Enabled or Configured

  '

---
id: php-perf-017
language: php
severity: error
message: Processing Large Files in Memory
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Processing Large Files in Memory

  '

---
id: php-perf-018
language: php
severity: warning
message: Unnecessary Object Creation in Loops
tags:
- performance
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Unnecessary Object Creation in Loops

  '

---
id: php-qual-005
language: php
severity: info
message: Incorrect Naming Convention - Constants
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Incorrect Naming Convention - Constants

  '

---
id: php-qual-006
language: php
severity: error
message: Missing Parameter Type Hints
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Missing Parameter Type Hints

  '

---
id: php-qual-007
language: php
severity: error
message: Missing Return Type Declarations
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Missing Return Type Declarations

  '

---
id: php-qual-008
language: php
severity: warning
message: Missing Property Type Declarations
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Missing Property Type Declarations

  '

---
id: php-qual-009
language: php
severity: warning
message: Using Weak Type Juggling
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Using Weak Type Juggling

  '

---
id: php-qual-010
language: php
severity: error
message: Silent Error Suppression (@)
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Silent Error Suppression (@)

  '

---
id: php-qual-012
language: php
severity: warning
message: Bare Exception Catching
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Bare Exception Catching

  '

---
id: php-qual-013
language: php
severity: warning
message: Uninitialized Variables
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Uninitialized Variables

  '

---
id: php-qual-014
language: php
severity: warning
message: Missing PHPDoc Comments - Functions
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Missing PHPDoc Comments - Functions

  '

---
id: php-qual-015
language: php
severity: info
message: Missing PHPDoc Comments - Classes
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Missing PHPDoc Comments - Classes

  '

---
id: php-qual-016
language: php
severity: info
message: Incorrect PHPDoc Type Annotations
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Incorrect PHPDoc Type Annotations

  '

---
id: php-qual-017
language: php
severity: error
message: Missing Unit Tests
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Missing Unit Tests

  '

---
id: php-qual-019
language: php
severity: warning
message: Test Code Coverage Below Threshold
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Test Code Coverage Below Threshold

  '

---
id: php-qual-020
language: php
severity: warning
message: Cyclomatic Complexity Too High
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Cyclomatic Complexity Too High

  '

---
id: php-qual-021
language: php
severity: warning
message: Function Length Exceeded
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Function Length Exceeded

  '

---
id: php-qual-022
language: php
severity: warning
message: Too Many Parameters
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Too Many Parameters

  '

---
id: php-qual-023
language: php
severity: warning
message: Duplicate Code - Copy-Paste
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Duplicate Code - Copy-Paste

  '

---
id: php-qual-025
language: php
severity: error
message: Global Variables Usage
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Global Variables Usage

  '

---
id: php-qual-026
language: php
severity: info
message: Dead Code - Unused Functions/Variables
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Dead Code - Unused Functions/Variables

  '

---
id: php-qual-027
language: php
severity: warning
message: Large Classes - God Object
tags:
- quality
- php
rule:
  kind: call
  pattern: '[pattern]'
note: 'Large Classes - God Object

  '

---
id: swift-sec-force-unwrap
tags:
- Security
severity: error
message: 'Quality: Avoid force unwrapping optionals'
note: '|'
language: swift

---
id: swift-sec-keychain-hardcoding
tags:
- Security
severity: error
message: 'Quality: Never hardcode keychain passwords or tokens'
note: '|'
language: swift

---
id: swift-sec-insecure-storage
tags:
- Security
severity: error
message: 'Quality: Avoid insecure storage of sensitive data'
note: '|'
language: swift

---
id: swift-sec-url-schemes
tags:
- Security
severity: error
message: 'Quality: Validate custom URL schemes and deep links'
note: '|'
language: swift

---
id: swift-sec-app-transport-security
tags:
- Security
severity: error
message: 'Quality: Enforce App Transport Security (ATS)'
note: '|'
language: swift

---
id: swift-sec-biometric-auth
tags:
- Security
severity: error
message: 'Quality: Validate biometric authentication properly'
note: '|'
language: swift

---
id: swift-sec-ssl-pinning
tags:
- Security
severity: error
message: 'Quality: Implement SSL/TLS certificate pinning for sensitive APIs'
note: '|'
language: swift

---
id: swift-sec-injection-attacks
tags:
- Security
severity: error
message: 'Quality: Prevent injection attacks (SQL, code, command)'
note: '|'
language: swift

---
id: swift-sec-memory-safety
tags:
- Security
severity: error
message: 'Quality: Maintain memory safety with proper pointer usage'
note: '|'
language: swift

---
id: swift-perf-value-vs-reference
tags:
- Performance
severity: warning
message: 'Quality: Choose appropriate value vs reference types'
note: '|'
language: swift

---
id: swift-perf-copy-on-write
tags:
- Performance
severity: warning
message: 'Quality: Leverage copy-on-write semantics for performance'
note: '|'
language: swift

---
id: swift-perf-arc-overhead
tags:
- Performance
severity: warning
message: 'Quality: Minimize Automatic Reference Counting (ARC) overhead'
note: '|'
language: swift

---
id: swift-perf-collection-operations
tags:
- Performance
severity: warning
message: 'Quality: Optimize collection operations for performance'
note: '|'
language: swift

---
id: swift-perf-lazy-properties
tags:
- Performance
severity: info
message: 'Quality: Use lazy properties for expensive initialization'
note: '|'
language: swift

---
id: swift-perf-inline-closures
tags:
- Performance
severity: info
message: 'Quality: Avoid capturing heavy objects in inline closures'
note: '|'
language: swift

---
id: swift-perf-avoid-string-concat
tags:
- Performance
severity: warning
message: 'Quality: Avoid string concatenation in loops'
note: '|'
language: swift

---
id: swift-perf-async-await-deadlock
tags:
- Performance
severity: error
message: 'Quality: Avoid deadlocks with async/await'
note: '|'
language: swift

---
id: swift-qual-naming-conventions
tags:
- Quality
severity: warning
message: 'Quality: Follow Swift naming conventions (PascalCase, camelCase)'
note: '|'
language: swift

---
id: swift-qual-optionals-usage
tags:
- Quality
severity: error
message: 'Quality: Use optionals correctly and safely'
note: '|'
language: swift

---
id: swift-qual-protocol-design
tags:
- Quality
severity: warning
message: 'Quality: Design protocols that are clear and maintainable'
note: '|'
language: swift

---
id: swift-qual-error-handling
tags:
- Quality
severity: error
message: 'Quality: Use proper error handling with typed errors'
note: '|'
language: swift

---
id: swift-qual-access-control
tags:
- Quality
severity: warning
message: 'Quality: Apply appropriate access control modifiers'
note: '|'
language: swift

---
id: swift-qual-documentation
tags:
- Quality
severity: warning
message: 'Quality: Document public APIs with DocC or inline comments'
note: '|'
language: swift

---
id: swift-qual-dependency-injection
tags:
- Quality
severity: warning
message: 'Quality: Use dependency injection to improve testability'
note: '|'
language: swift

---
id: swift-qual-testability
tags:
- Quality
severity: warning
message: 'Quality: Write code that is testable'
note: '|'
language: swift

---
id: swift-qual-type-safety
tags:
- Quality
severity: warning
message: 'Quality: Leverage Swift''s type safety'
note: '|'
language: swift

---
id: swift-qual-avoid-force-unwrap-general
tags:
- Quality
severity: error
message: 'Quality: Eliminate all force unwraps except in tests'
note: '"Comprehensive Swift security, performance, and quality rules"'
language: swift

---
id: objc-sec-001
name: Format String Vulnerability Detection
category: Security
severity: Critical
description: Detect format string vulnerabilities in NSString and NSLog calls
pattern: "(NSLog|NSString|stringWithFormat|stringByAppendingFormat|appendFormat|\n\
  \ initWithFormat|localizedStringWithFormat|stringWithCString|\n stringWithUTF8String).*%[a-zA-Z0-9@$]*\n"
check_type: format_string
vulnerable_patterns:
- NSLog(userInput)
- NSLog([dict description])
- '[NSString stringWithFormat:variable]'
- '[NSString localizedStringWithFormat:userString]'
safe_patterns:
- NSLog(@"%@", variable)
- '[NSString stringWithFormat:@"%@", variable]'
- 'NSLog(@"Static format: %@", value)'
recommendation: 'Always use format strings as literal constants, never from user input
  or variables.

  Pass user data as parameters to format specifiers:

  - NSLog(@"%@", userString) NOT NSLog(userString)

  - [NSString stringWithFormat:@"%@", value] NOT [NSString stringWithFormat:value]

  '
cwe:
- CWE-134
mitigation: Use %@ for objects, %d for integers, %f for floats. Validate all format
  strings.

---
id: objc-sec-002
name: Buffer Overflow Detection
category: Security
severity: Critical
description: Detect potential buffer overflow in C functions and char arrays
pattern: '(strcpy|strcat|sprintf|scanf|gets|fgets|memcpy|memmove|strncpy|strncat).*

  '
check_type: buffer_safety
vulnerable_patterns:
- strcpy(buffer, input)
- char buf[256]; strcpy(buf, userInput)
- sprintf(buffer, format, arg)
- char array[FIXED_SIZE]; memcpy(array, data, size)
- gets(buffer)
safe_patterns:
- strlcpy(buffer, input, sizeof(buffer))
- strncat(buffer, input, remaining)
- snprintf(buffer, sizeof(buffer), format, args)
- memset(buffer, 0, size); memcpy_s(buffer, size, data, min(size, dataLen))
recommendation: 'Use bounds-checked alternatives for string/memory operations:

  - Replace strcpy → strlcpy with explicit buffer size

  - Replace strcat → strlcat with explicit buffer size

  - Replace sprintf → snprintf with buffer size

  - Replace memcpy → use NS* equivalents or bounds checking

  - NEVER use gets() - always use fgets() with size limit

  - Use NSString for string handling when possible

  '
cwe:
- CWE-120
- CWE-119
mitigation: Validate buffer sizes, use safe variants, use NSString/NSData.

---
id: objc-sec-003
name: Keychain Security Issues
category: Security
severity: High
description: Detect insecure keychain usage and sensitive data handling
pattern: "(kSecClass|kSecAttrAccessible|kSecUseDataProtection|\n SecItemAdd|SecItemDelete|SecItemUpdate|SecItemCopyMatching|\n\
  \ SecKeyCreateSignature|SecKeyCreateDecryptedData).*\n"
check_type: keychain_security
vulnerable_patterns:
- 'kSecAttrAccessible: kSecAttrAccessibleAlways'
- 'kSecAttrAccessible: kSecAttrAccessibleWhenUnlocked'
- '[keychain storePassword:pwd user:u]'
- NSString *password = [NSString stringWithContentsOfFile:...]
- char password[256]; memcpy(password, data, len)
safe_patterns:
- 'kSecAttrAccessible: kSecAttrAccessibleWhenUnlockedThisDeviceOnly'
- 'kSecAttrAccessible: kSecAttrAccessibleAfterFirstUnlockThisDeviceOnly'
- 'kSecUseDataProtection: @YES'
- 'kSecAttrSynchronizable: @NO'
- volatile char *sensitiveData; memset(sensitiveData, 0, len)
recommendation: 'Follow Apple Keychain best practices:

  - Use kSecAttrAccessibleWhenUnlockedThisDeviceOnly for maximum security

  - Set kSecAttrSynchronizable: @NO for passwords (disable iCloud Keychain)

  - Use kSecUseDataProtection: @YES for encrypted storage at rest

  - Use volatile for sensitive buffers and zero-fill on release

  - Never log passwords or sensitive data

  - Validate keychain error codes and handle failures gracefully

  - Use SecItemDelete to remove sensitive items when no longer needed

  '
cwe:
- CWE-922
- CWE-316
mitigation: Use ThisDeviceOnly, disable iCloud sync, zero-fill buffers, handle errors.

---
id: objc-sec-004
name: Insecure Data Storage Detection
category: Security
severity: High
description: Detect hardcoded credentials, insecure file storage, plaintext data
pattern: "(@\"password|@\"secret|@\"apikey|@\"token|@\"credential|\n NSUserDefaults|preferences|defaults|NSPropertyListSerialization|\n\
  \ [NSString writeToFile|[NSData writeToFile|NSSearchPathForDirectoriesInDomains|\n\
  \ NSDocumentDirectory|NSCachesDirectory|NSApplicationSupportDirectory).*\n"
check_type: data_storage
vulnerable_patterns:
- NSString *password = @"myPassword123"
- NSString *apiKey = @"sk-xyz123"
- '[defaults setObject:password forKey:@"pwd"]'
- '[NSKeyedArchiver archiveRootObject:userData toFile:path]'
- NSString *filePath = [docs stringByAppendingPathComponent:@"secrets.plist"]
- '[userData writeToFile:path atomically:YES]'
safe_patterns:
- // Credentials from environment or secure configuration
- '[keychain storePassword:pwd forService:@"app" account:user]'
- '[keychain retrievePasswordForService:@"app" account:user]'
- NSDataWritingFileProtectionComplete
- '[data writeToFile:path options:NSDataWritingFileProtectionComplete error:nil]'
recommendation: 'Never store sensitive data in code or NSUserDefaults:

  - Use Keychain for passwords, tokens, and credentials

  - Use Data Protection (NSDataWritingFileProtectionComplete) for files

  - Remove hardcoded secrets and use secure configuration

  - Encrypt sensitive files with CommonCrypto or CryptoKit

  - Use NSFileProtectionComplete for file permissions

  - Never log sensitive data

  - Clear sensitive data from memory (memset, zero-fill)

  '
cwe:
- CWE-798
- CWE-312
- CWE-315
mitigation: Use Keychain, Data Protection, encrypt files, remove hardcoded secrets.

---
id: objc-sec-005
name: SSL/TLS Configuration Issues
category: Security
severity: High
description: Detect weak SSL/TLS configuration and certificate validation
pattern: "(NSURLSessionConfiguration|URLSessionConfiguration|\n serverTrustPolicy|validateServerTrust|allowInvalidCertificates|\n\
  \ kCFStreamSSLValidatesCertificateChain|kCFStreamSSLLevel|\n SFSafariViewController|WKWebView|UIWebView).*\n"
check_type: ssl_tls
vulnerable_patterns:
- config.allowInvalidCertificates = YES
- challenge.sender useCredential:[NSURLCredential credentialForTrust:trust]
- 'kCFStreamSSLValidatesCertificateChain: NO'
- serverTrustPolicy = [AFNoSSLPinningServerTrustPolicy new]
- UIWebView loadRequest:request
safe_patterns:
- NSURLSessionConfiguration.default
- '[challenge.sender performDefaultHandlingForAuthenticationChallenge:challenge]'
- '[challenge.sender rejectProtectionSpaceAndContinueWithChallenge:challenge]'
- WKWebViewConfiguration with certificate pinning
- SFSafariViewController for external URLs
recommendation: 'Implement proper SSL/TLS security:

  - Use NSURLSession with default configuration

  - Implement certificate pinning for sensitive connections

  - Validate certificate chains and hostnames

  - Reject invalid certificates (do NOT set allowInvalidCertificates=YES)

  - Use WKWebView instead of deprecated UIWebView

  - Use SFSafariViewController for external URLs

  - Disable weak SSL versions (SSLv3, TLS 1.0, 1.1)

  - Test with network security configuration (networksecurity.xml on Android)

  '
cwe:
- CWE-295
mitigation: Enable certificate validation, implement pinning, reject invalid certs.

---
id: objc-sec-006
name: Memory Corruption Detection
category: Security
severity: Critical
description: Detect use-after-free, double-free, and memory safety issues
pattern: "(__weak|__strong|__autoreleasing|__unsafe_unretained|\n dealloc|release|autorelease|retain|copy|strong|weak|assign|\n\
  \ unsafe_unretained|NSZombieEnabled|MallocStackLogging).*\n"
check_type: memory_safety
vulnerable_patterns:
- Object *obj = ...; [obj release]; [obj method]
- __unsafe_unretained Object *obj = ...
- assign properties without __weak
- dealloc { [observer removeObserver:self] } // after object freed
- '[_array addObject:obj]; [obj release]'
safe_patterns:
- Object *obj = ... // ARC manages release
- '@property (weak, nonatomic) Object *obj'
- '@property (strong, nonatomic) Object *obj'
- '- (void)dealloc { [[NSNotificationCenter defaultCenter] removeObserver:self] }'
recommendation: 'Follow ARC and memory management best practices:

  - Use ARC - only manually manage in specific legacy code

  - Use __weak for delegates and observers to break retain cycles

  - Use __strong (default) for ownership

  - Implement dealloc to remove observers and clean up resources

  - Test with Zombie Objects and MallocStackLogging

  - Avoid __unsafe_unretained except in performance-critical code

  - Use tools: Instruments (Allocations, Leaks), AddressSanitizer

  '
cwe:
- CWE-416
- CWE-415
mitigation: Use ARC, __weak for delegates, implement dealloc, test with Instruments.

---
id: objc-sec-007
name: Injection Attack Detection
category: Security
severity: High
description: Detect SQL injection, predicate injection, and code injection
pattern: "(NSFetchRequest|predicate|predicateWithFormat|SQLiteDatabase|\n sqlite3_prepare|sqlite3_bind|executeQuery|NSPredicate|\n\
  \ NSCompoundPredicate|stringByAppendingString|stringByAppendingFormat).*\n"
check_type: injection
vulnerable_patterns:
- '[NSPredicate predicateWithFormat:userInput]'
- NSString *query = [NSString stringWithFormat:@"SELECT * FROM users WHERE id = %d",
  userId]
- NSFetchRequest *request = [NSFetchRequest fetchRequestWithEntityName:@"Entity"];
- request.predicate = [NSPredicate predicateWithFormat:@"name = %@", userInput]
- sqlite3_prepare_v2(db, query, -1, &stmt, NULL)
safe_patterns:
- '[NSPredicate predicateWithFormat:@"name = %@", userInput]'
- '[NSPredicate predicateWithFormat:@"age > %d", userAge]'
- sqlite3_prepare_v2(db, @"SELECT * FROM users WHERE id = ?", -1, &stmt, NULL)
- sqlite3_bind_int(stmt, 1, userId)
- request.predicate = [NSPredicate predicateWithFormat:@"status = %@", statusValue]
recommendation: 'Use parameterized queries and predicates:

  - Always use %@ for objects and %d for integers in predicates

  - Use bound parameters in SQL queries (? placeholders)

  - Never concatenate user input directly into predicates or queries

  - Validate and sanitize all user input before use

  - Use SQLite3 prepared statements instead of string formatting

  - Implement input validation for expected types and ranges

  - Log and monitor injection attempts

  '
cwe:
- CWE-89
- CWE-90
mitigation: Use parameterized queries, validate input, use bound parameters.

---
id: objc-sec-008
name: Unvalidated URL Handling
category: Security
severity: High
description: Detect unvalidated URL schemes and deep linking vulnerabilities
pattern: "(NSURL|openURL|canOpenURL|openAppSettings|openExternalURL|\n application:openURL:options|application:handleOpenURL|\n\
  \ URLScheme|universalLinks|handlesURL).*\n"
check_type: url_handling
vulnerable_patterns:
- '[[UIApplication sharedApplication] openURL:url]'
- if ([UIApplication.shared canOpenURL:url]) { [UIApplication.shared openURL:url]
  }
- NSURL *url = [NSURL URLWithString:userInput]
- '- (BOOL)application:(UIApplication *)app openURL:(NSURL *)url ...'
- '[UIApplication.shared openURL:url options:@{} completionHandler:nil]'
safe_patterns:
- NSURL *url = [NSURL URLWithString:@"https://example.com"]
- if (url && [url.scheme isEqualToString:@"https"]) { ... }
- if ([url.host isEqualToString:@"trusted.domain.com"]) { ... }
- '- (BOOL)application:(UIApplication *)app openURL:(NSURL *)url options:(NSDictionary
  *)options'
- '{ if ([self validateURL:url]) { ... } return NO; }'
recommendation: 'Implement secure URL handling:

  - Validate URL scheme (whitelist https, custom schemes)

  - Validate URL host against trusted domains

  - Check source of URLs (prevent open redirects)

  - Validate deep link parameters

  - Use URL parsing (components, query parameters)

  - Implement input validation for all URL-based navigation

  - Prevent open redirects by validating domains

  - Log suspicious URL handling attempts

  '
cwe:
- CWE-601
- CWE-941
mitigation: Validate schemes, hosts, and parameters. Prevent open redirects.

---
id: objc-sec-009
name: Weak Cryptography Detection
category: Security
severity: High
description: Detect weak encryption algorithms and cryptographic misuse
pattern: "(CCCrypt|SecKeyCreateSignature|SecKeyCreateDecryptedData|\n MD5|SHA1|DES|AES|CommonCrypto|SecCertificateRef|\n\
  \ kCCAlgorithmAES|kCCAlgorithmDES|CCAlgorithm|SecKeyAlgorithm).*\n"
check_type: cryptography
vulnerable_patterns:
- 'kCCAlgorithm: kCCAlgorithmDES'
- HMAC-SHA1
- MD5 hash for password storage
- SecKeyCreateSignature without proper algorithm
- CCCrypt(kCCEncryptionMode,kCCAlgorithmDES,...)
safe_patterns:
- 'kCCAlgorithm: kCCAlgorithmAES128'
- 'CCMode: kCCModeCBC with random IV'
- HMAC-SHA256
- 'SecKeyAlgorithm: kSecKeyAlgorithmRSASignatureMessagePKCS1v15SHA256'
- CryptoKit.SHA256.hash(data:)
recommendation: 'Use modern cryptographic practices:

  - Use AES-128 minimum (prefer AES-256) for encryption

  - Use SHA-256+ for hashing (avoid MD5, SHA1)

  - Use HMAC for message authentication

  - Use random IVs and secure key derivation (PBKDF2, bcrypt)

  - Use CryptoKit framework (modern, audited)

  - Avoid ECB mode (use CBC, CTR, GCM)

  - Use authenticated encryption (AES-GCM)

  - Never reuse IVs with same key

  '
cwe:
- CWE-327
mitigation: Use AES-256, SHA-256+, HMAC, CryptoKit, authenticated encryption.

---
id: objc-sec-010
name: Insecure Deserialization Detection
category: Security
severity: High
description: Detect unsafe deserialization of untrusted data
pattern: "(NSKeyedUnarchiver|NSPropertyListSerialization|JSONSerialization|\n NSCoding|NSSecureCoding|unarchiveObjectWithData|unarchiveTopLevelObjectWithData|\n\
  \ propertyListWithData|JSONObjectWithData|decode).*\n"
check_type: deserialization
vulnerable_patterns:
- '[NSKeyedUnarchiver unarchiveObjectWithData:untrustedData]'
- '[NSPropertyListSerialization propertyListWithData:data options:0 format:nil error:nil]'
- '[NSPropertyListSerialization propertyListWithData:data options:NSPropertyListImmutable
  format:nil error:nil]'
- unarchiveTopLevelObjectWithData:data error:nil
- '[NSJSONSerialization JSONObjectWithData:untrustedData options:0 error:nil]'
safe_patterns:
- '[NSKeyedUnarchiver unarchivedObjectOfClass:[MyClass class] fromData:data error:nil]'
- '[NSKeyedUnarchiver unarchiveTopLevelObjectWithData:data error:nil]'
- 'NSPropertyListSerialization:unarchivedObjectOfClass:forKey:fromData:error:'
- NSSecureCoding protocol implementation
- 'JSONDecoder().decode(MyClass.self, from: data)'
recommendation: 'Implement secure deserialization:

  - Use NSSecureCoding protocol instead of NSCoding

  - Use unarchivedObjectOfClass: to restrict types

  - Validate deserialized objects before use

  - Never deserialize from untrusted sources without validation

  - Use Codable/JSONDecoder for JSON (type-safe)

  - Implement NSSecureCoding.supportsSecureCoding = YES

  - Validate all deserialized data

  - Avoid PropertyList deserialization from untrusted sources

  '
cwe:
- CWE-502
mitigation: Use NSSecureCoding, restrict types, validate objects.

---
id: objc-sec-011
name: Path Traversal Detection
category: Security
severity: High
description: Detect path traversal and directory traversal vulnerabilities
pattern: "(NSFileManager|fileManager|NSDocumentDirectory|NSCachesDirectory|\n NSApplicationSupportDirectory|NSTemporaryDirectory|stringByAppendingPathComponent|\n\
  \ stringByAppendingString|NSSearchPathForDirectoriesInDomains|pathWithComponents).*\n"
check_type: path_traversal
vulnerable_patterns:
- NSString *basePath = NSSearchPathForDirectoriesInDomains(...)[0]
- NSString *filePath = [basePath stringByAppendingPathComponent:userInput]
- NSString *path = [NSString stringWithFormat:@"%@/%@", basePath, userPath]
- '[fileManager fileExistsAtPath:[basePath stringByAppendingString:path]]'
safe_patterns:
- NSString *basePath = NSSearchPathForDirectoriesInDomains(...)[0]
- if ([userInput containsString:@".."]) { return nil }
- NSString *filePath = [basePath stringByAppendingPathComponent:filename]
- if (![filePath hasPrefix:basePath]) { return nil }
recommendation: 'Prevent path traversal attacks:

  - Validate all file paths before accessing

  - Check that resolved path is within base directory

  - Reject paths containing \"..\" or absolute paths

  - Use stringByAppendingPathComponent: instead of string concatenation

  - Implement whitelist of allowed files/directories

  - Validate user input matches expected filename format

  - Use realpath() equivalent to resolve full path

  - Check file permissions and ownership

  '
cwe:
- CWE-22
mitigation: Validate paths, reject .., use stringByAppendingPathComponent:.

---
id: objc-sec-012
name: Weak Random Number Generation
category: Security
severity: High
description: Detect insecure random number generation for cryptography
pattern: "(random|arc4random|drand48|rand|srand|srandom|\n RAND_bytes|SecRandomCopyBytes|getRandomBytes).*\n"
check_type: rng
vulnerable_patterns:
- int token = arc4random() % 1000
- srand(time(NULL)); int random = rand()
- double random = drand48()
- srandom(seed); int value = random()
safe_patterns:
- SecRandomCopyBytes(kSecRandomDefault, sizeof(bytes), bytes)
- uint8_t bytes[32]; SecRandomCopyBytes(kSecRandomDefault, 32, bytes)
- CommonCrypto arc4random_buf
- CryptoKit.SecureBytes
recommendation: 'Use cryptographically secure random generation:

  - Use SecRandomCopyBytes for cryptographic randomness

  - Use arc4random_buf for secure random bytes

  - Never use random(), rand(), drand48() for security

  - Use secure sources: /dev/urandom, SecRandomDefault

  - For tokens: use 32+ bytes of secure random data

  - For nonces: use cryptographically secure generation

  - Test randomness with statistical analysis tools

  '
cwe:
- CWE-338
mitigation: Use SecRandomCopyBytes, arc4random_buf, not random/rand.

---
id: objc-sec-013
name: Null Pointer Dereference Detection
category: Security
severity: Medium
description: Detect potential null pointer dereferences and unsafe access
pattern: "(nil|NULL|NSNull|@try|@catch|guard|if.*nil|unwrap|\n if\\s*\\(\\s*\\!\\\
  s*\\w+\\s*\\)|if\\s*\\(\\w+.*==\\s*nil|if\\s*\\(\\w+.*!=\\s*nil).*\n"
check_type: null_safety
vulnerable_patterns:
- '[nilObject method]'
- NSString *str = [dict objectForKey:@"key"]; [str uppercaseString]
- '[array lastObject]'
- self.property.subproperty
- '[results firstObject].property'
safe_patterns:
- if (obj) { [obj method] }
- 'NSString *str = [dict objectForKey:@"key"] ?: @""'
- if (array.count > 0) { id last = array.lastObject }
- if (obj && obj.property) { ... }
recommendation: 'Implement safe null checking:

  - Always check for nil before accessing objects

  - Use optional chaining for property access

  - Use ?: operator for nil coalescing

  - Use guard statements to ensure objects exist

  - Implement nullability annotations (__nullable, __nonnull)

  - Use @try/@catch for exception handling

  - Test with nullability warnings enabled

  - Use _Nonnull in method signatures

  '
cwe:
- CWE-476
mitigation: 'Check for nil, use ?: operator, nullability annotations.'

---
id: objc-sec-014
name: Race Condition Detection
category: Security
severity: Medium
description: Detect potential race conditions in multi-threaded code
pattern: "(@synchronized|dispatch_async|dispatch_sync|dispatch_barrier|\n pthread_mutex|NSLock|NSRecursiveLock|NSConditionLock|\n\
  \ @property.*nonatomic|@property.*atomic|GCD|DispatchQueue).*\n"
check_type: race_condition
vulnerable_patterns:
- '@property (nonatomic) NSMutableArray *array'
- dispatch_async(queue, ^{ [self.array addObject:obj] })
- '[self.dict setObject:val forKey:key] // from multiple threads'
- '@property NSMutableDictionary *mutableDict // accessed from multiple threads'
safe_patterns:
- '@property (atomic) NSMutableArray *array'
- dispatch_barrier_async(queue, ^{ [self.array addObject:obj] })
- '@synchronized(self) { [self.array addObject:obj] }'
- NSLock *lock; [lock lock]; [self.array addObject:obj]; [lock unlock]
recommendation: 'Implement thread-safe synchronization:

  - Use @synchronized for simple synchronization

  - Use NSLock/NSRecursiveLock for granular control

  - Use dispatch_barrier_async for synchronized writes

  - Use dispatch_sync for synchronized reads

  - Consider immutable objects for thread safety

  - Document thread-safety guarantees

  - Use atomic properties for simple properties

  - Test with ThreadSanitizer and race condition detectors

  '
cwe:
- CWE-362
mitigation: '@synchronized, NSLock, dispatch_barrier_async, atomic properties.'

---
id: objc-sec-015
name: Privilege Escalation Detection
category: Security
severity: High
description: Detect privilege escalation and insecure system operations
pattern: "(system|exec|fork|spawn|getuid|setuid|geteuid|seteuid|\n getgid|setgid|getegid|setegid|chmod|chown|sudo|elevated).*\n"
check_type: privilege
vulnerable_patterns:
- system(userCommand)
- execl("/bin/sh", userInput)
- setuid(0) // attempt to become root
- system("rm -rf /") // dangerous
safe_patterns:
- Task execution with checked parameters
- Limited user privileges for operations
- Capability-based security model
recommendation: 'Avoid privilege escalation vulnerabilities:

  - Never call system() with user input

  - Never use setuid/seteuid for privilege escalation

  - Run with least privilege principle

  - Drop privileges after operations

  - Implement capability-based security

  - Validate all shell commands

  - Use elevated privileges only when necessary

  '
cwe:
- CWE-250
- CWE-94
mitigation: Avoid system(), use least privilege, validate commands.

---
id: objc-perf-001
name: Autorelease Pool Management
category: Performance
severity: High
description: Detect inefficient autorelease pool usage causing memory spikes
pattern: "(@autoreleasepool|autorelease|NSAutoreleasePool|\n autoreleasingReferencingObjectAtIndex|drain).*\n"
check_type: autorelease_management
inefficient_patterns:
- for (int i = 0; i < 1000000; i++) { NSString *str = [NSString stringWithFormat:...]
  }
- // No @autoreleasepool in tight loops
- '[array enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) { NSString
  *s = [obj description] }]'
efficient_patterns:
- '@autoreleasepool { for (int i = 0; i < 1000000; i++) { NSString *str = ... } }'
- for (int i = 0; i < 1000000; i++) { @autoreleasepool { NSString *str = ... } }
- '[array enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) { @autoreleasepool
  { NSString *s = [obj description] } }]'
recommendation: 'Optimize autorelease pool usage:

  - Use @autoreleasepool in tight loops creating temporary objects

  - Drain autorelease pool in loops processing large collections

  - Move @autoreleasepool outside loop if possible

  - Use fast enumeration with autorelease pools

  - Consider using NSMutableString instead of string concatenation

  - Profile with Instruments to identify autorelease spikes

  - Use proper scoping for temporary objects

  '
mitigation: Add @autoreleasepool in tight loops and collection processing.

---
id: objc-perf-002
name: ARC Overhead Detection
category: Performance
severity: Medium
description: Detect excessive retain/release overhead in ARC-managed code
pattern: "(@property.*strong|@property.*copy|retain|release|\n __strong|__weak|__unsafe_unretained|copy|mutableCopy).*\n"
check_type: arc_overhead
inefficient_patterns:
- '@property (copy, nonatomic) NSString *string // string property'
- '@property (strong, nonatomic) NSArray *immutableArray // unnecessary strong'
- NSString *copy = [original copy] // in tight loop
efficient_patterns:
- '@property (nonatomic, copy) NSString *string // correct'
- '@property (strong, nonatomic) NSMutableArray *mutableArray'
- '@property (weak, nonatomic) id<MyDelegate> delegate // prevent cycles'
recommendation: 'Optimize ARC performance:

  - Use __weak for delegates and observers

  - Use __strong only for retained properties

  - Use __unsafe_unretained for performance-critical code with careful lifetime management

  - Avoid excessive copying of immutable objects

  - Use copy properties only for thread-safe immutable objects

  - Batch property updates to reduce retain/release pairs

  - Profile retain/release activity with Instruments

  - Use copy only when thread safety requires it

  '
mitigation: __weak for delegates, avoid unnecessary copy, profile with Instruments.

---
id: objc-perf-003
name: Collection Operation Inefficiency
category: Performance
severity: High
description: Detect inefficient collection operations (O(n) operations in loops)
pattern: "(NSArray|NSMutableArray|NSDictionary|NSMutableDictionary|NSSet|NSMutableSet|\n\
  \ enumerateObjectsUsingBlock|enumerateKeysAndObjectsUsingBlock|\n containsObject|indexOfObject|objectForKey|removeObjectForKey|\n\
  \ for.*in|addObject|removeObject|sortedArray).*\n"
check_type: collection_performance
inefficient_patterns:
- for (id obj in array) { if ([otherArray containsObject:obj]) { ... } } // O(n^2)
- for (id key in dict) { [mutableArray addObject:[dict objectForKey:key]] } // O(n)
- '[array sortedArrayUsingSelector:@selector(compare:)] // recreates array'
- while ([array containsObject:obj]) { [array removeObject:obj] } // O(n^2)
efficient_patterns:
- NSSet *otherSet = [NSSet setWithArray:otherArray]
- for (id obj in array) { if ([otherSet containsObject:obj]) { ... } } // O(n)
- '[array enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) { ... }]'
- '[mutableArray sortUsingSelector:@selector(compare:)] // sorts in-place'
recommendation: 'Optimize collection operations:

  - Use NSSet instead of NSArray for containsObject: checks

  - Convert arrays to sets for membership testing (O(1) vs O(n))

  - Use enumerateObjectsUsingBlock: instead of for loops (better memory)

  - Use sortUsingSelector: on mutable arrays (in-place vs copy)

  - Batch removals instead of removing one at a time

  - Use predicates for filtering NSArray

  - Pre-allocate collections with capacity when size known

  - Cache results of expensive operations (count, etc.)

  '
mitigation: Use NSSet for membership, batch operations, use predicates.

---
id: objc-perf-004
name: String Handling Inefficiency
category: Performance
severity: High
description: Detect inefficient string operations and concatenation
pattern: "(stringByAppendingString|stringByAppendingFormat|NSMutableString|\n stringByReplacingOccurrencesOfString|componentsSeparatedByString|\n\
  \ lowercaseString|uppercaseString|stringWithFormat).*\n"
check_type: string_performance
inefficient_patterns:
- NSString *result = @""; for (...) { result = [result stringByAppendingString:part]
  } // O(n^2)
- for (id obj in array) { str = [str stringByAppendingString:[obj description]] }
- '[string stringByReplacingOccurrencesOfString:@"a" withString:@"b"] // multiple
  times'
efficient_patterns:
- NSMutableString *result = [NSMutableString string]
- for (...) { [result appendString:part] } // O(n)
- '[result appendString:[NSString stringWithFormat:@"%d", value]]'
- '[mutableString replaceOccurrencesOfString:@"a" withString:@"b" options:0 range:NSMakeRange(0,
  [mutableString length])]'
recommendation: 'Optimize string operations:

  - Use NSMutableString for concatenation in loops

  - Use stringWithFormat: instead of multiple appends

  - Cache string properties (length, substring operations)

  - Use componentsSeparatedByString: vs manual parsing

  - Use regular expressions for complex replacements

  - Consider using NSScanner for parsing

  - Avoid repeated case conversions

  - Use string pooling for repeated strings

  '
mitigation: Use NSMutableString, cache operations, avoid loops with append.

---
id: objc-perf-005
name: Image Caching Strategy
category: Performance
severity: High
description: Detect missing or inefficient image caching mechanisms
pattern: "(UIImage|imageNamed|imageWithContentsOfFile|imageWithData|\n UIImageView|setImage|sd_setImageWithURL|drawInRect|\n\
  \ NSURLCache|URLCache|ImageCache).*\n"
check_type: image_caching
inefficient_patterns:
- UIImage *image = [UIImage imageWithContentsOfFile:path] // in cell display
- for (NSString *filename in filenames) { UIImage *img = [UIImage imageNamed:filename]
  }
- '[imageView setImage:[UIImage imageWithData:data]] // no caching'
- UIImage *image = [UIImage imageWithData:[NSData dataWithContentsOfURL:url]] // blocking
  main thread
efficient_patterns:
- UIImage *image = [UIImage imageNamed:@"cached"] // cached in bundle
- NSCache *imageCache; id cachedImage = [imageCache objectForKey:path]
- '[imageView sd_setImageWithURL:url placeholderImage:placeholder]'
- dispatch_async(dispatch_get_global_queue(...), ^{ UIImage *img = [UIImage imageWithData:data]
  })
recommendation: 'Implement efficient image caching:

  - Use NSCache for in-memory image caching

  - Implement disk caching for downloaded images

  - Use SDWebImage or similar for network image loading

  - Decode images off main thread

  - Resize images to view size before caching

  - Implement memory warnings handling (clearCache)

  - Use imageWithData: for temporary images only

  - Profile image memory with Instruments

  - Pre-load critical images

  '
mitigation: Use NSCache, SDWebImage, decode off main, resize before cache.

---
id: objc-perf-006
name: Lazy Loading and Initialization
category: Performance
severity: Medium
description: Detect missing lazy loading and initialization patterns
pattern: "(init|initWithFrame|awakeFromNib|viewDidLoad|layoutSubviews|\n dealloc|_|lazy|@synthesize).*\n"
check_type: lazy_loading
inefficient_patterns:
- '- (id)init { ... [self initializeExpensiveObject] ... } // initialize everything'
- UIView *view = [[UIView alloc] init]; view.hidden = YES // never shown
- viewDidLoad loads all views even if not visible
efficient_patterns:
- '- (MyObject *)expensiveObject { if (!_expensiveObject) { _expensiveObject = ...;
  } return _expensiveObject; }'
- '@property (nonatomic, lazy) MyObject *object'
- '- (void)viewDidLoad { // load visible views only }'
recommendation: 'Implement lazy loading and initialization:

  - Defer expensive initialization to first use

  - Create properties on demand with getter checks

  - Use lazy evaluation patterns

  - Load views only when needed (table cell configuration)

  - Defer network requests until visible

  - Implement lazy property initialization

  - Use lazy collections and data structures

  - Monitor initialization performance with Instruments

  '
mitigation: Defer expensive init, check before creation, lazy properties.

---
id: objc-perf-007
name: Memory Allocation Inefficiency
category: Performance
severity: Medium
description: Detect excessive memory allocations and inefficient allocation patterns
pattern: "(malloc|calloc|realloc|alloca|sizeof|NSMutableArray|NSMutableDictionary|\n\
  \ NSMutableString|new|alloc|copy|mutableCopy).*\n"
check_type: memory_allocation
inefficient_patterns:
- for (int i = 0; i < n; i++) { NSMutableArray *arr = [NSMutableArray array] }
- NSMutableArray *array = [[NSMutableArray alloc] init]; // without capacity
- '[array addObject:obj]; [array addObject:obj2]; // repeated grows'
efficient_patterns:
- NSMutableArray *array = [NSMutableArray arrayWithCapacity:expectedSize]
- NSMutableDictionary *dict = [NSMutableDictionary dictionaryWithCapacity:size]
- Reuse collection objects instead of recreating
recommendation: 'Optimize memory allocations:

  - Pre-allocate collections with capacity when size known

  - Reuse collection objects instead of creating new ones

  - Use object pooling for frequently allocated objects

  - Avoid excessive small allocations

  - Use immutable collections when possible (less memory overhead)

  - Profile allocations with Instruments (Allocations tool)

  - Monitor high-water memory mark

  '
mitigation: Pre-allocate with capacity, reuse objects, use object pooling.

---
id: objc-perf-008
name: Main Thread Blocking
category: Performance
severity: Critical
description: Detect blocking operations on main thread causing UI freezes
pattern: "(dispatch_get_main_queue|dispatchOnMainQueue|performSelectorOnMainThread|\n\
  \ dispatch_async.*main|dispatch_sync.*main|\n NSData.*URL|NSString.*URL|URLSession|dataTaskWithURL|\n\
  \ viewDidLoad|viewWillAppear|drawRect|layoutSubviews).*\n"
check_type: main_thread_blocking
inefficient_patterns:
- viewDidLoad { NSData *data = [NSData dataWithContentsOfURL:url] } // blocking network
- dispatch_sync(dispatch_get_main_queue(), ^{ ... }) // deadlock risk
- '[NSString stringWithContentsOfURL:url encoding:NSUTF8StringEncoding error:nil]
  // blocking'
- '- (void)drawRect:(CGRect)rect { [self loadDataFromDisk] }'
efficient_patterns:
- dispatch_async(dispatch_get_global_queue(...), ^{
- '  NSData *data = [NSData dataWithContentsOfURL:url]'
- '  dispatch_async(dispatch_get_main_queue(), ^{ [self updateUI:data] })'
- '})'
recommendation: 'Avoid blocking main thread:

  - Move network operations to background queue

  - Move file I/O to background queue

  - Move database operations to background queue

  - Use dispatch_async to avoid deadlocks

  - Profile with Main Thread Checker (Xcode)

  - Set os_log points to identify blocking operations

  - Use NSURLSession for network (built-in queue support)

  - Keep main thread for UI updates only

  '
mitigation: dispatch_async for background work, Main Thread Checker.

---
id: objc-perf-009
name: View Hierarchy Complexity
category: Performance
severity: Medium
description: Detect overly complex view hierarchies causing rendering issues
pattern: "(UIView|addSubview|insertSubview|UIStackView|\n layoutSubviews|drawRect|CALayer|cornerRadius|\n\
  \ masksToBounds|shadowPath|opacity).*\n"
check_type: view_hierarchy
inefficient_patterns:
- // Deeply nested view hierarchies (>10 levels)
- view.layer.cornerRadius = 50; view.layer.masksToBounds = YES // rasterizes
- view.layer.shadowPath = nil // expensive shadow
- '[superview addSubview:view] // in loop without batching'
efficient_patterns:
- UIStackView for layout (flattens hierarchy)
- view.layer.cornerRadius = 50 WITH view.layer.shadowPath = [UIBezierPath bezierPathWithRoundedRect:...]
- Use CADisplayLink for smooth animations
- 'Batch view creation: CATransaction { [superview addSubview:v] }'
recommendation: 'Optimize view hierarchies:

  - Keep view depth < 10 levels

  - Use UIStackView for dynamic layouts

  - Set shadowPath explicitly (not nil/null)

  - Use rasterization sparingly (disable when animating)

  - Batch view updates with CATransaction

  - Pre-render static content (image snapshots)

  - Use CADisplayLink for animation

  - Profile rendering with Core Animation tool

  '
mitigation: Flatten hierarchy, UIStackView, explicit shadowPath, CATransaction.

---
id: objc-perf-010
name: Scrolling Performance Issues
category: Performance
severity: High
description: Detect UITableView/UICollectionView scrolling performance problems
pattern: "(UITableViewCell|UICollectionViewCell|cellForRowAtIndexPath|\n cellForItemAtIndexPath|dequeueReusableCellWithIdentifier|\n\
  \ heightForRowAtIndexPath|estimatedHeightForRowAtIndexPath|\n scrollViewDidScroll|willDisplayCell).*\n"
check_type: scroll_performance
inefficient_patterns:
- '- (UITableViewCell *)tableView:(UITableView *)table cellForRowAtIndexPath:(NSIndexPath
  *)indexPath {'
- '  cell.imageView.image = [UIImage imageWithContentsOfFile:path] // main thread'
- '  cell.textLabel.text = [expensiveObject description]'
- '  return cell'
- '}'
- '- (CGFloat)tableView:(UITableView *)table heightForRowAtIndexPath:(NSIndexPath
  *)indexPath {'
- '  return [self calculateHeightForRow:indexPath] // expensive'
- '}'
efficient_patterns:
- '- (void)configureCell:(UITableViewCell *)cell forIndexPath:(NSIndexPath *)indexPath'
- '  cell.imageView.image = [self.imageCache objectForKey:indexPath]'
- '}'
- '- (CGFloat)tableView:(UITableView *)table estimatedHeightForRowAtIndexPath:(NSIndexPath
  *)indexPath'
- '  return 44.0 // estimated'
- '}'
recommendation: 'Optimize table/collection view scrolling:

  - Use estimatedHeightForRowAtIndexPath instead of exact height

  - Pre-calculate row heights and cache

  - Cache cell heights in NSIndexPath-indexed dictionary

  - Load images asynchronously

  - Avoid complex calculations in cellForRowAtIndexPath

  - Reuse cells properly (dequeueReusableCellWithIdentifier)

  - Pre-render complex cell content

  - Use shouldHighlightRowAtIndexPath to skip unnecessary work

  - Profile with Core Animation and Time Profiler

  '
mitigation: Use estimated heights, cache, async images, pre-render cells.

---
id: objc-perf-011
name: Database Query Inefficiency
category: Performance
severity: High
description: Detect inefficient Core Data/SQLite queries
pattern: "(NSFetchRequest|NSPredicate|NSFetchedResultsController|\n sqlite3_prepare|sqlite3_step|sqlite3_finalize|\n\
  \ fetchAllObjects|executeFetchRequest|NSManagedObjectContext).*\n"
check_type: database_performance
inefficient_patterns:
- NSFetchRequest *request = [NSFetchRequest fetchRequestWithEntityName:@"Entity"]
- '[context executeFetchRequest:request error:nil] // no predicate, fetches all'
- for (Entity *obj in results) { [obj.relationships count] } // faults loaded
- NSFetchRequest without batch size // loads all to memory
efficient_patterns:
- NSFetchRequest *request = [NSFetchRequest fetchRequestWithEntityName:@"Entity"]
- request.predicate = [NSPredicate predicateWithFormat:@"status = %@", @"active"]
- request.relationshipKeyPathsForPrefetching = @[@"related"]
- request.returnsObjectsAsFaults = NO
- request.fetchBatchSize = 100
recommendation: 'Optimize database queries:

  - Use predicates to filter early (server-side filtering)

  - Use relationshipKeyPathsForPrefetching for joins

  - Set appropriate fetchBatchSize (default 0 = all)

  - Use returnsObjectsAsFaults for efficiency

  - Index frequently queried columns

  - Use NSFetchedResultsController for table views

  - Avoid N+1 queries (faulting relationships)

  - Profile with Core Data debugging tools

  '
mitigation: Use predicates, prefetch, batch size, NSFetchedResultsController.

---
id: objc-perf-012
name: Regular Expression Performance
category: Performance
severity: Medium
description: Detect inefficient regular expression usage
pattern: "(NSRegularExpression|enumerateMatchesInString|\n NSRegularExpressionSearch|componentsSeparatedByRegex|\n\
  \ stringByMatching|stringByReplacingOccurrences).*\n"
check_type: regex_performance
inefficient_patterns:
- for (NSString *str in array) {
- '  NSRegularExpression *regex = [NSRegularExpression ... pattern:regexPattern ...]'
- '  [regex enumerateMatchesInString:str ...]'
- '} // regex compiled each time'
efficient_patterns:
- NSRegularExpression *regex = [NSRegularExpression regularExpressionWithPattern:pattern
  options:0 error:nil]
- for (NSString *str in array) {
- '  [regex enumerateMatchesInString:str ...]'
- '}'
recommendation: 'Optimize regular expression usage:

  - Cache compiled regex objects (not create per match)

  - Use NSRegularExpressionCaseInsensitive option for optimization

  - Use NSRegularExpressionAnchorsMatchLines for multiline

  - Consider simple string operations for basic patterns

  - Use NSScanner for simple parsing instead of regex

  - Profile regex performance on large strings

  - Consider precompiled/optimized patterns

  '
mitigation: Cache regex, compile once, reuse for multiple matches.

---
id: objc-perf-013
name: Animation Performance
category: Performance
severity: Medium
description: Detect inefficient animation implementations
pattern: "(UIView.*animateWithDuration|CABasicAnimation|CAKeyframeAnimation|\n CADisplayLink|CATransaction|[CATransaction\
  \ begin|[CATransaction commit|\n animationWithKeyPath|opacity|position|scale|cornerRadius).*\n"
check_type: animation_performance
inefficient_patterns:
- '[UIView animateWithDuration:0.3 animations:^{'
- '  for (int i = 0; i < 100; i++) {'
- '    view.alpha = 1.0 - (i / 100.0) // expensive'
- '  }'
- '}]'
efficient_patterns:
- CABasicAnimation *anim = [CABasicAnimation animationWithKeyPath:@"opacity"]
- anim.fromValue = @(1.0); anim.toValue = @(0.0)
- anim.duration = 0.3
- '[view.layer addAnimation:anim forKey:@"opacity"]'
recommendation: 'Optimize animations:

  - Use CABasicAnimation instead of block animations for smooth 60fps

  - Use CADisplayLink for complex animations

  - Avoid animating complex views (pre-render/snapshot)

  - Disable shadows and rounded corners during animation

  - Use CATransaction for batch animations

  - Profile with Core Animation and Time Profiler

  - Use shouldRasterize sparingly (disable after animation)

  '
mitigation: Use CABasicAnimation, CADisplayLink, disable effects during anim.

---
id: objc-perf-014
name: Framework Load Time Optimization
category: Performance
severity: Medium
description: Detect excessive framework loading and initialization overhead
pattern: "(didFinishLaunchingWithOptions|applicationDidBecomeActive|\n import|@import|Framework|dyld|DYLD_|launch|startup|load).*\n"
check_type: framework_loading
inefficient_patterns:
- // Importing many frameworks in main thread
- '[self initializeAllFrameworks] // in didFinishLaunching'
- dispatch_sync(mainQueue) // in framework init
efficient_patterns:
- Lazy load frameworks on first use
- Initialize non-critical frameworks on background
- Use modulemap for framework management
recommendation: 'Optimize framework loading:

  - Measure app launch time with Instruments

  - Lazy load frameworks on first use

  - Defer non-critical initialization

  - Profile with Time Profiler tool

  - Consider removing unused frameworks

  - Use dynamic linking for optional features

  '
mitigation: Lazy load, defer init, measure launch time with Instruments.

---
id: objc-qual-001
name: Apple Naming Conventions
category: Quality
severity: Medium
description: Enforce Apple-style naming conventions for classes, methods, properties
pattern: '(^[A-Z]|^[a-z].*:|method|property|variable|class|protocol).*

  '
check_type: naming_conventions
violations:
- class myClass { } // should be MyClass
- '@property NSString *strValue; // should be string'
- '- (void)GetValue { } // should be getValue (camelCase)'
- '@property String *str; // should be NSString'
- '- (void)PROCESS_DATA { } // should be processData'
correct_usage:
- class MyClass { } // PascalCase for classes
- '@property (nonatomic) NSString *string; // camelCase for properties'
- '- (void)getValue { } // camelCase for methods'
- '- (void)setName:(NSString *)name { } // setter with (void)'
- '- (BOOL)isEnabled { } // boolean with ''is'' prefix'
recommendation: 'Follow Apple naming conventions:

  - Classes: PascalCase (MyViewController, NSMutableArray)

  - Properties/variables: camelCase (firstName, isEnabled)

  - Methods: camelCase (getValue:, processData)

  - Constants: ALL_CAPS with K prefix (kMaxRetries, kPIValue)

  - Protocols: PascalCase with Delegate/DataSource suffix (MyDelegate)

  - Getters: getPropertyName: only for expensive operations

  - Setters: setPropertyName: or property = syntax

  - Booleans: is/has/should prefix (isEnabled, hasData, shouldRetry)

  - Prefixes: Use 2-3 letter class prefix to avoid conflicts

  '
mitigation: Use PascalCase for classes, camelCase for methods/properties.

---
id: objc-qual-002
name: Property Attributes
category: Quality
severity: High
description: Enforce proper property attribute declarations
pattern: "(@property|nonatomic|atomic|strong|weak|copy|assign|\n readonly|readwrite|getter|setter).*\n"
check_type: property_attributes
violations:
- '@property NSString *name; // missing nonatomic'
- '@property (strong) NSMutableArray *array; // redundant, default'
- '@property (retain) NSString *str; // use strong in ARC'
- '@property (assign) id delegate; // should use weak'
correct_usage:
- '@property (nonatomic, copy) NSString *name; // immutable'
- '@property (nonatomic, strong) NSMutableArray *array; // mutable'
- '@property (weak, nonatomic) id<MyDelegate> delegate; // break cycles'
- '@property (nonatomic, readonly) NSInteger identifier; // read-only'
- '@property (nonatomic, getter=isEnabled) BOOL enabled; // custom getter'
recommendation: 'Use correct property attributes:

  - nonatomic: almost always (atomic expensive, rarely needed)

  - strong: for owned objects (default in ARC)

  - weak: for delegates, observers, self-referential objects

  - copy: for immutable objects (NSString, NSArray, NSData)

  - assign: rarely (for primitives and weak non-ARC pointers)

  - readonly/readwrite: explicit when limiting access

  - getter/setter: custom accessors for special handling

  - Avoid atomic unless truly thread-safe required

  '
mitigation: Add nonatomic, use weak for delegates, copy for immutable.

---
id: objc-qual-003
name: Nullability Annotations
category: Quality
severity: High
description: Enforce nullability annotations for type safety
pattern: "(_Nullable|_Nonnull|nullable|nonnull|null_resettable|\n __nullable|__nonnull|__null_unspecified).*\n"
check_type: nullability
violations:
- '- (NSString *)getName { } // unclear if can return nil'
- '- (void)setName:(NSString *)name { } // can name be nil?'
- '@property NSArray *items; // unclear if mutable'
correct_usage:
- '- (nullable NSString *)getName { } // can return nil'
- '- (void)setName:(nonnull NSString *)name { } // name cannot be nil'
- '@property (nonnull) NSArray *items; // never nil'
- '- (nullable NSError **)error; // out parameter'
- '@property (nonnull, copy) NSString *identifier; // never nil, copy for safety'
recommendation: 'Add nullability annotations:

  - Use _Nonnull for parameters and properties that cannot be nil

  - Use _Nullable for return values and out parameters that can be nil

  - Use __null_unspecified for legacy code (migrate over time)

  - Use NS_ASSUME_NONNULL_BEGIN/END for bulk annotations

  - Annotate all public API headers

  - Enable warnings: -Wnullability-completeness

  - Document nil behavior in method comments

  '
mitigation: Add _Nonnull/_Nullable, use NS_ASSUME_NONNULL_BEGIN.

---
id: objc-qual-004
name: Memory Management Patterns
category: Quality
severity: High
description: Enforce proper ARC memory management patterns
pattern: "(dealloc|release|retain|autorelease|copy|strong|weak|\n __strong|__weak|NSZombieEnabled|MallocStackLogging).*\n"
check_type: memory_patterns
violations:
- // Missing dealloc for observer cleanup
- // Retaining self in block causing cycle
- '- (void)setupBlock { self.block = ^{ [self doSomething] } }'
- __strong Object *obj = strongRef; // unnecessary
correct_usage:
- '- (void)dealloc { [[NSNotificationCenter defaultCenter] removeObserver:self] }'
- __weak typeof(self) weakSelf = self; self.block = ^{ [weakSelf doSomething] }
- '@property (weak) id<MyDelegate> delegate; // no retain cycle'
- '@interface MyClass { NSMutableArray *_internal; }'
recommendation: 'Follow ARC memory management:

  - Use ARC exclusively (no manual retain/release)

  - Use __weak in blocks to break retain cycles

  - Implement dealloc for cleanup (observers, timers, etc.)

  - Use __strong only when explicitly needed

  - Document retain cycle risks in comments

  - Test with Leaks and Allocations instruments

  - Use Weak/Strong Dance pattern: weakSelf/strongSelf in blocks

  - Avoid circular references through delegates

  '
mitigation: __weak in blocks, dealloc for cleanup, no manual ARC.

---
id: objc-qual-005
name: Protocol Design
category: Quality
severity: Medium
description: Enforce proper protocol design and compliance
pattern: "(@protocol|@required|@optional|delegate|dataSource|\n conformsToProtocol|respondsToSelector).*\n"
check_type: protocol_design
violations:
- '@protocol MyProtocol // no methods (unclear intent)'
- '- (void)update; // vague, unclear parameters'
- '@protocol MyDelegate <NSObject> // missing NSCopying adoption'
- // Protocol mixing delegates and data source responsibilities
correct_usage:
- '@protocol MyDelegate <NSObject>'
- '@required'
- '- (void)updateWithData:(nonnull NSData *)data;'
- '@optional'
- '- (void)didFinishWithError:(nullable NSError *)error;'
- '@end'
recommendation: 'Design protocols properly:

  - Inherit from NSObject for compatibility

  - Separate delegates from data sources (single responsibility)

  - Use @required for mandatory methods

  - Use @optional for optional behavior (with respondsToSelector checks)

  - Document parameter meanings (especially NULL/nil cases)

  - Use nullability annotations in protocol declarations

  - Keep protocols focused and cohesive

  - Use protocol composition for complex requirements

  '
mitigation: Separate concerns, use @required/@optional, annotate nullability.

---
id: objc-qual-006
name: Error Handling Patterns
category: Quality
severity: High
description: Enforce proper error handling and exception use
pattern: "(@try|@catch|@finally|@throw|NSError|NSException|\n error:|completionHandler|resultHandler).*\n"
check_type: error_handling
violations:
- '- (NSString *)loadFile:(NSString *)path error:(NSError **)error {'
- '  [UIImage imageNamed:path] // ignores error, crashes on missing'
- '  return data'
- '}'
- '@try { ... } @catch (...) { } @finally { } // bare catches'
correct_usage:
- '- (nullable NSData *)loadFile:(nonnull NSString *)path error:(NSError * _Nullable
  *)error {'
- '  if (!path || !path.length) {'
- '    if (error) { *error = [NSError errorWithDomain:... code:... userInfo:...] }'
- '    return nil'
- '  }'
- '  return data'
- '}'
- '@try { ... } @catch (NSException *ex) { /* handle */ } @finally { /* cleanup */
  }'
recommendation: 'Implement proper error handling:

  - Use NSError for recoverable errors (not exceptions)

  - Use exceptions only for programming errors

  - Return nil with error pointer for failures

  - Validate error pointer before dereferencing (if (error) { *error = ... })

  - Use error domains and codes for categorization

  - Include NSUnderlyingError for error chains

  - Log errors but don''t expose to users

  - Provide recovery suggestions in userInfo

  - Use @try/@catch only for exception handling

  '
mitigation: Use NSError for failures, check error pointer, validate inputs.

---
id: objc-qual-007
name: Constants and Enums
category: Quality
severity: Medium
description: Enforce proper constant and enum declarations
pattern: "(const|NS_ENUM|NS_OPTIONS|typedef|#define|static|\n extern|kConstant|Constant).*\n"
check_type: constants_enums
violations:
- '#define kMaxRetries 5 // unsafe macro'
- static NSString *GlobalString = nil // mutable global
- enum Status { OK = 0, ERROR = 1 } // untyped enum
- extern int MAX_SIZE; // unsafe, should be const
correct_usage:
- static const NSInteger kMaxRetries = 5; // type-safe
- static NSString * const kErrorDomain = @"com.app.error"; // immutable
- typedef NS_ENUM(NSInteger, Status) { StatusOK = 0, StatusError = 1 }
- typedef NS_OPTIONS(NSUInteger, Permissions) { PermissionRead = 1, PermissionWrite
  = 2 }
- extern NSString * const kMyConstant; // in header
recommendation: 'Declare constants properly:

  - Use static const for primitive constants

  - Use extern for public constants (declare in header, define in implementation)

  - Use NS_ENUM for enumeration types

  - Use NS_OPTIONS for bitmask options

  - Avoid #define (use const instead)

  - Prefix constants with k (kMaxRetries, kAppName)

  - Use stringification for string constants

  - Document constant meanings and usage

  '
mitigation: Use NS_ENUM/NS_OPTIONS, static const, extern for public.

---
id: objc-qual-008
name: Method Signature Clarity
category: Quality
severity: Medium
description: Enforce clear and descriptive method signatures
pattern: '(^-|^\\+|\\(void\\)|\\(BOOL\\)|\\(id\\)|parameter|argument|return).*

  '
check_type: method_clarity
violations:
- '- (id)process { } // vague return type'
- '- (void)set:(id)value { } // unclear parameter'
- '- (void)doSomething:(NSString *)str other:(id)o { } // unclear'
- '- (NSString *)getValue { } // unclear what gets value'
correct_usage:
- '- (nullable id<MyDelegate>)delegate { return _delegate; }'
- '- (void)setValue:(nonnull id)value forKey:(nonnull NSString *)key { }'
- '- (void)updateWithData:(nonnull NSData *)data error:(NSError **)error { }'
- '- (nullable NSError *)validateWithOptions:(NSDictionary *)options { }'
recommendation: 'Write clear method signatures:

  - Use descriptive parameter names (user, not u)

  - Indicate parameter purpose with descriptive names

  - Use completion blocks for asynchronous results

  - Return values that indicate success/failure

  - Use error pointers for recoverable errors

  - Document complex parameter meanings

  - Keep signatures to 3-4 parameters maximum

  - Use factory methods for common initializations

  '
mitigation: Use descriptive names, clear parameters, error pointers.

---
id: objc-qual-009
name: Documentation Standards
category: Quality
severity: Medium
description: Enforce proper code documentation and comments
pattern: '(///|@param|@return|@throws|@warning|@deprecated|MARK|pragma).*

  '
check_type: documentation
violations:
- '- (void)complexMethod { } // no documentation'
- /**/ // incomplete documentation
- '@property NSString *data; // no comment explaining purpose'
correct_usage:
- /**
- ' * Processes the input data and returns the result.'
- ' *'
- ' * @param data The data to process.'
- ' * @return The processed result, or nil if processing fails.'
- ' * @warning This method blocks the calling thread.'
- ' */'
- '- (nullable id)processData:(nonnull NSData *)data;'
recommendation: 'Document code properly:

  - Add header comments for all public methods

  - Document parameters, return values, and exceptions

  - Use @param, @return, @throws style documentation

  - Add @warning for non-obvious behavior

  - Use @deprecated for obsolete methods

  - Add @see for related methods

  - Use // for inline explanations

  - Use #pragma mark for section organization

  - Document thread safety guarantees

  '
mitigation: Add documentation comments, use standard format, document warnings.

---
id: objc-qual-010
name: Type Safety and Casting
category: Quality
severity: High
description: Enforce type safety and proper object casting
pattern: '(id|NSObject|cast|as|typeof|isKindOfClass|isMemberOfClass).*

  '
check_type: type_safety
violations:
- NSString *str = (NSString *)obj; // unsafe cast
- if ([obj class] == [NSString class]) { } // direct class comparison
- '[array objectAtIndex:0]; // returns id, type unknown'
- NSObject *obj = ...; [obj doSomething]; // unknown method
correct_usage:
- if ([obj isKindOfClass:[NSString class]]) { NSString *str = (NSString *)obj; }
- '@try { NSString *str = (NSString *)obj; } @catch (...) { }'
- id result = array.firstObject; NSString *str = nil;
- if ([result isKindOfClass:[NSString class]]) { str = result; }
recommendation: 'Ensure type safety:

  - Check type with isKindOfClass: before casting

  - Use respondsToSelector: for dynamic method calls

  - Avoid unsafe casts (use if statements with checks)

  - Use generic collections (NSArray<NSString *> *)

  - Document expected types in comments

  - Use explicit type annotations

  - Use -Wstrict-selector-match for selector checking

  '
mitigation: Check type before casting, use generics, respondsToSelector:.

---
id: objc-qual-011
name: Initialization Patterns
category: Quality
severity: Medium
description: Enforce proper initialization and designated initializers
pattern: '(init|initWith|new|alloc|designated|initializer).*

  '
check_type: initialization
violations:
- '- (id)init { return [super init]; } // incomplete init'
- // Multiple init methods without designated pattern
- '[[MyClass alloc] init] // correct usage'
- '- (id)initWithValue:(id)val { self.value = val; return self; }'
correct_usage:
- '- (instancetype)initWithValue:(nonnull id)value {'
- '  self = [super init];'
- '  if (!self) return nil;'
- '  _value = value;'
- '  return self;'
- '}'
- '- (instancetype)initWithValue:(nonnull id)value name:(nonnull NSString *)name {'
- '  // Call designated initializer'
- '  return [self initWithValue:value];'
- '}'
recommendation: 'Follow initialization patterns:

  - Use instancetype as return type (not id)

  - Implement [super init] first and check result

  - Establish one designated initializer per class

  - Other inits should call designated initializer

  - Return nil on initialization failure

  - Initialize all ivars in designated init

  - Use lazy initialization for expensive properties

  - Document required initialization steps

  '
mitigation: Use instancetype, call super init, designated pattern.

---
id: objc-qual-012
name: Category Usage
category: Quality
severity: Medium
description: Enforce proper category design and naming
pattern: '(@interface.*\\(|category|+|extension).*

  '
check_type: category_design
violations:
- '@interface NSString (MyExtension) // no prefix'
- '@interface MyClass (SomethingRandom) // multiple categories conflict'
- '@interface NSString (Transform) @property ... // property in category'
correct_usage:
- '@interface NSString (APP_MyExtension) // app-prefixed'
- '@interface MyClass (Transform)'
- '- (NSString *)uppercaseFirstLetter;'
- '@end'
- '// Separate files: MyClass+Transform.h/m'
recommendation: 'Use categories properly:

  - Use app/framework prefix to avoid collisions

  - One category per file (MyClass+Transform.m)

  - Don''t add properties to categories (use private class extension)

  - Don''t override existing methods in categories

  - Use for organizing related methods

  - Document cross-file dependencies

  - Consider private extensions for internal organization

  - Use +functionName for functions in categories

  '
mitigation: Use prefixes, one category per file, avoid properties.

---
id: objc-qual-013
name: Compatibility Annotations
category: Quality
severity: Medium
description: Enforce deprecation and availability annotations
pattern: "(DEPRECATED_ATTRIBUTE|NS_DEPRECATED|__attribute__|\n UNAVAILABLE_ATTRIBUTE|NS_UNAVAILABLE|available|introduced|deprecated).*\n"
check_type: compatibility
violations:
- '- (void)oldMethod { } // no deprecation marking'
- // No indication of iOS version requirements
- '- (void)newMethod // no availability marking'
correct_usage:
- '- (void)oldMethod NS_DEPRECATED_IOS(2_0, 5_0, "Use -newMethod instead")'
- '@available(iOS 13.0, *) - (void)modernMethod { }'
- API_AVAILABLE(ios(13.0)) - (void)newMethod { }
- NS_UNAVAILABLE - (void)unsupportedMethod { }
recommendation: 'Mark compatibility properly:

  - Use NS_DEPRECATED_IOS for deprecated methods

  - Use NS_UNAVAILABLE for removed methods

  - Use @available for version-specific code

  - Document replacement methods

  - Include minimum version requirements

  - Use __attribute__ for compiler directives

  - Test on minimum supported version

  '
mitigation: Add deprecation marks, @available, NS_UNAVAILABLE.

---
id: objc-qual-014
name: Assertion and Defensive Programming
category: Quality
severity: Medium
description: Enforce defensive programming with assertions
pattern: "(NSAssert|NSAssert[1-5]|NSParameterAssert|NSCAssert|\n assert|@throw|precondition|postcondition).*\n"
check_type: assertions
violations:
- '- (void)setName:(NSString *)name { _name = name; } // no validation'
- '- (NSString *)getName { return _name; } // could be nil'
- NSArray *array = ...; [array objectAtIndex:index] // no bounds check
correct_usage:
- '- (void)setName:(nonnull NSString *)name {'
- '  NSParameterAssert(name);'
- '  NSParameterAssert(name.length > 0);'
- '  _name = [name copy];'
- '}'
- '- (void)insertObject:(nonnull id)obj atIndex:(NSUInteger)idx {'
- '  NSAssert(idx <= [_items count], @"Index out of bounds");'
- '  [_items insertObject:obj atIndex:idx];'
- '}'
recommendation: 'Use assertions for defense:

  - Use NSParameterAssert for parameter validation

  - Use NSAssert for invariant validation

  - Use NSCAssert for C code assertions

  - Assertions compile out in Release builds

  - Add assertions after guard statements

  - Use descriptive assertion messages

  - Test with assertions enabled

  - Don''t rely on assertions for user input validation

  '
mitigation: Add NSParameterAssert, NSAssert for validation.

---
id: objc-qual-015
name: Code Organization and Structure
category: Quality
severity: Medium
description: Enforce proper code organization within files
pattern: "(pragma mark|MARK|interface|implementation|synthesize|\n extension|private|public|protected).*\n"
check_type: code_organization
violations:
- // No organization, methods in random order
- '@interface/@implementation mixed'
- // Private and public methods interleaved
correct_usage:
- '@interface MyClass ()'
- '@property (nonatomic) NSString *private;'
- '@end'
- '@implementation MyClass'
- '#pragma mark - Lifecycle'
- '- (instancetype)init { ... }'
- '- (void)dealloc { ... }'
- '#pragma mark - Public Methods'
- '- (void)publicMethod { ... }'
- '#pragma mark - Private Methods'
- '- (void)privateMethod { ... }'
- '#pragma mark - Getters & Setters'
- '@end'
recommendation: 'Organize code properly:

  - Use #pragma mark for section organization

  - Group related methods together

  - Order: lifecycle, public, private, getters/setters

  - Use private class extension for private properties

  - Keep implementation organized by functionality

  - Use separate files for categories

  - Limit file size (<500 lines is good)

  - Document complex sections with comments

  '
mitigation: 'Use #pragma mark, organize by section, private extensions.'

---
id: objc-qual-016
name: Performance Profiling Markers
category: Quality
severity: Low
description: Enforce use of performance profiling markers
pattern: "(os_log|os_signpost|signpost_interval_begin|signpost_interval_end|\n SIGNPOST_|OSLog).*\n"
check_type: profiling_markers
inefficient_patterns:
- // No profiling markers in critical paths
- // Complex operations without timing
efficient_patterns:
- 'os_log(.info, log: OSLog.default, "Starting operation")'
- 'os_signpost(.begin, log: OSLog.default, name: "DataLoad")'
- '[performWork]'
- 'os_signpost(.end, log: OSLog.default, name: "DataLoad")'
recommendation: 'Add profiling markers:

  - Use os_log for informational logging

  - Use os_signpost for performance intervals

  - Mark critical operations for profiling

  - Test with Instruments signpost tool

  - Use appropriate log levels (debug, info, error)

  - Profile on actual devices

  - Remove debug logs in production

  '
mitigation: Add os_signpost markers for profiling, use os_log.

---
id: react-xss-dangerously-inner-html
tags:
- Security
severity: error
message: 'Quality: XSS via dangerouslySetInnerHTML'
note: '|'
language: javascript

---
id: react-state-management-side-effects
tags:
- Quality
severity: error
message: 'Quality: State Management and Side Effects Anti-patterns'
note: '|'
language: javascript

---
id: react-unnecessary-rerenders
tags:
- Performance
severity: warning
message: 'Quality: Unnecessary Component Re-renders'
note: '|'
language: javascript

---
id: react-memo-prop-drilling
tags:
- Performance
severity: warning
message: 'Quality: memo() Ineffective with Deep Props'
note: '|'
language: javascript

---
id: react-useeffect-cleanup
tags:
- Quality
severity: error
message: 'Quality: Missing useEffect Cleanup Functions'
note: '|'
language: javascript

---
id: react-native-secure-storage
tags:
- Security
severity: error
message: 'Quality: Storing Sensitive Data Insecurely'
note: '|'
language: javascript

---
id: angular-template-injection
tags:
- Security
severity: error
message: 'Quality: Template Injection and XSS'
note: '|'
language: typescript

---
id: angular-change-detection
tags:
- Performance
severity: warning
message: 'Quality: Inefficient Change Detection Strategy'
note: '|'
language: typescript

---
id: angular-unsubscribe-memory-leak
tags:
- Quality
severity: error
message: 'Quality: Unsubscribed Observables Cause Memory Leaks'
note: '|'
language: typescript

---
id: angular-trackby-ngfor
tags:
- Performance
severity: warning
message: 'Quality: Missing trackBy in *ngFor Loops'
note: '|'
language: typescript

---
id: vue-v-html-xss
tags:
- Security
severity: error
message: 'Quality: XSS via v-html Directive'
note: '|'
language: javascript

---
id: vue-reactive-pitfalls
tags:
- Quality
severity: error
message: 'Quality: Reactive Object Pitfalls and Anti-patterns'
note: '|'
language: javascript

---
id: vue-computed-vs-methods
tags:
- Performance
severity: warning
message: 'Quality: Computed Properties vs Methods Optimization'
note: '|'
language: javascript

---
id: vue-watcher-cleanup
tags:
- Quality
severity: error
message: 'Quality: Watcher Memory Leaks and Cleanup'
note: '|'
language: javascript

---
id: django-sql-injection
tags:
- Security
severity: error
message: 'Quality: SQL Injection via Raw Queries'
note: '|'
language: python

---
id: django-xss-template-injection
tags:
- Security
severity: error
message: 'Quality: XSS and Template Injection'
note: '|'
language: python

---
id: django-csrf-bypass
tags:
- Security
severity: error
message: 'Quality: CSRF Protection Bypass'
note: '|'
language: python

---
id: django-n-plus-one-queries
tags:
- Performance
severity: error
message: 'Quality: N+1 Query Problem'
note: '|'
language: python

---
id: django-settings-security
tags:
- Security
severity: error
message: 'Quality: Insecure Settings Configuration'
note: '|'
language: python

---
id: django-model-mass-assignment
tags:
- Security
severity: warning
message: 'Quality: Mass Assignment / Over-posting'
note: '|'
language: python

---
id: spring-spel-injection
tags:
- Security
severity: error
message: 'Quality: SpEL (Spring Expression Language) Injection'
note: '|'
language: java

---
id: spring-mass-assignment
tags:
- Security
severity: error
message: 'Quality: Mass Assignment / Unsafe Deserialization'
note: '|'
language: java

---
id: spring-actuator-exposure
tags:
- Security
severity: error
message: 'Quality: Exposed Actuator Endpoints'
note: '|'
language: java

---
id: spring-connection-pooling
tags:
- Performance
severity: warning
message: 'Quality: Database Connection Pool Misconfiguration'
note: '|'
language: java

---
id: spring-caching-pitfalls
tags:
- Quality
severity: warning
message: 'Quality: Caching Issues and Cache Invalidation'
note: '|'
language: java

---
id: spring-bean-scope-confusion
tags:
- Quality
severity: warning
message: 'Quality: Bean Scope Misuse and Thread Safety'
note: '|'
language: java

---
id: rails-mass-assignment
tags:
- Security
severity: error
message: 'Quality: Mass Assignment Vulnerability'
note: '|'
language: ruby

---
id: rails-sql-injection
tags:
- Security
severity: error
message: 'Quality: SQL Injection'
note: '|'
language: ruby

---
id: rails-xss-prevention
tags:
- Security
severity: error
message: 'Quality: XSS via Unsafe HTML Rendering'
note: '|'
language: ruby

---
id: rails-n-plus-one-queries
tags:
- Performance
severity: error
message: 'Quality: N+1 Query Problem'
note: '|'
language: ruby

---
id: rails-caching-invalidation
tags:
- Performance
severity: warning
message: 'Quality: Cache Invalidation and Fragment Caching'
note: '|'
language: ruby

---
id: rails-convention-patterns
tags:
- Quality
severity: warning
message: 'Quality: Rails Convention Over Configuration Best Practices'
note: '|'
language: ruby

---
id: rails-testing-patterns
tags:
- Quality
severity: warning
message: 'Quality: Testing Best Practices and Patterns'
note: '|'
language: ruby
